<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5JDKMG4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-5JDKMG4")</script><title>Change schema of huge table in MySQL ::
/home/xluffy
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://taoquangne.com/post/change-schema-of-huge-table-in-mysql/><link rel=stylesheet href=https://taoquangne.com/assets/style.css><link rel=stylesheet href=https://taoquangne.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://taoquangne.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://taoquangne.com/img/favicon.png><link href=https://taoquangne.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Change schema of huge table in MySQL"><meta property="og:url" content="https://taoquangne.com/post/change-schema-of-huge-table-in-mysql/"><meta property="og:site_name" content="/home/xluffy"><meta property="og:title" content="Change schema of huge table in MySQL"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-12-27T00:00:00+00:00"><meta property="article:modified_time" content="2019-12-27T00:00:00+00:00"><meta property="article:tag" content="Mysql"><meta property="article:tag" content="Percona"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>/home/xluffy ft ğŸ„</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Change schema of huge table in MySQL</h1><div class=post-meta><span class=post-date>2019-12-27</span></div><span class=post-tags><a href=https://taoquangne.com/tags/mysql/>#mysql</a>&nbsp;
<a href=https://taoquangne.com/tags/percona/>#percona</a>&nbsp;</span><div class=post-content><blockquote><p>BÃ i nÃ y Ä‘Æ°á»£c update láº¡i gáº§n nhÆ° toÃ n bá»™ sau khi mÃ¬nh join team research-database cá»§a <a href=https://www.grokking.org/>Grokking</a>. LÃ½ do chÃ­nh lÃ  mÃ¬nh phÃ¡t hiá»‡n cÃ³ nhiá»u Ä‘iá»ƒm khÃ´ng chÃ­nh xÃ¡c á»Ÿ ná»™i dung cÅ©.</p></blockquote><h2 id=1-theo-dÃ²ng-lá»‹ch-sá»­>1. Theo dÃ²ng lá»‹ch sá»­</h2><p>Thay Ä‘á»•i schema cá»§a má»™t báº£ng dá»¯ liá»‡u trong MySQL lÃ  má»™t nhu cáº§u thÆ°á»ng xuyÃªn vÃ  háº¿t sá»©c cÆ¡ báº£n khi phÃ¡t triá»ƒn há»‡ thá»‘ng. Tuy nhiÃªn báº¥t ká»³ ai hiá»ƒu biáº¿t vá» MySQL Ä‘á»u biáº¿t ráº±ng cÃ´ng viá»‡c nÃ y thá»±c sá»± ráº¥t Ä‘au Ä‘á»›n vÃ¬ nÃ³ cÃ³ thá»ƒ lÃ m drop traffic production, tÄƒng thá»i gian xá»­ lÃ½ á»Ÿ táº§ng database, Ä‘em láº¡i tráº£i nghiá»‡m khÃ´ng tá»‘t cho ngÆ°á»i dÃ¹ng, trong má»™t sá»‘ trÆ°á»ng há»£p há»‡ thá»‘ng sáº½ bá»‹ downtime cho tá»›i khi viá»‡c thay Ä‘á»•i schema hoÃ n thÃ nh. Há»‡ quáº£ lÃ  giáº£m revenue, khÃ¡ch hÃ ng bá» Ä‘i. Äá»‘i vá»›i nhá»¯ng há»‡ thá»‘ng traffic cao, yÃªu cáº§u phá»¥c vá»¥ lÃ  24/7 thÃ¬ khÃ¡ch hÃ ng sáº½ khÃ³ cháº¥p nháº­n chuyá»‡n nÃ y.</p><p>CÃ¡c há»‡ quáº£n trá»‹ CSDL sá»­ dá»¥ng má»™t ngÃ´n ngá»¯ Ä‘á»ƒ Ä‘á»‹nh nghÄ©a cáº¥u trÃºc cá»§a dá»¯ liá»‡u gá»i lÃ  DDL (Data Definition Language) Ä‘á»ƒ thÃªm/sá»­a/xÃ³a cáº¥u trÃºc logic cá»§a schema (databases, tables, keys &mldr;). VÃ­ dá»¥ vá» DDL nhÆ° <code>CREATE</code>, <code>ALTER TABLE ...</code>, <code>DROP ...</code>má»™t sá»‘ nhu cáº§u thÆ°á»ng tháº¥y nhÆ°:</p><ul><li>ÄÃ¡nh index cho má»™t báº£ng Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™ truy váº¥n dá»¯ liá»‡u.</li><li>XÃ³a cÃ¡c index dÆ° thá»«a.</li><li>ThÃªm cá»™t dá»¯ liá»‡u vÃ o má»™t báº£ng.</li><li>XÃ³a cá»™t dá»¯ liá»‡u trong má»™t báº£ng.</li><li>Thay Ä‘á»•i data-type cá»§a má»™t cá»™t trong báº£ng.</li><li>Thay Ä‘á»•i charset cá»§a báº£ng hoáº·c database.</li></ul><p><strong>Tuy nhiÃªn</strong> vá»›i cÃ¡c phiÃªn báº£n MySQL khÃ¡c nhau, <em>storage engine</em> khÃ¡c nhau, MySQL sáº½ cÃ³ cÃ¡ch hÃ nh xá»­ khÃ¡c nhau trÃªn cÃ¡c cÃ¢u lá»‡nh thay Ä‘á»•i schema:</p><ul><li>Vá»›i MySQL &lt; 5.1, storage engine máº·c Ä‘á»‹nh lÃ  MyISAM.</li><li>Vá»›i MySQL > 5.1 vá»›i InnoDB plugin, hoáº·c MySQL 5.5.</li><li>Vá»›i MySQL > 5.6 vá»›i Online DDL.</li></ul><p>NgoÃ i ra, Ä‘á»ƒ giáº£i quyáº¿t nhu cáº§u thay Ä‘á»•i schema, cÅ©ng cÃ³ nhá»¯ng cÃ¡ch tiáº¿p cáº­n khÃ¡c khi báº£n thÃ¢n MySQL chÆ°a há»— trá»£ tá»‘t online DDL (á»Ÿ cÃ¡c version cÅ©) hoáº·c báº£n thÃ¢n storage engine chÆ°a xá»­ lÃ½ tá»‘t yÃªu cáº§u thay Ä‘á»•i schema nhÆ°:</p><ul><li><a href=https://www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html>pt-online-schema-change</a> tá»« Percona team.</li><li><a href=https://github.com/github/gh-ost>gh-ost</a> tá»« github team.</li><li><a href=https://github.com/facebookincubator/OnlineSchemaChange>osc</a> tá»« facebook team.</li></ul><p>Má»—i tool sáº½ cÃ³ cÃ¡ch tiáº¿p cáº­n khÃ¡c nhau, nhÆ°ng tÃ¹y vÃ o tÃ¬nh huá»‘ng vÃ  cÅ©ng tÃ¹y vÃ o phiÃªn báº£n MySQL sáº½ cÃ³ nhá»¯ng Æ°u nhÆ°á»£c Ä‘iá»ƒm riÃªng.</p><p>NgoÃ i ra cÃ²n 2 cÃ¡ch tiáº¿p cáº­n khÃ¡c Ä‘Ã³ lÃ :</p><ul><li>Downtime há»‡ thá»‘ng vÃ  thá»±c hiá»‡n thay Ä‘á»•i schema xong thÃ¬ má»›i báº­t há»‡ thá»‘ng láº¡i.</li><li>Thá»±c hiá»‡n thay Ä‘á»•i trÃªn Slave, sau khi hoÃ n thÃ nh thÃ¬ promote slave lÃªn thay tháº¿ master. (manunal nhiá»u, tá»‘n thá»i gian, phá»©c táº¡p khi cÃ³ nhiá»u slave, schema inconsistent)</li></ul><h2 id=2-mysql-50-vÃ -myisam>2. MySQL 5.0 vÃ  MyISAM</h2><p>ÄÃ¢y lÃ  storage engine máº·c Ä‘á»‹nh á»Ÿ version MySQL 5.0, hiá»‡n giá» nÃ³ khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng nhiá»u ná»¯a nhÆ°ng báº¡n cÅ©ng cáº§n biáº¿t vá» nÃ³ Ä‘á»ƒ hiá»ƒu táº¡i sao viá»‡c thay Ä‘á»•i schema trÃªn InnoDB láº¡i dá»… dÃ ng hÆ¡n MyISAM.</p><p>Äiá»ƒm khÃ¡c biá»‡t lá»›n nháº¥t liÃªn quan Ä‘áº¿n nhu cáº§u thay Ä‘á»•i schema giá»¯a 2 storage engine nÃ y lÃ  cÆ¡ cháº¿ locking:</p><ul><li>InnoDB dÃ¹ng cÆ¡ cháº¿ row-level locking.</li><li>MyISAM dÃ¹ng cÆ¡ cháº¿ full table-level locking.</li></ul><p>Lock trong MyISAM Ä‘Æ°á»£c chia lÃ m hai loáº¡i lÃ  READ-LOCK vÃ  WRITE-LOCK Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau:</p><ul><li>READ-LOCK sáº½ Ä‘Æ°á»£c yÃªu cáº§u trÃªn toÃ n bá»™ báº£ng khi cÃ³ má»™t truy váº¥n Ä‘á»c dá»¯ liá»‡u, vÃ­ dá»¥ <code>SELECT</code>.</li><li>Khi má»™t READ-LOCK Ä‘Æ°á»£c yÃªu cáº§u, nÃ³ sáº½ khÃ´ng cho phÃ©p báº¥t cá»© truy váº¥n ghi dá»¯ liá»‡u nÃ o Ä‘Æ°á»£c thá»±c thi (Ä‘á»ƒ Ä‘áº£m báº£o dá»¯ liá»‡u Ä‘á»c lÃªn khÃ´ng cÃ³ sá»± thay Ä‘á»•i), nghÄ©a lÃ  cÃ¡c truy váº¥n UPDATE/DELETE/INSERT sáº½ khÃ´ng Ä‘Æ°á»£c thá»±c thi, cÃ¡c truy váº¥n nÃ y pháº£i chá» cho tá»›i khi táº¥t cáº£ cÃ¡c client Ä‘ang Ä‘á»c dá»¯ liá»‡u hoÃ n thÃ nh vÃ  release lock.</li><li>Khi má»™t báº£ng bá»‹ lock bá»Ÿi má»™t READ-LOCK, cÃ¡c client khÃ¡c váº«n cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u tá»« báº£ng Ä‘Ã³ cÃ¹ng má»™t thá»i Ä‘iá»ƒm -> cÃ³ thá»ƒ cÃ³ nhiá»u READ-LOCK Ä‘á»“ng thá»i trÃªn má»™t báº£ng.</li><li>WRITE-LOCK lÃ  má»™t khÃ³a Ä‘á»™c quyá»n, nÃ³ chá»‰ cÃ³ thá»ƒ Ä‘Æ°á»£c yÃªu cáº§u khi báº£ng Ä‘Ã³ hoÃ n toÃ n khÃ´ng Ä‘Æ°á»£c sá»­ dá»¥ng. Khi Ä‘Æ°á»£c yÃªu cáº§u, chá»‰ cÃ¡c client nÃ o giá»¯ WRITE-LOCK má»›i cÃ³ thá»ƒ Ä‘á»c/ghi dá»¯ liá»‡u trÃªn báº£ng. Táº¥t cáº£ cÃ¡c client khÃ¡c Ä‘á»u khÃ´ng thá»ƒ Ä‘á»c/ghi dá»¯ liá»‡u cÅ©ng nhÆ° khÃ´ng thá»ƒ yÃªu cáº§u báº¥t ká»³ khÃ³a nÃ o khÃ¡c trÃªn báº£ng nÃ y.</li><li>Concurrent INSTER lÃ  má»™t trÆ°á»ng há»£p Ä‘áº·c biá»‡t, náº¿u má»™t báº£ng khÃ´ng cÃ³ <strong>no holes</strong> á»Ÿ giá»¯a (káº¿t quáº£ cá»§a viá»‡c xÃ³a cÃ¡c record dá»¯ liá»‡u), thÃ¬ dá»¯ liá»‡u INSERT sáº½ luÃ´n luÃ´n Ä‘Æ°á»£c Ä‘áº·t á»Ÿ cuá»‘i cá»§a báº£ng. Trong trÆ°á»ng há»£p nÃ y, client Ä‘á»c dá»¯ liá»‡u trÃªn báº£ng nÃ y, Ä‘Ã£ yÃªu cáº§u má»™t READ-LOCK, cho phÃ©p cÃ¡c client khÃ¡c Ä‘Æ°á»£c phÃ©p INSTER dá»¯ liá»‡u vÃ o báº£ng nÃ y. Náº¿u má»™t báº£ng cÃ³ má»™t hole, concurrent INSTER sáº½ khÃ´ng Ä‘Æ°á»£c phÃ©p thá»±c hiá»‡n, tuy nhiÃªn báº¡n cÃ³ thá»ƒ xÃ³a hole báº±ng cÃ¡ch sá»­ dá»¥ng <code>OPTIMIZE TABLE</code> Ä‘á»ƒ chá»‘ng phÃ¢n máº£nh báº£ng (LÆ°u Ã½ lÃ  viá»‡c xÃ³a record á»Ÿ cuá»‘i cÃ¹ng cá»§a báº£ng khÃ´ng táº¡o ra hole).</li><li>Má»™t client chá»‰ Ä‘Æ°á»£c phÃ©p yÃªu cáº§u má»™t WRITE-LOCK khi khÃ´ng cÃ³ báº¥t ká»³ má»™t client nÃ o khÃ¡c Ä‘ang sá»­ dá»¥ng báº£ng Ä‘Ã³. Náº¿u cÃ³ tá»“n táº¡i má»™t client khÃ¡c Ä‘ang sá»­ dá»¥ng báº£ng khi WRITE LOCK Ä‘Æ°á»£c yÃªu cáº§u, nÃ³ sáº½ pháº£i chá» cho tá»›i khi táº¥t cáº£ cÃ¡c client Ä‘Ã³ hoÃ n thÃ nh.</li></ul><p>Theo mÃ´ táº£ cá»§a <a href=https://www.cmi.ac.in/~madhavan/courses/databases10/mysql-5.0-reference-manual/sql-syntax.html#alter-table>MySQL 5.0</a> thÃ¬ lá»‡nh <code>ALTER TABLE ...</code> sáº½ hoáº¡t Ä‘á»™ng nhÆ° sau:</p><ul><li>Táº¡o má»™t báº£ng táº¡m giá»‘ng cáº¥u trÃºc báº£ng gá»‘c.</li><li>Thá»±c hiá»‡n yÃªu cáº§u thay Ä‘á»•i lÃªn báº£ng táº¡m.</li><li>Copy dá»¯ liá»‡u tá»« báº£ng gá»‘c sang báº£ng táº¡m má»›i theo tá»«ng dÃ²ng.</li><li>Khi hoÃ n thÃ nh viá»‡c copy, drop báº£ng cÅ© vÃ  rename báº£ng táº¡m thÃ nh báº£ng gá»‘c.</li></ul><p>Trong quÃ¡ trÃ¬nh <code>ALTER TABLE</code> thá»±c thi, báº£ng gá»‘c sáº½ bá»‹ lock á»Ÿ READ-LOCK, nghÄ©a lÃ  cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u nhÆ°ng khÃ´ng thá»ƒ cáº­p nháº­t dá»¯ liá»‡u. Táº¥t cáº£ cÃ¡c truy váº¥n cáº­p nháº­t dá»¯ liá»‡u sáº½ bá»‹ Ä‘Ã¬nh trá»‡ cho tá»›i khi báº£ng má»›i sáºµn sÃ ng, vÃ  sáº½ Ä‘Æ°á»£c tá»± Ä‘á»™ng chuyá»ƒn hÆ°á»›ng qua báº£ng má»›i mÃ  khÃ´ng cÃ³ báº¥t ká»³ lá»—i nÃ o (timeout).</p><p>Váº¥n Ä‘á» lÃ  náº¿u má»™t báº£ng MyISAM cÃ³ nhiá»u dá»¯ liá»‡u thÃ¬ trong quÃ¡ trÃ¬nh thay Ä‘á»•i cáº¥u trÃºc báº£ng ta sáº½ khÃ´ng thá»ƒ cáº­p nháº­t dá»¯ liá»‡u mÃ  chá»‰ cÃ³ thá»ƒ Ä‘á»c dá»¯ liá»‡u. Náº¿u quÃ¡ trÃ¬nh thay Ä‘á»•i cáº¥u trÃºc báº£ng máº¥t 1 tiáº¿ng, Ä‘á»“ng nghÄ©a á»©ng dá»¥ng khÃ´ng thá»ƒ cáº­p nháº­t dá»¯ liá»‡u trong 1 tiáº¿ng Ä‘á»“ng há»“.</p><h2 id=3-55--mysql-innodb-51>3. 5.5 >= MySQL InnoDB>= 5.1</h2><p>Chia lÃ m 2 loáº¡i:</p><ul><li>Vá»›i index, phá»¥ thuá»™c vÃ o tÃ­nh nÄƒng fast-create-index cá»§a InnoDB.</li><li>Vá»›i thay Ä‘á»•i cáº¥u trÃºc, thÃªm/xÃ³a cá»™t dá»¯ liá»‡u hoáº·c kiá»ƒu dá»¯ liá»‡u -> hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»± MyISAM, chá»‰ khÃ¡c lÃ  do InnoDB dÃ¹ng cÆ¡ cháº¿ row-level locking, nÃªn sáº½ chá»‰ lock trÃªn dÃ²ng dá»¯ liá»‡u copy.</li></ul><p>Äiá»ƒm Ä‘áº·c biá»‡t á»Ÿ phiÃªn báº£n nÃ y lÃ  tÃ­nh nÄƒng <a href=https://dev.mysql.com/doc/refman/5.5/en/innodb-create-index-overview.html>fast create index</a> Ä‘Æ°á»£c cung cáº¥p bá»Ÿi InnoDB storage engine. Tá»« Ä‘Ã¢y trá»Ÿ vá» sau, ta máº·c Ä‘á»‹nh sáº½ chá»‰ nÃ³i vá» InnoDB storage engine. TrÆ°á»›c khi nÃ³i vá» tÃ­nh nÄƒng fast-create-index, ta sáº½ cáº§n hiá»ƒu vá» 2 khÃ¡i niá»‡m lÃ  <strong>clustered index</strong> vÃ  <strong>non-clustered index.</strong> Äiá»u nÃ y <strong>Ä‘áº·c biá»‡t quan trá»ng</strong> vÃ¬ tÃ­nh nÄƒng nÃ y phá»¥ thuá»™c hoÃ n toÃ n vÃ o cÃ¡ch hoáº¡t Ä‘á»™ng cá»§a 2 loáº¡i index nÃ y.</p><p>Khi nÃ³i tá»›i clustered-index lÃ  máº·c nhiÃªn nÃ³i tá»›i InnoDB (vÃ¬ cÃ¡c storage engine khÃ¡c khÃ´ng há»— trá»£). NgoÃ i InnoDB thÃ¬ MSSQL cÅ©ng cÃ³ khÃ¡i niá»‡m clustered-index, cÃ¡ch hoáº¡t Ä‘á»™ng tÆ°Æ¡ng tá»±. MyISAM vÃ  Postgres khÃ´ng cÃ³ khÃ¡i niá»‡m clustered-index.</p><p><strong>Clustered index</strong> vs <strong>non-clustered index:</strong></p><ul><li><p>Ã tÆ°á»Ÿng cá»§a clustered indexes lÃ  lÆ°u trá»¯ <strong>toÃ n bá»™ má»™t báº£ng dá»¯ liá»‡u</strong> vÃ o má»™t cáº¥u trÃºc B-tree, hay nÃ³i cÃ¡ch khÃ¡c má»™t báº£ng cÃ³ clustered indexes thÃ¬ báº£n thÃ¢n báº£ng Ä‘Ã³ chÃ­nh lÃ  má»™t cÃ¢y index Ä‘Æ°á»£c sáº¯p xáº¿p theo <strong>trÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh index</strong>, bÃ¬nh thÆ°á»ng lÃ  PK .</p></li><li><p>CÃ¡c <strong>nodex lÃ¡</strong> cá»§a clustered indexes <strong>chá»©a khÃ³a lÃ  cÃ¡c trÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh index</strong> vÃ  Ä‘á»“ng thá»i chá»©a táº¥t cáº£ cÃ¡c trÆ°á»ng cÃ²n láº¡i cá»§a báº£ng. NÃªn viá»‡c truy suáº¥t dá»¯ liá»‡u thÃ´ng qua clustered index sáº½ ráº¥t nhanh bá»Ÿi vÃ¬ <strong>row data</strong> sáº½ náº±m trÃªn cÃ¹ng má»™t page vá»›i <strong>khÃ³a cá»§a index</strong></p></li><li><p>Clustered index khÃ´ng yÃªu cáº§u pháº£i unique, tuy nhiÃªn náº¿u trÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh clustered index khÃ´ng unique thÃ¬ khÃ³a cÅ©ng Ä‘Æ°á»£c thÃªm vÃ o má»™t giÃ¡ trá»‹ random Ä‘á»ƒ Ä‘áº£m báº£o cÃ¡c node index váº«n unique.</p></li><li><p>TrÃªn MySQL, vá»›i InnoDB storage engine, khÃ³a chÃ­nh sáº½ Ä‘Æ°á»£c máº·c Ä‘á»‹nh sá»­ dá»¥ng lÃ m clustered index. Náº¿u má»™t báº£ng khÃ´ng cÃ³ khÃ³a chÃ­nh thÃ¬ MySQL sáº½ chá»n má»™t index unique vá»›i táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ khÃ¡c NULL lÃ m clustered index. Náº¿u khÃ´ng cÃ³ cáº£ khÃ³a chÃ­nh vÃ  unique index, MySQL sáº½ tá»± sinh ra má»™t clustered index áº©n tÃªn lÃ  <code>GEN_CLUST_INDEX</code>.</p></li><li><p>Khi má»™t báº£ng Ä‘Ã£ cÃ³ clustered index thÃ¬ táº¥t cáº£ cÃ¡c index khÃ¡c sáº½ Ä‘Æ°á»£c gá»i lÃ  non-clustered index hoáº·c secondary-index. Non-clustered index sáº½ cÃ³ má»™t cáº¥u trÃºc tÃ¡ch biá»‡t vá»›i dá»¯ liá»‡u cá»§a báº£ng (cÃ³ thá»ƒ xem nhÆ° má»™t báº£ng riÃªng).</p></li><li><p>Äiá»ƒm khÃ¡c biá»‡t giá»¯a clustered-index vÃ  non-clustered-index lÃ  node lÃ¡ cá»§a non-clustered-index khÃ´ng chá»©a dá»¯ liá»‡u, hay nÃ³i cÃ¡ch khÃ¡c lÃ  táº¥t cáº£ cÃ¡c node cá»§a non-clustered-index sáº½ chá»©a khÃ³a lÃ  trÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh index vÃ  má»™t con trá», trá» tá»›i vÃ¹ng dá»¯ liá»‡u chá»©a giÃ¡ trá»‹ khÃ³a, trong trÆ°á»ng há»£p nÃ y lÃ  trá» ngÆ°á»£c sang clustered-index. VÃ­ dá»¥ náº¿u PK lÃ  trÆ°á»ng <code>id</code> thÃ¬ clustered-index chÃ­nh lÃ  <code>id</code>, náº¿u ta Ä‘Ã¡nh index trÃªn má»™t trÆ°á»ng khÃ¡c vÃ­ dá»¥ lÃ  <code>name</code> thÃ¬ index nÃ y sáº½ lÃ  non-clustered-index, á»Ÿ dáº¡ng <code>id, name</code></p></li><li><p>Äiá»u nÃ y dáº«n tá»›i sá»± khÃ¡c biá»‡t khi truy váº¥n dá»¯ liá»‡u vá»›i Ä‘iá»u kiá»‡n lÃ  clustered-index hay non-clustered-index:</p><ul><li>Vá»›i clustered-index, khi tÃ¬m Ä‘áº¿n node lÃ¡, báº£n thÃ¢n node lÃ¡ Ä‘Ã£ chá»©a sáºµn dá»¯ liá»‡u cáº§n truy váº¥n nÃªn tá»›i Ä‘Ã¢y coi nhÆ° káº¿t thÃºc truy váº¥n.</li><li>Vá»›i non-clustered-index, khi tÃ¬m Ä‘áº¿n node lÃ¡ phÃ¹ há»£p vá»›i Ä‘iá»u kiá»‡n tÃ¬m kiáº¿m, node lÃ¡ sáº½ chá»‰ chá»©a má»™t con trá», trá» tá»›i clustered-index. NÃªn sáº½ cáº§n look-up thÃªm má»™t láº§n ná»¯a sang clustered-index Ä‘á»ƒ láº¥y cÃ¡c trÆ°á»ng dá»¯ liá»‡u cáº§n tÃ¬m.</li></ul><p><em>Minh há»a clustered-index vÃ  non-clustered-index (nguá»“n: <a href=https://use-the-index-luke.com>https://use-the-index-luke.com</a>)</em></p></li></ul><p><img src=https://use-the-index-luke.com/static/fig05_03_secondary_index_on_clustered_index.x1.Q21aCRSZ.png alt=clustered-index></p><p>TÃ­nh nÄƒng <strong>fast-create-index</strong> thá»±c cháº¥t chá»‰ Ã¡p dá»¥ng cho <strong>secondary-index</strong>, vÃ¬ thá»±c cháº¥t secondary-index tÃ¡ch biá»‡t vá»›i báº£ng dá»¯ liá»‡u, dáº«n Ä‘áº¿n náº¿u táº¡o secondary-index sáº½ khÃ´ng cáº§n pháº£i copy láº¡i toÃ n bá»™ báº£ng dá»¯ liá»‡u (nhÆ° cÃ¡ch mÃ  MyISAM hoáº¡t Ä‘á»™ng). RiÃªng clustered-index, do báº£n cháº¥t lÃ  toÃ n bá»™ báº£ng dá»¯ liá»‡u nÃªn thay Ä‘á»•i trÃªn clustered-index hoáº¡t Ä‘á»™ng giá»‘ng cÃ¡ch mÃ  MyISAM hoáº¡t Ä‘á»™ng, tá»©c lÃ  pháº£i copy láº¡i toÃ n bá»™ báº£ng.</p><p>CÆ¡ cháº¿ cá»§a <strong>fast-create-index</strong> hoáº¡t Ä‘á»™ng nhÆ° sau:</p><ul><li>ThÃªm má»›i secondary-index vÃ o má»™t báº£ng Ä‘Ã£ tá»“n táº¡i, InnoDB sáº½ scan toÃ n báº£ng nÃ y, sáº¯p xáº¿p cÃ¡c row dá»¯ liá»‡u báº±ng cÃ¡ch sá»­ dá»¥ng memory buffer vÃ  temporary file theo thá»© tá»± cá»§a trÆ°á»ng Ä‘Æ°á»£c Ä‘Ã¡nh index (<a href=https://mariadb.com/kb/en/innodb-system-variables/#innodb_sort_buffer_size>innodb_sort_buffer_size</a>). Sau Ä‘Ã³ cÃ¢y index cá»§a secondary-index sáº½ Ä‘Æ°á»£c táº¡o dá»±a trÃªn key-value Ä‘Ã£ Ä‘Æ°á»£c sáº¯p xáº¿p, Ä‘iá»u nÃ y khiáº¿n viá»‡c táº¡o cÃ¢y index sáº½ hiá»‡u quáº£ hÆ¡n chÃ¨n tá»«ng dÃ²ng cá»§a báº£ng vÃ o cÃ¢y index (vÃ¬ chÃ¨n tá»«ng dÃ²ng lÃ  random access). NÃªn ta sáº½ tháº¥y viá»‡c add secondary-index vÃ o má»™t báº£ng sáº½ máº¥t má»™t chÃºt thá»i gian tÃ¹y thuá»™c vÃ o sá»‘ lÆ°á»£ng dá»¯ liá»‡u (quÃ¡ trÃ¬nh scan vÃ  sort).</li><li>XÃ³a secondary-index thÃ¬ Ä‘Æ¡n giáº£n hÆ¡n, chá»‰ cÃ¡c internal InnoDB system table vÃ  MySQL data table Ä‘Æ°á»£c cáº­p nháº­t láº¡i lÃ  index nÃ y khÃ´ing cÃ²n tá»“n táº¡i, InnoDB sau Ä‘Ã³ sáº½ tráº£ láº¡i vÃ¹ng nhá»› sá»­ dá»¥ng index cho tablespace chá»©a index Ä‘Ã³ Ä‘á»ƒ cÃ¡c indexes má»›i hoáº·c cÃ¡c dá»¯ liá»‡u má»›i cÃ³ thá»ƒ tÃ¡i sá»­ dá»¥ng vÃ¹ng nhá»› nÃ y. NÃªn ta sáº½ tháº¥y viá»‡c xÃ³a index tráº£ vá» káº¿t quáº£ tá»©c thÃ¬.</li></ul><p>Khi má»™t InnoDB secondary index Ä‘Æ°á»£c táº¡o hoáº·c xÃ³a, báº£ng sáº½ bá»‹ lock á»Ÿ <strong>shared mode</strong>. Báº¥t ká»³ truy váº¥n ghi dá»¯ liá»‡u nÃ o lÃªn báº£ng nÃ y sáº½ bá»‹ block, nhÆ°ng dá»¯ liá»‡u cá»§a báº£ng váº«n cÃ³ thá»ƒ Ä‘Æ°á»£c Ä‘á»c. Nghe cÃ³ váº» giá»‘ng cÃ¡ch MyISAM hoáº¡t Ä‘á»™ng, nhÆ°ng thá»±c cháº¥t sáº½ chá»‰ thao tÃ¡c trÃªn trÆ°á»ng cáº§n táº¡o index mÃ  khÃ´ng pháº£i copy toÃ n bá»™ báº£ng nÃªn quÃ¡ trÃ¬nh nÃ y váº«n nhanh hÆ¡n.</p><p>Khi thay Ä‘á»•i clustered-index cá»§a báº£ng, báº£ng sáº½ bá»‹ lock á»Ÿ exclusive mode bá»Ÿi vÃ¬ dá»¯ liá»‡u sáº½ cáº§n pháº£i copy nÃªn táº¥t cáº£ cÃ¡c operation trÃªn báº£ng nÃ y sáº½ bá»‹ block háº¿t. <code>CREATE INDEX</code> vÃ  <code>ALTER TABLE</code> cho InnoDB sáº½ luÃ´n luÃ´n chá» cho cÃ¡c transaction Ä‘ang thá»±c thi Ä‘Æ°á»£c commit hoáº·c rollback má»›i Ä‘Æ°á»£c thá»±c thi. RiÃªng vá»›i clustered-index thÃ¬ pháº£i chá» táº¥t cáº£ cÃ¡c truy váº¥n SELECT hoÃ n thÃ nh má»›i Ä‘Æ°á»£c thá»±c thi.</p><p>Má»™t lÆ°u Ã½ quan trá»ng ná»¯a lÃ  InnoDB secondary index sáº½ chá»‰ chá»©a cÃ¡c dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c commited Táº I THá»œI ÄIá»‚M <code>CREATE INDEX</code> hoáº·c <code>ALTER TALBE</code> báº¯t Ä‘áº§u thá»±c thi, khÃ´ng bao gá»“m dá»¯ liá»‡u uncommitted (trong má»™t transaction Ä‘Æ°á»£c khá»Ÿi táº¡o trÆ°á»›c khi <code>ALTER TABLE</code> nhÆ°ng chÆ°a commited), nhá»¯ng dá»¯ liá»‡u bá»‹ mark deleted hoáº·c old version cá»§a dá»¯ liá»‡u (do cÆ¡ cháº¿ MVCC cá»§a InnoDB).</p><p>Test vá»›i MySQL 5.5 nhÆ° sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>users<span style=color:#f92672>`</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#f92672>`</span>users<span style=color:#f92672>`</span> (
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>id<span style=color:#f92672>`</span> int(<span style=color:#ae81ff>10</span>) unsigned <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span> AUTO_INCREMENT,
</span></span><span style=display:flex><span>  <span style=color:#f92672>`</span>name<span style=color:#f92672>`</span> varchar(<span style=color:#ae81ff>255</span>) <span style=color:#66d9ef>COLLATE</span> utf8mb4_unicode_ci <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (<span style=color:#f92672>`</span>id<span style=color:#f92672>`</span>)
</span></span><span style=display:flex><span>) ENGINE<span style=color:#f92672>=</span>InnoDB AUTO_INCREMENT<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#66d9ef>DEFAULT</span> CHARSET<span style=color:#f92672>=</span>utf8mb4 <span style=color:#66d9ef>COLLATE</span><span style=color:#f92672>=</span>utf8mb4_unicode_ci;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELIMITER</span> <span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>PROCEDURE</span> generate_data(<span style=color:#66d9ef>IN</span> no_rows INT)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>BEGIN</span>
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>DECLARE</span> i INT;
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>SET</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>START</span> <span style=color:#66d9ef>TRANSACTION</span>;
</span></span><span style=display:flex><span>                WHILE i <span style=color:#f92672>&lt;=</span> no_rows <span style=color:#66d9ef>DO</span>
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>users<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#34;Jamal&#34;</span>),(<span style=color:#e6db74>&#34;Thaddeus&#34;</span>),(<span style=color:#e6db74>&#34;Hasad&#34;</span>),(<span style=color:#e6db74>&#34;August&#34;</span>),(<span style=color:#e6db74>&#34;Macaulay&#34;</span>),(<span style=color:#e6db74>&#34;Rudyard&#34;</span>),(<span style=color:#e6db74>&#34;Amal&#34;</span>),(<span style=color:#e6db74>&#34;Harding&#34;</span>),(<span style=color:#e6db74>&#34;Todd&#34;</span>),(<span style=color:#e6db74>&#34;Julian&#34;</span>),(<span style=color:#e6db74>&#34;Vaughan&#34;</span>),(<span style=color:#e6db74>&#34;August&#34;</span>),(<span style=color:#e6db74>&#34;Martin&#34;</span>),(<span style=color:#e6db74>&#34;Clark&#34;</span>),(<span style=color:#e6db74>&#34;Bevis&#34;</span>),(<span style=color:#e6db74>&#34;Branden&#34;</span>),(<span style=color:#e6db74>&#34;Maxwell&#34;</span>),(<span style=color:#e6db74>&#34;Brian&#34;</span>),(<span style=color:#e6db74>&#34;Kelly&#34;</span>),(<span style=color:#e6db74>&#34;Basil&#34;</span>),(<span style=color:#e6db74>&#34;Cyrus&#34;</span>),(<span style=color:#e6db74>&#34;Isaac&#34;</span>),(<span style=color:#e6db74>&#34;Joshua&#34;</span>),(<span style=color:#e6db74>&#34;Cadman&#34;</span>),(<span style=color:#e6db74>&#34;Rigel&#34;</span>),(<span style=color:#e6db74>&#34;Alec&#34;</span>),(<span style=color:#e6db74>&#34;Aquila&#34;</span>),(<span style=color:#e6db74>&#34;Wing&#34;</span>),(<span style=color:#e6db74>&#34;Alden&#34;</span>),(<span style=color:#e6db74>&#34;Ulric&#34;</span>),(<span style=color:#e6db74>&#34;Theodore&#34;</span>),(<span style=color:#e6db74>&#34;Barrett&#34;</span>),(<span style=color:#e6db74>&#34;Jamal&#34;</span>),(<span style=color:#e6db74>&#34;Cooper&#34;</span>),(<span style=color:#e6db74>&#34;Matthew&#34;</span>),(<span style=color:#e6db74>&#34;Malik&#34;</span>),(<span style=color:#e6db74>&#34;Lane&#34;</span>),(<span style=color:#e6db74>&#34;Eagan&#34;</span>),(<span style=color:#e6db74>&#34;Dylan&#34;</span>),(<span style=color:#e6db74>&#34;Colt&#34;</span>),(<span style=color:#e6db74>&#34;Kevin&#34;</span>),(<span style=color:#e6db74>&#34;Gannon&#34;</span>),(<span style=color:#e6db74>&#34;Maxwell&#34;</span>),(<span style=color:#e6db74>&#34;Drew&#34;</span>),(<span style=color:#e6db74>&#34;Coby&#34;</span>),(<span style=color:#e6db74>&#34;Burke&#34;</span>),(<span style=color:#e6db74>&#34;Ishmael&#34;</span>),(<span style=color:#e6db74>&#34;Kasimir&#34;</span>),(<span style=color:#e6db74>&#34;Byron&#34;</span>),(<span style=color:#e6db74>&#34;Moses&#34;</span>),(<span style=color:#e6db74>&#34;Kaseem&#34;</span>),(<span style=color:#e6db74>&#34;Aladdin&#34;</span>),(<span style=color:#e6db74>&#34;Brenden&#34;</span>),(<span style=color:#e6db74>&#34;Geoffrey&#34;</span>),(<span style=color:#e6db74>&#34;Grant&#34;</span>),(<span style=color:#e6db74>&#34;Nathaniel&#34;</span>),(<span style=color:#e6db74>&#34;Dominic&#34;</span>),(<span style=color:#e6db74>&#34;Merrill&#34;</span>),(<span style=color:#e6db74>&#34;Garrison&#34;</span>),(<span style=color:#e6db74>&#34;Marsden&#34;</span>),(<span style=color:#e6db74>&#34;Raymond&#34;</span>),(<span style=color:#e6db74>&#34;Baxter&#34;</span>),(<span style=color:#e6db74>&#34;Tate&#34;</span>),(<span style=color:#e6db74>&#34;Kibo&#34;</span>),(<span style=color:#e6db74>&#34;Hall&#34;</span>),(<span style=color:#e6db74>&#34;Cullen&#34;</span>),(<span style=color:#e6db74>&#34;Nehru&#34;</span>),(<span style=color:#e6db74>&#34;Wesley&#34;</span>),(<span style=color:#e6db74>&#34;Silas&#34;</span>),(<span style=color:#e6db74>&#34;Fitzgerald&#34;</span>),(<span style=color:#e6db74>&#34;Zeph&#34;</span>),(<span style=color:#e6db74>&#34;Salvador&#34;</span>),(<span style=color:#e6db74>&#34;Lyle&#34;</span>),(<span style=color:#e6db74>&#34;Jakeem&#34;</span>),(<span style=color:#e6db74>&#34;Lyle&#34;</span>),(<span style=color:#e6db74>&#34;Tarik&#34;</span>),(<span style=color:#e6db74>&#34;Nehru&#34;</span>),(<span style=color:#e6db74>&#34;Nero&#34;</span>),(<span style=color:#e6db74>&#34;Stewart&#34;</span>),(<span style=color:#e6db74>&#34;Jameson&#34;</span>),(<span style=color:#e6db74>&#34;Nicholas&#34;</span>),(<span style=color:#e6db74>&#34;Jamal&#34;</span>),(<span style=color:#e6db74>&#34;Hu&#34;</span>),(<span style=color:#e6db74>&#34;Erasmus&#34;</span>),(<span style=color:#e6db74>&#34;Chaney&#34;</span>),(<span style=color:#e6db74>&#34;Nash&#34;</span>),(<span style=color:#e6db74>&#34;Emery&#34;</span>),(<span style=color:#e6db74>&#34;Colby&#34;</span>),(<span style=color:#e6db74>&#34;Brett&#34;</span>),(<span style=color:#e6db74>&#34;Benjamin&#34;</span>),(<span style=color:#e6db74>&#34;Philip&#34;</span>),(<span style=color:#e6db74>&#34;Chaim&#34;</span>),(<span style=color:#e6db74>&#34;Jakeem&#34;</span>),(<span style=color:#e6db74>&#34;Hyatt&#34;</span>),(<span style=color:#e6db74>&#34;Avram&#34;</span>),(<span style=color:#e6db74>&#34;Theodore&#34;</span>),(<span style=color:#e6db74>&#34;Palmer&#34;</span>),(<span style=color:#e6db74>&#34;Brandon&#34;</span>),(<span style=color:#e6db74>&#34;Thane&#34;</span>),(<span style=color:#e6db74>&#34;Adrian&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#66d9ef>SET</span> i <span style=color:#f92672>=</span> i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>END</span> WHILE;
</span></span><span style=display:flex><span>             <span style=color:#66d9ef>COMMIT</span>;
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>END</span><span style=color:#960050;background-color:#1e0010>$$</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>DELIMITER</span> ;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>CALL</span> generate_data(<span style=color:#ae81ff>100000</span>);
</span></span></code></pre></div><p>TrÃªn má»™t session, add thÃªm má»™t secondary-index vÃ o báº£ng users nhÆ° sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> users <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>INDEX</span> <span style=color:#a6e22e>idx_users_name</span>(name); <span style=color:#75715e># assume lÃ  sáº½ máº¥t nhiá»u thá»i gian Ä‘á»ƒ thá»±c hiá»‡n
</span></span></span></code></pre></div><p>TrÃªn má»™t session khÃ¡c, truy váº¥n dá»¯ liá»‡u hoáº·c chÃ¨n thÃªm dá»¯ liá»‡u, expect lÃ  session nÃ y sáº½ bá»‹ block cho tá»›i khi viá»‡c thay Ä‘á»•i schema hoÃ n thÃ nh:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> <span style=color:#f92672>`</span>users<span style=color:#f92672>`</span> (<span style=color:#f92672>`</span>name<span style=color:#f92672>`</span>) <span style=color:#66d9ef>VALUES</span> (<span style=color:#e6db74>&#34;Quang&#34;</span>); <span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>1</span>;
</span></span></code></pre></div><p>Káº¿t quáº£:</p><pre tabindex=0><code>&gt; DESC users;
+-------+------------------+------+-----+---------+----------------+
| Field | Type             | Null | Key | Default | Extra          |
+-------+------------------+------+-----+---------+----------------+
| id    | int(10) unsigned | NO   | PRI | NULL    | auto_increment |
| name  | varchar(255)     | NO   |     | NULL    |                |
+-------+------------------+------+-----+---------+----------------+
&gt; SELECT COUNT(*) FROM users;
+----------+
| COUNT(*) |
+----------+
|  3000104 |
+----------+
1 row in set (0.42 sec)

mysql&gt; ALTER TABLE users DROP INDEX idx_users_name;
Query OK, 0 rows affected (0.08 sec)
Records: 0  Duplicates: 0  Warnings: 0

mysql&gt; ALTER TABLE users ADD INDEX idx_users_name(name);
Query OK, 0 rows affected, 2 warnings (14.19 sec)
Records: 0  Duplicates: 0  Warnings: 2
</code></pre><p>Tiáº¿p theo ta sáº½ thá»­ UPDATE PK Ä‘á»ƒ xem káº¿t quáº£ vá» thá»i gian sáº½ khÃ¡c biá»‡t nhÆ° tháº¿ nÃ o.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> users <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>COLUMN</span> phone_no <span style=color:#66d9ef>VARCHAR</span>(<span style=color:#ae81ff>20</span>);
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>3000104</span> rows <span style=color:#a6e22e>affected</span> (<span style=color:#ae81ff>10</span>.<span style=color:#ae81ff>18</span> sec)
</span></span><span style=display:flex><span>Records: <span style=color:#ae81ff>3000104</span>  Duplicates: <span style=color:#ae81ff>0</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>UPDATE</span> users <span style=color:#66d9ef>SET</span> phone_no <span style=color:#f92672>=</span> <span style=color:#a6e22e>FLOOR</span>(<span style=color:#a6e22e>rand</span>()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000000</span>);
</span></span><span style=display:flex><span>Query OK, <span style=color:#ae81ff>3000104</span> rows <span style=color:#a6e22e>affected</span> (<span style=color:#ae81ff>46</span>.<span style=color:#ae81ff>12</span> sec)
</span></span><span style=display:flex><span>Rows matched: <span style=color:#ae81ff>3000104</span>  Changed: <span style=color:#ae81ff>3000104</span>  Warnings: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Remove duplicate phone_no
</span></span></span><span style=display:flex><span><span style=color:#75715e>#
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span>(phone_no), <span style=color:#a6e22e>COUNT</span>(phone_no) <span style=color:#66d9ef>AS</span> c <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> phone_no <span style=color:#66d9ef>HAVING</span> c <span style=color:#f92672>&gt;=</span><span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>DELETE</span> t1 <span style=color:#66d9ef>FROM</span> users <span style=color:#66d9ef>AS</span> t1 <span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> users <span style=color:#66d9ef>AS</span> t2 <span style=color:#66d9ef>WHERE</span> t1.id <span style=color:#f92672>&lt;</span> t2.id <span style=color:#66d9ef>AND</span> t1.phone_no <span style=color:#f92672>=</span> t2.phone_no;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mysql<span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> users MODIFY id <span style=color:#66d9ef>int</span>(<span style=color:#ae81ff>10</span>) <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>, <span style=color:#66d9ef>DROP</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>, <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span> (phone_no);
</span></span></code></pre></div><p>Máº·c dÃ¹ viá»‡c táº¡o secondary-index Ä‘Ã£ nhanh hÆ¡n, nhÆ°ng nÃ³ váº«n phá»¥ thuá»™c vÃ o kÃ­ch thÆ°á»›c cá»§a báº£ng dá»¯ liá»‡u vÃ  vá»›i cÃ¡c trÆ°á»ng há»£p ngoÃ i index, váº¥n khÃ´ng cÃ³ giáº£i phÃ¡p trÃ¡nh downtime. <strong>ÄÃ¢y lÃ  lÃ½ do mÃ  cÃ¡c giáº£i phÃ¡p thá»© 3 ra Ä‘á»i tá»« percona, github hoáº·c facebook</strong>.</p><h2 id=4-3rd-solution>4. 3rd solution</h2><h3 id=41-pt-online-schema-change>4.1 pt-online-schema-change</h3><p>Percona phÃ¡t triá»ƒn má»™t á»©ng dá»¥ng, cho phÃ©p thay Ä‘á»•i schema trá»Ÿ lÃªn bá»›t painful hÆ¡n Ã¡p dá»¥ng cho MySQL 5.5 trá»Ÿ xuá»‘ng lÃ  <code>pt-online-schema-change</code>. Báº£n cháº¥t cÃ´ng cá»¥ nÃ y hoáº¡t Ä‘á»™ng nhÆ° sau:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; grep <span style=color:#e6db74>&#39;Step&#39;</span> /usr/bin/pt-online-schema-change
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 1: Create the new table.</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 2: Alter the new, empty table.  This should be very quick,</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 3: Create the triggers to capture changes on the original table and</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 4: Copy rows.</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 5: Rename tables: orig -&gt; old, new -&gt; orig</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 6: Update foreign key constraints if there are child tables.</span>
</span></span><span style=display:flex><span>   <span style=color:#75715e># Step 7: Drop the old table.</span>
</span></span></code></pre></div><ul><li>Táº¡o báº£ng má»›i vá»›i cáº¥u trÃºc tÆ°Æ¡ng tá»± báº£ng cÅ© <code>_new_table_name</code>.</li><li><code>ALTER TABLE</code> báº£ng má»›i Ä‘Æ°á»£c táº¡o ra nhÆ° yÃªu cáº§u -> do báº£ng má»›i rá»—ng nÃªn viá»‡c nÃ y sáº½ ráº¥t nhanh.</li><li>Táº¡o 3 trigger trÃªn báº£ng cÅ© dáº¡ng <code>AFTER DELETE ON</code>, <code>AFTER UPDATE ON</code>, <code>AFTER INSERT ON</code> Ä‘á»ƒ trigger khi cÃ³ dá»¯ liá»‡u má»›i trÃªn báº£ng cÅ© thÃ¬ cáº­p nháº­t vÃ o báº£ng má»›i. -> <strong>metadata lock</strong>.</li><li>Copy dá»¯ liá»‡u tá»« báº£ng cÅ© qua báº£ng má»›i theo chunk.</li><li>Sau khi copy xong, swap báº£ng gá»‘c thÃ nh báº£ng cÅ© vÃ  báº£ng má»›i thÃ nh báº£ng gá»‘c, xÃ³a cÃ¡c trigger -> <strong>metadata lock</strong></li><li>Cáº­p nháº­t rÃ ng buá»™c khÃ³a ngoáº¡i (FK) náº¿u cÃ³ trÃªn cÃ¡c báº£ng con.</li><li>Drop báº£ng cÅ©.</li></ul><p>NhÆ° ta tháº¥y á»Ÿ trÃªn thÃ¬ bÆ°á»›c 3 vÃ  5 lÃ  2 bÆ°á»›c quan trá»ng vÃ¬ cÃ³ <strong>metadata lock</strong>, cÃ³ nghÄ©a lÃ  báº£n cháº¥t cÃ¡c truy váº¥n xáº£y ra trong thá»i gian thá»±c hiá»‡n hai bÆ°á»›c nÃ y váº«n sáº½ pháº£i <strong>chá»</strong>. <strong>Metadata lock</strong> Ä‘Æ°á»£c giá»›i thiá»‡u á»Ÿ phiÃªn báº£n MySQL 5.5.3, khi má»™t transaction Ä‘Æ°á»£c cháº¡y, nÃ³ sáº½ acquire má»™t metadata lock trÃªn táº¥t cáº£ cÃ¡c table nÃ³ sá»­ dá»¥ng vÃ  sau Ä‘Ã³ release khi transaction Ä‘Ã³ hoÃ n thÃ nh. Äiá»u nÃ y Ä‘áº£m báº£o sáº½ khÃ´ng cÃ³ báº¥t cá»© má»™t sá»± thay Ä‘á»•i cáº¥u trÃºc báº£ng nÃ o khÃ¡c trong quÃ¡ trÃ¬nh transaction Ä‘Ã³ thá»±c hiá»‡n.</p><p>Váº­y ngoáº¡i trá»« 2 bÆ°á»›c cÃ³ <strong>metadata lock</strong> thÃ¬ cÃ¡c operation khÃ¡c cÃ³ lÃ m tÄƒng thá»i gian xá»­ lÃ½ cá»§a database hay khÃ´ng? <strong>vá» lÃ½ thuyáº¿t lÃ  KHÃ”NG áº£nh hÆ°á»Ÿng vá»›i cÃ¡c read operation</strong>, nhÆ°ng cÃ¡c write operation sáº½ bá»‹ <strong>double thá»i gian thá»±c thi</strong>, do cáº§n <strong>trigger</strong> data qua báº£ng má»›i Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh Ä‘Ãºng Ä‘áº¯n cá»§a dá»¯ liá»‡u.</p><p>NgoÃ i ra cÃ³ 4 Ä‘iá»ƒm Ä‘áº·c biá»‡t cáº§n lÆ°u Ã½:</p><ul><li>Thay Ä‘á»•i schema báº±ng <code>pt-osc</code> cÃ³ thá»ƒ lÃ m tÄƒng lag cá»§a slave, <code>pt-osc</code> cÃ³ há»— trá»£ check-slave-lag vÃ  sáº½ táº¡m dá»«ng quÃ¡ trÃ¬nh copy dá»¯ liá»‡u náº¿u giÃ¡ trá»‹ max_lag vÆ°á»£t qua ngÆ°á»¡ng cáº¥u hÃ¬nh.</li><li><code>pt-osc</code> yÃªu cáº§u táº¡o trigger trÃªn báº£ng cáº§n thay Ä‘á»•i schema nÃªn cÃ¡c báº£ng Ä‘Ã£ tá»“n táº¡i trigger sáº½ khÃ´ng hoáº¡t Ä‘á»™ng.</li><li><code>pt-osc</code> cÃ³ má»™t vÃ i cÃ¡ch handle vá»›i cÃ¡c báº£ng cÃ³ khÃ³a ngoáº¡i, nhÆ°ng rÃ ng buá»™c dá»¯ liá»‡u giá»¯a hai báº£ng sáº½ ráº¥t phá»©c táº¡p khi thay Ä‘á»•i schema, tá»‘t nháº¥t nÃªn trÃ¡nh.</li><li>LuÃ´n cháº¡y trong <code>tmux</code> hoáº·c <code>screen</code> Ä‘á»ƒ trÃ¡nh rá»›t káº¿t ná»‘i</li></ul><h3 id=42-osc>4.2 OSC</h3><p>(WIP)</p><h3 id=43-g-host>4.3 g-host</h3><p>(WIP)</p><h2 id=5-mysql--56>5. MySQL >= 5.6</h2><p>Ká»ƒ tá»« MySQL 5.6, <a href=https://mariadb.com/kb/en/alter-table/#online-ddl>online DDL</a> Ä‘Ã£ Ä‘Æ°á»£c há»— trá»£ bá»Ÿi cÃº phÃ¡p <code>ALGORITHM </code>(Ä‘iá»u khiá»ƒn cÃ¡ch DDL operation Ä‘Æ°á»£c thá»±c hiá»‡n) vÃ  <code>LOCK</code> (Ä‘iá»u khiá»ƒn lock Ä‘Æ°á»£c yÃªu cáº§u khi má»™t DDL operation Ä‘Æ°á»£c thá»±c hiá»‡n). á» Ä‘Ã¢y sáº½ chá»‰ nÃ³i trÆ°á»ng há»£p cho InnoDB, vÃ¬ Ä‘Ã¢y lÃ  storage enginee phá»• biáº¿n nháº¥t hiá»‡n nay.</p><p>VÃ­ dá»¥ vá» online DDL:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> users <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>index</span> <span style=color:#a6e22e>idx_user_user_status</span> (user_status), ALGORITHM<span style=color:#f92672>=</span><span style=color:#66d9ef>IN</span><span style=color:#f92672>-</span>PLACE, <span style=color:#66d9ef>LOCK</span><span style=color:#f92672>=</span>NONE;
</span></span></code></pre></div><p>Online DDL nhÆ°ng váº«n cáº§n copy vÃ  lock cÃ¡c truy váº¥n ghi dá»¯ liá»‡u.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-mysql data-lang=mysql><span style=display:flex><span><span style=color:#66d9ef>ALTER</span> <span style=color:#66d9ef>TABLE</span> users <span style=color:#66d9ef>ADD</span> <span style=color:#66d9ef>index</span> <span style=color:#a6e22e>idx_user_user_status</span> (user_status), ALGORITHM<span style=color:#f92672>=</span>COPY, <span style=color:#66d9ef>LOCK</span><span style=color:#f92672>=</span>SHARED;
</span></span></code></pre></div><p>Cá»¥ thá»ƒ vá» online DDL Ä‘Æ°á»£c mÃ´ táº£ ká»¹ tá»«ng trÆ°á»ng há»£p trÃªn tÃ i liá»‡u cá»§a MariaDB táº¡i <a href=https://mariadb.com/kb/en/alter-table/#online-ddl>link</a> hoáº·c <a href=https://mariadb.com/kb/en/innodb-online-ddl-operations-with-the-inplace-alter-algorithm/>in-place</a>, tuy nhiÃªn cÃ³ thá»ƒ tÃ³m gá»n nhÆ° sau:</p><p><strong>ALGORITHM:</strong></p><ul><li>INPLACE: thay Ä‘á»•i sáº½ Ä‘Æ°á»£c thá»±c hiá»‡n táº¡i chá»— mÃ  khÃ´ng cáº§n rebuild láº¡i toÃ n bá»™ báº£ng, ko cáº§n copy dá»¯ liá»‡u ra báº£ng táº¡m.</li><li>COPY: copy dá»¯ liá»‡u ra báº£ng táº¡m, rebuild láº¡i table, tÃ¡i cáº¥u trÃºc láº¡i secondary-index.</li></ul><p><strong>LOCK:</strong></p><ul><li>NONE: CÃ¡c truy váº¥n Ä‘á»c/ghi Ä‘Æ°á»£c cho phÃ©p trong quÃ¡ trÃ¬nh thay Ä‘á»•i schema cá»§a báº£ng.</li><li>SHARED: Chá»‰ cho phÃ©p cÃ¡c truy váº¥n Ä‘á»c dá»¯ liá»‡u Ä‘Æ°á»£c thá»±c thi khi thay Ä‘á»•i schema cá»§a báº£ng (DML khÃ´ng Ä‘Æ°á»£c phÃ©p thá»±c thi).</li><li>EXCLUSIVE: ToÃ n bá»™ báº£ng sáº½ bá»‹ lock cho cáº£ Ä‘á»c vÃ  ghi ()The entire table will be locked for both reading and writing (SELECT vÃ  DML Ä‘á»u khÃ´ng Ä‘Æ°á»£c phÃ©p thá»±c thi).</li></ul><p>KhÃ´ng pháº£i táº¥t cáº£ cÃ¡c yÃªu cáº§u thay Ä‘á»•i schema sá»­ dá»¥ng online DDL Ä‘á»u lÃ  Online (khÃ´ng yÃªu cáº§u copy hoáº·c rebuild láº¡i báº£ng). Má»™t sá»‘ trÆ°á»ng há»£p ngoáº¡i lá»‡ dÃ¹ dÃ¹ng <code>ALGORITHM=IN-PLACE, LOCK=NONE</code> váº«n yÃªu cáº§u copy báº£ng nhÆ°:</p><ul><li>Thay Ä‘á»•i kiá»ƒu dá»¯ liá»‡u cá»§a cá»™t (tá»« 5.7 thÃ¬ tÄƒng kÃ­ch thÆ°á»›c cá»§a VARCHAR lÃ  in-place).</li><li>Thay Ä‘á»•i charset.</li><li>Thay Ä‘á»•i trÃªn PK.</li></ul><p>Vá»›i replica, Online DDL váº«n cÃ³ side-effect:</p><ul><li>Operations sáº½ cáº§n hoÃ n thÃ nh trÃªn master, sau Ä‘Ã³ má»›i Ä‘Æ°á»£c sync qua slave.</li><li>SQL thread sáº½ bá»‹ block trong khi slave thá»±c thi DDL operation tá»« master replica qua.</li><li>Khi thá»±c thi xong DDL operation tá»« master, lag sáº½ tÄƒng Ä‘á»™t biáº¿n.</li></ul><h2 id=6->6. ?!!?</h2><p>QuÃ¡ dÃ i Ä‘á»ƒ tiáº¿p tá»¥c, nhÆ°ng thá»±c sá»± nÃªn dÃ¹ng cÃ¡ch nÃ o lÃ  má»™t cÃ¢u há»i dÃ iiiiiiiiiiiiiiii vÃ  khÃ³. CÃ¢u tráº£ lÃ  tÃ¹y vÃ  phá»¥ thuá»™c vÃ o ráº¥t nhiá»u yáº¿u tá»‘ khÃ¡c nhau nhÆ° thay Ä‘á»•i cÃ¡i gÃ¬? cÃ³ xÃ i MySQL service cá»§a AWS/GCP hay khÃ´ng, cÃ³ Fulltext index hay khÃ´ng &mldr;. Xin phÃ©p Ä‘Æ°á»£c cáº­p nháº­t sau, nhÆ°ng náº¿u báº¡n ráº£nh, cÃ³ thá»ƒ Ä‘á»c thÃªm nhÆ° cÃ¡c link phÃ­a dÆ°á»›i.</p><blockquote><p>Má»™t phiÃªn báº£n ngáº¯n gá»n cÃ³ thá»ƒ dá»±a trÃªn <a href=https://www.percona.com/blog/wp-content/uploads/2014/11/DDLFlow1.png>flow nÃ y cá»§a Percona</a>.</p><p>Hoáº·c 2 phiÃªn báº£n vÃ´ cÃ¹ng phá»©c táº¡p lÃ :</p><ul><li><a href=https://www.slideshare.net/MariaDB/m18-battle-of-the-online-schema-change-methods>https://www.slideshare.net/MariaDB/m18-battle-of-the-online-schema-change-methods</a></li><li><a href=https://blog.pythian.com/depth-mysql-5-6-ddl/>https://blog.pythian.com/depth-mysql-5-6-ddl/</a></li></ul></blockquote><h2 id=7-ref>7. Ref</h2><ul><li><a href=https://www.percona.com/blog/2014/11/18/avoiding-mysql-alter-table-downtime>https://www.percona.com/blog/2014/11/18/avoiding-mysql-alter-table-downtime</a></li><li><a href=https://www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html>https://www.percona.com/doc/percona-toolkit/LATEST/pt-online-schema-change.html</a></li><li><a href=https://mariadb.com/kb/en/library/alter-table>https://mariadb.com/kb/en/library/alter-table</a></li><li><a href=https://www.fromdual.com/online-ddl_vs_pt-online-schema-change>https://www.fromdual.com/online-ddl_vs_pt-online-schema-change</a></li><li><a href=https://github.com/facebookincubator/OnlineSchemaChange/wiki/How-OSC-works>https://github.com/facebookincubator/OnlineSchemaChange/wiki/How-OSC-works</a></li><li><a href=https://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932/>https://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932/</a></li><li><a href=https://github.com/github/gh-ost/tree/master/doc>https://github.com/github/gh-ost/tree/master/doc</a></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://taoquangne.com/post/chaos-of-configuration/><span class=button__icon>â†</span>
<span class=button__text>Chaos of configuration</span>
</a></span><span class="button next"><a href=https://taoquangne.com/post/cloudflare-101/><span class=button__text>Cloudflare 101</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href=https://creativecommons.org/licenses/by-nc/4.0>giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://taoquangne.com/assets/main.js></script><script src=https://taoquangne.com/assets/prism.js></script></div></body></html>