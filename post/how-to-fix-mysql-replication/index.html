<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        How to fix MySQL replication ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Khi v·∫≠n h√†nh m·ªôt h·ªá th·ªëng MySQL replication, th√¨ khi m·ªôt server slave b·ªã l·ªói c√≥ nghƒ©a l√† d·ªØ li·ªáu gi·ªØa Slave v√† Master ƒë√£ c√≥ s·ª± sai l·ªách, v√† l√∫c ƒë√≥ Slave s·∫Ω kh√¥ng c√≤n t√°c d·ª•ng trong h·ªá th·ªëng n·ªØa."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/how-to-fix-mysql-replication/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to fix MySQL replication"/>
<meta name="twitter:description" content="Khi v·∫≠n h√†nh m·ªôt h·ªá th·ªëng MySQL replication, th√¨ khi m·ªôt server slave b·ªã l·ªói c√≥ nghƒ©a l√† d·ªØ li·ªáu gi·ªØa Slave v√† Master ƒë√£ c√≥ s·ª± sai l·ªách, v√† l√∫c ƒë√≥ Slave s·∫Ω kh√¥ng c√≤n t√°c d·ª•ng trong h·ªá th·ªëng n·ªØa."/>



<meta property="og:title" content="How to fix MySQL replication" />
<meta property="og:description" content="Khi v·∫≠n h√†nh m·ªôt h·ªá th·ªëng MySQL replication, th√¨ khi m·ªôt server slave b·ªã l·ªói c√≥ nghƒ©a l√† d·ªØ li·ªáu gi·ªØa Slave v√† Master ƒë√£ c√≥ s·ª± sai l·ªách, v√† l√∫c ƒë√≥ Slave s·∫Ω kh√¥ng c√≤n t√°c d·ª•ng trong h·ªá th·ªëng n·ªØa." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/how-to-fix-mysql-replication/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-03-27T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-03-27T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">How to fix MySQL replication</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-03-27
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/mysql/">#mysql</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/replication/">#replication</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Khi v·∫≠n h√†nh m·ªôt h·ªá th·ªëng MySQL replication, th√¨ khi m·ªôt server slave b·ªã l·ªói c√≥ nghƒ©a l√† d·ªØ li·ªáu gi·ªØa Slave v√† Master ƒë√£ c√≥ s·ª± sai l·ªách, v√† l√∫c ƒë√≥ Slave s·∫Ω kh√¥ng c√≤n t√°c d·ª•ng trong h·ªá th·ªëng n·ªØa. Nhi·ªám v·ª• c·ªßa ng∆∞·ªùi v·∫≠n h√†nh h·ªá th·ªëng l√† c·∫ßn fix ƒë·ªÉ ƒë∆∞a slave quay tr·ªü l·∫°i ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</p>
<p>C√≥ nhi·ªÅu c√°ch ƒë·ªÉ fix slave t√πy v√†o t·ª´ng tr∆∞·ªùng h·ª£p c·ª• th·ªÉ, m·ªôt trong nh·ªØng y√™u c·∫ßu c·∫ßn thi·∫øt ƒë·ªÉ c√≥ th·ªÉ gi·∫£i quy·∫øt nhanh ch√≥ng khi h·ªá th·ªëng M-S b·ªã l·ªói ƒë√≥ l√† b·∫°n ph·∫£i <strong>hi·ªÉu</strong> d·ªØ li·ªáu c·ªßa b·∫°n, ph·∫£i bi·∫øt l√† table ƒë√≥ l√†m g√¨, d·ªØ li·ªáu l∆∞u trong ƒë√≥ c√≥ t√°c d·ª•ng g√¨, ph·ª•c v·ª• cho ch·ª©c nƒÉng n√†o, y√™u c·∫ßu ƒë·ªô ch√≠nh x√°c c·ªßa d·ªØ li·ªáu ƒë√≥ ra sao th√¨ m·ªõi c√≥ h∆∞·ªõng gi·∫£i quy·∫øt c·ª• th·ªÉ.</p>
<p>C∆° b·∫£n s·∫Ω c√≥ 2 ph∆∞∆°ng ph√°p ch√≠nh:</p>
<ul>
<li>Stop slave v√† rebuild l·∫°i slave m·ªõi -&gt; ƒë√¢y l√† c√°ch d·ªÖ nh·∫•t m√† kh√¥ng c·∫ßn hi·ªÉu data, nh∆∞ng ƒëi k√®m ƒë√≥ l√† t·ªën r·∫•t nhi·ªÅu th·ªùi gian n·∫øu d·ªØ li·ªáu kh√° l·ªõn.</li>
<li>Ph√¢n t√≠ch binlog v√† fix tr√™n qu√° tr√¨nh sync d·ªØ li·ªáu -&gt; c√°ch n√†y gi√∫p recovery slave m·ªôt c√°ch c·ª±c k·ª≥ nhanh ch√≥ng v·ªõi c√°c h·ªá th·ªëng c√≥ d·ªØ li·ªáu l·ªõn, nh∆∞ng ƒë√≤i h·ªèi c·∫ßn ph·∫£i hi·ªÉu v·ªÅ d·ªØ li·ªáu c·ªßa ch√≠nh m√¨nh.</li>
</ul>
<h2 id="1-rebuild-new-slave-with-mysqldump">1. Rebuild new slave with mysqldump</h2>
<p>Rebuild l·∫°i m·ªôt slave c≈©ng t∆∞∆°ng t·ª± nh∆∞ c√°ch ch√∫ng ta setup m·ªôt h·ªá th·ªëng MySQL replication t·ª´ ƒë·∫ßu, ch·ªâ kh√°c m·ªôt ƒëi·ªÉm ƒë√≥ l√† <strong>h·ªá th·ªëng hi·ªán t·∫°i ƒëang online</strong> v√† b·∫•t c·ª© h√†nh ƒë·ªìng n√†o t√°c ƒë·ªông ƒë·∫øn Master server ƒë·ªÅu ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp t·ªõi ng∆∞·ªùi d√πng. V·ªõi ph∆∞∆°ng ph√°p n√†y ta c·∫ßn d√πng <code>mysqldump</code> ƒë·ªÉ dump d·ªØ li·ªáu ra sql file v√† ƒë·ªìng b·ªô d·ªØ li·ªáu, m√¨nh t√≥m g·ªçn n√≥ trong v√†o b∆∞·ªõc nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## Master</span>
mysql&gt; FLUSH TABLES WITH READ LOCK;
mysql&gt; SHOW MASTER STATUS;

&gt; mysqldump -uroot -p dwh_prod &gt; dwh_prod_03072015.sql
&gt; rsync -avz -P -e<span style="color:#e6db74">&#39;ssh&#39;</span> dwh_prod_03072015.sql root@172.17.0.2:/root/

<span style="color:#75715e">## New Slave</span>
&gt; mysql -uroot -p dwh_prod &lt; /root/dwh_prod_03072015.sql

mysql&gt; CHANGE MASTER TO MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;172.17.0.1&#39;</span>,MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;slave_user&#39;</span>, MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p@ssword&#39;</span>, MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m01-bin.000001&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span>827;
mysql&gt; START SLAVE
mysql&gt; SHOW SLAVE STATUS<span style="color:#ae81ff">\G</span>
</code></pre></div><p>ƒêi·ªÉm l∆∞u √Ω duy nh·∫•t nh∆∞ m√¨nh n√≥i ·ªü tr√™n l√† vi·ªác lock table ·ªü master s·∫Ω ·∫£nh h∆∞·ªüng tr·ª±c ti·∫øp t·ªõi ng∆∞·ªùi d√πng n√™n ph∆∞∆°ng ph√°p n√†y ch·ªâ n√™n s·ª≠ d·ª•ng trong th·ªùi gian b·∫£o tr√¨ h·ªá th·ªëng v√† <strong>n·∫øu d·ªØ li·ªáu c√†ng l·ªõn, th·ªùi gian dump c√†ng l√¢u th√¨ h·ªá th·ªëng c√†ng ph·∫£i b·∫£o tr√¨ l√¢u</strong>.</p>
<h2 id="2-rebuild-new-slave-with-xtrabackup">2. Rebuild new slave with xtrabackup</h2>
<p><code>xtrabackup</code> l√† m·ªôt c√¥ng c·ª• vi·∫øt b·∫±ng C c·ªßa Percona, th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ hotbackup MySQL, ∆∞u/nh∆∞·ª£c ƒëi·ªÉm c·ªßa n√≥ so v·ªõi <code>mysqldump</code> l√†:</p>
<ul>
<li>Kh√¥ng c·∫ßn b·∫£o tr√¨ h·ªá th·ªëng, kh√¥ng lock db v√† kh√¥ng ·∫£nh h∆∞·ªüng t·ªõi ng∆∞·ªùi d√πng.</li>
<li>Qu√° tr√¨nh backup nhanh h∆°n r·∫•t nhi·ªÅu so v·ªõi <code>mysqldump</code>.</li>
<li>Nh∆∞·ª£c ƒëi·ªÉm l√† th∆∞ m·ª•c backup c√≥ k√≠ch th∆∞·ªõc ch√≠nh b·∫±ng data-raw, trong khi dump sql th√¨ r·∫•t nh·∫π.</li>
</ul>
<p>V·ªõi c√°c h·ªá th·ªëng c√≥ CSDL l·ªõn th√¨ d√πng <code>xtrabackup</code> l√† gi·∫£i ph√°p ho√†n h·∫£o cho vi·ªác backup c≈©ng nh∆∞ rebuild 1 slave server v·ª´a <strong>kh√¥ng ·∫£nh h∆∞·ªüng</strong> t·ªõi h·ªá th·ªëng ƒëang ch·∫°y, <strong>v·ª´a nhanh</strong> h∆°n so v·ªõi ph∆∞∆°ng ph√°p truy·ªÅn th·ªëng. C·ª• th·ªÉ g·ªìm 2 b∆∞·ªõc nh∆∞ sau:</p>
<ul>
<li>Backup v√† restore d·ªØ li·ªáu v·ªõi <code>xtrabackup</code>.</li>
<li>Point slave t·ªõi binlog v√† position c·ªßa binlog tr√™n master v√† sync d·ªØ li·ªáu.</li>
</ul>
<p>ƒê·ªÉ backup v√† restore d·ªØ li·ªáu v·ªõi <code>xtrabackup</code> ta c√≥ 3 b∆∞·ªõc c∆° b·∫£n nh∆∞ sau:</p>
<p>Backup to√†n b·ªô data c·ªßa mysql master v·ªõi l·ªánh:</p>
<pre tabindex="0"><code>&gt; xtrabackup --backup --target-dir=/backup/data
</code></pre><p>=&gt; ·ªü ƒë√¢y m√¨nh ƒë√£ c·∫•u h√¨nh user/pass c·ªßa root user trong file <code>~/.my.cnf</code> n√™n kh√¥ng c·∫ßn ph·∫£i pass th√¥ng tin n√†y khi ch·∫°y <code>xtrabackup</code>, v√† c√≥ th·ªÉ ch·∫°y v·ªõi t√πy ch·ªçn <code>--compact</code> ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc khi backup.</p>
<p>Sync data qua slave v√† ch·∫°y prepare data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; xtrabackup --prepare --rebuild-indexes --target-dir<span style="color:#f92672">=</span>/backup/data/

InnoDB: Starting shutdown...
InnoDB: Shutdown completed; log sequence number <span style="color:#ae81ff">22528643996</span>
<span style="color:#ae81ff">180329</span> 14:48:04 completed OK!
</code></pre></div><p>=&gt; trong qu√° tr√¨nh backup, c√≥ th·ªÉ c√≥ nh·ªØng uncommited transaction kh√¥ng ho√†n th√†nh ho·∫∑c c√°c transaction trong log c·∫ßn ph·∫£i ƒë∆∞·ª£c relay -&gt; qu√° tr√¨nh n√†y nh·∫±m ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n c·ªßa d·ªØ li·ªáu. C≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng th√™m t√πy ch·ªçn <code>--rebuild-threads=16</code> ƒë·ªÉ t·∫°o nhi·ªÅu worker-theard ƒë·ªÉ rebuild-index t·∫°i c√πng m·ªôt th·ªùi ƒëi·ªÉm.</p>
<p>Restore d·ªØ li·ªáu v√† start mysql</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; service mysql stop
&gt; rm -rf /var/lib/mysql/
&gt; xtrabackup --copy-back --target-dir<span style="color:#f92672">=</span>/backup/data/

&gt; chown -R mysql: /var/lib/mysql
</code></pre></div><p>=&gt; ƒê√¢y l√† qu√° tr√¨nh ch√©p ng∆∞·ª£c data backup v√†o datadir, c·∫ßn l∆∞u √Ω l√† datadir ph·∫£i r·ªóng ho√†n to√†n tr∆∞·ªõc khi copy-back.</p>
<p>Sau 3 b∆∞·ªõc tr√™n l√† qu√° tr√¨nh backup v√† restore d·ªØ li·ªáu ƒë√£ ho√†n th√†nh, vi·ªác c√≤n l·∫°i l√† ƒë·ªìng b·ªô h√≥a d·ªØ li·ªáu v·ªõi master ƒë·ªÉ th·ª±c hi·ªán qu√° tr√¨nh sync.</p>
<p>Sau khi copy-back xong, trong th∆∞ m·ª•c <code>/var/lib/mysql</code> s·∫Ω c√≥ 1 file <code>xtrabackup_binlog_info</code>, file n√†y ch·ª©a th√¥ng tin v·ªÅ binlog v√† position c·∫ßn d√πng ƒë·ªÉ sync.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; cat /var/lib/mysql/xtrabackup_binlog_info

mysql-bin.000209    <span style="color:#ae81ff">713297953</span>
</code></pre></div><p>V√† c·∫•u h√¨nh sync t·ª´ master nh∆∞ c√°ch b√¨nh th∆∞·ªùng trong <code>mysqldump</code> l√† ƒë∆∞·ª£c</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; CHANGE MASTER TO MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;172.17.0.1&#39;</span>,MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;slave_user&#39;</span>, MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p@ssword&#39;</span>, MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mysql-bin.000209&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span> 713297953;
&gt; START SLAVE
&gt; SHOW SLAVE STATUS<span style="color:#ae81ff">\G</span>
</code></pre></div><p>L∆∞u √Ω l√† <code>xtrabackup</code> ƒë∆∞·ª£c vi·∫øt b·∫±ng C, <code>innobackupex</code> l√† m·ªôt Perl script ƒë∆∞·ª£c symlink t·ªõi <code>xtrabackup</code>, hi·ªán t·∫°i Percona khuy·∫øn kh√≠ch ch√∫ng ta chuy·ªÉn qua <code>xtrabackup</code> v√¨ <code>innobackupex</code> kh√¥ng c√≤n ƒë∆∞·ª£c ph√°t tri·ªÉn n·ªØa, tuy nhi√™n trong m·ªôt s·ªë tr∆∞·ªùng h·ª£p ta s·∫Ω v·∫´n c·∫ßn t·ªõi n√≥.</p>
<h3 id="21-m·ªôt-s·ªë-tips-v·ªõi-xtrabackup">2.1 M·ªôt s·ªë tips v·ªõi xtrabackup</h3>
<p>N·∫øu ch·ªãu ƒë√†o x·ªõi documentt c·ªßa <code>xtrabackup</code> b·∫°n c√≥ th·ªÉ t√¨m th·∫•y kh√° nhi·ªÅu th·ª© h·ªØu √≠ch trong nhi·ªÅu t√¨nh hu·ªëng kh√°c nhau. Th·ª±c t·∫ø m√¨nh c≈©ng ƒë√£ g·∫∑p nh·ªØng t√¨nh hu·ªëng ƒë√≥ v√† m·ªõi th·∫•y s·ª± powerful c·ªßa <code>xtrabackup</code>.</p>
<p><strong>Backup v√† stream qua network</strong></p>
<p>M·ªôt t√¨nh hu·ªëng ƒë√≥ l√† ·ªï c·ª©ng c·ªßa server master c√≥ k√≠ch th∆∞·ªõc l√† 1TB, d·ªØ li·ªáu trong MySQL l√† &gt;500GB, nghƒ©a l√† ƒë·ªÉ backup ra ·ªï hi·ªán t·∫°i l√† <strong>kh√¥ng ƒë·ªß ch·ªó ch·ª©a</strong>, vi·ªác g·∫Øn th√™m ·ªï c·ª©ng s·∫Ω r·∫•t m·∫•t th·ªùi gian v·ªõi h·ªá th·ªëng bare-metal. ƒê∆°n gi·∫£n ta c√≥ th·ªÉ stream tr·ª±c ti·∫øp b·∫£n backup qua server slave nh∆∞ sau.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## New slave</span>
&gt; nc -l <span style="color:#ae81ff">9999</span> | cat - &gt; /data/backups/backup.tar
</code></pre></div><p>=&gt; s·∫Ω m·ªü m·ªôt port 9999 v√† output ra m·ªôt file archive.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## Master</span>
&gt; innobackupex --stream<span style="color:#f92672">=</span>tar ./ | nc 172.17.0.2 <span style="color:#ae81ff">9999</span>
</code></pre></div><p>=&gt; backup v√† g·ª≠i tr·ª±c ti·∫øp qua slave.</p>
<p>Nh∆∞ ta th·∫•y, sau khi backup xong ta s·∫Ω c√≥ m·ªôt file archive tr√™n slave, v√† vi·ªác c√≤n l·∫°i ch·ªâ l√† unarchive v√† restore data. NH∆ØNG ta c≈©ng c√≥ th·ªÉ gi·∫£i n√©n lu√¥n trong qu√° tr√¨nh stream.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## New Slave</span>
&gt; nc -l <span style="color:#ae81ff">9999</span> | tar -ivxf -

<span style="color:#75715e">## Master</span>
&gt; innobackupex --stream<span style="color:#f92672">=</span>tar ./ | nc 172.17.0.2 <span style="color:#ae81ff">9999</span>
</code></pre></div><p><strong>T·∫°o newslave m·ªõi t·ª´ slave c≈©</strong></p>
<p>Gi·∫£ s·ª≠ ta c√≥ m·ªôt server Master, m·ªôt server slave, nh∆∞ng v√¨ l√Ω do n√†o ƒë√≥ m√† server slave c·∫ßn b·∫£o tr√¨, ta s·∫Ω c·∫ßn build slave m·ªõi thay th·∫ø. Nh∆∞ng ta l·∫°i kh√¥ng mu·ªën ƒë·ª•ng t·ªõi server Master, ta c√≥ th·ªÉ d·ªÖ d√†ng t·∫°o slave m·ªõi t·ª´ server slave s·∫Øp b·∫£o tr√¨ v·ªõi <code>xtrabackup</code> nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">## Old slave</span>
&gt; xtrabackup --backup --slave-info --target-dir<span style="color:#f92672">=</span>/backup/data
</code></pre></div><p>Ho·∫∑c stream</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; innobackupex --slave-info --stream<span style="color:#f92672">=</span>tar ./ | nc 172.17.0.2 <span style="color:#ae81ff">9999</span>
</code></pre></div><p>ƒêi·ªÉm kh√°c bi·ªát duy nh·∫•t l√† binlog v√† position thay v√¨ ƒë∆∞·ª£c l∆∞u tr√™n <code>xtrabackup_binlog_info </code> th√¨ s·∫Ω ƒë∆∞·ª£c l∆∞u trong <code>xtrabackup_slave_info</code>, ta ch·ªâ c·∫ßn th·ª±c hi·ªán prepare-data, restore v√† point slave m·ªõi t·ªõi master v·ªõi th√¥ng tin trong file <code>xtrabackup_slave_info</code>.</p>
<h3 id="22-m·ªôt-s·ªë-th√¥ng-tin-th·ª±c-t·∫ø">2.2 M·ªôt s·ªë th√¥ng tin th·ª±c t·∫ø</h3>
<ul>
<li>Data 500GB, d√πng <code>xtrabackup</code> stream qua network t·ªën 93 ph√∫t, unachive file tar 420GB t·ªën 39 ph√∫t, <code>--prepare</code> t·ªën c·ª° 60ph.</li>
<li>Data 500GB, d√πng <code>xtrabackup</code> stream v√† unarchive tr·ª±c ti·∫øp cho t·ªõi khi build xong slave t·ªën ~2h.</li>
<li>Data 500GB, d√πng <code>mysqldump</code> data ra ƒëƒ©a, t·ªën 183 ph√∫t, file sql n·∫∑ng 182GB ch∆∞a n√©n.</li>
</ul>
<h2 id="3-ph√¢n-t√≠ch-binlog-v√†-fix-tr√™n-qu√°-tr√¨nh-sync-d·ªØ-li·ªáu">3. Ph√¢n t√≠ch binlog v√† fix tr√™n qu√° tr√¨nh sync d·ªØ li·ªáu</h2>
<p>N·∫øu t√¨m ki·∫øm tr√™n Internet ta s·∫Ω th·∫•y c√≥ m·ªôt s·ªë blog h∆∞·ªõng d·∫´n fix replication data gi·ªØa M-S nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysql&gt; STOP SLAVE; SET GLOBAL SQL_SLAVE_SKIP_COUNTER<span style="color:#f92672">=</span>1; START SLAVE; 
</code></pre></div><p>Tuy nhi√™n ƒë√¢y l√† m·ªôt √Ω t∆∞·ªüng kh√° l√† t·ªá v√† t·ªët nh·∫•t l√† n√™n tr√°nh s·ª≠ d·ª•ng ph∆∞∆°ng ph√°p n√†y. V·ªõi c√¢u l·ªánh tr√™n, Slave s·∫Ω b·ªè qua l·ªói ƒë√≥ v√† next t·ªõi transaction ti·∫øp theo ƒë·ªÉ apply binlog =&gt; m·∫•t t√≠nh nh·∫•t qu√°n c·ªßa d·ªØ li·ªáu.</p>
<p>V√≠ d·ª•:</p>
<ul>
<li>·ª®ng d·ª•ng qu·∫£n l√Ω t·ªìn kho, c√°c query read ƒë∆∞·ª£c ƒë·∫©y v√†o Slave.</li>
<li>M·ªôt s·∫£n ph·∫©m t·ªìn kho c√≤n 1, user sau khi mua s·ªë l∆∞·ª£ng 1, s·ªë t·ªìn kho ƒë∆∞·ª£c tr·ª´ v·ªÅ 0 tr√™n master.</li>
<li>Binlog sinh ra, sync qua slave v√† ƒë∆∞·ª£c apply v√†o slave nh∆∞ng b·ªã l·ªói.</li>
<li>Th·ª±c hi·ªán skip qua transaction ƒë√≥ -&gt; s·ªë t·ªìn kho c·ªßa s·∫£n ph·∫©m ƒë√≥ v·∫´n l√† 1 tr√™n slave -&gt; v√† n·∫øu kh√¥ng c√≥ th√™m b·∫•t c·ª© t√°c ƒë·ªông g√¨ t·ªõi record ƒë√≥ th√¨ slave v·∫´n ho·∫°t ƒë·ªông v√† sync data b√¨nh th∆∞·ªùng.</li>
</ul>
<p>=&gt; Khi c√≥ m·ªôt user kh√°c v√†o xem s·∫£n ph·∫©m, ph√°t sinh query ƒë·ªçc l√™n s·ªë l∆∞·ª£ng t·ªìn kho t·ª´ slave v√† th√¥ng b√°o s·∫£n ph·∫©m c√≤n s·ªë l∆∞·ª£ng l√† 1. User th·ª±c hi·ªán b·ªè v√†o gi·ªè h√†ng (write data -&gt; g·ªçi v√†o slave) =&gt; Kh√¥ng th·ªÉ b·ªè v√†o gi·ªè h√†ng do tr√™n master l·∫°i ki·ªÉm tra l√† s·ªë l∆∞·ª£ng l√† 0.</p>
<p>Th·ª±c t·∫ø vi·ªác s·ª≠ d·ª•ng nh∆∞ tr√™n ch·ªâ khi th·ª±c s·ª± hi·ªÉu r·∫±ng data c·ªßa ch√∫ng ta s·∫Ω b·ªã t√°c ƒë·ªông nh∆∞ th·∫ø n√†o, v√≠ d·ª• c√≥ nhi·ªÅu ·ª©ng d·ª•ng l∆∞u log request ho·∫∑c <code>push_notification_log</code> v√†o mysql th√¨ ta ho√†n to√†n c√≥ th·ªÉ SKIP n·∫øu bi·∫øt ch·∫Øc ch·∫Øn apply log v√†o c√°c b·∫£ng d·ªØ li·ªáu tr√™n.</p>
<p>Trong th·ª±c t·∫ø, tr∆∞·ªõc ƒë√¢y m√¨nh g·∫∑p m·ªôt v√†i t√¨nh hu·ªëng kh√° k·ª≥ c·ª•c, nh∆∞ng b·∫±ng c√°ch l√† decode binlog m√† m√¨nh ƒë√£ gi·∫£i quy·∫øt kh√° nhi·ªÅu tr∆∞·ªùng h·ª£p m√† kh√¥ng c·∫ßn rebuild l·∫°i slave, ti·∫øt ki·ªám r·∫•t nhi·ªÅu th·ªùi gian v√† c√¥ng s·ª©c. Th∆∞·ªùng c√°c tr∆∞·ªùng h·ª£p ƒë√≥ l√†:</p>
<ul>
<li>Ki·ªÉu d·ªØ li·ªáu c·ªßa column, charet c·ªßa b·∫£ng gi·ªØa slave v√† master kh√¥ng ƒë·ªìng nh·∫•t.</li>
<li>D·ªØ li·ªáu m·ªôt record tr√™n slave kh√°c master, ho·∫∑c index ƒë√£ t·ªìn t·∫°i tr√™n slave.</li>
</ul>
<p>=&gt; nh·ªØng l·ªói n√†y th·ª±c ra ch·ªß y·∫øu do con ng∆∞·ªùi t·∫°o ra, nh∆∞ng vi·ªác fix nhanh ch√≥ng v·∫´n l√† ƒëi·ªÅu c·∫ßn thi·∫øt.</p>
<p>V√≠ d·ª• 1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">                Relay_Log_Pos: <span style="color:#ae81ff">619131881</span>
        Relay_Master_Log_File: mysql-bin.000569
             Slave_IO_Running: Yes
            Slave_SQL_Running: No 
                   Last_Errno: <span style="color:#ae81ff">1061</span>
                   Last_Error: Error <span style="color:#e6db74">&#39;Duplicate key name &#39;</span>users_id_photo_idx<span style="color:#e6db74">&#39;&#39;</span> ON query. DEFAULT DATABASE: <span style="color:#e6db74">&#39;facebook&#39;</span>. Query: <span style="color:#e6db74">&#39;CREATE INDEX `users_id_photo_idx` ON `users`(`id`, `photo_id`) USING BTREE&#39;</span>
</code></pre></div><p>=&gt; nh∆∞ ·ªü tr√™n b√°o l·ªói ·ªü file binlog l√† <code>mysql-bin.000569</code>, v·ªã tr√≠ 619131881, ta s·∫Ω c·∫ßn decode binlog.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; mysqlbinlog --base64-output<span style="color:#f92672">=</span>DECODE-ROWS --verbose mysql-bin.000569 &gt; mysql-bin.000569.decode.sql
&gt; grep --color<span style="color:#f92672">=</span>always -A <span style="color:#ae81ff">30</span> <span style="color:#ae81ff">619131881</span> decode.sql
</code></pre></div><p>=&gt; b·∫£n ch·∫•t l√† kh√¥ng hi·ªÉu b·∫±ng c√°ch n√†o ƒë√≥, <code>users_id_photo_idx</code> ƒë√£ t·ªìn t·∫°i tr√™n slave, v√† khi ta ƒë√°nh index tr√™n master, index n√†y ƒëc sync qua slave v√† apply th√¨ b√°o l·ªói ƒë√£ t·ªìn t·∫°i.</p>
<p>C√°ch fix ƒë∆°n gi·∫£n l√† x√≥a index <code>users_id_photo_idx</code> tr√™n slave v√† slave l·∫°i replication l√† c√≥ th·ªÉ fix.</p>
<p>V√≠ d·ª• 2:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> 				  Last_SQL_Errno: <span style="color:#ae81ff">1062</span>
               Last_SQL_Error: Error <span style="color:#e6db74">&#39;Duplicate entry &#39;</span>5<span style="color:#e6db74">&#39; for key &#39;</span>PRIMARY<span style="color:#e6db74">&#39;&#39;</span> on query. Default database: <span style="color:#e6db74">&#39;facebook&#39;</span>. <span style="color:#ae81ff">\ </span>
               Query: <span style="color:#e6db74">&#39;INSERT INTO t VALUES (5,2)&#39;</span>
</code></pre></div><p>=&gt; Tr√™n b·∫£ng <code>t</code> c·ªßa slave ƒë√£ t·ªìn t·∫°i m·ªôt record c√≥ <code>id</code> b·∫±ng 5, d·∫´n t·ªõi khi sync l·ªánh <code>INSERT</code> qua slave th√¨ b·ªã duplicate, ƒë∆°n gi·∫£n ch·ªâ c·∫ßn x√≥a record match ƒë√≥ ƒëi <code>DELETE FROM t WHERE id = 5 AND pid = 2</code> v√† start l·∫°i slave.</p>
<p><strong>T√≥m l·∫°i</strong> v·ªõi c√°ch n√†y, vi·ªác fix slave l√† v√¥ c√πng nhanh ch√≥ng, ch·ªâ t·ªën kho·∫£ng v√†i gi√¢y, v√†i ph√∫t v√† slave c√≥ th·ªÉ quay tr·ªü l·∫°i ho·∫°t ƒë·ªông v√† b·∫°n c≈©ng kh√¥ng ph·∫£i m·∫•t th·ªùi gian build l·∫°i slave v√† ch·ªù sync k·ªãp d·ªØ li·ªáu.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/delayed-replication-in-mysql/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Delayed Replication in MySQL</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://taoquangne.com/post/docker-eco-system/">
                  <span class="button__text">Docker Ecosystem</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> h√†ng nh√† tr·ªìng üå¥ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">gi·∫•y ph√©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
