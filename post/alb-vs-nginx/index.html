<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5JDKMG4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-5JDKMG4")</script><title>ALB vs nginx ::
/home/xluffy
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://taoquangne.com/post/alb-vs-nginx/><link rel=stylesheet href=https://taoquangne.com/assets/style.css><link rel=stylesheet href=https://taoquangne.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://taoquangne.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://taoquangne.com/img/favicon.png><link href=https://taoquangne.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="ALB vs nginx"><meta property="og:url" content="https://taoquangne.com/post/alb-vs-nginx/"><meta property="og:site_name" content="/home/xluffy"><meta property="og:title" content="ALB vs nginx"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-11-30T00:00:00+00:00"><meta property="article:modified_time" content="2018-11-30T00:00:00+00:00"><meta property="article:tag" content="Alb"><meta property="article:tag" content="Nginx"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>/home/xluffy ft ğŸ„</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>ALB vs nginx</h1><div class=post-meta><span class=post-date>2018-11-30</span></div><span class=post-tags><a href=https://taoquangne.com/tags/alb/>#alb</a>&nbsp;
<a href=https://taoquangne.com/tags/nginx/>#nginx</a>&nbsp;</span><div class=post-content><blockquote><p>NhÃ¢n má»™t ngÆ°á»i báº¡n há»i vá» váº¥n Ä‘á» nÃ y, mÃ¬nh take note láº¡i vÃ¬ Ä‘Ã£ Ä‘Æ°á»£c há»i 2 láº§n :sosad:</p></blockquote><p><strong>ALB</strong>: lÃ  dá»‹ch vá»¥ Application Load Balancer cá»§a AWS, má»™t dá»‹ch vá»¥ vá» cÃ¢n báº±ng táº£i cá»§a AWS hoáº¡t Ä‘á»™ng á»Ÿ layer 7 support giao thá»©c HTTP/HTTPs, Websocket, HTTP2.</p><p><strong>nginx</strong>: lÃ  má»™t webserver opensource, support cáº£ chá»©c nÄƒng cÃ¢n báº±ng táº£i á»Ÿ layer 7 (cÃ³ support á»Ÿ layer 4 nhÆ°ng khÃ¡ cÆ¡ báº£n).</p><p>NgoÃ i ALB vÃ  nginx thÃ¬ cÃ²n cÃ³ <strong>HAproxy</strong> cÅ©ng lÃ  má»™t service cung cáº¥p chá»©c nÄƒng cÃ¢n báº±ng táº£i á»Ÿ layer 4 vÃ  layer 7 khÃ¡ phá»• biáº¿n.</p><p>Load balancer lÃ  dá»‹ch vá»¥ sáº½ phá»¥c vá»¥ nhÆ° má»™t single point giao tiáº¿p vá»›i user. Load balancer sáº½ phÃ¢n tÃ¡n cÃ¡c incomming request tá»« user tá»›i nhiá»u server phÃ­a sau LB nháº±m má»¥c Ä‘Ã­ch scale há»‡ thá»‘ng.</p><p>CÃ¢u há»i Ä‘áº·t ra lÃ  khi xÃ¢y dá»±ng má»™t há»‡ thá»‘ng trÃªn AWS, ta sáº½ chá»n cÃ¡i gÃ¬ Ä‘á»ƒ thá»±c hiá»‡n chá»©c nÄƒng cÃ¢n báº±ng táº£i? ALB hay nginx? Æ°u nhÆ°á»£c Ä‘iá»ƒm cá»§a tá»«ng dá»‹ch vá»¥ lÃ  gÃ¬?</p><p>Vá» báº£n cháº¥t, ALB vÃ  nginx hoáº¡t Ä‘á»™ng cÃ¹ng chá»©c nÄƒng cÃ¢n báº±ng táº£i, má»™t trong cÃ¡c rule khi thiáº¿t káº¿ há»‡ thá»‘ng Ä‘Ã³ lÃ  <a href=https://wiki.archlinux.org/index.php/arch_terminology#KISS>KISS</a>, giá»¯ cho há»‡ thá»‘ng Ä‘Æ¡n giáº£n nháº¥t cÃ³ thá»ƒ, trÃ¡nh gÃ¢y confuse. Äiá»u Ä‘Ã³ cÃ³ nghÄ©a lÃ  vá» lÃ½ thuyáº¿t ta chá»‰ nÃªn sá»­ dá»¥ng má»™t dá»‹ch vá»¥ cho má»™t chá»©c nÄƒng cá»¥ thá»ƒ nÃ o Ä‘Ã³.</p><h2 id=1-chá»‰-xÃ i-alb>1. Chá»‰ xÃ i ALB</h2><p><strong>Æ¯u Ä‘iá»ƒm</strong>:</p><ul><li>Chi phÃ­ ráº», $20.</li><li>Support tÃ­nh nÄƒng host-based vÃ  path-based giÃºp routing request tá»›i cÃ¡c cá»¥m host cÃ³ chá»©c nÄƒng khÃ¡c nhau.</li><li>Táº­n dá»¥ng infra cá»§a AWS Ä‘á»ƒ há»— trá»£ multi-zone, high availability dá»… dÃ ng.</li></ul><p><strong>NhÆ°á»£c Ä‘iá»ƒm</strong>:</p><ul><li>ALB chá»‰ há»— trá»£ round robin algorithm.</li><li>Log cá»§a ALB khÃ´ng nhiá»u thÃ´ng tin há»¯u Ã­ch cho viá»‡c build 1 in-house metric system nhÆ° nginx.</li></ul><p>LÆ°u Ã½ thÃªm lÃ  round-robin lÃ  má»™t thuáº­t toÃ¡n cÃ¢n báº±ng táº£i ráº¥t khÃ´ng fair, LB sáº½ tuáº§n tá»± pass Ä‘á»u sá»‘ lÆ°á»£ng request incoming tá»›i cÃ¡c instance phÃ­a sau mÃ  khÃ´ng quan tÃ¢m tráº¡ng thÃ¡i hay kháº£ nÄƒng phá»¥c vá»¥ cá»§a instance phÃ­a sau nhÆ° tháº¿ nÃ¡o. Sáº½ dáº«n tá»›i trÆ°á»ng há»£p lÃ :</p><ul><li>CÃ³ instance xui xáº»o sáº½ chá»‰ nháº­n cÃ¡c heavy request, nhÆ°ng nÃ³ chÆ°a ká»‹p xá»­ lÃ½ xong Ä‘Ã£ bá»‹ pass tiáº¿p nhiá»u heavy request khÃ¡c vÃ o.</li><li>CÃ³ instance thÃ¬ láº¡i chá»‰ pháº£i phá»¥c vá»¥ cÃ¡c request ráº¥t nhanh, nhÆ°ng vÃ¬ round-robin chia Ä‘á»u nÃªn á»Ÿ request tiáº¿p theo nÃ³ váº«n cÃ³ thá»ƒ nháº­n Ä‘Æ°á»£c cÃ¡c request nháº¹ nhÃ ng Ä‘Ã³ tiáº¿p.</li></ul><p>TÃ­nh nÄƒng multi-zone lÃ  má»™t tÃ­nh nÄƒng khÃ¡ khÃ³ xÃ¢y dá»±ng trÃªn má»™t há»‡ thá»‘ng on-premise, hiá»ƒu Ä‘Æ¡n giáº£n thÃ¬ náº¿u báº¡n cÃ³ má»™t LB Ä‘áº·t á»Ÿ DC Viettel thÃ¬ báº¡n sáº½ pháº£i cÃ³ 1 LB khÃ¡c cÃ¹ng chá»©c nÄƒng, sync vá»›i nhau vÃ  heartbeat vá»›i nhau á»Ÿ DC cá»§a FPT.</p><h2 id=2-náº¿u-chá»‰-xÃ i-nginx>2. Náº¿u chá»‰ xÃ i nginx</h2><p>Má»™t lá»±a chá»n khÃ¡c Ä‘Ã³ lÃ  thay vÃ¬ sá»­ dá»¥ng dá»‹ch vá»¥ cá»§a AWS, ta cÃ³ thá»ƒ tá»± build LB vÃ  tá»± váº­n hÃ nh nhÆ° cÃ¡c há»‡ thá»‘ng on-premise. ÄÃ¢y lÃ  bÃ i toÃ¡n cÅ© mÃ  báº¥t cá»© ai xÃ¢y dá»±ng há»‡ thá»‘ng on-premise cÅ©ng Ä‘Ã£ tá»«ng gáº·p qua.</p><p><strong>Æ¯u Ä‘iá»ƒm</strong>:</p><ul><li>Há»— trá»£ <a href=http://nginx.org/en/docs/http/load_balancing.html>nhiá»u thuáº­t toÃ¡n load balancer</a> nhÆ° round-robin, round-robin weight, ip_hash (session persistence), least-connected.</li><li>Log cÃ³ nhiá»u thÃ´ng tin há»— trá»£ debug vÃ  metric.</li><li>Há»— trá»£ nhiá»u module giÃºp thá»±c hiá»‡n nhiá»u chá»©c nÄƒng nÃ¢ng cao:<ul><li><a href=https://github.com/openresty>lua modules.</a></li><li><a href=https://github.com/openresty/headers-more-nginx-module>headers-more-nginx-module</a> -> giÃºp áº©n token hoáº·c lÃ m sai lá»‡ch token tá»« server -> há»¯u Ã­ch khi cáº§n che giáº¥u cÃ´ng nghá»‡ á»Ÿ server-side.</li><li>CÃ¡c module giao tiáº¿p trá»±c tiáº¿p tá»›i cÃ¡c service nhÆ° redis, memcached, mysql &mldr;</li></ul></li><li>Há»— trá»£ cÃ¡c tÃ­nh nÄƒng cáº£n lá»c cÆ¡ báº£n vÃ  lightweight á»Ÿ táº§ng load balancer nhÆ° block by ip, geoip, user-agent.</li><li>Há»— trá»£ routing tá»« má»™t dáº£i IP vÃ o má»™t cá»¥m server nÃ o Ä‘Ã³ trong backend -> sáº½ ráº¥t há»¯u Ã­ch khi muá»‘n debug/test trÃªn production mÃ  khÃ´ng áº£nh hÆ°á»Ÿng tá»›i user.</li></ul><p><strong>NhÆ°á»£c Ä‘iá»ƒm</strong>:</p><p>LB sáº½ lÃ  single point of fail giá»¯a user vÃ  server, sá»­ dá»¥ng nginx lÃ m LB ta pháº£i Ä‘áº£m báº£o Ä‘Æ°á»£c lÃ  dá»‹ch vá»¥ LB sáº½ luÃ´n cÃ³ kháº£ nÄƒng dá»± phÃ²ng. Dá»± phÃ²ng á»Ÿ Ä‘Ã¢y cáº§n Ä‘áº¡t Ä‘Æ°á»£c á»Ÿ 3 yÃªu cáº§u:</p><ul><li>Dá»± phÃ²ng á»Ÿ má»©c service, dá»‹ch vá»¥ nginx pháº£i luÃ´n luÃ´n Ä‘Æ°á»£c phá»¥c vá»¥ hoáº·c Ã­t nháº¥t cÃ³ kháº£ nÄƒng tá»± restart Ä‘á»ƒ giáº£m thiá»ƒu thá»i gian downtime (nhÆ°ng restart sáº½ force close current connection).</li><li>Dá»± phÃ²ng á»Ÿ má»©c server, sáº½ pháº£i luÃ´n cÃ³ má»™t server nginx tÆ°Æ¡ng tá»± Ä‘á»ƒ thay tháº¿ khi server chÃ­nh bá»‹ hÆ° há»ng pháº§n cá»©ng hoáº·c sáº­p Ä‘iá»‡n &mldr; YÃªu cáº§u nÃ y cÃ³ thá»ƒ thá»±c hiá»‡n á»Ÿ khi sá»­ dá»¥ng nginx + keepalived + floating IP.</li><li>á» má»©c dá»± phÃ²ng server, ta cáº§n pháº£i Ä‘áº·t LB á»Ÿ má»™t khu vá»±c khÃ¡c vÃ­ dá»¥ nhÆ° á»Ÿ 2 DC khÃ¡c nhau, Ä‘Ã¢y lÃ  váº¥n Ä‘á» khÃ´ng dá»… vÃ  so vá»›i chi phÃ­ $20 cá»§a AWS thÃ¬ Ä‘Ã¢y lÃ  má»™t má»©c giÃ¡ quÃ¡ há»i cho tÃ­nh nÄƒng nÃ y.</li></ul><p>NÃ³i thÃªm vá» tÃ­nh nÄƒng routing dá»±a trÃªn client IP cá»§a nginx lÃ  nÃ³ vÃ´ cÃ¹ng há»¯u Ã­ch khi ta cáº§n test sáº£n pháº©m trÃªn mÃ´i trÆ°á»ng production, nhÆ°ng chá»‰ effect tá»›i 1 lÆ°á»£ng nhá» user (vÃ­ dá»¥ user lÃ  QC trong cty, routing dá»±a trÃªn static ip cá»§a cty), ngoÃ i ra cÅ©ng cÃ³ thá»ƒ routing tá»›i 1 server má»›i vá»›i code má»›i nhÆ°ng database vÃ  cÃ¡c pháº§n khÃ¡c váº«n nhÆ° cÅ©.</p><p>Vá» metric, ta cÃ³ thá»ƒ cÃ³ metric dáº¡ng nhÆ° váº§y giÃºp Ä‘Ã¡nh giÃ¡ há»‡ thá»‘ng.</p><p><img src=https://raw.githubusercontent.com/xluffy/assets/master/nginx_metric_log.png alt=nginx-metric-log></p><h2 id=3-tÃ³m-láº¡i>3. TÃ³m láº¡i</h2><p>Äá»ƒ táº­n dá»¥ng lá»£i tháº¿ cá»§a cáº£ 2 dá»‹ch vá»¥, cuá»‘i cÃ¹ng ta cÃ³ diagram nhÆ° sau:</p><p align=center><img src="https://github.com/xluffy/assets/blob/master/alb_nginx_backend.png?raw=true" alt=alb_nginx_backend width=45%></p><blockquote><p>NgoÃ i lÃ½ do á»Ÿ Ä‘áº§u bÃ i (do má»™t ngÆ°á»i báº¡n há»i) thÃ¬ bÃ i nÃ y nháº±m thá»a mÃ£n cho cÃ¢u há»i táº¡i sao láº¡i cÃ³ <strong>2 service cÃ¹ng chá»©c nÄƒng</strong> trong há»‡ thá»‘ng. Tháº¯c máº¯c, tá»± Ä‘áº·t cÃ¢u há»i, tá»± tÃ¬m cÃ¢u tráº£ lá»i luÃ´n Ä‘em láº¡i má»™t cáº£m há»©ng giÃºp thÃºc Ä‘áº©y Ä‘am mÃª trong cÃ´ng viá»‡c vÃ  thÃºc Ä‘áº©y báº£n thÃ¢n tá»± phÃ¡t triá»ƒn.</p></blockquote></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://taoquangne.com/post/how-to-resolve-io-issue-on-cloud/><span class=button__icon>â†</span>
<span class=button__text>How to resolve I/O issue on cloud</span>
</a></span><span class="button next"><a href=https://taoquangne.com/post/build-simple-bg-job-with-rabbitmq/><span class=button__text>Build a simple background job with RabbitMQ</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href=https://creativecommons.org/licenses/by-nc/4.0>giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://taoquangne.com/assets/main.js></script><script src=https://taoquangne.com/assets/prism.js></script></div></body></html>