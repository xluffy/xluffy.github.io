<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=GTM-5JDKMG4"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","GTM-5JDKMG4")</script><title>Sidekiq, how to reliability? ::
/home/xluffy
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://taoquangne.com/post/sidekiq-how-to-reliability/><link rel=stylesheet href=https://taoquangne.com/assets/style.css><link rel=stylesheet href=https://taoquangne.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://taoquangne.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://taoquangne.com/img/favicon.png><link href=https://taoquangne.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="Sidekiq, how to reliability?"><meta property="og:url" content="https://taoquangne.com/post/sidekiq-how-to-reliability/"><meta property="og:site_name" content="/home/xluffy"><meta property="og:title" content="Sidekiq, how to reliability?"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2018-07-26T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-26T00:00:00+00:00"><meta property="article:tag" content="Rails"><meta property="article:tag" content="Sidekiq"></head><body><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>/home/xluffy ft ğŸ„</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>Sidekiq, how to reliability?</h1><div class=post-meta><span class=post-date>2018-07-26</span></div><span class=post-tags><a href=https://taoquangne.com/tags/rails/>#rails</a>&nbsp;
<a href=https://taoquangne.com/tags/sidekiq/>#sidekiq</a>&nbsp;</span><div class=post-content><p>ThÃ´ng thÆ°á»ng, khi xÃ¢y dá»±ng má»™t á»©ng dá»¥ng web, quy trÃ¬nh Ä‘Æ¡n giáº£n sáº½ nhÆ° sau:</p><ul><li>NgÆ°á»i dÃ¹ng gá»­i yÃªu cáº§u, request tá»›i web application.</li><li>Web application nháº­n request, xá»­ lÃ½ (hoáº·c intergration vá»›i service khÃ¡c nhÆ° database Ä‘á»ƒ xá»­ lÃ½).</li><li>Cuá»‘i cÃ¹ng tráº£ vá» káº¿t quáº£ cho user.</li></ul><p>VÃ­ dá»¥ trong thá»±c táº¿, báº¡n Ä‘Äƒng kÃ½ user á»Ÿ má»™t website nÃ o Ä‘Ã³, sau khi nháº­p Ä‘áº§y Ä‘á»§ thÃ´ng tin, submit -> request sáº½ Ä‘Æ°á»£c gá»­i lÃªn server vÃ  ngÆ°á»i dÃ¹ng sáº½ <strong>chá»</strong> cho tá»›i khi server xá»­ lÃ½ xong vÃ  tráº£ vá» káº¿t quáº£ (thÃ nh cÃ´ng hoáº·c tháº¥t báº¡i). Do ngÆ°á»i dÃ¹ng pháº£i <strong>chá»</strong> nÃªn ta gá»i Ä‘Ã³ lÃ  synchronous task.</p><p>Tuy nhiÃªn trong thá»±c táº¿, khÃ´ng pháº£i lÃºc nÃ o web app cÅ©ng xá»­ lÃ½ nhanh hoáº·c khÃ´ng pháº£i lÃºc nÃ o chÃºng ta cÅ©ng cáº§n <strong>pháº£n há»“i ngay láº­p tá»©c</strong> káº¿t quáº£ cho ngÆ°á»i dÃ¹ng. VÃ­ dá»¥ sau khi Ä‘Äƒng kÃ½ ta cÃ³ gá»­i email thÃ´ng bÃ¡o tá»›i cho ngÆ°á»i dÃ¹ng, nhÆ°ng khÃ´ng nháº¥t thiáº¿t pháº£i gá»­i email <strong>ngay láº­p tá»©c</strong> cho ngÆ°á»i dÃ¹ng, cÃ³ thá»ƒ cháº­m 1-2 phÃºt cÅ©ng cháº¥p nháº­n Ä‘Æ°á»£c hoáº·c vÃ­ dá»¥ cÃ¡c tÃ¡c vá»¥ resize, optimize áº£nh do ngÆ°á»i dÃ¹ng upload thÆ°á»ng tá»‘n nhiá»u thá»i gian, náº¿u Ä‘á»ƒ user chá» á»Ÿ mÃ n hÃ¬nh upload cÅ©ng khÃ´ng pháº£i lÃ  cÃ¡ch hay.</p><p>Nhá»¯ng tÃ¡c vá»¥ nhÆ° váº­y ta cÃ³ thá»ƒ Ä‘Æ°a vÃ o cháº¡y ná»n hay cÃ²n gá»i lÃ  backgroud job/asynchronous job. GiÃºp trÃ¡nh báº¯t ngÆ°á»i dÃ¹ng pháº£i chá» Ä‘á»£i lÃ¢u mÃ  váº«n Ä‘áº£m báº£o lÃ  sáº½ xá»­ lÃ½ tÃ¡c vá»¥ Ä‘Ã³ cho ngÆ°á»i dÃ¹ng.</p><p>MÃ´ hÃ¬nh chung sáº½ nhÆ° sau:</p><p align=center><img src=https://getaround.tech/assets/posts/2015-10-12-taskqueues-go-wild/taskqueues.svg alt=alb_nginx_backend width=65%><a href=https://drivy.engineering/taskqueues-tips><i>https://drivy.engineering/taskqueues-tips</i></a></p><ul><li>Broker lÃ  má»™t queue vÃ­ dá»¥ nhÆ° redis, RabbitMQ.</li><li>App sáº½ enqueue cÃ¡c tÃ¡c vá»¥ cáº§n xá»­ lÃ½ background tÃ¹y vÃ o tá»«ng request.</li><li>CRON sáº½ enqueue cÃ¡c bg job Ä‘á»‹nh ká»³ vÃ o nhá»¯ng thá»i Ä‘iá»ƒm cá»¥ thá»ƒ.</li><li>Worker sáº½ dequeue vÃ  xá»­ lÃ½ cÃ¡c tÃ¡c vá»¥ Ä‘Ã³.</li></ul><p>Sidekiq lÃ  má»™t background processing framework cho ngÃ´n ngá»¯ Ruby Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c bÃ i toÃ¡n tÆ°Æ¡ng tá»± nhÆ° trÃªn. Xá»­ lÃ½ background khÃ´ng pháº£i lÃ  bÃ i toÃ¡n má»›i, báº¥t ká»³ ngÃ´n ngá»¯ láº­p trÃ¬nh nÃ o cÅ©ng cÃ³ nhá»¯ng cÃ¡ch giáº£i quyáº¿t tÆ°Æ¡ng tá»±, vá» job queue cÅ©ng cÃ³ ráº¥t nhiá»u lá»±a chá»n khÃ¡c nhau vÃ­ dá»¥ <a href=http://gearman.org>Gearmand</a>, <a href=http://www.celeryproject.org>Celery</a>, <a href=http://python-rq.org>rq</a>.</p><p>CÃ¡c xá»­ lÃ½ mÃ  sáº½ phÃ¹ há»£p Ä‘á»ƒ Ä‘Æ°a vÃ o cháº¡y ná»n bao gá»“m:</p><ul><li>CÃ¡c xá»­ lÃ½ náº·ng vá» CPU, vÃ­ dá»¥ cÃ¡c phÃ©p tÃ­nh toÃ¡n há»c hoáº·c phÃ¢n tÃ­ch cáº¥u trÃºc.</li><li>CÃ¡c xá»­ lÃ½ náº·ng vá» I/O vÃ­ dá»¥ load data tÃ­nh toÃ¡n report, ETL.</li><li>Batch job vÃ­ dá»¥ nhÆ° update/processing report vá» Ä‘Ãªm.</li><li>&mldr;</li></ul><h2 id=1-sidekiq-architecture>1. Sidekiq Architecture</h2><p>Sidekiq gá»“m 3 pháº§n chÃ­nh:</p><ul><li>Sidekiq client cháº¡y trÃªn báº¥t ká»³ Ruby process nÃ o Ä‘Ã³ vÃ­ dá»¥ nhÆ° <code>puma</code> hoáº·c <code>passsenger</code> cho phÃ©p <strong>táº¡o</strong> job Ä‘á»ƒ xá»­ lÃ½ sau.</li><li>Redis lÃ  data storage cho sidekiq, dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c job Ä‘Æ°á»£c Ä‘áº©y xuá»‘ng tá»« sidekiq client.</li><li>Sidekiq server lÃ  má»™t process Ä‘á»™c láº­p, <strong>pull job</strong> tá»« queue trong Redis vÃ  xá»­ lÃ½.</li></ul><p align=center><img src=https://brandonhilkert.com/images/sidekiq/rails-web-worker.png alt=rails-web-worker width=65%><a href=https://brandonhilkert.com/blog/sidekiq-as-a-microservice-message-queue><i>Source: https://brandonhilkert.com/blog/sidekiq-as-a-microservice-message-queue</i></a></p><p>Äá»©ng á»Ÿ gÃ³c Ä‘á»™ váº­n hÃ nh há»‡ thá»‘ng, mÃ¬nh chá»‰ quan tÃ¢m chuyá»‡n gÃ¬ xáº£y ra khi báº¥t cá»© thÃ nh pháº§n trÃªn fail vÃ  lÃ m cÃ¡ch nÃ o Ä‘á»ƒ Ä‘áº£m báº£o há»‡ thá»‘ng cÃ³ kháº£ nÄƒng fail-over. Äá»ƒ tráº£ lá»i cÃ¢u há»i Ä‘Ã³ thÃ¬ cáº§n pháº£i hiá»ƒu cÃ¡ch hoáº¡t Ä‘á»™ng, implement cá»§a sidekiq.</p><h2 id=2-how-to-reliability>2. How to Reliability?</h2><h3 id=21-sidekiq-client>2.1 Sidekiq client</h3><p>Khi sidekiq client push má»™t job tá»›i redis, giáº£ Ä‘á»‹nh ráº±ng network khÃ´ng hoáº¡t Ä‘á»™ng tá»‘t, dáº«n tá»›i job khÃ´ng thá»ƒ lÆ°u trá»¯ vÃ o redis, váº­y lÃ m sao Ä‘áº£m báº£o Ä‘á»™ tin cáº­y cho sidekiq client? Má»™t hÆ°á»›ng tiáº¿p cáº­n Ä‘Ã³ lÃ  implement má»™t local queue Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c job náº¿u gá»i network fail vÃ  sáº½ delivery khi network káº¿t ná»‘i thÃ nh cÃ´ng. <code>fluentd</code> cÅ©ng cÃ³ má»™t cÃ¡ch tÆ°Æ¡ng tá»± gá»i lÃ  buffer, logstash cÅ©ng cÃ³ cÃ¡ch giáº£i quyáº¿t tÆ°Æ¡ng tá»± lÃ  <em>persistent queue</em>. Tuy nhiÃªn nÃ³ cÅ©ng cÃ³ má»™t sá»‘ nhÆ°á»£c Ä‘iá»ƒm:</p><ul><li>local queue per-process vÃ  in-memory, náº¿u client process bá»‹ restart thÃ¬ job váº«n bá»‹ máº¥t.</li><li>sidekiq chá»‰ lÆ°u 1000 job cuá»‘i cÃ¹ng Ä‘á»ƒ trÃ¡nh lÆ°u quÃ¡ nhiá»u dáº«n tá»›i full mem.</li></ul><h3 id=22-redis>2.2 Redis</h3><p>Redis Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ cÃ¡c job cáº§n xá»­ lÃ½, náº¿u storage fail ta máº¥t táº¥t cáº£ cÃ¡c job chÆ°a ká»‹p xá»­ lÃ½ vÃ  ngÆ°á»i dÃ¹ng sáº½ khÃ´ng nháº­n Ä‘Æ°á»£c thá»© mÃ  há» cáº§n.</p><p>CÃ¢u há»i lÃ  táº¡i sao láº¡i lÃ  redis chá»© khÃ´ng pháº£i cÃ¡i gÃ¬ khÃ¡c? VÃ  lÃ m sao Ä‘áº£m báº£o dÃ¹ fail cÅ©ng pháº£i Ä‘áº£m báº£o tÃ¡c vá»¥ cá»§a ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c xá»­ lÃ½.</p><ul><li>Redis cÃ³ tá»‘c Ä‘á»™ read/write operation ráº¥t tá»‘t so vá»›i cÃ¡c storage khÃ¡c nhÆ° MySQL nÃªn dÃ¹ng redis lá»£i hÆ¡n vá» máº·t tá»‘c Ä‘á»™ (Gearman cÃ³ há»— trá»£ persistent vÃ o MySQL vÃ  memcached)</li><li>Náº¿u so vá»›i memcached thÃ¬ redis há»— trá»£ nhiá»u kiá»ƒu dá»¯ liá»‡u hÆ¡n vÃ  váº«n cÃ³ cÆ¡ cháº¿ persistent dá»¯ liá»‡u xuá»‘ng Ä‘Ä©a cá»©ng Ä‘á»‹nh ká»³, táº¥t nhiÃªn náº¿u redis fail mÃ  chÆ°a ká»‹p persistent dá»¯ liá»‡u xuá»‘ng thÃ¬ váº«n máº¥t job tuy nhiÃªn vÃ¹ng dá»¯ liá»‡u bá»‹ máº¥t sáº½ nhá» hÆ¡n.</li><li>Tuy nhiÃªn náº¿u redis server cháº¿t háº³n thÃ¬ sidekiq client sáº½ khÃ´ng thá»ƒ Ä‘áº©y job vÃ o redis Ä‘Æ°á»£c, cÃ³ nghÄ©a lÃ  ngÆ°á»i dÃ¹ng váº«n bá»‹ stuck. LÃºc nÃ y ta cÃ³ thá»ƒ sá»­ dá»¥ng redis sentinel (master-slave) vá»«a Ä‘áº£m báº£o viá»‡c persistent job vá»«a Ä‘áº£m báº£o failover náº¿u 1 server cháº¿t.</li><li>Redis cháº¡y á»•n khi táº¥t cáº£ data fit vá»«a vá»›i memory, náº¿u full mem redis sáº½ evict data theo policy mÃ  ta cáº¥u hÃ¬nh, vÃ­ dá»¥ LRU -> máº¥t cÃ¡c job cÅ© chÆ°a ká»‹p xá»­ lÃ½ nÃªn Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng evict nháº§m nÃªn cáº¥u hÃ¬nh redis <code>maxmemory-policy noeviction</code>.</li><li>Redis thÆ°á»ng Ä‘Æ°á»£c xÃ i Ä‘á»ƒ cache dá»¯ liá»‡u, tuy nhiÃªn báº£n cháº¥t cá»§a viá»‡c cache vÃ  storage job lÃ  khÃ¡c nhau (cache cÃ³ thá»ƒ invalidate nhÆ°ng job thÃ¬ khÃ´ng Ä‘Æ°á»£c máº¥t), nÃªn tá»‘t nháº¥t lÃ  xÃ i tÃ¡ch rá»i 2 server redis cho viá»‡c cache vÃ  lÆ°u job sidekiq.</li><li>Má»™t lÃ½ do ná»¯a nÃªn tÃ¡ch redis dÃ¹ng cho cache vÃ  redis dÃ¹ng Ä‘á»ƒ storage backgroud job cho sidekiq lÃ  timeout. Khi full mem, Ä‘á»ƒ khÃ´ng bá»‹ OOM redis sáº½ xÃ i tá»›i swap -> disk swapping -> tÄƒng Ä‘á»™ trá»… khi Ä‘á»c dá»¯ liá»‡u. Hoáº·c náº¿u cÃ³ cÃ¡c command latency trÃªn redis mÃ  tá»‘n thá»i gian cÅ©ng gÃ¢y ra Ä‘á»™ trá»… khi pull job.</li></ul><h3 id=23-sidekiq-server>2.3 Sidekiq server</h3><p>CÃ¢u há»i Ä‘áº·t ra lÃ :</p><ul><li>Náº¿u sidekiq xá»­ lÃ½ liÃªn tá»¥c thÃ¬ lÃ m sao Ä‘á»ƒ restart sidekiq khi má»™t job Ä‘ang Ä‘Æ°á»£c sidekiq xá»­ lÃ½?</li><li>Náº¿u job bá»‹ lá»—i, exception thÃ¬ cÆ¡ cháº¿ nÃ o Ä‘á»ƒ retry?</li><li>Náº¿u sidekiq server Ä‘ang xá»­ lÃ½ má»™t job, nhÆ°ng bá»‹ segfault hoáº·c crash hoáº·c force kill (kill -9) thÃ¬ lÃ m sao Ä‘áº£m báº£o job váº«n sáº½ Ä‘Æ°á»£c xá»­ lÃ½.</li></ul><p>Vá» cÃ¢u há»i Ä‘áº§u tiÃªn, Ä‘Ã¢y lÃ  má»™t Ä‘iá»ƒm khÃ¡ thÃº vÃ­ vá» cÃ¡ch thiáº¿t káº¿, náº¿u ai quen vá»›i nginx sáº½ tháº¥y má»™t cÆ¡ cháº¿ tÆ°Æ¡ng tá»±. Pháº§n giáº£i thÃ­ch nÃ y thá»±c cháº¥t lÃ  pháº§n <a href=https://github.com/mperham/sidekiq/wiki/Signals>Signals</a> trong wiki cá»§a Sidekiq.</p><ul><li>Khi ta gá»­i TSTP signal tá»›i sidekiq (<code>kill -TSTP [sidekiq_pid]</code>), Sidekiq sáº½ hiá»ƒu lÃ  nÃ³ sáº½ bá»‹ shutdown trong tÆ°Æ¡ng lai gáº§n, sidekiq sáº½ chuyá»ƒn sang tráº¡ng thÃ¡i &ldquo;quiet&rdquo; nghÄ©a lÃ  nÃ³ sáº½ dá»«ng viá»‡c fetch new job tá»« redis nhÆ°ng váº«n tiáº¿p tá»¥c xá»­ lÃ½ cÃ¡c job mÃ  nÃ³ Ä‘ang giá»¯, khi táº¥t cáº£ cÃ¡c current job Ä‘Æ°á»£c xá»­ lÃ½ xong thÃ¬ sidekiq sáº½ shutdown.</li><li>TERM signal nghÄ©a lÃ  Sidekiq nÃªn shutdown sau khoáº£ng thá»i thá»i gian <code>-t</code> timeout. TÆ°Æ¡ng tá»± nhÆ° <code>TSTP</code> sidekiq cÅ©ng sáº½ khÃ´ng fetch job má»›i nhÆ°ng váº«n tiáº¿p tá»¥c xá»­ lÃ½ cÃ¡c job cÅ© cho xong. Äiá»ƒm khÃ¡c biá»‡t lÃ  sau timeout náº¿u job khÃ´ng Ä‘Æ°á»£c <strong>hoÃ n thÃ nh</strong> thÃ¬ sáº½ bá»‹ force terminated vÃ  message Ä‘Ã³ sáº½ Ä‘Æ°á»£c <strong>push back</strong> láº¡i vÃ o redis, Ä‘á»ƒ láº§n sau khi sidekiq Ä‘Æ°á»£c start job Ä‘Ã³ sáº½ Ä‘Æ°á»£c fetch láº¡i vÃ  Ä‘Æ°á»£c xá»­ lÃ½.</li></ul><p>=> Best practice lÃ  ta sáº½ gá»­i signal <code>TSTP</code> lÃºc báº¯t Ä‘áº§u deploy vÃ  <code>TERM</code> lÃºc káº¿t thÃºc deploy. VÃ  lÃºc nÃ y cÃ³ thá»ƒ thoáº£i mÃ¡i restart mÃ  khÃ´ng sá»£ bá»‹ miss báº¥t cá»© job nÃ o.</p><p>Sidekiq cÃ³ built-in má»™t chÆ¡ cháº¿ Ä‘á»ƒ retry, sáº½ catch cÃ¡c exception vÃ  tá»± Ä‘á»™ng retry thÆ°á»ng xuyÃªn dá»±a trÃªn cÃ´ng thá»©c <code>(retry_count ** 4) + 15 + (rand(30) * (retry_count + 1))</code> (tÆ°Æ¡ng Ä‘Æ°Æ¡ng 15, 16, 31, 96, 271, &mldr; giÃ¢y + má»™t lÆ°á»£ng random time), vá»›i giÃ¡ trá»‹ <a href=https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/job_retry.rb#L63>default retry lÃ  25</a> nghÄ©a lÃ  Ä‘á»ƒ thá»±c hiá»‡n 25 láº§n retry sáº½ vÃ o khoáº£ng 21 ngÃ y, trong 21 ngÃ y nÃ y ta cÃ³ thá»ƒ fix bug, deploy vÃ  job sáº½ Ä‘Æ°á»£c xá»­ lÃ½ thÃ nh cÃ´ng á»Ÿ láº§n retry tiáº¿p theo.</p><p>Náº¿u sau 25 láº§n retry vÃ  job váº«n khÃ´ng thÃ nh cÃ´ng thÃ¬ sidekiq sáº½ chuyá»ƒn job Ä‘Ã³ vÃ  Dead Job queue vÃ  pháº£i can thiá»‡p thá»§ cÃ´ng Ä‘á»ƒ cháº¡y láº¡i job Ä‘Ã³. VÃ  náº¿u sau 6 thÃ¡ng, job Ä‘Ã³ khÃ´ng Ä‘Æ°á»£c xá»­ lÃ½ thÃ¬ sidekiq sáº½ discard job Ä‘Ã³.</p><p>Vá» cÃ¢u há»i cuá»‘i, lÃ m tháº¿ nÃ o Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh tin cáº­y cho má»™t job khi Ä‘Æ°á»£c fetch bá»Ÿi sidekiq server, vÃ  sidekiq server bá»‹ crash thÃ¬ job Ä‘Ã³ váº«n cÃ³ thá»ƒ Ä‘Æ°á»£c xá»­ lÃ½. ÄÃ¢y lÃ  má»™t bÃ i toÃ¡n ráº¥t thÃº vá»‹ Ä‘á»ƒ tÃ¬m hiá»ƒu vÃ  qua Ä‘Ã³ ta sáº½ tháº¥y sá»©c máº¡nh cá»§a redis.</p><p>TrÆ°á»›c tiÃªn ta sáº½ nÃ³i 1 chÃºt xÃ­u vá» list vÃ  queue trong redis. Trong redis thÃ¬ list lÃ  má»™t táº­p há»£p cá»§a cÃ¡c pháº§n tá»­ cÃ³ kiá»ƒu dá»¯ liá»‡u lÃ  string Ä‘Ã£ Ä‘Æ°á»£c sáº¯p xáº¿p báº±ng thuáº­t toÃ¡n insertion sort. List trong redis Ä‘Æ°á»£c implement báº±ng cáº¥u trÃºc dá»¯ liá»‡u lÃ  <a href=https://redis.io/topics/data-types-intro>linked list</a>.</p><p>Redis há»— trá»£ má»™t sá»‘ lá»‡nh trÃªn list nhÆ° <code>LPUSH, RPUSH, LPOP, RPOP, LLEN, LINSERT, LINDEX</code>, vá»›i táº­p lá»‡nh nÃ y ta cÃ³ thá»ƒ dÃ¹ng list trong redis nhÆ° queue (FIFO vá»›i táº­p lá»‡nh LPUSH, RPOP, pháº§n tá»­ thÃªm vÃ o Ä‘áº§u tiÃªn sáº½ Ä‘Æ°á»£c láº¥y ra Ä‘áº§u tiÃªn) hoáº·c stack (LIFO vá»›i táº­p lá»‡nh RPUSH, LPOP, pháº§n tá»­ thÃªm vÃ o Ä‘áº§u tiÃªn sáº½ Ä‘Æ°á»£c láº¥y ra sau cÃ¹ng).</p><p>Báº±ng cÃ¡ch sá»­ dá»¥ng list nhÆ° queue ta cÃ³ thá»ƒ implement producer Ä‘á»ƒ Ä‘áº©y dá»¯ liá»‡u vÃ  consumer Ä‘á»ƒ láº¥y dá»¯ liá»‡u tá»« trong queue ra vá»›i 2 step Ä‘Æ¡n giáº£n:</p><ul><li>push item vÃ o list, producer gá»i LPUSH.</li><li>láº¥y item trong list, Ä‘em ra xá»­ lÃ½, consumer gá»i RPOP.</li></ul><p>Váº¥n Ä‘á» lÃ  khÃ´ng pháº£i lÃºc nÃ o list cá»§a chÃºng ta cÅ©ng cÃ³ pháº§n tá»­, vÃ  khi list khÃ´ng cÃ³ pháº§n tá»­ thÃ¬ sáº½ consumer sáº½ khÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ xá»­ lÃ½ cáº£, lá»‡nh RPOP tráº£ vá» <code>nil</code>.</p><pre tabindex=0><code>127.0.0.1:6379&gt; LPUSH sidekiq a b c
(integer) 3
127.0.0.1:6379&gt; LLEN sidekiq
(integer) 3
127.0.0.1:6379&gt; RPOP sidekiq
&#34;a&#34;
127.0.0.1:6379&gt; RPOP sidekiq
&#34;b&#34;
127.0.0.1:6379&gt; RPOP sidekiq
&#34;c&#34;
127.0.0.1:6379&gt; RPOP sidekiq
(nil)
</code></pre><p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» trÃªn, ta cÃ³ thá»ƒ báº¯t consumer Ä‘á»£i trong má»™t khoáº£ng thá»i gian nÃ o Ä‘Ã³ vÃ  sau Ä‘Ã³ sáº½ gá»i láº¡i LPOP Ä‘á»ƒ láº¥y dá»¯ liá»‡u, ká»¹ thuáº­t nÃ y gá»i lÃ  <em>polling</em>. Tuy nhiÃªn ká»¹ thuáº­t nÃ y váº«n cÃ³ nhÆ°á»£c Ä‘iá»ƒm:</p><ul><li>Náº¿u láº§n gá»i láº¡i RPOP Ä‘á»ƒ láº¥y dá»¯ liá»‡u mÃ  list váº«n rá»—ng nghÄ©a lÃ  consumer tá»‘n cÃ´ng xá»­ lÃ½ má»™t lá»‡nh vÃ´ nghÄ©a vÃ  redis server cÅ©ng tá»‘n cÃ´ng xá»­ lÃ½ mÃ  khÃ´ng Ä‘áº¡t Ä‘Æ°á»£c káº¿t quáº£ gÃ¬.</li><li>TÄƒng thá»i gian Ä‘á»ƒ gá»i láº¡i RPOP láº¥y dá»¯ liá»‡u, nghÄ©a lÃ  sau khi consumer nháº­n vá» <code>nil</code> thÃ¬ sáº½ Ä‘á»£i má»™t khoáº£ng thá»i gian rá»“i má»›i RPOP láº¡i. Tuy nhiÃªn delay-time mÃ  cao thÃ¬ cÃ³ thá»ƒ sáº½ cÃ³ má»™t lÆ°á»£ng lá»›n item Ä‘Æ°á»£c push vÃ o list rá»“i mÃ  delay-time mÃ  quÃ¡ ngáº¯n thÃ¬ láº¡i quay vá» váº¥n Ä‘á» sá»‘ 1, gá»i lá»‡nh vÃ´ nghÄ©a.</li></ul><p>Do Ä‘Ã³ redis implement má»™t sá»‘ lá»‡nh gá»i lÃ  blocking operation Ä‘Ã³ lÃ  BLPOP vÃ  BRPOP. NghÄ©a lÃ  náº¿u list rá»—ng, thay vÃ¬ tráº£ vá» <code>nil</code> thÃ¬ consumer sáº½ block connection vÃ  chá» vá»›i má»™t khoáº£ng thá»i gian timeout (ta cÃ³ thá»ƒ chá» vÃ´ táº­n báº±ng cÃ¡ch set timeout = 0), khi cÃ³ má»™t item má»›i Ä‘Æ°á»£c thÃªm vÃ o list thÃ¬ POP ra vÃ  xá»­ lÃ½. Äiá»ƒm khÃ¡c biá»‡t lÃ  khÃ´ng cáº§n pháº£i Ä‘á»‹nh ká»³ quay trá»Ÿ láº¡i kiá»ƒm tra -> trÃ¡nh thá»±c hiá»‡n cÃ¡c lá»‡nh vÃ´ nghÄ©a.</p><p>Quay trá»Ÿ láº¡i váº¥n Ä‘á» cá»§a sidekiq server, sidekiq dÃ¹ng lá»‡nh <code>BRPOP</code> Ä‘á»ƒ fetch má»™t job tá»« trong queue redis ra vÃ  xá»­ lÃ½, khÃ´ng cÃ³ gÃ¬ pháº£i bÃ n cÃ£i vá» viá»‡c táº¡i sao láº¡i dÃ¹ng <code>BRPOP</code> ná»¯a, tuy nhiÃªn viá»‡c dÃ¹ng <code>BRPOP</code> hay <code>RPOP</code> bá»‹ má»™t váº¥n Ä‘á» lÃ  sau khi sidekiq fetch job thÃ¬ <strong>job Ä‘Ã³ khÃ´ng cÃ²n tá»“n táº¡i trong redis</strong>. VÃ  bÃ¢y giá», náº¿u sidekiq crash, job vá»«a Ä‘Æ°á»£c fetch ra, chÆ°a ká»‹p xá»­ lÃ½ sáº½ biáº¿n máº¥t hoÃ n toÃ n.</p><p>TÃ³m láº¡i, Ä‘en thÃ´i, Ä‘á» quÃªn Ä‘i, náº¿u quay trá»Ÿ láº¡i váº¥n Ä‘á» restart, sidekiq cÃ³ shutdown thÃ¬ váº«n cÃ³ thá»ƒ <code>push-back</code> job láº¡i vá» redis chá»© Ä‘Ã£ crash giá»¯a Ä‘Æ°á»ng job sáº½ khÃ´ng cÃ³ cÃ¡ch nÃ o cá»©u chá»¯a.</p><p>Váº­y thá»­ nghÄ© xem cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh tin cáº­y khi xá»­ lÃ½ job, theo cÃ¡ch suy nghÄ© thÃ´ng thÆ°á»ng thÃ¬ ÄÆ N GIáº¢N lÃ  khi fetch job thÃ¬ Ä‘á»«ng XÃ“A job Ä‘Ã³ ra khá»i queue cá»§a redis. Tuy nhiÃªn nÃ³ dáº«n tá»›i má»™t váº¥n Ä‘á» khÃ¡c Ä‘Ã³ lÃ  má»™t sidekiq server khÃ¡c cÃ³ thá»ƒ <strong>nhÃ¬n tháº¥y</strong> job Ä‘Ã³, fetch ra vÃ  xá»­ lÃ½ job Ä‘Ã³. Há»‡ quáº£ lÃ  job Ä‘Æ°á»£c xá»­ lÃ½ 2 láº§n, náº¿u báº¡n gá»­i mail thÃ¬ cÃ³ nghÄ©a lÃ  ngÆ°á»i dÃ¹ng sáº½ nháº­n Ä‘Æ°á»£c 2 email cÃ³ cÃ¹ng ná»™i dung.</p><p>Má»™t cÃ¡ch tiáº¿p cáº­n khÃ¡c lÃ  thay vÃ¬ giá»¯ job Ä‘Ã³ trong queue thÃ¬ ta váº«n cá»© fetch job Ä‘Ã³ ra nhÆ°ng sau Ä‘Ã³ sáº½ push job Ä‘Ã³ vÃ o má»™t queue khÃ¡c gá»i lÃ  <code>queue_Ä‘ang_xá»­_lÃ½</code>. ÄÃ¢y chÃ­nh xÃ¡c lÃ  cÃ¡ch lá»‡nh <code>RPOPLPUSH</code> trong redis hoáº¡t Ä‘á»™ng, <a href=https://redis.io/commands/rpoplpush>reliable queue pattern</a>. Lá»‡nh nÃ y:</p><ul><li>Fetch vÃ  xÃ³a last-item (tail) tá»« queue cÅ© vÃ  cÃ¹ng thá»i Ä‘iá»ƒm Ä‘Ã³ thÃªm item Ä‘Ã³ Ä‘áº§u má»™t queue khÃ¡c -> gá»i lÃ  <em>processing_queue</em> (head).</li><li>Atomically return nghÄ©a lÃ  hoáº¡t Ä‘á»™ng nhÆ° transaction trong database, 1 lÃ  thÃ nh cÃ´ng thÃ¬ commit (xÃ³a tá»« queue cÅ© vÃ  thÃªm vÃ o queue má»›i), 2 lÃ  fail thÃ¬ rollback, tráº£ job vá» láº¡i queue cÅ©.</li><li>DÃ¹ng lá»‡nh <code>LREM</code> theo thá»© tá»± Ä‘á»ƒ xÃ³a item trong <em>processing_queue</em> má»™t khi item Ä‘Ã³ Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ xong</li></ul><pre tabindex=0><code>127.0.0.1:6379&gt; LPUSH sidekiq a b c
(integer) 3
127.0.0.1:6379&gt; RPOPLPUSH sidekiq sidekiq_current_processing
&#34;a&#34;
127.0.0.1:6379&gt; LRANGE sidekiq 0 -1
1) &#34;c&#34;
2) &#34;b&#34;
127.0.0.1:6379&gt; LRANGE sidekiq_current_processing 0 -1
1) &#34;a&#34;
</code></pre><p>Vá»›i Sidekiq Pro, Ä‘á»ƒ Ä‘áº£m báº£o tÃ­nh tin cáº­y thÃ¬ thay vÃ¬ dÃ¹ng <code>fetch</code> ta cÃ³ hÃ m <code>super_fetch</code> sá»­ dá»¥ng <code>RPOPLPUSH</code> nhÆ° cÃ¡ch á»Ÿ trÃªn.</p><h3 id=24-others>2.4 Others</h3><p>Máº·c Ä‘á»‹nh, sidekiq sá»­ dá»¥ng duy nháº¥t má»™t queue lÃ  <code>default</code> trong redis. Náº¿u muá»‘n sá»­ dá»¥ng nhiá»u queue thÃ¬ chá»‰ viá»‡c Ä‘á»‹nh nghÄ©a thÃªm queue, vÃ  váº¥n Ä‘á» tiáº¿p theo lÃ  lÃ m tháº¿ nÃ o Ä‘á»ƒ biáº¿t queue nÃ o Ä‘Æ°á»£c Æ°u tiÃªn xá»­ lÃ½.</p><p>VÃ­ dá»¥ ta cÃ³ 2 queue sau:</p><pre tabindex=0><code>sidekiq -q critical,2 -q default
</code></pre><p>Chá»‰ sá»‘ phÃ­a sau queue gá»i lÃ  weight cá»§a queue, queue <code>critical</code> sáº½ Ä‘Æ°á»£c check/fetch 2 láº§n so vá»›i queue default cÃ³ weight lÃ  1.</p><p>Hoáº·c náº¿u muá»‘n xá»­ lÃ½ job theo thá»© tá»± khai bÃ¡o, Ä‘Æ¡n giáº£n lÃ  Ä‘á»‹nh nghÄ©a queue khÃ´ng cÃ³ trá»ng sá»‘</p><pre tabindex=0><code>sidekiq -q critical -q default -q low
</code></pre><p>=> NghÄ©a lÃ  job trong <code>default</code> queue chá»‰ Ä‘Æ°á»£c xá»­ lÃ½ khi <code>critical</code> queue rá»—ng.</p><p>Má»™t sá»‘ váº¥n Ä‘á» khÃ¡c vá» bao nhiÃªu queue lÃ  Ä‘á»§, concurrent cá»§a sidekiq bao nhiÃªu lÃ  há»£p lÃ½ cÃ³ thá»ƒ tÃ¬m tháº¥y trong <a href=https://github.com/mperham/sidekiq/wiki/Advanced-Options#concurrency>wiki sidekiq</a></p><h2 id=3-chá»‘t>3. Chá»‘t</h2><p>NhÆ°ng tui Ä‘Ã¢u cÃ³ biáº¿t Ruby Ä‘Ã¢u, váº­y táº¡i sao tui pháº£i Ä‘á»c bÃ i nÃ y lÃ m chi? Thá»±c ra má»¥c Ä‘Ã­ch ban Ä‘áº§u cá»§a mÃ¬nh lÃ  tÃ¬m hiá»ƒu má»™t sá»‘ váº¥n Ä‘á» cá»§a sidekiq nhÆ° bao nhiÃªu queue lÃ  Ä‘á»§, bao nhiÃªu sidekiq process hoáº·c táº¡i sao láº¡i timeout nhÆ°ng sau khi tÃ¬m hiá»ƒu xong há»c thÃªm Ä‘c khÃ¡ nhiá»u thá»© hay ho vá» cÃ¡ch thiáº¿t káº¿, implement vÃ  má»™t sá»‘ khÃ¡i niá»‡m má»›i:</p><ul><li>list/queue/blockingqueue vÃ  cÃ¡ch redis implement</li><li>Reliable queue</li><li>polling vÃ  long-polling</li></ul><p>NgoÃ i ra, sau khi Ä‘á»c bÃ i nÃ y báº¡n cÅ©ng sáº½ hiá»ƒu má»™t sá»‘ metric cáº§n thiáº¿t cho viá»‡c monitor nháº±m Ä‘áº£m báº£o tÃ­nh tin cáº­y cho xá»­ lÃ½ backgroud job, vÃ­ dá»¥ má»™t sá»‘ metric cáº§n lÆ°u Ã½ nhÆ°:</p><ul><li>á» phÃ­a client pháº£i alert trong trÆ°á»ng há»£p network fail khÃ´ng thá»ƒ connect tá»›i queue.</li><li>á» redis queue pháº£i Ä‘áº£m báº£o ráº±ng redis luÃ´n availability, ngoÃ i ra cáº§n monitor thÃªm vá» sá»‘ lÆ°á»£ng job in queue, náº¿u sá»‘ lÆ°á»£ng job trong queue vÆ°á»£t ngÆ°á»¡ng nÃ o Ä‘Ã³ cÃ³ nghÄ©a lÃ  worker Ä‘ang bá»‹ stuck hoáº·c sá»‘ worker khÃ´ng Ä‘á»§ Ä‘á»ƒ xá»­ lÃ½ Ä‘á»§ lÆ°á»£ng job enqueue hoáº·c táº¥t cáº£ worker Ä‘á»u Ä‘ang cháº¿t.</li><li>á» Worker cáº§n pháº£i monitor worker sá»‘ng hay cháº¿t, vÃ  pháº£i monitor thÃªm vá» thá»i gian xá»­ lÃ½ cÃ¡c job, tá»« Ä‘Ã¢y sáº½ biáº¿t cÃ¡ch Ä‘á»ƒ tÄƒng sá»‘ worker hay tá»‘i Æ°u láº¡i xá»­ lÃ½.</li></ul><h2 id=4-ref>4. Ref</h2><ul><li><a href=https://github.com/mperham/sidekiq/wiki>https://github.com/mperham/sidekiq/wiki</a></li><li><a href=https://redis.io/topics/data-types-intro>https://redis.io/topics/data-types-intro</a></li><li><a href=https://redis.io/commands/blpop>https://redis.io/commands/blpop</a></li><li><a href=https://redis.io/commands/rpoplpush>https://redis.io/commands/rpoplpush</a></li><li><a href=https://docs.microsoft.com/en-us/azure/architecture/best-practices/background-jobs>https://docs.microsoft.com/en-us/azure/architecture/best-practices/background-jobs</a></li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://taoquangne.com/post/build-simple-bg-job-with-rabbitmq/><span class=button__icon>â†</span>
<span class=button__text>Build a simple background job with RabbitMQ</span>
</a></span><span class="button next"><a href=https://taoquangne.com/post/rails-for-devops-engineer/><span class=button__text>Rails for DevOps engineer</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href=https://creativecommons.org/licenses/by-nc/4.0>giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://taoquangne.com/assets/main.js></script><script src=https://taoquangne.com/assets/prism.js></script></div></body></html>