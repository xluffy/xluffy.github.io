<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Sidekiq, how to reliability? ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Th√¥ng th∆∞·ªùng, khi x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web, quy tr√¨nh ƒë∆°n gi·∫£n s·∫Ω nh∆∞ sau:"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/sidekiq-how-to-reliability/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Sidekiq, how to reliability?"/>
<meta name="twitter:description" content="Th√¥ng th∆∞·ªùng, khi x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web, quy tr√¨nh ƒë∆°n gi·∫£n s·∫Ω nh∆∞ sau:"/>



<meta property="og:title" content="Sidekiq, how to reliability?" />
<meta property="og:description" content="Th√¥ng th∆∞·ªùng, khi x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web, quy tr√¨nh ƒë∆°n gi·∫£n s·∫Ω nh∆∞ sau:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/sidekiq-how-to-reliability/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-07-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-07-26T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Sidekiq, how to reliability?</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-07-26
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/rails/">#rails</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/sidekiq/">#sidekiq</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Th√¥ng th∆∞·ªùng, khi x√¢y d·ª±ng m·ªôt ·ª©ng d·ª•ng web, quy tr√¨nh ƒë∆°n gi·∫£n s·∫Ω nh∆∞ sau:</p>
<ul>
<li>Ng∆∞·ªùi d√πng g·ª≠i y√™u c·∫ßu, request t·ªõi web application.</li>
<li>Web application nh·∫≠n request, x·ª≠ l√Ω (ho·∫∑c intergration v·ªõi service kh√°c nh∆∞ database ƒë·ªÉ x·ª≠ l√Ω).</li>
<li>Cu·ªëi c√πng tr·∫£ v·ªÅ k·∫øt qu·∫£ cho user.</li>
</ul>
<p>V√≠ d·ª• trong th·ª±c t·∫ø, b·∫°n ƒëƒÉng k√Ω user ·ªü m·ªôt website n√†o ƒë√≥, sau khi nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin, submit -&gt; request s·∫Ω ƒë∆∞·ª£c g·ª≠i l√™n server v√† ng∆∞·ªùi d√πng s·∫Ω <strong>ch·ªù</strong> cho t·ªõi khi server x·ª≠ l√Ω xong v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ (th√†nh c√¥ng ho·∫∑c th·∫•t b·∫°i). Do ng∆∞·ªùi d√πng ph·∫£i <strong>ch·ªù</strong> n√™n ta g·ªçi ƒë√≥ l√† synchronous task.</p>
<p>Tuy nhi√™n trong th·ª±c t·∫ø, kh√¥ng ph·∫£i l√∫c n√†o web app c≈©ng x·ª≠ l√Ω nhanh ho·∫∑c kh√¥ng ph·∫£i l√∫c n√†o ch√∫ng ta c≈©ng c·∫ßn <strong>ph·∫£n h·ªìi ngay l·∫≠p t·ª©c</strong> k·∫øt qu·∫£ cho ng∆∞·ªùi d√πng. V√≠ d·ª• sau khi ƒëƒÉng k√Ω ta c√≥ g·ª≠i email th√¥ng b√°o t·ªõi cho ng∆∞·ªùi d√πng, nh∆∞ng kh√¥ng nh·∫•t thi·∫øt ph·∫£i g·ª≠i email <strong>ngay l·∫≠p t·ª©c</strong> cho ng∆∞·ªùi d√πng, c√≥ th·ªÉ ch·∫≠m 1-2 ph√∫t c≈©ng ch·∫•p nh·∫≠n ƒë∆∞·ª£c ho·∫∑c v√≠ d·ª• c√°c t√°c v·ª• resize, optimize ·∫£nh do ng∆∞·ªùi d√πng upload th∆∞·ªùng t·ªën nhi·ªÅu th·ªùi gian, n·∫øu ƒë·ªÉ user ch·ªù ·ªü m√†n h√¨nh upload c≈©ng kh√¥ng ph·∫£i l√† c√°ch hay.</p>
<p>Nh·ªØng t√°c v·ª• nh∆∞ v·∫≠y ta c√≥ th·ªÉ ƒë∆∞a v√†o ch·∫°y n·ªÅn hay c√≤n g·ªçi l√† backgroud job/asynchronous job. Gi√∫p tr√°nh b·∫Øt ng∆∞·ªùi d√πng ph·∫£i ch·ªù ƒë·ª£i l√¢u m√† v·∫´n ƒë·∫£m b·∫£o l√† s·∫Ω x·ª≠ l√Ω t√°c v·ª• ƒë√≥ cho ng∆∞·ªùi d√πng.</p>
<p>M√¥ h√¨nh chung s·∫Ω nh∆∞ sau:</p>
<p><img src="https://drivy.engineering/assets/posts/2015-10-12-taskqueues-go-wild/taskqueues.svg" alt="task-queue"></p>
<p><em>image source from <a href="https://drivy.engineering/taskqueues-tips">https://drivy.engineering/taskqueues-tips</a></em></p>
<ul>
<li>Broker l√† m·ªôt queue v√≠ d·ª• nh∆∞ redis, RabbitMQ.</li>
<li>App s·∫Ω enqueue c√°c t√°c v·ª• c·∫ßn x·ª≠ l√Ω background t√πy v√†o t·ª´ng request.</li>
<li>CRON s·∫Ω enqueue c√°c bg job ƒë·ªãnh k·ª≥ v√†o nh·ªØng th·ªùi ƒëi·ªÉm c·ª• th·ªÉ.</li>
<li>Worker s·∫Ω dequeue v√† x·ª≠ l√Ω c√°c t√°c v·ª• ƒë√≥.</li>
</ul>
<p>Sidekiq l√† m·ªôt background processing framework cho ng√¥n ng·ªØ Ruby ƒë·ªÉ gi·∫£i quy·∫øt c√°c b√†i to√°n t∆∞∆°ng t·ª± nh∆∞ tr√™n. X·ª≠ l√Ω background kh√¥ng ph·∫£i l√† b√†i to√°n m·ªõi, b·∫•t k·ª≥ ng√¥n ng·ªØ l·∫≠p tr√¨nh n√†o c≈©ng c√≥ nh·ªØng c√°ch gi·∫£i quy·∫øt t∆∞∆°ng t·ª±, v·ªÅ job queue c≈©ng c√≥ r·∫•t nhi·ªÅu l·ª±a ch·ªçn kh√°c nhau v√≠ d·ª• <a href="http://gearman.org">Gearmand</a>, <a href="http://www.celeryproject.org">Celery</a>, <a href="http://python-rq.org">rq</a>.</p>
<p>C√°c x·ª≠ l√Ω m√† s·∫Ω ph√π h·ª£p ƒë·ªÉ ƒë∆∞a v√†o ch·∫°y n·ªÅn bao g·ªìm:</p>
<ul>
<li>C√°c x·ª≠ l√Ω n·∫∑ng v·ªÅ CPU, v√≠ d·ª• c√°c ph√©p t√≠nh to√°n h·ªçc ho·∫∑c ph√¢n t√≠ch c·∫•u tr√∫c.</li>
<li>C√°c x·ª≠ l√Ω n·∫∑ng v·ªÅ I/O v√≠ d·ª• load data t√≠nh to√°n report, ETL.</li>
<li>Batch job v√≠ d·ª• nh∆∞ update/processing report v·ªÅ ƒë√™m.</li>
<li>&hellip;</li>
</ul>
<h2 id="1-sidekiq-architecture">1. Sidekiq Architecture</h2>
<p>Sidekiq g·ªìm 3 ph·∫ßn ch√≠nh:</p>
<ul>
<li>Sidekiq client ch·∫°y tr√™n b·∫•t k·ª≥ Ruby process n√†o ƒë√≥ v√≠ d·ª• nh∆∞ <code>puma</code> ho·∫∑c <code>passsenger</code> cho ph√©p <strong>t·∫°o</strong> job ƒë·ªÉ x·ª≠ l√Ω sau.</li>
<li>Redis l√† data storage cho sidekiq, d√πng ƒë·ªÉ l∆∞u tr·ªØ c√°c job ƒë∆∞·ª£c ƒë·∫©y xu·ªëng t·ª´ sidekiq client.</li>
<li>Sidekiq server l√† m·ªôt process ƒë·ªôc l·∫≠p, <strong>pull job</strong> t·ª´ queue trong Redis v√† x·ª≠ l√Ω.</li>
</ul>
<p><img src="https://brandonhilkert.com/images/sidekiq/rails-web-worker.png" alt="sidekiq-flow">
<em>image source from <a href="https://brandonhilkert.com/blog/sidekiq-as-a-microservice-message-queue">https://brandonhilkert.com/blog/sidekiq-as-a-microservice-message-queue</a></em></p>
<p>ƒê·ª©ng ·ªü g√≥c ƒë·ªô v·∫≠n h√†nh h·ªá th·ªëng, m√¨nh ch·ªâ quan t√¢m chuy·ªán g√¨ x·∫£y ra khi b·∫•t c·ª© th√†nh ph·∫ßn tr√™n fail v√† l√†m c√°ch n√†o ƒë·ªÉ ƒë·∫£m b·∫£o h·ªá th·ªëng c√≥ kh·∫£ nƒÉng fail-over. ƒê·ªÉ tr·∫£ l·ªùi c√¢u h·ªèi ƒë√≥ th√¨ c·∫ßn ph·∫£i hi·ªÉu c√°ch ho·∫°t ƒë·ªông, implement c·ªßa sidekiq.</p>
<h2 id="2-how-to-reliability">2. How to Reliability?</h2>
<h3 id="21-sidekiq-client">2.1 Sidekiq client</h3>
<p>Khi sidekiq client push m·ªôt job t·ªõi redis, gi·∫£ ƒë·ªãnh r·∫±ng network kh√¥ng ho·∫°t ƒë·ªông t·ªët, d·∫´n t·ªõi job kh√¥ng th·ªÉ l∆∞u tr·ªØ v√†o redis, v·∫≠y l√†m sao ƒë·∫£m b·∫£o ƒë·ªô tin c·∫≠y cho sidekiq client? M·ªôt h∆∞·ªõng ti·∫øp c·∫≠n ƒë√≥ l√† implement m·ªôt local queue ƒë·ªÉ l∆∞u tr·ªØ c√°c job n·∫øu g·ªçi network fail v√† s·∫Ω delivery khi network k·∫øt n·ªëi th√†nh c√¥ng. <code>fluentd</code> c≈©ng c√≥ m·ªôt c√°ch t∆∞∆°ng t·ª± g·ªçi l√† buffer, logstash c≈©ng c√≥ c√°ch gi·∫£i quy·∫øt t∆∞∆°ng t·ª± l√† <em>persistent queue</em>. Tuy nhi√™n n√≥ c≈©ng c√≥ m·ªôt s·ªë nh∆∞·ª£c ƒëi·ªÉm:</p>
<ul>
<li>local queue per-process v√† in-memory, n·∫øu client process b·ªã restart th√¨ job v·∫´n b·ªã m·∫•t.</li>
<li>sidekiq ch·ªâ l∆∞u 1000 job cu·ªëi c√πng ƒë·ªÉ tr√°nh l∆∞u qu√° nhi·ªÅu d·∫´n t·ªõi full mem.</li>
</ul>
<h3 id="22-redis">2.2 Redis</h3>
<p>Redis ƒë∆∞·ª£c d√πng ƒë·ªÉ l∆∞u tr·ªØ c√°c job c·∫ßn x·ª≠ l√Ω, n·∫øu storage fail ta m·∫•t t·∫•t c·∫£ c√°c job ch∆∞a k·ªãp x·ª≠ l√Ω v√† ng∆∞·ªùi d√πng s·∫Ω kh√¥ng nh·∫≠n ƒë∆∞·ª£c th·ª© m√† h·ªç c·∫ßn.</p>
<p>C√¢u h·ªèi l√† t·∫°i sao l·∫°i l√† redis ch·ª© kh√¥ng ph·∫£i c√°i g√¨ kh√°c? V√† l√†m sao ƒë·∫£m b·∫£o d√π fail c≈©ng ph·∫£i ƒë·∫£m b·∫£o t√°c v·ª• c·ªßa ng∆∞·ªùi d√πng ƒë∆∞·ª£c x·ª≠ l√Ω.</p>
<ul>
<li>Redis c√≥ t·ªëc ƒë·ªô read/write operation r·∫•t t·ªët so v·ªõi c√°c storage kh√°c nh∆∞ MySQL n√™n d√πng redis l·ª£i h∆°n v·ªÅ m·∫∑t t·ªëc ƒë·ªô (Gearman c√≥ h·ªó tr·ª£ persistent v√†o MySQL v√† memcached)</li>
<li>N·∫øu so v·ªõi memcached th√¨ redis h·ªó tr·ª£ nhi·ªÅu ki·ªÉu d·ªØ li·ªáu h∆°n v√† v·∫´n c√≥ c∆° ch·∫ø persistent d·ªØ li·ªáu xu·ªëng ƒëƒ©a c·ª©ng ƒë·ªãnh k·ª≥, t·∫•t nhi√™n n·∫øu redis fail m√† ch∆∞a k·ªãp persistent d·ªØ li·ªáu xu·ªëng th√¨ v·∫´n m·∫•t job tuy nhi√™n v√πng d·ªØ li·ªáu b·ªã m·∫•t s·∫Ω nh·ªè h∆°n.</li>
<li>Tuy nhi√™n n·∫øu redis server ch·∫øt h·∫≥n th√¨ sidekiq client s·∫Ω kh√¥ng th·ªÉ ƒë·∫©y job v√†o redis ƒë∆∞·ª£c, c√≥ nghƒ©a l√† ng∆∞·ªùi d√πng v·∫´n b·ªã stuck. L√∫c n√†y ta c√≥ th·ªÉ s·ª≠ d·ª•ng redis sentinel (master-slave) v·ª´a ƒë·∫£m b·∫£o vi·ªác persistent job v·ª´a ƒë·∫£m b·∫£o failover n·∫øu 1 server ch·∫øt.</li>
<li>Redis ch·∫°y ·ªïn khi t·∫•t c·∫£ data fit v·ª´a v·ªõi memory, n·∫øu full mem redis s·∫Ω evict data theo policy m√† ta c·∫•u h√¨nh, v√≠ d·ª• LRU -&gt; m·∫•t c√°c job c≈© ch∆∞a k·ªãp x·ª≠ l√Ω n√™n ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng evict nh·∫ßm n√™n c·∫•u h√¨nh redis <code>maxmemory-policy noeviction</code>.</li>
<li>Redis th∆∞·ªùng ƒë∆∞·ª£c x√†i ƒë·ªÉ cache d·ªØ li·ªáu, tuy nhi√™n b·∫£n ch·∫•t c·ªßa vi·ªác cache v√† storage job l√† kh√°c nhau (cache c√≥ th·ªÉ invalidate nh∆∞ng job th√¨ kh√¥ng ƒë∆∞·ª£c m·∫•t), n√™n t·ªët nh·∫•t l√† x√†i t√°ch r·ªùi 2 server redis cho vi·ªác cache v√† l∆∞u job sidekiq.</li>
<li>M·ªôt l√Ω do n·ªØa n√™n t√°ch redis d√πng cho cache v√† redis d√πng ƒë·ªÉ storage backgroud job cho sidekiq l√† timeout. Khi full mem, ƒë·ªÉ kh√¥ng b·ªã OOM redis s·∫Ω x√†i t·ªõi swap -&gt; disk swapping -&gt; tƒÉng ƒë·ªô tr·ªÖ khi ƒë·ªçc d·ªØ li·ªáu. Ho·∫∑c n·∫øu c√≥ c√°c command latency tr√™n redis m√† t·ªën th·ªùi gian c≈©ng g√¢y ra ƒë·ªô tr·ªÖ khi pull job.</li>
</ul>
<h3 id="23-sidekiq-server">2.3 Sidekiq server</h3>
<p>C√¢u h·ªèi ƒë·∫∑t ra l√†:</p>
<ul>
<li>N·∫øu sidekiq x·ª≠ l√Ω li√™n t·ª•c th√¨ l√†m sao ƒë·ªÉ restart sidekiq khi m·ªôt job ƒëang ƒë∆∞·ª£c sidekiq x·ª≠ l√Ω?</li>
<li>N·∫øu job b·ªã l·ªói, exception th√¨ c∆° ch·∫ø n√†o ƒë·ªÉ retry?</li>
<li>N·∫øu sidekiq server ƒëang x·ª≠ l√Ω m·ªôt job, nh∆∞ng b·ªã segfault ho·∫∑c crash ho·∫∑c force kill (kill -9) th√¨ l√†m sao ƒë·∫£m b·∫£o job v·∫´n s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω.</li>
</ul>
<p>V·ªÅ c√¢u h·ªèi ƒë·∫ßu ti√™n, ƒë√¢y l√† m·ªôt ƒëi·ªÉm kh√° th√∫ v√≠ v·ªÅ c√°ch thi·∫øt k·∫ø, n·∫øu ai quen v·ªõi nginx s·∫Ω th·∫•y m·ªôt c∆° ch·∫ø t∆∞∆°ng t·ª±. Ph·∫ßn gi·∫£i th√≠ch n√†y th·ª±c ch·∫•t l√† ph·∫ßn <a href="https://github.com/mperham/sidekiq/wiki/Signals">Signals</a> trong wiki c·ªßa Sidekiq.</p>
<ul>
<li>Khi ta g·ª≠i TSTP signal t·ªõi sidekiq (<code>kill -TSTP [sidekiq_pid]</code>), Sidekiq s·∫Ω hi·ªÉu l√† n√≥ s·∫Ω b·ªã shutdown trong t∆∞∆°ng lai g·∫ßn, sidekiq s·∫Ω chuy·ªÉn sang tr·∫°ng th√°i &ldquo;quiet&rdquo; nghƒ©a l√† n√≥ s·∫Ω d·ª´ng vi·ªác fetch new job t·ª´ redis nh∆∞ng v·∫´n ti·∫øp t·ª•c x·ª≠ l√Ω c√°c job m√† n√≥ ƒëang gi·ªØ, khi t·∫•t c·∫£ c√°c current job ƒë∆∞·ª£c x·ª≠ l√Ω xong th√¨ sidekiq s·∫Ω shutdown.</li>
<li>TERM signal nghƒ©a l√† Sidekiq n√™n shutdown sau kho·∫£ng th·ªùi th·ªùi gian <code>-t</code> timeout. T∆∞∆°ng t·ª± nh∆∞ <code>TSTP</code> sidekiq c≈©ng s·∫Ω kh√¥ng fetch job m·ªõi nh∆∞ng v·∫´n ti·∫øp t·ª•c x·ª≠ l√Ω c√°c job c≈© cho xong. ƒêi·ªÉm kh√°c bi·ªát l√† sau timeout n·∫øu job kh√¥ng ƒë∆∞·ª£c <strong>ho√†n th√†nh</strong> th√¨ s·∫Ω b·ªã force terminated v√† message ƒë√≥ s·∫Ω ƒë∆∞·ª£c <strong>push back</strong> l·∫°i v√†o redis, ƒë·ªÉ l·∫ßn sau khi sidekiq ƒë∆∞·ª£c start job ƒë√≥ s·∫Ω ƒë∆∞·ª£c fetch l·∫°i v√† ƒë∆∞·ª£c x·ª≠ l√Ω.</li>
</ul>
<p>=&gt; Best practice l√† ta s·∫Ω g·ª≠i signal <code>TSTP</code> l√∫c b·∫Øt ƒë·∫ßu deploy v√† <code>TERM</code> l√∫c k·∫øt th√∫c deploy. V√† l√∫c n√†y c√≥ th·ªÉ tho·∫£i m√°i restart m√† kh√¥ng s·ª£ b·ªã miss b·∫•t c·ª© job n√†o.</p>
<p>Sidekiq c√≥ built-in m·ªôt ch∆° ch·∫ø ƒë·ªÉ retry, s·∫Ω catch c√°c exception v√† t·ª± ƒë·ªông retry th∆∞·ªùng xuy√™n d·ª±a tr√™n c√¥ng th·ª©c <code>(retry_count ** 4) + 15 + (rand(30) * (retry_count + 1))</code> (t∆∞∆°ng ƒë∆∞∆°ng 15, 16, 31, 96, 271, &hellip; gi√¢y + m·ªôt l∆∞·ª£ng random time), v·ªõi gi√° tr·ªã <a href="https://github.com/mperham/sidekiq/blob/master/lib/sidekiq/job_retry.rb#L63">default retry l√† 25</a> nghƒ©a l√† ƒë·ªÉ th·ª±c hi·ªán 25 l·∫ßn retry s·∫Ω v√†o kho·∫£ng 21 ng√†y, trong 21 ng√†y n√†y ta c√≥ th·ªÉ fix bug, deploy v√† job s·∫Ω ƒë∆∞·ª£c x·ª≠ l√Ω th√†nh c√¥ng ·ªü l·∫ßn retry ti·∫øp theo.</p>
<p>N·∫øu sau 25 l·∫ßn retry v√† job v·∫´n kh√¥ng th√†nh c√¥ng th√¨ sidekiq s·∫Ω chuy·ªÉn job ƒë√≥ v√† Dead Job queue v√† ph·∫£i can thi·ªáp th·ªß c√¥ng ƒë·ªÉ ch·∫°y l·∫°i job ƒë√≥. V√† n·∫øu sau 6 th√°ng, job ƒë√≥ kh√¥ng ƒë∆∞·ª£c x·ª≠ l√Ω th√¨ sidekiq s·∫Ω discard job ƒë√≥.</p>
<p>V·ªÅ c√¢u h·ªèi cu·ªëi, l√†m th·∫ø n√†o ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh tin c·∫≠y cho m·ªôt job khi ƒë∆∞·ª£c fetch b·ªüi sidekiq server, v√† sidekiq server b·ªã crash th√¨ job ƒë√≥ v·∫´n c√≥ th·ªÉ ƒë∆∞·ª£c x·ª≠ l√Ω. ƒê√¢y l√† m·ªôt b√†i to√°n r·∫•t th√∫ v·ªã ƒë·ªÉ t√¨m hi·ªÉu v√† qua ƒë√≥ ta s·∫Ω th·∫•y s·ª©c m·∫°nh c·ªßa redis.</p>
<p>Tr∆∞·ªõc ti√™n ta s·∫Ω n√≥i 1 ch√∫t x√≠u v·ªÅ list v√† queue trong redis. Trong redis th√¨ list l√† m·ªôt t·∫≠p h·ª£p c·ªßa c√°c ph·∫ßn t·ª≠ c√≥ ki·ªÉu d·ªØ li·ªáu l√† string ƒë√£ ƒë∆∞·ª£c s·∫Øp x·∫øp b·∫±ng thu·∫≠t to√°n insertion sort. List trong redis ƒë∆∞·ª£c implement b·∫±ng c·∫•u tr√∫c d·ªØ li·ªáu l√† <a href="https://redis.io/topics/data-types-intro">linked list</a>.</p>
<p>Redis h·ªó tr·ª£ m·ªôt s·ªë l·ªánh tr√™n list nh∆∞ <code>LPUSH, RPUSH, LPOP, RPOP, LLEN, LINSERT, LINDEX</code>, v·ªõi t·∫≠p l·ªánh n√†y ta c√≥ th·ªÉ d√πng list trong redis nh∆∞ queue (FIFO v·ªõi t·∫≠p l·ªánh LPUSH, RPOP, ph·∫ßn t·ª≠ th√™m v√†o ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c l·∫•y ra ƒë·∫ßu ti√™n) ho·∫∑c stack (LIFO v·ªõi t·∫≠p l·ªánh RPUSH, LPOP, ph·∫ßn t·ª≠ th√™m v√†o ƒë·∫ßu ti√™n s·∫Ω ƒë∆∞·ª£c l·∫•y ra sau c√πng).</p>
<p>B·∫±ng c√°ch s·ª≠ d·ª•ng list nh∆∞ queue ta c√≥ th·ªÉ implement producer ƒë·ªÉ ƒë·∫©y d·ªØ li·ªáu v√† consumer ƒë·ªÉ l·∫•y d·ªØ li·ªáu t·ª´ trong queue ra v·ªõi 2 step ƒë∆°n gi·∫£n:</p>
<ul>
<li>push item v√†o list, producer g·ªçi LPUSH.</li>
<li>l·∫•y item trong list, ƒëem ra x·ª≠ l√Ω, consumer g·ªçi RPOP.</li>
</ul>
<p>V·∫•n ƒë·ªÅ l√† kh√¥ng ph·∫£i l√∫c n√†o list c·ªßa ch√∫ng ta c≈©ng c√≥ ph·∫ßn t·ª≠, v√† khi list kh√¥ng c√≥ ph·∫ßn t·ª≠ th√¨ s·∫Ω consumer s·∫Ω kh√¥ng c√≥ g√¨ ƒë·ªÉ x·ª≠ l√Ω c·∫£, l·ªánh RPOP tr·∫£ v·ªÅ <code>nil</code>.</p>
<pre tabindex="0"><code>127.0.0.1:6379&gt; LPUSH sidekiq a b c
(integer) 3
127.0.0.1:6379&gt; LLEN sidekiq
(integer) 3
127.0.0.1:6379&gt; RPOP sidekiq
&quot;a&quot;
127.0.0.1:6379&gt; RPOP sidekiq
&quot;b&quot;
127.0.0.1:6379&gt; RPOP sidekiq
&quot;c&quot;
127.0.0.1:6379&gt; RPOP sidekiq
(nil)
</code></pre><p>ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ tr√™n, ta c√≥ th·ªÉ b·∫Øt consumer ƒë·ª£i trong m·ªôt kho·∫£ng th·ªùi gian n√†o ƒë√≥ v√† sau ƒë√≥ s·∫Ω g·ªçi l·∫°i LPOP ƒë·ªÉ l·∫•y d·ªØ li·ªáu, k·ªπ thu·∫≠t n√†y g·ªçi l√† <em>polling</em>. Tuy nhi√™n k·ªπ thu·∫≠t n√†y v·∫´n c√≥ nh∆∞·ª£c ƒëi·ªÉm:</p>
<ul>
<li>N·∫øu l·∫ßn g·ªçi l·∫°i RPOP ƒë·ªÉ l·∫•y d·ªØ li·ªáu m√† list v·∫´n r·ªóng nghƒ©a l√† consumer t·ªën c√¥ng x·ª≠ l√Ω m·ªôt l·ªánh v√¥ nghƒ©a v√† redis server c≈©ng t·ªën c√¥ng x·ª≠ l√Ω m√† kh√¥ng ƒë·∫°t ƒë∆∞·ª£c k·∫øt qu·∫£ g√¨.</li>
<li>TƒÉng th·ªùi gian ƒë·ªÉ g·ªçi l·∫°i RPOP l·∫•y d·ªØ li·ªáu, nghƒ©a l√† sau khi consumer nh·∫≠n v·ªÅ <code>nil</code> th√¨ s·∫Ω ƒë·ª£i m·ªôt kho·∫£ng th·ªùi gian r·ªìi m·ªõi RPOP l·∫°i. Tuy nhi√™n delay-time m√† cao th√¨ c√≥ th·ªÉ s·∫Ω c√≥ m·ªôt l∆∞·ª£ng l·ªõn item ƒë∆∞·ª£c push v√†o list r·ªìi m√† delay-time m√† qu√° ng·∫Øn th√¨ l·∫°i quay v·ªÅ v·∫•n ƒë·ªÅ s·ªë 1, g·ªçi l·ªánh v√¥ nghƒ©a.</li>
</ul>
<p>Do ƒë√≥ redis implement m·ªôt s·ªë l·ªánh g·ªçi l√† blocking operation ƒë√≥ l√† BLPOP v√† BRPOP. Nghƒ©a l√† n·∫øu list r·ªóng, thay v√¨ tr·∫£ v·ªÅ <code>nil</code> th√¨ consumer s·∫Ω block connection v√† ch·ªù v·ªõi m·ªôt kho·∫£ng th·ªùi gian timeout (ta c√≥ th·ªÉ ch·ªù v√¥ t·∫≠n b·∫±ng c√°ch set timeout = 0), khi c√≥ m·ªôt item m·ªõi ƒë∆∞·ª£c th√™m v√†o list th√¨ POP ra v√† x·ª≠ l√Ω. ƒêi·ªÉm kh√°c bi·ªát l√† kh√¥ng c·∫ßn ph·∫£i ƒë·ªãnh k·ª≥ quay tr·ªü l·∫°i ki·ªÉm tra -&gt; tr√°nh th·ª±c hi·ªán c√°c l·ªánh v√¥ nghƒ©a.</p>
<p>Quay tr·ªü l·∫°i v·∫•n ƒë·ªÅ c·ªßa sidekiq server, sidekiq d√πng l·ªánh <code>BRPOP</code> ƒë·ªÉ fetch m·ªôt job t·ª´ trong queue redis ra v√† x·ª≠ l√Ω, kh√¥ng c√≥ g√¨ ph·∫£i b√†n c√£i v·ªÅ vi·ªác t·∫°i sao l·∫°i d√πng <code>BRPOP</code> n·ªØa, tuy nhi√™n vi·ªác d√πng <code>BRPOP</code> hay <code>RPOP</code> b·ªã m·ªôt v·∫•n ƒë·ªÅ l√† sau khi sidekiq fetch job th√¨ <strong>job ƒë√≥ kh√¥ng c√≤n t·ªìn t·∫°i trong redis</strong>. V√† b√¢y gi·ªù, n·∫øu sidekiq crash, job v·ª´a ƒë∆∞·ª£c fetch ra, ch∆∞a k·ªãp x·ª≠ l√Ω s·∫Ω bi·∫øn m·∫•t ho√†n to√†n.</p>
<p>T√≥m l·∫°i, ƒëen th√¥i, ƒë·ªè qu√™n ƒëi, n·∫øu quay tr·ªü l·∫°i v·∫•n ƒë·ªÅ restart, sidekiq c√≥ shutdown th√¨ v·∫´n c√≥ th·ªÉ <code>push-back</code> job l·∫°i v·ªÅ redis ch·ª© ƒë√£ crash gi·ªØa ƒë∆∞·ªùng job s·∫Ω kh√¥ng c√≥ c√°ch n√†o c·ª©u ch·ªØa.</p>
<p>V·∫≠y th·ª≠ nghƒ© xem c√≥ c√°ch n√†o ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh tin c·∫≠y khi x·ª≠ l√Ω job, theo c√°ch suy nghƒ© th√¥ng th∆∞·ªùng th√¨ ƒê∆†N GI·∫¢N l√† khi fetch job th√¨ ƒë·ª´ng X√ìA job ƒë√≥ ra kh·ªèi queue c·ªßa redis. Tuy nhi√™n n√≥ d·∫´n t·ªõi m·ªôt v·∫•n ƒë·ªÅ kh√°c ƒë√≥ l√† m·ªôt sidekiq server kh√°c c√≥ th·ªÉ <strong>nh√¨n th·∫•y</strong> job ƒë√≥, fetch ra v√† x·ª≠ l√Ω job ƒë√≥. H·ªá qu·∫£ l√† job ƒë∆∞·ª£c x·ª≠ l√Ω 2 l·∫ßn, n·∫øu b·∫°n g·ª≠i mail th√¨ c√≥ nghƒ©a l√† ng∆∞·ªùi d√πng s·∫Ω nh·∫≠n ƒë∆∞·ª£c 2 email c√≥ c√πng n·ªôi dung.</p>
<p>M·ªôt c√°ch ti·∫øp c·∫≠n kh√°c l√† thay v√¨ gi·ªØ job ƒë√≥ trong queue th√¨ ta v·∫´n c·ª© fetch job ƒë√≥ ra nh∆∞ng sau ƒë√≥ s·∫Ω push job ƒë√≥ v√†o m·ªôt queue kh√°c g·ªçi l√† <code>queue_ƒëang_x·ª≠_l√Ω</code>. ƒê√¢y ch√≠nh x√°c l√† c√°ch l·ªánh <code>RPOPLPUSH</code> trong redis ho·∫°t ƒë·ªông, <a href="https://redis.io/commands/rpoplpush">reliable queue pattern</a>. L·ªánh n√†y:</p>
<ul>
<li>Fetch v√† x√≥a last-item (tail) t·ª´ queue c≈© v√† c√πng th·ªùi ƒëi·ªÉm ƒë√≥ th√™m item ƒë√≥ ƒë·∫ßu m·ªôt queue kh√°c -&gt; g·ªçi l√† <em>processing_queue</em> (head).</li>
<li>Atomically return nghƒ©a l√† ho·∫°t ƒë·ªông nh∆∞ transaction trong database, 1 l√† th√†nh c√¥ng th√¨ commit (x√≥a t·ª´ queue c≈© v√† th√™m v√†o queue m·ªõi), 2 l√† fail th√¨ rollback, tr·∫£ job v·ªÅ l·∫°i queue c≈©.</li>
<li>D√πng l·ªánh <code>LREM</code> theo th·ª© t·ª± ƒë·ªÉ x√≥a item trong <em>processing_queue</em> m·ªôt khi item ƒë√≥ ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω xong</li>
</ul>
<pre tabindex="0"><code>127.0.0.1:6379&gt; LPUSH sidekiq a b c
(integer) 3
127.0.0.1:6379&gt; RPOPLPUSH sidekiq sidekiq_current_processing
&quot;a&quot;
127.0.0.1:6379&gt; LRANGE sidekiq 0 -1
1) &quot;c&quot;
2) &quot;b&quot;
127.0.0.1:6379&gt; LRANGE sidekiq_current_processing 0 -1
1) &quot;a&quot;
</code></pre><p>V·ªõi Sidekiq Pro, ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh tin c·∫≠y th√¨ thay v√¨ d√πng <code>fetch</code> ta c√≥ h√†m <code>super_fetch</code> s·ª≠ d·ª•ng <code>RPOPLPUSH</code> nh∆∞ c√°ch ·ªü tr√™n.</p>
<h3 id="24-others">2.4 Others</h3>
<p>M·∫∑c ƒë·ªãnh, sidekiq s·ª≠ d·ª•ng duy nh·∫•t m·ªôt queue l√† <code>default</code> trong redis. N·∫øu mu·ªën s·ª≠ d·ª•ng nhi·ªÅu queue th√¨ ch·ªâ vi·ªác ƒë·ªãnh nghƒ©a th√™m queue, v√† v·∫•n ƒë·ªÅ ti·∫øp theo l√† l√†m th·∫ø n√†o ƒë·ªÉ bi·∫øt queue n√†o ƒë∆∞·ª£c ∆∞u ti√™n x·ª≠ l√Ω.</p>
<p>V√≠ d·ª• ta c√≥ 2 queue sau:</p>
<pre tabindex="0"><code>sidekiq -q critical,2 -q default
</code></pre><p>Ch·ªâ s·ªë ph√≠a sau queue g·ªçi l√† weight c·ªßa queue, queue <code>critical</code> s·∫Ω ƒë∆∞·ª£c check/fetch 2 l·∫ßn so v·ªõi queue default c√≥ weight l√† 1.</p>
<p>Ho·∫∑c n·∫øu mu·ªën x·ª≠ l√Ω job theo th·ª© t·ª± khai b√°o, ƒë∆°n gi·∫£n l√† ƒë·ªãnh nghƒ©a queue kh√¥ng c√≥ tr·ªçng s·ªë</p>
<pre tabindex="0"><code>sidekiq -q critical -q default -q low
</code></pre><p>=&gt; Nghƒ©a l√† job trong <code>default</code> queue ch·ªâ ƒë∆∞·ª£c x·ª≠ l√Ω khi <code>critical</code> queue r·ªóng.</p>
<p>M·ªôt s·ªë v·∫•n ƒë·ªÅ kh√°c v·ªÅ bao nhi√™u queue l√† ƒë·ªß, concurrent c·ªßa sidekiq bao nhi√™u l√† h·ª£p l√Ω c√≥ th·ªÉ t√¨m th·∫•y trong <a href="https://github.com/mperham/sidekiq/wiki/Advanced-Options#concurrency">wiki sidekiq</a></p>
<h2 id="3-ch·ªët">3. Ch·ªët</h2>
<p>Nh∆∞ng tui ƒë√¢u c√≥ bi·∫øt Ruby ƒë√¢u, v·∫≠y t·∫°i sao tui ph·∫£i ƒë·ªçc b√†i n√†y l√†m chi? Th·ª±c ra m·ª•c ƒë√≠ch ban ƒë·∫ßu c·ªßa m√¨nh l√† t√¨m hi·ªÉu m·ªôt s·ªë v·∫•n ƒë·ªÅ c·ªßa sidekiq nh∆∞ bao nhi√™u queue l√† ƒë·ªß, bao nhi√™u sidekiq process ho·∫∑c t·∫°i sao l·∫°i timeout nh∆∞ng sau khi t√¨m hi·ªÉu xong h·ªçc th√™m ƒëc kh√° nhi·ªÅu th·ª© hay ho v·ªÅ c√°ch thi·∫øt k·∫ø, implement v√† m·ªôt s·ªë kh√°i ni·ªám m·ªõi:</p>
<ul>
<li>list/queue/blockingqueue v√† c√°ch redis implement</li>
<li>Reliable queue</li>
<li>polling v√† long-polling</li>
</ul>
<p>Ngo√†i ra, sau khi ƒë·ªçc b√†i n√†y b·∫°n c≈©ng s·∫Ω hi·ªÉu m·ªôt s·ªë metric c·∫ßn thi·∫øt cho vi·ªác monitor nh·∫±m ƒë·∫£m b·∫£o t√≠nh tin c·∫≠y cho x·ª≠ l√Ω backgroud job, v√≠ d·ª• m·ªôt s·ªë metric c·∫ßn l∆∞u √Ω nh∆∞:</p>
<ul>
<li>·ªû ph√≠a client ph·∫£i alert trong tr∆∞·ªùng h·ª£p network fail kh√¥ng th·ªÉ connect t·ªõi queue.</li>
<li>·ªû redis queue ph·∫£i ƒë·∫£m b·∫£o r·∫±ng redis lu√¥n availability, ngo√†i ra c·∫ßn monitor th√™m v·ªÅ s·ªë l∆∞·ª£ng job in queue, n·∫øu s·ªë l∆∞·ª£ng job trong queue v∆∞·ª£t ng∆∞·ª°ng n√†o ƒë√≥ c√≥ nghƒ©a l√† worker ƒëang b·ªã stuck ho·∫∑c s·ªë worker kh√¥ng ƒë·ªß ƒë·ªÉ x·ª≠ l√Ω ƒë·ªß l∆∞·ª£ng job enqueue ho·∫∑c t·∫•t c·∫£ worker ƒë·ªÅu ƒëang ch·∫øt.</li>
<li>·ªû Worker c·∫ßn ph·∫£i monitor worker s·ªëng hay ch·∫øt, v√† ph·∫£i monitor th√™m v·ªÅ th·ªùi gian x·ª≠ l√Ω c√°c job, t·ª´ ƒë√¢y s·∫Ω bi·∫øt c√°ch ƒë·ªÉ tƒÉng s·ªë worker hay t·ªëi ∆∞u l·∫°i x·ª≠ l√Ω.</li>
</ul>
<h2 id="4-ref">4. Ref</h2>
<ul>
<li><a href="https://github.com/mperham/sidekiq/wiki">https://github.com/mperham/sidekiq/wiki</a></li>
<li><a href="https://redis.io/topics/data-types-intro">https://redis.io/topics/data-types-intro</a></li>
<li><a href="https://redis.io/commands/blpop">https://redis.io/commands/blpop</a></li>
<li><a href="https://redis.io/commands/rpoplpush">https://redis.io/commands/rpoplpush</a></li>
<li><a href="https://docs.microsoft.com/en-us/azure/architecture/best-practices/background-jobs">https://docs.microsoft.com/en-us/azure/architecture/best-practices/background-jobs</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/build-simple-bg-job-with-rabbitmq/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Build simple backgroud job with RabbitMQ</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://taoquangne.com/post/rails-for-devops-engineer/">
                  <span class="button__text">Rails for DevOps engineer</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">h√†ng nh√† tr·ªìng üå¥ theo gi·∫•y ph√©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
