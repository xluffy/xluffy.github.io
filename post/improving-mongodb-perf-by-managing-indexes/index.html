<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Improving MongoDB performance by managing indexes ::
        /dev/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Ai c≈©ng bi·∫øt ƒë√°nh index gi√∫p tƒÉng t·ªëc c√°c truy v·∫•n t√¨m ki·∫øm, t√¨m ki·∫øm trong c√¢y index (B-Tree) s·∫Ω nhanh h∆°n scan trong to√†n b·ªô b·∫£ng."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xluffy.github.io/post/improving-mongodb-perf-by-managing-indexes/" />





<link rel="stylesheet" href="https://xluffy.github.io/assets/style.css" />

<link rel="stylesheet" href="https://xluffy.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://xluffy.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://xluffy.github.io/img/favicon.png" />


<link href="https://xluffy.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Improving MongoDB performance by managing indexes"/>
<meta name="twitter:description" content="Ai c≈©ng bi·∫øt ƒë√°nh index gi√∫p tƒÉng t·ªëc c√°c truy v·∫•n t√¨m ki·∫øm, t√¨m ki·∫øm trong c√¢y index (B-Tree) s·∫Ω nhanh h∆°n scan trong to√†n b·ªô b·∫£ng."/>



<meta property="og:title" content="Improving MongoDB performance by managing indexes" />
<meta property="og:description" content="Ai c≈©ng bi·∫øt ƒë√°nh index gi√∫p tƒÉng t·ªëc c√°c truy v·∫•n t√¨m ki·∫øm, t√¨m ki·∫øm trong c√¢y index (B-Tree) s·∫Ω nhanh h∆°n scan trong to√†n b·ªô b·∫£ng." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xluffy.github.io/post/improving-mongodb-perf-by-managing-indexes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-05-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-05-30T00:00:00+00:00" /><meta property="og:site_name" content="/dev/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/dev/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Improving MongoDB performance by managing indexes</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-05-30
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://xluffy.github.io/tags/mongod/">#mongod</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/index/">#index</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Ai c≈©ng bi·∫øt ƒë√°nh index gi√∫p tƒÉng t·ªëc c√°c truy v·∫•n t√¨m ki·∫øm, t√¨m ki·∫øm trong c√¢y index (B-Tree) s·∫Ω nhanh h∆°n scan trong to√†n b·ªô b·∫£ng. Ai c≈©ng bi·∫øt n√™n kh√¥ng n√≥i nhi·ªÅu v·ªÅ index l√† g√¨ n·ªØa :trollface: v·∫≠y nh√©.</p>
<p>ƒê√¢y l√† <a href="https://github.com/xluffy/assets/blob/master/users.bson.gz">MongoDB users dataset</a> b·∫°n c√≥ th·ªÉ t·∫£i v·ªÅ ch∆°i th·ª≠.</p>
<h2 id="1-s∆°-s∆°-v·ªÅ-index">1. S∆° s∆° v·ªÅ index</h2>
<p>Index trong Mongo c≈©ng t∆∞∆°ng t·ª± c√°c c∆° s·ªü d·ªØ li·ªáu quan h·ªá, v√≠ d·ª• ta c√≥ m·ªôt index ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_user_status&#39;</span>
});
</code></pre></div><p>C√¢u tr√™n s·∫Ω n√≥i v·ªõi database build m·ªôt index d·ª±a tr√™n gi√° tr·ªã c·ªßa field <code>user_status</code> c·ªßa collection <code>users</code>.</p>
<p>Ngo√†i ra n√≥ c√≥ th√™m m·ªôt t√πy ch·ªçn l√† <code>backgroud: true</code> ƒë·ªÉ build index ·ªü d·∫°ng backgroud, th√¥ng th∆∞·ªùng ƒë√°nh index s·∫Ω block t·∫•t c·∫£ c√°c operation kh√°c, v√† v·ªõi c√°c collection c√≥ k√≠ch th∆∞·ªõc l·ªõn th√¨ vi·ªác ƒë√°nh index s·∫Ω t·ªën t·ªõi v√†i gi·ªù ƒë·ªÉ ho√†n th√†nh v√† trong th·ªùi gian n√†y database s·∫Ω kh√¥ng th·ªÉ response, ƒë√°nh index <code>background</code> ƒë·ªÉ tr√°nh t√≠nh tr·∫°ng block c√°c operation kh√°c [nh∆∞ng kh√¥ng h·∫≥n ƒë·ªùi l√∫c n√†o c≈©ng nh∆∞ m∆°].</p>
<p>L∆∞u √Ω l√† n√™n ch·∫°y query ƒë√°nh index trong <code>tmux</code> ƒë·ªÉ tr√°nh r·ªõt k·∫øt n·ªëi v√† ƒë·ªÉ ki·ªÉm tra process c·ªßa index ta c√≥ th·ªÉ truy v·∫•n:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">currentOp</span>(
  { <span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">/Index Build/</span> }
);

<span style="color:#e6db74">&#34;msg&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Index Build (background) Index Build (background): 3305028/574961784 0%&#34;</span>
</code></pre></div><p>Ok, ti·∫øp t·ª•c v·ªõi index ph√≠a tr√™n, n√≥ s·∫Ω c√≥ t√°c d·ª•ng v·ªõi c√°c truy v·∫•n t√¨m ki·∫øm v·ªõi ƒëi·ªÅu ki·ªán l√† field <code>user_status</code>, v√≠ d·ª• nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">find</span>({
  <span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;new_user&#34;</span>
});
</code></pre></div><p>Kh√¥ng c√≥ g√¨ ph·∫£i b√†n c√£i th√™m, truy v·∫•n tr√™n s·ª≠ d·ª•ng index <code>idx_users_by_user_status</code> v√† tr·∫£ v·ªÅ k·∫øt qu·∫£ v·ªõi t·ªëc ƒë·ªô c·ªßa m·ªôt v·ªã th·∫ßn gi√≥. üò§</p>
<p>Gi·ªù gi·∫£ s·ª≠, ta c√≥ m·ªôt truy v·∫•n l·∫•y ra t·∫•t c·∫£ c√°c user <code>confirmed</code> NH∆ØNG trong m·ªôt th√°ng c·ªßa nƒÉm 2013 nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2013-04-01T00:00:00Z&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2013-04-30T23:59:59Z&#34;</span>);

<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">find</span>({
	<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;confirmed&#34;</span>,
	<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gte</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">$lte</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">end</span>}
});
</code></pre></div><p>T∆∞∆°ng t·ª± nh∆∞ tr√™n, l·∫•y ra danh s√°ch c√°c <code>confirmed</code> kh√° nhanh ch√≥ng do s·ª≠ d·ª•ng index nh∆∞ c√¢u truy v·∫•n tr√™n c√πng, tuy nhi√™n trong danh s√°ch tr·∫£ ra <code>confirmed</code> ta c·∫ßn l·ªçc th√™m m·ªôt l·∫ßn n·ªØa ƒë·ªÉ l·∫•y ra c√°c user ƒëƒÉng k√≠ trong th√°ng ƒë√≥, v√† do <code>created_at</code> kh√¥ng ƒë∆∞·ª£c ƒë√°nh index n√™n c√≥ bao nhi√™u <code>confirmed</code> th√¨ ta c·∫ßn qu√©t to√†n b·ªô t·ª´ng ƒë·∫•y.</p>
<p>ƒê·ªÉ gi·∫£i quy·∫øt truy v·∫•n tr√™n, ta c·∫ßn ƒë√°nh index tr√™n 2 field, g·ªçi l√† <strong>compound index</strong> nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
  <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> 
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, 
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_user_status_and_created_at&#39;</span> 
});
</code></pre></div><p>Ok, trong c√≥ v·∫ª ngon r·ªìi, truy v·∫•n c·ªßa ch√∫ng ta ƒë√£ nhanh h∆°n r·ªìi. Nh∆∞ng th·ª≠ nghƒ© xem, ch√∫ng ta c√≥ th·ªÉ l√†m t·ªët h∆°n hay kh√¥ng nh·ªâ?</p>
<p>Gi·∫£ s·ª≠ b·∫°n c√≥ 20 tri·ªáu register user (ho·∫∑c b·∫°n c√≥ th·ªÉ t∆∞·ªüng t∆∞·ª£ng b·∫°n c√≥ 1 t·ª∑ register user v√† b·∫°n gi√†u h∆°n Mark Zuckerberg üôÇ c≈©ng ƒë∆∞·ª£c) <code>user_status</code> c√≥ c√°c gi√° tr·ªã sau:</p>
<ul>
<li>new_user</li>
<li>confirmed</li>
<li>banned</li>
<li>deleted</li>
</ul>
<p>N·∫øu kh√¥ng c√≥ index tr√™n <code>user_status</code>, b·∫°n c·∫ßn qu√©t h·∫øt 20 tri·ªáu docs n√†y, ƒë√°nh index tr√™n <code>user_status</code> con s·ªë gi·∫£m t·ª´ 20 tri·ªáu -&gt; 5 tri·ªáu (1/4).</p>
<p>Gi·ªù gi·∫£ s·ª≠, start-√∫p m·∫∑t c·ªßa b·∫°n ra ƒë·ªùi nƒÉm 2015, ƒë·∫øn b√¢y gi·ªù l√† 3 nƒÉm, gi·∫£ s·ª≠ user ƒëƒÉng k√≠ ƒë·ªìng ƒë·ªÅu gi·ªØa c√°c ng√†y (th·ª±c t·∫ø th√¨ ƒë√©o ph·∫£i nh∆∞ v·∫≠y ƒë√¢u  üòÖ). B·∫°n index l·∫°i nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_created_at_user_status&#39;</span>
});
</code></pre></div><p>Gi·ªù v·ªõi c√¢u truy v·∫•n tr√™n, ta ƒë∆∞·ª£c m·ªôt danh s√°ch c√°c user ƒëƒÉng k√Ω trong v√≤ng 1 th√°ng, l√† c·ª° h∆°n 500 ng√†n user (1 ng√†y c√≥ ~ 18 ng√†n user ƒëƒÉng k√Ω), sau ƒë√≥ l·ªçc theo ƒëi·ªÅu ki·ªán <code>new_user</code> ta ch·ªâ c·∫ßn qu√©t trong t·∫≠p 500k user n√†y so v·ªõi 5 tri·ªáu nh∆∞ c√°ch ƒë√°nh index ban ƒë·∫ßu.</p>
<p>Ch·ªët l·∫°i, v·ªõi <strong>compound index</strong> n√™n ƒë√°nh index field c√≥ gi√° tr·ªã uniqe nhi·ªÅu h∆°n tr∆∞·ªõc. ·ªû tr√™n th√¨ ƒë√°nh <code>created_at</code> tr∆∞·ªõc v√¨ c√°c gi√° tr·ªã trong field n√†y h·∫ßu h·∫øt ƒë·ªÅu kh√°c nhau (trong khi <code>user_status</code> ch·ªâ c√≥ 4 gi√° tr·ªã), n√™n s·∫Ω gi·∫£m ƒë∆∞·ª£c v√πng t√¨m ki·∫øm c·ªßa truy v·∫•n nhi·ªÅu h∆°n.</p>
<h2 id="2-how-to-improve">2. How to improve</h2>
<p>Xong xu√¥i vi·ªác ƒë√°nh index, b√¢y gi·ªù l√†m c√°ch n√†o ƒë·ªÉ ta c√≥ th·ªÉ ch·∫Øc ch·∫Øn r·∫±ng database s·∫Ω s·ª≠ d·ª•ng index m·ªôt c√°ch hi·ªáu qu·∫£? Index c≈©ng nh∆∞ d·ªØ li·ªáu, ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n ƒëƒ©a c·ª©ng, v√† ƒë·ªÉ index c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng hi·ªáu qu·∫£ th√¨ t·ªët nh·∫•t l√† n√≥ n√™n ƒë∆∞·ª£c ƒë·∫∑t tr√™n RAM. Trong Mongo, RAM th√¨ th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ gi·ªØ c√°c d·ªØ li·ªáu v√† index th∆∞·ªùng xuy√™n truy v·∫•n (WiredTiger internal cache) tr√°nh ph·∫£i ƒë·ªçc ƒëƒ©a th∆∞·ªùng xuy√™n. Recommend l√† 50% physical memory, v√≠ d·ª• server c√≥ 32GB th√¨ d internal cache l√† 15GB.</p>
<p>Nh∆∞ng data th√¨ l√∫c n√†o c≈©ng l·ªõn h∆°n RAM, b·∫°n kh√¥ng th·ªÉ ƒë·∫∑t to√†n b·ªô d·ªØ li·ªáu l√™n Wiredtiger cadhe ƒë∆∞·ª£c, v·ªõi index c≈©ng v·∫≠y, ƒë√°nh index th√¨ c√°c truy v·∫•n ƒë·ªçc d·ªØ li·ªáu tr√™n ƒëi·ªÅu ki·ªán s·∫Ω nhanh, nh∆∞ng qu√° nhi·ªÅu index d∆∞ th·ª´a th√¨ g√¢y ra 2 v·∫•n ƒë·ªÅ:</p>
<ul>
<li>Kh√¥ng th·ªÉ ch·ª©a t·∫•t c·∫£ c√°c index tr√™n memory.</li>
<li>L√†m ch·∫≠m c√°c truy v·∫•n ghi d·ªØ li·ªáu nh∆∞ Insert/Update/Delete -&gt; nh∆∞ng th·ª±c ra
n·∫øu ph·∫ßn ghi chi·∫øm t·ªõi 80-95% th√¨ vi·ªác ƒë√°nh ƒë·ªïi c≈©ng ƒë√°ng k·ªÉ.</li>
</ul>
<p>B·∫°n c√≥ th·ªÉ ki·ªÉm tra k√≠ch th∆∞·ªõc t·ªïng th·ªÉ c·ªßa index tr√™n c∆° s·ªü d·ªØ li·ªáu nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">runCommand</span>({ <span style="color:#a6e22e">dbStats</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">scale</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> });
{
    <span style="color:#e6db74">&#34;db&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;test&#34;</span>,
    <span style="color:#e6db74">&#34;collections&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>,
    <span style="color:#e6db74">&#34;objects&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2000000</span>,
    <span style="color:#e6db74">&#34;avgObjSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">96.120665</span>,
    <span style="color:#e6db74">&#34;dataSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">192241330</span>,
    <span style="color:#e6db74">&#34;storageSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">374370304</span>,
    <span style="color:#e6db74">&#34;numExtents&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
    <span style="color:#e6db74">&#34;indexes&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>,
    <span style="color:#e6db74">&#34;indexSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">53964800</span>,
    <span style="color:#e6db74">&#34;ok&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>C·ª• th·ªÉ h∆°n (d·ªØ li·ªáu n√†y ƒÉn c·∫Øp tr√™n production)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">stats</span>().<span style="color:#a6e22e">indexSize</span>
<span style="color:#ae81ff">86508650496</span>
</code></pre></div><p>=&gt; k√≠ch th∆∞·ªõc c·ªßa t·∫•t c·∫£ c√°c index tr√™n CSDL l√† 86GB, c√≥ nghƒ©a l√† index kh√¥ng th·ªÉ fit h·∫øt tr√™n memory, n√™n khi n√†o c·∫ßn s·ª≠ d·ª•ng t·ªõi index, n·∫øu index ƒë√≥ kh√¥ng c√≥ s·∫µn tr√™n memory th√¨ c·∫ßn ƒë·ªçc index ƒë√≥ t·ª´ ƒëƒ©a l√™n.</p>
<p>N√≥i chung, x√°c ƒë·ªãnh bao nhi√™u memory l√† c·∫ßn thi·∫øt kh√¥ng d·ªÖ, b·∫°n c√≥ th·ªÉ tr·∫£ l·ªùi v√†i c√¢u h·ªèi sau ƒë·ªÉ t·ª± x√°c ƒë·ªãnh v√† ƒëi·ªÅu ch·ªânh memory cho h·ª£p l√Ω:</p>
<ul>
<li>ƒê·ªô l·ªõn data c·ªßa b·∫°n l√† bao nhi√™u?</li>
<li>ƒê·ªô l·ªõn c·ªßa index l√† bao nhi√™u?</li>
<li>ƒê·ªô ph√°t tri·ªÉn c·ªßa d·ªØ li·ªáu (trong 1 th√°ng, 1 nƒÉm?)</li>
<li>ƒê·ªô l·ªõn c·ªßa t·∫≠p d·ªØ li·ªáu th∆∞·ªùng xuy√™n truy c·∫≠p nh·∫•t (g·ªçi l√† working set)?</li>
</ul>
<p>V·∫≠y chi·∫øn l∆∞·ª£c ƒë·ªÉ gi·ªØ index c√≥ k√≠ch th∆∞·ªõc nh·ªè l√† nh∆∞ th·∫ø n√†o?</p>
<h3 id="21-x√≥a-c√°c-index-kh√¥ng-s·ª≠-d·ª•ng">2.1 X√≥a c√°c index kh√¥ng s·ª≠ d·ª•ng</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">aggregate</span>([ { <span style="color:#a6e22e">$indexStats</span><span style="color:#f92672">:</span> {} } ]);
[{
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_created_at_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">456550227</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:31:09.020Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">277641131</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:05:39.148Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;_id_&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">0</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:03:12.197Z&#34;</span>)
	}
}]
</code></pre></div><p>·ªû v√≠ d·ª• tr√™n, ta c√≥ 3 index, ·ªü gi√° tr·ªã <code>accesses</code>, ta th·∫•y 2 index ƒë·∫ßu ti√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng r·∫•t nhi·ªÅu l·∫ßn, trong khi ƒë√≥ index th·ª© 3 kh√¥ng h·ªÅ ƒë∆∞·ª£c s·ª≠ d·ª•ng. Con s·ªë bao nhi√™u l√† h·ª£p l√≠ ƒë·ªÉ lo·∫°i b·ªè m·ªôt index t√πy thu·ªôc v√†o s·ªë l∆∞·ª£ng truy v·∫•n v√† nghi·ªáp v·ª• c·ªßa ch√≠nh b·∫°n, b·∫°n c√≥ th·ªÉ t·ª± c√¢n nh·∫Øc, ƒëo l∆∞·ªùng v√† lo·∫°i b·ªè n·∫øu kh√¥ng c·∫ßn thi·∫øt.</p>
<p>C·∫ßn l∆∞u √Ω, <code>ops</code> c√≥ th·ªÉ b·ªã reset, con s·ªë hi·ªán t·∫°i th·ªÉ hi·ªán s·ªë l·∫ßn ƒë∆∞·ª£c s·ª≠ d·ª•ng k·ªÉ t·ª´ <code>since</code> -&gt; th·ªùi gian mongod ƒë∆∞·ª£c restart.</p>
<h3 id="22-lo·∫°i-b·ªè-c√°c-index-d∆∞-th·ª´a">2.2 Lo·∫°i b·ªè c√°c index d∆∞ th·ª´a</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">aggregate</span>([ { <span style="color:#a6e22e">$indexStats</span><span style="color:#f92672">:</span> {} } ])
[{
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status_created_at&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">456550227</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:31:09.020Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">277641131</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:05:39.148Z&#34;</span>)
	}
}]
</code></pre></div><p>·ªû v√≠ d·ª• tr√™n, c·∫£ 2 index ƒë·ªÅu ƒë∆∞·ª£c s·ª≠ d·ª•ng. Tuy nhi√™n index ƒë·∫ßu ti√™n c√≥ th·ªÉ l√†m cho index th·ª© 2 tr·ªü l√™n d∆∞ th·ª´a, v√¨ c√°c truy v·∫•n ch·ªâ tr√™n ƒëi·ªÅu ki·ªán <code>user_status</code> c√≥ th·ªÉ s·ª≠ d·ª•ng index ƒë·∫ßu ti√™n m√† kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨.</p>
<h3 id="23-s·ª≠-d·ª•ng-sparse-index">2.3 S·ª≠ d·ª•ng sparse index</h3>
<p>ƒê√¢y l√† ki·ªÉu ƒë√°nh index tr√™n ƒëi·ªÅu ki·ªán, v√≠ d·ª• ta c√≥ 20 tri·ªáu user, nh∆∞ng n·∫øu ta ch·ªâ th∆∞·ªùng truy v·∫•n <code>user_status</code> l√† <code>new_user</code> th√¨ ta c√≥ th·ªÉ ƒë√°nh index ri√™ng v·ªõi t·∫≠p <code>new_user</code> th√¥i -&gt; gi·∫£ s·ª≠ s·ªë l∆∞·ª£ng <code>new_user</code> l√† 40% tr√™n t·ªïng s·ªë user -&gt; index c·ªßa ch√∫ng ta s·∫Ω gi·∫£m xu·ªëng t·ªõi 60% k√≠ch th∆∞·ªõc.</p>
<h3 id="24-gi·∫£m-b·ªõt-k√≠ch-th∆∞·ªõc-c·ªßa-collection">2.4 Gi·∫£m b·ªõt k√≠ch th∆∞·ªõc c·ªßa collection</h3>
<p>C√°ch duy nh·∫•t ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc c·ªßa collection ƒë√≥ l√† &hellip; <strong>x√≥a d·ªØ li·ªáu</strong>, th·ª±c t·∫ø c√≥ nh·ªØng nghi·ªáp v·ª• l∆∞u tr·ªØ logs, events kh√¥ng c·∫ßn gi·ªØ qu√° 1-2 nƒÉm ƒë·ªÉ tra c·ª©u th√¨ ta c√≥ th·ªÉ x√≥a b·ªõt c√°c d·ªØ li·ªáu kh√¥ng c√≤n c·∫ßn thi·∫øt (ho·∫∑c di chuy·ªÉn n√≥ sang m·ªôt CSDL kh√°c v·ªõi t·∫ßn su·∫•t tuy v·∫•n th·∫•p h∆°n). Khi k√≠ch th∆∞·ªõc c·ªßa collection gi·∫£m, k√≠ch th∆∞·ªõc c·ªßa index c≈©ng s·∫Ω gi·∫£m theo v√† data/index c√≥ th·ªÉ fit v·ª´a tr√™n RAM.</p>
<h3 id="24-gi·ªØ-index-ƒë∆°n-gi·∫£n">2.4 Gi·ªØ index ƒë∆°n gi·∫£n</h3>
<p>Compound index r·∫•t l·ª£i h·∫°i trong tr∆∞·ªùng h·ª£p truy v·∫•n d·ªØ li·ªáu tr√™n nhi·ªÅu ƒëi·ªÅu ki·ªán kh√°c nhau, tuy nhi√™n n√≥ c≈©ng t·ªën chi ph√≠ b·∫£o tr√¨ v√† d·ªØ li·ªáu c√†ng l·ªõn th√¨ index size s·∫Ω c√†ng tƒÉng nhanh. T∆∞∆°ng t·ª± nh∆∞ truy v·∫•n, c·ªë g·∫Øng gi·ªØ cho index m·ªôt c√°ch ƒë∆°n gi·∫£n nh·∫•t c√≥ th·ªÉ.</p>
<h2 id="3-bonus">3. Bonus</h2>
<p>ƒê√°ng ra ƒë√©o c√≥ ph·∫ßn n√†y, <a href="http://whyyoushouldusemongodb.com">nh∆∞ng s·ª£ anh em l·∫°i b·∫£o th·∫±ng chuy√™n b√†i tr·ª´ Mongo m√† nay l·∫°i vi·∫øt v·ªÅ Mongo</a>, th·∫•y sai sai th·∫ø √©o n√†o n√™n ph·∫£i vi·∫øt th√™m t√≠.</p>
<p>Th·∫≠t ra nh·ªØng l√Ω thuy·∫øt tr√™n v·ªÅ index v√† qu·∫£n l√Ω index ƒë·ªÅu c√≥ th·ªÉ √°p d·ª•ng cho c√°c c∆° s·ªü d·ªØ li·ªáu quan h·ªá nh∆∞ MySQL hay PostgreSQL. V√≠ d·ª• v·ªõi PostgreSQL c≈©ng c√≥ index tr√™n ƒëi·ªÅu ki·ªán ƒë√≥ l√† partial index t∆∞∆°ng t·ª± nh∆∞ sparse index (MySQL th√¨ kh√¥ng bi·∫øt c√≥ kh√¥ng).</p>
<p>B·∫£n ch·∫•t, n·∫øu ƒë·ªÉ √Ω s·∫Ω th·∫•y c√°c h·ªá CSDL c√≥ r·∫•t nhi·ªÅu ƒë·∫∑c ƒëi·ªÉm gi·ªëng nhau (k·ªÉ c·∫£ M$ SQL), l√Ω thuy·∫øt n√†y c√≥ th·ªÉ √°p d·ª•ng cho CSDL kh√°c, v√† ng∆∞·ª£c l·∫°i. C·ªët l√µi c·ªßa v·∫•n ƒë·ªÅ l√† <strong>t∆∞ duy</strong> v·ªÅ vi·ªác <strong>ƒëo l∆∞·ªùng</strong>, c√°ch th·ª©c ƒëo l∆∞·ªùng v√† ƒë√°nh gi√° hi·ªáu qu·∫£ c·ªßa m·ªói h√†nh ƒë·ªông t√°c ƒë·ªông l√™n h·ªá th·ªëng</p>
<p>L·∫ßn sau s·∫Ω vi·∫øt th√™m v·ªÅ m·ªôt s·ªë th·ª© li√™n quan ƒë·∫øn metric trong CSDL quan h·ªá, h·ªó tr·ª£ cho vi·ªác t·ªëi ∆∞u h·ªá th·ªëng t∆∞∆°ng t·ª± nh∆∞ tr√™n MongoDB.</p>
<h2 id="4-ref">4. Ref</h2>
<ul>
<li><a href="https://mixmax.com/blog/improving-mongo-performance-by-managing-indexes">https://mixmax.com/blog/improving-mongo-performance-by-managing-indexes</a></li>
<li><a href="https://github.com/ozlerhakan/mongodb-json-files">https://github.com/ozlerhakan/mongodb-json-files</a></li>
<li><a href="https://docs.mongodb.com/manual/tutorial/ensure-indexes-fit-ram">https://docs.mongodb.com/manual/tutorial/ensure-indexes-fit-ram</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xluffy.github.io/post/what-is-difference-between-ssl-tls-https/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">What is difference between SSL, TLS, and HTTPs?</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xluffy.github.io/post/delayed-replication-in-mysql/">
                  <span class="button__text">Delayed Replication in MySQL</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">h√†ng nh√† tr·ªìng üå¥ theo gi·∫•y ph√©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://xluffy.github.io/assets/main.js"></script>
<script src="https://xluffy.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
