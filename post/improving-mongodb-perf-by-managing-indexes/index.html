<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Improving MongoDB performance by managing indexes ::
        /dev/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Ai cÅ©ng biáº¿t Ä‘Ã¡nh index giÃºp tÄƒng tá»‘c cÃ¡c truy váº¥n tÃ¬m kiáº¿m, tÃ¬m kiáº¿m trong cÃ¢y index (B-Tree) sáº½ nhanh hÆ¡n scan trong toÃ n bá»™ báº£ng."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xluffy.github.io/post/improving-mongodb-perf-by-managing-indexes/" />





<link rel="stylesheet" href="https://xluffy.github.io/assets/style.css" />

<link rel="stylesheet" href="https://xluffy.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://xluffy.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://xluffy.github.io/img/favicon.png" />


<link href="https://xluffy.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Improving MongoDB performance by managing indexes"/>
<meta name="twitter:description" content="Ai cÅ©ng biáº¿t Ä‘Ã¡nh index giÃºp tÄƒng tá»‘c cÃ¡c truy váº¥n tÃ¬m kiáº¿m, tÃ¬m kiáº¿m trong cÃ¢y index (B-Tree) sáº½ nhanh hÆ¡n scan trong toÃ n bá»™ báº£ng."/>



<meta property="og:title" content="Improving MongoDB performance by managing indexes" />
<meta property="og:description" content="Ai cÅ©ng biáº¿t Ä‘Ã¡nh index giÃºp tÄƒng tá»‘c cÃ¡c truy váº¥n tÃ¬m kiáº¿m, tÃ¬m kiáº¿m trong cÃ¢y index (B-Tree) sáº½ nhanh hÆ¡n scan trong toÃ n bá»™ báº£ng." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xluffy.github.io/post/improving-mongodb-perf-by-managing-indexes/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-05-30T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-05-30T00:00:00+00:00" /><meta property="og:site_name" content="/dev/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/dev/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Improving MongoDB performance by managing indexes</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-05-30
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://xluffy.github.io/tags/mongod/">#mongod</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/index/">#index</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Ai cÅ©ng biáº¿t Ä‘Ã¡nh index giÃºp tÄƒng tá»‘c cÃ¡c truy váº¥n tÃ¬m kiáº¿m, tÃ¬m kiáº¿m trong cÃ¢y index (B-Tree) sáº½ nhanh hÆ¡n scan trong toÃ n bá»™ báº£ng. Ai cÅ©ng biáº¿t nÃªn khÃ´ng nÃ³i nhiá»u vá» index lÃ  gÃ¬ ná»¯a :trollface: váº­y nhÃ©.</p>
<p>ÄÃ¢y lÃ  <a href="https://github.com/xluffy/assets/blob/master/users.bson.gz">MongoDB users dataset</a> báº¡n cÃ³ thá»ƒ táº£i vá» chÆ¡i thá»­.</p>
<h2 id="1-sÆ¡-sÆ¡-vá»-index">1. SÆ¡ sÆ¡ vá» index</h2>
<p>Index trong Mongo cÅ©ng tÆ°Æ¡ng tá»± cÃ¡c cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡, vÃ­ dá»¥ ta cÃ³ má»™t index Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_user_status&#39;</span>
});
</code></pre></div><p>CÃ¢u trÃªn sáº½ nÃ³i vá»›i database build má»™t index dá»±a trÃªn giÃ¡ trá»‹ cá»§a field <code>user_status</code> cá»§a collection <code>users</code>.</p>
<p>NgoÃ i ra nÃ³ cÃ³ thÃªm má»™t tÃ¹y chá»n lÃ  <code>backgroud: true</code> Ä‘á»ƒ build index á»Ÿ dáº¡ng backgroud, thÃ´ng thÆ°á»ng Ä‘Ã¡nh index sáº½ block táº¥t cáº£ cÃ¡c operation khÃ¡c, vÃ  vá»›i cÃ¡c collection cÃ³ kÃ­ch thÆ°á»›c lá»›n thÃ¬ viá»‡c Ä‘Ã¡nh index sáº½ tá»‘n tá»›i vÃ i giá» Ä‘á»ƒ hoÃ n thÃ nh vÃ  trong thá»i gian nÃ y database sáº½ khÃ´ng thá»ƒ response, Ä‘Ã¡nh index <code>background</code> Ä‘á»ƒ trÃ¡nh tÃ­nh tráº¡ng block cÃ¡c operation khÃ¡c [nhÆ°ng khÃ´ng háº³n Ä‘á»i lÃºc nÃ o cÅ©ng nhÆ° mÆ¡].</p>
<p>LÆ°u Ã½ lÃ  nÃªn cháº¡y query Ä‘Ã¡nh index trong <code>tmux</code> Ä‘á»ƒ trÃ¡nh rá»›t káº¿t ná»‘i vÃ  Ä‘á»ƒ kiá»ƒm tra process cá»§a index ta cÃ³ thá»ƒ truy váº¥n:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">currentOp</span>(
  { <span style="color:#e6db74">&#34;msg&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">/Index Build/</span> }
);

<span style="color:#e6db74">&#34;msg&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Index Build (background) Index Build (background): 3305028/574961784 0%&#34;</span>
</code></pre></div><p>Ok, tiáº¿p tá»¥c vá»›i index phÃ­a trÃªn, nÃ³ sáº½ cÃ³ tÃ¡c dá»¥ng vá»›i cÃ¡c truy váº¥n tÃ¬m kiáº¿m vá»›i Ä‘iá»u kiá»‡n lÃ  field <code>user_status</code>, vÃ­ dá»¥ nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">find</span>({
  <span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;new_user&#34;</span>
});
</code></pre></div><p>KhÃ´ng cÃ³ gÃ¬ pháº£i bÃ n cÃ£i thÃªm, truy váº¥n trÃªn sá»­ dá»¥ng index <code>idx_users_by_user_status</code> vÃ  tráº£ vá» káº¿t quáº£ vá»›i tá»‘c Ä‘á»™ cá»§a má»™t vá»‹ tháº§n giÃ³. ğŸ˜¤</p>
<p>Giá» giáº£ sá»­, ta cÃ³ má»™t truy váº¥n láº¥y ra táº¥t cáº£ cÃ¡c user <code>confirmed</code> NHÆ¯NG trong má»™t thÃ¡ng cá»§a nÄƒm 2013 nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">start</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2013-04-01T00:00:00Z&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">end</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2013-04-30T23:59:59Z&#34;</span>);

<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">find</span>({
	<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;confirmed&#34;</span>,
	<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gte</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">start</span>, <span style="color:#a6e22e">$lte</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">end</span>}
});
</code></pre></div><p>TÆ°Æ¡ng tá»± nhÆ° trÃªn, láº¥y ra danh sÃ¡ch cÃ¡c <code>confirmed</code> khÃ¡ nhanh chÃ³ng do sá»­ dá»¥ng index nhÆ° cÃ¢u truy váº¥n trÃªn cÃ¹ng, tuy nhiÃªn trong danh sÃ¡ch tráº£ ra <code>confirmed</code> ta cáº§n lá»c thÃªm má»™t láº§n ná»¯a Ä‘á»ƒ láº¥y ra cÃ¡c user Ä‘Äƒng kÃ­ trong thÃ¡ng Ä‘Ã³, vÃ  do <code>created_at</code> khÃ´ng Ä‘Æ°á»£c Ä‘Ã¡nh index nÃªn cÃ³ bao nhiÃªu <code>confirmed</code> thÃ¬ ta cáº§n quÃ©t toÃ n bá»™ tá»«ng Ä‘áº¥y.</p>
<p>Äá»ƒ giáº£i quyáº¿t truy váº¥n trÃªn, ta cáº§n Ä‘Ã¡nh index trÃªn 2 field, gá»i lÃ  <strong>compound index</strong> nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
  <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> 
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>, 
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_user_status_and_created_at&#39;</span> 
});
</code></pre></div><p>Ok, trong cÃ³ váº» ngon rá»“i, truy váº¥n cá»§a chÃºng ta Ä‘Ã£ nhanh hÆ¡n rá»“i. NhÆ°ng thá»­ nghÄ© xem, chÃºng ta cÃ³ thá»ƒ lÃ m tá»‘t hÆ¡n hay khÃ´ng nhá»‰?</p>
<p>Giáº£ sá»­ báº¡n cÃ³ 20 triá»‡u register user (hoáº·c báº¡n cÃ³ thá»ƒ tÆ°á»Ÿng tÆ°á»£ng báº¡n cÃ³ 1 tá»· register user vÃ  báº¡n giÃ u hÆ¡n Mark Zuckerberg ğŸ™‚ cÅ©ng Ä‘Æ°á»£c) <code>user_status</code> cÃ³ cÃ¡c giÃ¡ trá»‹ sau:</p>
<ul>
<li>new_user</li>
<li>confirmed</li>
<li>banned</li>
<li>deleted</li>
</ul>
<p>Náº¿u khÃ´ng cÃ³ index trÃªn <code>user_status</code>, báº¡n cáº§n quÃ©t háº¿t 20 triá»‡u docs nÃ y, Ä‘Ã¡nh index trÃªn <code>user_status</code> con sá»‘ giáº£m tá»« 20 triá»‡u -&gt; 5 triá»‡u (1/4).</p>
<p>Giá» giáº£ sá»­, start-Ãºp máº·t cá»§a báº¡n ra Ä‘á»i nÄƒm 2015, Ä‘áº¿n bÃ¢y giá» lÃ  3 nÄƒm, giáº£ sá»­ user Ä‘Äƒng kÃ­ Ä‘á»“ng Ä‘á»u giá»¯a cÃ¡c ngÃ y (thá»±c táº¿ thÃ¬ Ä‘Ã©o pháº£i nhÆ° váº­y Ä‘Ã¢u  ğŸ˜…). Báº¡n index láº¡i nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">createIndex</span>({
  <span style="color:#a6e22e">created_at</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
  <span style="color:#a6e22e">user_status</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}, {
  <span style="color:#a6e22e">background</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;idx_users_by_created_at_user_status&#39;</span>
});
</code></pre></div><p>Giá» vá»›i cÃ¢u truy váº¥n trÃªn, ta Ä‘Æ°á»£c má»™t danh sÃ¡ch cÃ¡c user Ä‘Äƒng kÃ½ trong vÃ²ng 1 thÃ¡ng, lÃ  cá»¡ hÆ¡n 500 ngÃ n user (1 ngÃ y cÃ³ ~ 18 ngÃ n user Ä‘Äƒng kÃ½), sau Ä‘Ã³ lá»c theo Ä‘iá»u kiá»‡n <code>new_user</code> ta chá»‰ cáº§n quÃ©t trong táº­p 500k user nÃ y so vá»›i 5 triá»‡u nhÆ° cÃ¡ch Ä‘Ã¡nh index ban Ä‘áº§u.</p>
<p>Chá»‘t láº¡i, vá»›i <strong>compound index</strong> nÃªn Ä‘Ã¡nh index field cÃ³ giÃ¡ trá»‹ uniqe nhiá»u hÆ¡n trÆ°á»›c. á» trÃªn thÃ¬ Ä‘Ã¡nh <code>created_at</code> trÆ°á»›c vÃ¬ cÃ¡c giÃ¡ trá»‹ trong field nÃ y háº§u háº¿t Ä‘á»u khÃ¡c nhau (trong khi <code>user_status</code> chá»‰ cÃ³ 4 giÃ¡ trá»‹), nÃªn sáº½ giáº£m Ä‘Æ°á»£c vÃ¹ng tÃ¬m kiáº¿m cá»§a truy váº¥n nhiá»u hÆ¡n.</p>
<h2 id="2-how-to-improve">2. How to improve</h2>
<p>Xong xuÃ´i viá»‡c Ä‘Ã¡nh index, bÃ¢y giá» lÃ m cÃ¡ch nÃ o Ä‘á»ƒ ta cÃ³ thá»ƒ cháº¯c cháº¯n ráº±ng database sáº½ sá»­ dá»¥ng index má»™t cÃ¡ch hiá»‡u quáº£? Index cÅ©ng nhÆ° dá»¯ liá»‡u, Ä‘Æ°á»£c lÆ°u trá»¯ trÃªn Ä‘Ä©a cá»©ng, vÃ  Ä‘á»ƒ index cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng hiá»‡u quáº£ thÃ¬ tá»‘t nháº¥t lÃ  nÃ³ nÃªn Ä‘Æ°á»£c Ä‘áº·t trÃªn RAM. Trong Mongo, RAM thÃ¬ thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ giá»¯ cÃ¡c dá»¯ liá»‡u vÃ  index thÆ°á»ng xuyÃªn truy váº¥n (WiredTiger internal cache) trÃ¡nh pháº£i Ä‘á»c Ä‘Ä©a thÆ°á»ng xuyÃªn. Recommend lÃ  50% physical memory, vÃ­ dá»¥ server cÃ³ 32GB thÃ¬ d internal cache lÃ  15GB.</p>
<p>NhÆ°ng data thÃ¬ lÃºc nÃ o cÅ©ng lá»›n hÆ¡n RAM, báº¡n khÃ´ng thá»ƒ Ä‘áº·t toÃ n bá»™ dá»¯ liá»‡u lÃªn Wiredtiger cadhe Ä‘Æ°á»£c, vá»›i index cÅ©ng váº­y, Ä‘Ã¡nh index thÃ¬ cÃ¡c truy váº¥n Ä‘á»c dá»¯ liá»‡u trÃªn Ä‘iá»u kiá»‡n sáº½ nhanh, nhÆ°ng quÃ¡ nhiá»u index dÆ° thá»«a thÃ¬ gÃ¢y ra 2 váº¥n Ä‘á»:</p>
<ul>
<li>KhÃ´ng thá»ƒ chá»©a táº¥t cáº£ cÃ¡c index trÃªn memory.</li>
<li>LÃ m cháº­m cÃ¡c truy váº¥n ghi dá»¯ liá»‡u nhÆ° Insert/Update/Delete -&gt; nhÆ°ng thá»±c ra
náº¿u pháº§n ghi chiáº¿m tá»›i 80-95% thÃ¬ viá»‡c Ä‘Ã¡nh Ä‘á»•i cÅ©ng Ä‘Ã¡ng ká»ƒ.</li>
</ul>
<p>Báº¡n cÃ³ thá»ƒ kiá»ƒm tra kÃ­ch thÆ°á»›c tá»•ng thá»ƒ cá»§a index trÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">runCommand</span>({ <span style="color:#a6e22e">dbStats</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">scale</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> });
{
    <span style="color:#e6db74">&#34;db&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;test&#34;</span>,
    <span style="color:#e6db74">&#34;collections&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>,
    <span style="color:#e6db74">&#34;objects&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">2000000</span>,
    <span style="color:#e6db74">&#34;avgObjSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">96.120665</span>,
    <span style="color:#e6db74">&#34;dataSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">192241330</span>,
    <span style="color:#e6db74">&#34;storageSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">374370304</span>,
    <span style="color:#e6db74">&#34;numExtents&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
    <span style="color:#e6db74">&#34;indexes&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>,
    <span style="color:#e6db74">&#34;indexSize&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">53964800</span>,
    <span style="color:#e6db74">&#34;ok&#34;</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
}
</code></pre></div><p>Cá»¥ thá»ƒ hÆ¡n (dá»¯ liá»‡u nÃ y Äƒn cáº¯p trÃªn production)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">stats</span>().<span style="color:#a6e22e">indexSize</span>
<span style="color:#ae81ff">86508650496</span>
</code></pre></div><p>=&gt; kÃ­ch thÆ°á»›c cá»§a táº¥t cáº£ cÃ¡c index trÃªn CSDL lÃ  86GB, cÃ³ nghÄ©a lÃ  index khÃ´ng thá»ƒ fit háº¿t trÃªn memory, nÃªn khi nÃ o cáº§n sá»­ dá»¥ng tá»›i index, náº¿u index Ä‘Ã³ khÃ´ng cÃ³ sáºµn trÃªn memory thÃ¬ cáº§n Ä‘á»c index Ä‘Ã³ tá»« Ä‘Ä©a lÃªn.</p>
<p>NÃ³i chung, xÃ¡c Ä‘á»‹nh bao nhiÃªu memory lÃ  cáº§n thiáº¿t khÃ´ng dá»…, báº¡n cÃ³ thá»ƒ tráº£ lá»i vÃ i cÃ¢u há»i sau Ä‘á»ƒ tá»± xÃ¡c Ä‘á»‹nh vÃ  Ä‘iá»u chá»‰nh memory cho há»£p lÃ½:</p>
<ul>
<li>Äá»™ lá»›n data cá»§a báº¡n lÃ  bao nhiÃªu?</li>
<li>Äá»™ lá»›n cá»§a index lÃ  bao nhiÃªu?</li>
<li>Äá»™ phÃ¡t triá»ƒn cá»§a dá»¯ liá»‡u (trong 1 thÃ¡ng, 1 nÄƒm?)</li>
<li>Äá»™ lá»›n cá»§a táº­p dá»¯ liá»‡u thÆ°á»ng xuyÃªn truy cáº­p nháº¥t (gá»i lÃ  working set)?</li>
</ul>
<p>Váº­y chiáº¿n lÆ°á»£c Ä‘á»ƒ giá»¯ index cÃ³ kÃ­ch thÆ°á»›c nhá» lÃ  nhÆ° tháº¿ nÃ o?</p>
<h3 id="21-xÃ³a-cÃ¡c-index-khÃ´ng-sá»­-dá»¥ng">2.1 XÃ³a cÃ¡c index khÃ´ng sá»­ dá»¥ng</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">aggregate</span>([ { <span style="color:#a6e22e">$indexStats</span><span style="color:#f92672">:</span> {} } ]);
[{
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_created_at_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">456550227</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:31:09.020Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">277641131</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:05:39.148Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;_id_&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">0</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:03:12.197Z&#34;</span>)
	}
}]
</code></pre></div><p>á» vÃ­ dá»¥ trÃªn, ta cÃ³ 3 index, á»Ÿ giÃ¡ trá»‹ <code>accesses</code>, ta tháº¥y 2 index Ä‘áº§u tiÃªn Ä‘Æ°á»£c sá»­ dá»¥ng ráº¥t nhiá»u láº§n, trong khi Ä‘Ã³ index thá»© 3 khÃ´ng há» Ä‘Æ°á»£c sá»­ dá»¥ng. Con sá»‘ bao nhiÃªu lÃ  há»£p lÃ­ Ä‘á»ƒ loáº¡i bá» má»™t index tÃ¹y thuá»™c vÃ o sá»‘ lÆ°á»£ng truy váº¥n vÃ  nghiá»‡p vá»¥ cá»§a chÃ­nh báº¡n, báº¡n cÃ³ thá»ƒ tá»± cÃ¢n nháº¯c, Ä‘o lÆ°á»ng vÃ  loáº¡i bá» náº¿u khÃ´ng cáº§n thiáº¿t.</p>
<p>Cáº§n lÆ°u Ã½, <code>ops</code> cÃ³ thá»ƒ bá»‹ reset, con sá»‘ hiá»‡n táº¡i thá»ƒ hiá»‡n sá»‘ láº§n Ä‘Æ°á»£c sá»­ dá»¥ng ká»ƒ tá»« <code>since</code> -&gt; thá»i gian mongod Ä‘Æ°á»£c restart.</p>
<h3 id="22-loáº¡i-bá»-cÃ¡c-index-dÆ°-thá»«a">2.2 Loáº¡i bá» cÃ¡c index dÆ° thá»«a</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">aggregate</span>([ { <span style="color:#a6e22e">$indexStats</span><span style="color:#f92672">:</span> {} } ])
[{
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status_created_at&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
		<span style="color:#e6db74">&#34;created_at&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">456550227</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:31:09.020Z&#34;</span>)
	}
} {
	<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;idx_users_by_user_status&#34;</span>,
	<span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;user_status&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>
	},
	<span style="color:#e6db74">&#34;host&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;6b1b716ae456:27017&#34;</span>,
	<span style="color:#e6db74">&#34;accesses&#34;</span><span style="color:#f92672">:</span> {
		<span style="color:#e6db74">&#34;ops&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">NumberLong</span>(<span style="color:#ae81ff">277641131</span>),
		<span style="color:#e6db74">&#34;since&#34;</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ISODate</span>(<span style="color:#e6db74">&#34;2018-05-31T15:05:39.148Z&#34;</span>)
	}
}]
</code></pre></div><p>á» vÃ­ dá»¥ trÃªn, cáº£ 2 index Ä‘á»u Ä‘Æ°á»£c sá»­ dá»¥ng. Tuy nhiÃªn index Ä‘áº§u tiÃªn cÃ³ thá»ƒ lÃ m cho index thá»© 2 trá»Ÿ lÃªn dÆ° thá»«a, vÃ¬ cÃ¡c truy váº¥n chá»‰ trÃªn Ä‘iá»u kiá»‡n <code>user_status</code> cÃ³ thá»ƒ sá»­ dá»¥ng index Ä‘áº§u tiÃªn mÃ  khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬.</p>
<h3 id="23-sá»­-dá»¥ng-sparse-index">2.3 Sá»­ dá»¥ng sparse index</h3>
<p>ÄÃ¢y lÃ  kiá»ƒu Ä‘Ã¡nh index trÃªn Ä‘iá»u kiá»‡n, vÃ­ dá»¥ ta cÃ³ 20 triá»‡u user, nhÆ°ng náº¿u ta chá»‰ thÆ°á»ng truy váº¥n <code>user_status</code> lÃ  <code>new_user</code> thÃ¬ ta cÃ³ thá»ƒ Ä‘Ã¡nh index riÃªng vá»›i táº­p <code>new_user</code> thÃ´i -&gt; giáº£ sá»­ sá»‘ lÆ°á»£ng <code>new_user</code> lÃ  40% trÃªn tá»•ng sá»‘ user -&gt; index cá»§a chÃºng ta sáº½ giáº£m xuá»‘ng tá»›i 60% kÃ­ch thÆ°á»›c.</p>
<h3 id="24-giáº£m-bá»›t-kÃ­ch-thÆ°á»›c-cá»§a-collection">2.4 Giáº£m bá»›t kÃ­ch thÆ°á»›c cá»§a collection</h3>
<p>CÃ¡ch duy nháº¥t Ä‘á»ƒ giáº£m kÃ­ch thÆ°á»›c cá»§a collection Ä‘Ã³ lÃ  &hellip; <strong>xÃ³a dá»¯ liá»‡u</strong>, thá»±c táº¿ cÃ³ nhá»¯ng nghiá»‡p vá»¥ lÆ°u trá»¯ logs, events khÃ´ng cáº§n giá»¯ quÃ¡ 1-2 nÄƒm Ä‘á»ƒ tra cá»©u thÃ¬ ta cÃ³ thá»ƒ xÃ³a bá»›t cÃ¡c dá»¯ liá»‡u khÃ´ng cÃ²n cáº§n thiáº¿t (hoáº·c di chuyá»ƒn nÃ³ sang má»™t CSDL khÃ¡c vá»›i táº§n suáº¥t tuy váº¥n tháº¥p hÆ¡n). Khi kÃ­ch thÆ°á»›c cá»§a collection giáº£m, kÃ­ch thÆ°á»›c cá»§a index cÅ©ng sáº½ giáº£m theo vÃ  data/index cÃ³ thá»ƒ fit vá»«a trÃªn RAM.</p>
<h3 id="24-giá»¯-index-Ä‘Æ¡n-giáº£n">2.4 Giá»¯ index Ä‘Æ¡n giáº£n</h3>
<p>Compound index ráº¥t lá»£i háº¡i trong trÆ°á»ng há»£p truy váº¥n dá»¯ liá»‡u trÃªn nhiá»u Ä‘iá»u kiá»‡n khÃ¡c nhau, tuy nhiÃªn nÃ³ cÅ©ng tá»‘n chi phÃ­ báº£o trÃ¬ vÃ  dá»¯ liá»‡u cÃ ng lá»›n thÃ¬ index size sáº½ cÃ ng tÄƒng nhanh. TÆ°Æ¡ng tá»± nhÆ° truy váº¥n, cá»‘ gáº¯ng giá»¯ cho index má»™t cÃ¡ch Ä‘Æ¡n giáº£n nháº¥t cÃ³ thá»ƒ.</p>
<h2 id="3-bonus">3. Bonus</h2>
<p>ÄÃ¡ng ra Ä‘Ã©o cÃ³ pháº§n nÃ y, <a href="http://whyyoushouldusemongodb.com">nhÆ°ng sá»£ anh em láº¡i báº£o tháº±ng chuyÃªn bÃ i trá»« Mongo mÃ  nay láº¡i viáº¿t vá» Mongo</a>, tháº¥y sai sai tháº¿ Ã©o nÃ o nÃªn pháº£i viáº¿t thÃªm tÃ­.</p>
<p>Tháº­t ra nhá»¯ng lÃ½ thuyáº¿t trÃªn vá» index vÃ  quáº£n lÃ½ index Ä‘á»u cÃ³ thá»ƒ Ã¡p dá»¥ng cho cÃ¡c cÆ¡ sá»Ÿ dá»¯ liá»‡u quan há»‡ nhÆ° MySQL hay PostgreSQL. VÃ­ dá»¥ vá»›i PostgreSQL cÅ©ng cÃ³ index trÃªn Ä‘iá»u kiá»‡n Ä‘Ã³ lÃ  partial index tÆ°Æ¡ng tá»± nhÆ° sparse index (MySQL thÃ¬ khÃ´ng biáº¿t cÃ³ khÃ´ng).</p>
<p>Báº£n cháº¥t, náº¿u Ä‘á»ƒ Ã½ sáº½ tháº¥y cÃ¡c há»‡ CSDL cÃ³ ráº¥t nhiá»u Ä‘áº·c Ä‘iá»ƒm giá»‘ng nhau (ká»ƒ cáº£ M$ SQL), lÃ½ thuyáº¿t nÃ y cÃ³ thá»ƒ Ã¡p dá»¥ng cho CSDL khÃ¡c, vÃ  ngÆ°á»£c láº¡i. Cá»‘t lÃµi cá»§a váº¥n Ä‘á» lÃ  <strong>tÆ° duy</strong> vá» viá»‡c <strong>Ä‘o lÆ°á»ng</strong>, cÃ¡ch thá»©c Ä‘o lÆ°á»ng vÃ  Ä‘Ã¡nh giÃ¡ hiá»‡u quáº£ cá»§a má»—i hÃ nh Ä‘á»™ng tÃ¡c Ä‘á»™ng lÃªn há»‡ thá»‘ng</p>
<p>Láº§n sau sáº½ viáº¿t thÃªm vá» má»™t sá»‘ thá»© liÃªn quan Ä‘áº¿n metric trong CSDL quan há»‡, há»— trá»£ cho viá»‡c tá»‘i Æ°u há»‡ thá»‘ng tÆ°Æ¡ng tá»± nhÆ° trÃªn MongoDB.</p>
<h2 id="4-ref">4. Ref</h2>
<ul>
<li><a href="https://mixmax.com/blog/improving-mongo-performance-by-managing-indexes">https://mixmax.com/blog/improving-mongo-performance-by-managing-indexes</a></li>
<li><a href="https://github.com/ozlerhakan/mongodb-json-files">https://github.com/ozlerhakan/mongodb-json-files</a></li>
<li><a href="https://docs.mongodb.com/manual/tutorial/ensure-indexes-fit-ram">https://docs.mongodb.com/manual/tutorial/ensure-indexes-fit-ram</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xluffy.github.io/post/what-is-difference-between-ssl-tls-https/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">What is difference between SSL, TLS, and HTTPs?</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xluffy.github.io/post/delayed-replication-in-mysql/">
                  <span class="button__text">Delayed Replication in MySQL</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">hÃ ng nhÃ  trá»“ng ğŸŒ´ theo giáº¥y phÃ©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://xluffy.github.io/assets/main.js"></script>
<script src="https://xluffy.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
