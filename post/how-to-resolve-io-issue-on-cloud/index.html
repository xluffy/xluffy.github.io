<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        How to resolve I/O issue on cloud ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Má»™t trong cÃ¡c bÃ i toÃ¡n khiáº¿n mÃ¬nh khÃ¡ Ä‘au Ä‘áº§u khi lÃªn plan Ä‘á»ƒ chuyá»ƒn má»™t há»‡ thá»‘ng tá»« physical server lÃªn cloud Ä‘Ã³ lÃ  bÃ i toÃ¡n giá»›i háº¡n I/O vÃ  chi phÃ­ cho database."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xluffy.github.io/post/how-to-resolve-io-issue-on-cloud/" />





<link rel="stylesheet" href="https://xluffy.github.io/assets/style.css" />

<link rel="stylesheet" href="https://xluffy.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://xluffy.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://xluffy.github.io/img/favicon.png" />


<link href="https://xluffy.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to resolve I/O issue on cloud"/>
<meta name="twitter:description" content="Má»™t trong cÃ¡c bÃ i toÃ¡n khiáº¿n mÃ¬nh khÃ¡ Ä‘au Ä‘áº§u khi lÃªn plan Ä‘á»ƒ chuyá»ƒn má»™t há»‡ thá»‘ng tá»« physical server lÃªn cloud Ä‘Ã³ lÃ  bÃ i toÃ¡n giá»›i háº¡n I/O vÃ  chi phÃ­ cho database."/>



<meta property="og:title" content="How to resolve I/O issue on cloud" />
<meta property="og:description" content="Má»™t trong cÃ¡c bÃ i toÃ¡n khiáº¿n mÃ¬nh khÃ¡ Ä‘au Ä‘áº§u khi lÃªn plan Ä‘á»ƒ chuyá»ƒn má»™t há»‡ thá»‘ng tá»« physical server lÃªn cloud Ä‘Ã³ lÃ  bÃ i toÃ¡n giá»›i háº¡n I/O vÃ  chi phÃ­ cho database." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xluffy.github.io/post/how-to-resolve-io-issue-on-cloud/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-01-28T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-01-28T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">How to resolve I/O issue on cloud</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2019-01-28
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://xluffy.github.io/tags/mysql/">#mysql</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/cloud/">#cloud</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/io/">#io</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Má»™t trong cÃ¡c bÃ i toÃ¡n khiáº¿n mÃ¬nh khÃ¡ Ä‘au Ä‘áº§u khi lÃªn plan Ä‘á»ƒ chuyá»ƒn má»™t há»‡ thá»‘ng tá»« physical server lÃªn cloud Ä‘Ã³ lÃ  bÃ i toÃ¡n giá»›i háº¡n I/O vÃ  chi phÃ­ cho database. NÃ³ khiáº¿n mÃ¬nh máº¥t khÃ¡ nhiá»u thá»i gian vÃ  tháº¯c máº¯c, bÃ i nÃ y lÃ  bÃ i lÆ°á»£c dá»‹ch tá»« <a href="https://www.percona.com/blog/2018/08/20/using-aws-ec2-instance-store-vs-ebs-for-mysql-how-to-increase-performance-and-decrease-cost">má»™t bÃ i blog cá»§a Percona</a>, cÃ³ nÃ³i chi tiáº¿t cÃ¡c cÃ¡ch giáº£i quyáº¿t, cÃ¡c issues cÃ³ thá»ƒ gáº·p pháº£i vÃ  cÃ¡ch giáº£i quyáº¿t cÃ¡c issues Ä‘Ã³. MÃ¬nh dá»‹ch láº¡i, hi vá»ng náº¿u ai Ä‘Ã³ gáº·p pháº£i cÃ³ thá»ƒ tÃ¬m Ä‘Æ°á»£c cÃ¡ch giáº£i quyáº¿t vÃ  dá»… dÃ ng migrate há»‡ thá»‘ng lÃªn cloud.</p>
<h2 id="1-Ä‘áº·t-váº¥n-Ä‘á»">1. Äáº·t váº¥n Ä‘á»</h2>
<p>Há»‡ thá»‘ng sá»­ dá»¥ng MySQL (hoáº·c PostgeSQL), sá»­ dá»¥ng 1 siÃªu physical server vá»›i cáº¥u hÃ¬nh vÃ  thÃ´ng sá»‘ vá» data tÆ°á»£ng trÆ°ng nhÆ° sau:</p>
<ul>
<li>Dell PowerEdge R720 (2-socket, 2U rack server).</li>
<li>CPU Xeon E5-2660V4 (14 cores, 28 threads) 2.20 Ghz.</li>
<li>16GB * 12 ~ 192 GB RAM.</li>
<li>2 * 4TB Samsung SSD 860 Pro (consumer SSD) -&gt; RAID 1.
<ul>
<li>Sequential Read Speed ~ Up to 560 MB/sec.</li>
<li>Sequential Write Speed ~ Up to 530 MB/sec.</li>
<li>Random read (4KB, QD32) ~ Up to <strong>100,000 IOPS</strong>.</li>
<li>Random write (4KB, QD32) ~ Up to <strong>90,000 IOPS</strong>.</li>
<li>Random read (4KB, QD1) ~ Up to <strong>11,000 IOPS</strong>.</li>
<li>Random write (4KB, QD1) ~ Up to <strong>43,000 IOPS</strong>.</li>
<li>Reliablility (MTBF) ~ 1.5 milion hours.</li>
<li>&hellip;.</li>
</ul>
</li>
<li>KÃ­ch thÆ°á»›c dá»¯ liá»‡u thÃ´ giáº£ Ä‘á»‹nh lÃ  ~ 2 TB (chÆ°a bao gá»“m binlog &hellip;).</li>
</ul>
<p>Äáº·c Ä‘iá»ƒm cá»§a má»™t server phá»¥c vá»¥ database lÃ  cáº¥u hÃ¬nh cÃ¡i gÃ¬ cÅ©ng sáº½ cáº§n máº¡nh:</p>
<ul>
<li>Cáº§n memory lá»›n, dÃ¹ng Ä‘á»ƒ cache (<code>innodb_buffer_pool_size</code>) dá»¯ liá»‡u Ä‘á»c tá»« Ä‘Ä©a (giáº£m thá»i gian Ä‘á»c Ä‘Ä©a), tuy nhiÃªn dá»¯ liá»‡u sáº½ luÃ´n lá»›n hÆ¡n ráº¥t nhiá»u so vá»›i memory (2TB vá»›i gáº§n 200GB RAM) nÃªn khÃ´ng thá»ƒ fit háº¿t data trÃªn memory Ä‘Æ°á»£c, memory to chá»‰ giÃºp <strong>giáº£m thiá»ƒu</strong> viá»‡c Ä‘á»c Ä‘Ä©a.</li>
<li>CPU máº¡nh, nhiá»u core giÃºp xá»­ lÃ½ nhanh vÃ  Ä‘á»“ng thá»i tá»‘t.</li>
<li>ÄÄ©a cÃ ng nhanh cÃ ng tá»‘t, vÃ¬ data váº«n náº±m chÃ­nh trÃªn Ä‘Ä©a, mÃ  execute time á»Ÿ Ä‘Ä©a thÃ¬ ráº¥t cháº­m so vá»›i cÃ¡c bá»™ nhá»› khÃ¡c nÃªn Ä‘Ã³ lÃ  lÃ­ do cáº§n dÃ¹ng SSD. Tuy nhiÃªn náº¿u cÃ³ Ä‘iá»u kiá»‡n nÃªn sá»­ dá»¥ng cÃ¡c dÃ²ng SSD DataCenter hoáº·c cÃ¡c Ä‘Ä©a xÃ i NVMe Interface (á»Ÿ trÃªn xÃ i Consumer SSD), tham kháº£o thÃªm táº¡i <a href="https://en.wikipedia.org/wiki/IOPS">wikipedia vá» IOPS</a> cá»§a cÃ¡c loáº¡i Ä‘Ä©a.</li>
</ul>
<p>Má»™t sá»‘ lÆ°u Ã½ khÃ¡c trong quÃ¡ trÃ¬nh setup:</p>
<ul>
<li>KhÃ´ng xÃ i swap, do swapping Ä‘á»c Ä‘Ä©a sáº½ cháº­m.</li>
<li>TÃ¡ch biá»‡t cÃ¡c vÃ¹ng OS, data ra cÃ¡c Ä‘Ä©a/partition riÃªng. VÃ­ dá»¥ nÃªn dÃ¹ng 1 cáº·p Ä‘Ä©a nhá» hÆ¡n Ä‘á»ƒ setup OS, cáº·p Ä‘Ä©a data nÃªn Ä‘á»ƒ riÃªng Ä‘á»ƒ trÃ¡nh bá»‹ áº£nh hÆ°á»Ÿng IOPS khi OS Ä‘á»c/ghi dá»¯ liá»‡u (log).</li>
<li>Náº¿u cÃ³ thá»ƒ, nÃªn tÃ¡ch riÃªng vÃ¹ng lÆ°u trá»¯ binlog ra partition riÃªng (tÆ°Æ¡ng tá»± postgres khi tÃ¡ch WAL).</li>
<li>CÃ¢n nháº¯c ZFS náº¿u cÃ³ nhiá»u file nhá» hoáº·c cÃ¡c filesystem khÃ¡c phÃ¹ há»£p hÆ¡n.</li>
<li>&hellip;</li>
</ul>
<p><strong>Váº¥n Ä‘á»</strong>:</p>
<p>Váº¥n Ä‘á» chÃ­nh lÃ  kÃ­ch thÆ°á»›c dá»¯ liá»‡u vÃ  IOPS cá»§a Ä‘Ä©a. á» physical server nhÆ° link wiki phÃ­a trÃªn vÃ  tráº¡ng thÃ¡i cá»§a Ä‘Ä©a Samsung SSD 860Pro thÃ¬ IOPS ráº¥t lá»›n nÃªn khi chuyá»ƒn lÃªn cloud thÃ¬ cÅ©ng pháº£i lá»±a chá»n Ä‘Ä©a cÃ³ cáº¥u hÃ¬nh tÆ°Æ¡ng tá»±. NÃ³i chung háº§u háº¿t cÃ¡c váº¥n Ä‘á» cháº­m cá»§a database lÃ  do tá»‘c Ä‘á»™ cá»§a Ä‘Ä©a.</p>
<p>NÃ³i qua vá» má»™t sá»‘ loáº¡i Ä‘Ä©a trÃªn AWS vÃ  GCP</p>
<p><strong>AWS</strong></p>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSVolumeTypes.html">EBS</a>: ÄÃ¢y lÃ  loáº¡i Ä‘Ä©a thÆ°á»ng tháº¥y trÃªn AWS, vá» báº£n cháº¥t nÃ³ lÃ  má»™t dáº¡ng <strong>network disk</strong> (nhÆ°ng ko giá»‘ng EFS, loáº¡i network disk cÃ³ thá»ƒ mount Ä‘á»“ng thá»i vÃ o nhiá»u server cÃ¹ng lÃºc, EBS chá»‰ mount vÃ o 1 instance táº¡i 1 thá»i Ä‘iá»ƒm), Ä‘áº·c Ä‘iá»ƒm lÃ  <strong>persistent</strong> nhÆ°ng cÃ³ giá»›i háº¡n vá» tá»‘c Ä‘á»™. EBS láº¡i chia lÃ m má»™t sá»‘ loáº¡i nhá», nhÆ°ng á»Ÿ Ä‘Ã¢y ta chá»‰ nÃ³i vá» <code>gp2</code> vÃ  <code>io1</code>:
<ul>
<li><code>gp2</code> lÃ  EBS giÃ¡ ráº», IOPS phá»¥ thuá»™c vÃ o kÃ­ch thÆ°á»›c cá»§a Ä‘Ä©a (muá»‘n tÄƒng IOPS pháº£i resize disk), thÆ°á»ng xÃ i cho OS vÃ  cÃ¡c nhu cáº§u chung chung khÃ¡c. KÃ­ch thÆ°á»›c tá»« 1GB - 16TB, Max IOPS/volume lÃ  16,000, max throughput/volume 250 MB/s, max IOPS/instance lÃ  80,000, max throughput/instance 1,750 MB/s. NgoÃ i ra <code>gp2</code> cÃ³ má»™t khÃ¡i niá»‡m lÃ  IO credit vÃ  baseline performance, nÃ³i 1 cÃ¡ch dá»… hiá»ƒu lÃ  chá»‰ xÃ i Ä‘c 100% performance trong 1 khoáº£ng thá»i gian vÃ  credit cÃ³ Ä‘Æ°á»£c phá»¥ thuá»™c vÃ o thá»i gian sá»­ dá»¥ng. VÃ­ dá»¥ Ä‘Ä©a 4TB sáº½ cÃ³ IOPS lÃ  12.288 vÃ  giÃ¡ lÃ  ~ <strong>$406</strong> táº¡i region us-east-1.</li>
<li><code>io1</code> lÃ  loáº¡i EBS mÃ  IOPS khÃ´ng phá»¥ thuá»™c vÃ o kÃ­ch thÆ°á»›c Ä‘Ä©a, cÃ³ thá»ƒ mua riÃªng IOPS. ThÆ°á»ng xÃ i khi cáº§n nhiá»u IOPS vÃ­ dá»¥ cÃ¡c á»©ng dá»¥ng database. KÃ­ch thÆ°á»›c tá»« 4 GB - 16TB. Max IOPS/volume lÃ  64,000, max throughput/volume 1,000 MB/s, max IOPS/instance lÃ  80.000, max throughput/instance 1750 MB/s. VÃ­ dá»¥ vá»›i 4TB dá»¯ liá»‡u + 12,288 IOPS sáº½ cÃ³ throughput lÃ  1000 MB/s, thÃ¬ sáº½ cÃ³ giÃ¡ lÃ  <strong>$1441</strong> táº¡i region us-east-1 -&gt; má»™t sá»± chÃªnh lá»‡nh ráº¥t lá»›n so vá»›i <code>gp2</code>. VÃ  giáº£ sá»­ cáº§n IOPS táº§m 20,000 (1 Æ°á»›c tÃ­nh cháº¯c Äƒn vÃ  so vá»›i physical server) thÃ¬ ta sáº½ tá»‘n gáº§n <strong>$2000</strong>/thÃ¡ng chá»‰ cho má»—i Ä‘Ä©a cá»©ng ğŸ˜‘.</li>
</ul>
</li>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html">Instance storage</a>: cung cáº¥p temporary block-level storage. Storage sáº½ Ä‘Æ°á»£c Ä‘áº·t trÃªn local disk mÃ  Ä‘Æ°á»£c physical attach vÃ o host computer (Ä‘Æ¡n giáº£n lÃ  1 physical Ä‘Æ°á»£c chia lÃ m nhiá»u EC2, thÃ¬ instance storage lÃ  vÃ¹ng storage láº¥y ra tá»« chÃ­nh local disk Ä‘áº·t trÃªn con physical Ä‘Ã³ vÃ  mount vÃ o EC2 - khÃ¡c vá»›i EBS lÃ  network disk, mount tá»« 1 physical khÃ¡c vÃ  instance storage thÃ¬ khÃ´ng thá»ƒ deattach/attach vÃ o instance khÃ¡c). Äáº·c Ä‘iá»ƒm chÃ­nh lÃ  <strong>cÃ³ tá»‘c Ä‘á»™ cao hÆ¡n</strong> nhÆ°ng dá»¯ liá»‡u <strong>khÃ´ng persistent</strong> (nghÄ©a lÃ  sáº½ máº¥t dá»¯ liá»‡u náº¿u instance bá»‹ stop hoáº·c terminate hoáº·c Ä‘Ä©a bá»‹ fail). CÃ³ 2 interface lÃ  SATA vÃ  NVMe tÆ°Æ¡ng tá»± nhÆ° physical disk.</li>
</ul>
<p><strong>GCP</strong> vá» cÆ¡ báº£n cÅ©ng tÆ°Æ¡ng tá»± nhÆ° AWS.</p>
<ul>
<li>Persistent Disk, tÆ°Æ¡ng tá»± EBS.</li>
<li>Local SSD, tÆ°Æ¡ng tá»± Instance storage.</li>
</ul>
<p>NÃ³i thÃªm vá» dá»¯ liá»‡u trÃªn Instance Storage/LocalSSD:</p>
<ul>
<li>Dá»¯ liá»‡u cá»§a instance storage/LocalSSD chá»‰ persistent trong vÃ²ng Ä‘á»i liÃªn káº¿t vá»›i instance chá»©a nÃ³, Náº¿u reboot (vÃ´ hÃ¬nh hoáº·c cá»‘ Ã½) thÃ¬ dá»¯ liá»‡u sáº½ khÃ´ng bá»‹ máº¥t.</li>
<li>Dá»¯ liá»‡u sáº½ bá»‹ máº¥t trong cÃ¡c trÆ°á»ng há»£p sau:
<ul>
<li>á»” Ä‘Ä©a bÃªn dÆ°á»›i bá»‹ lá»—i.</li>
<li>Instance stop.</li>
<li>Instance bá»‹ terminate.</li>
</ul>
</li>
<li>Vá»›i AWS, sáº½ khÃ´ng cÃ³ má»™t cÃ¡ch chÃ­nh thá»‘ng nÃ o Ä‘á»ƒ change instance type mÃ  giá»¯ láº¡i Ä‘Æ°á»£c dá»¯ liá»‡u trÃªn instance storage.</li>
</ul>
<p>Náº¿u báº¡n pháº£i lÃ m viá»‡c vá»›i instance storage/LocalSSD thÃ¬ <strong>báº¯t buá»™c</strong> pháº£i Ä‘á»c ká»¹ cÃ¡c link phÃ­a dÆ°á»›i náº¿u khÃ´ng muá»‘n bá»‹ máº¥t sáº¡ch dá»¯ liá»‡u.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html#instance-store-lifetime">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/InstanceStorage.html#instance-store-lifetime</a></li>
<li><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html#resize-instance-store-backed-instance">https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-resize.html#resize-instance-store-backed-instance</a></li>
<li><a href="https://cloud.google.com/compute/docs/disks/local-ssd#data_persistence">https://cloud.google.com/compute/docs/disks/local-ssd#data_persistence</a></li>
</ul>
<p>Váº­y tÃ³m táº¯t láº¡i 2 váº¥n Ä‘á» chÃ­nh:</p>
<ul>
<li>LÃ m sao náº¿u cáº§n IOPS vÆ°á»£t quÃ¡ giá»›i háº¡n cá»§a <code>io1</code> mÃ  dá»¯ liá»‡u váº«n Ä‘áº£m báº£o an toÃ n.</li>
<li>Chi phÃ­ há»£p lÃ½ (náº¿u <code>$2.000/month</code> thÃ¬ má»™t nÄƒm sáº½ tá»‘n $24.000 chá»‰ cho má»—i má»™t Ä‘Ä©a).</li>
</ul>
<h2 id="2-giáº£i-phÃ¡p">2. Giáº£i phÃ¡p</h2>
<p>Pháº§n nÃ y chá»§ yáº¿u dá»‹ch tá»« percona (cÃ³ lÆ°á»£c bá» 1 sá»‘ pháº§n Ä‘Ã£ nÃ³i á»Ÿ trÃªn), cÃ¡c issue Ä‘á»u tÆ°Æ¡ng tá»± pháº§n trÃªn, chá»‰ cÃ³ má»™t Ä‘iá»ƒm khÃ¡c biá»‡t lÃ  data cÃ³ kÃ­ch thÆ°á»›c lÃ  <strong>10TB+</strong>.</p>
<p>Giáº£i phÃ¡p cÃ³ thá»ƒ tÃ³m gá»n nhÆ° sau:</p>
<ul>
<li>DÃ¹ng local disk (instance storage) NHÆ¯NG lÆ°u Ã½ instance storage khÃ´ng <strong>persistence</strong> vÃ¬:
<ul>
<li>Nhanh vÃ¬ nÃ³ lÃ  local disk -&gt; giáº£i quyáº¿t chuyá»‡n vÆ°á»£t giá»›i háº¡n cá»§a <code>io1</code>.</li>
<li>Ráº» hÆ¡n EBS nhiá»u -&gt; ráº» hÆ¡n <code>io1</code> -&gt; giáº£i quyáº¿t bÃ i toÃ¡n chi phÃ­.</li>
</ul>
</li>
<li>VÃ¬ dá»¯ liá»‡u khÃ´ng an toÃ n vÃ  ta cáº§n EBS snapshot nÃªn sáº½ dÃ¹ng vÃ i instance <strong>replication</strong> (chi tiáº¿t á»Ÿ dÆ°á»›i).</li>
</ul>
<h3 id="21-so-sÃ¡nh-chi-phÃ­">2.1 So sÃ¡nh chi phÃ­</h3>
<p>Sá»­ dá»¥ng <a href="https://calculator.s3.amazonaws.com/index.html">cÃ´ng cá»¥ tÃ­nh chi phÃ­ cá»§a AWS</a>, cost Æ°á»›c tÃ­nh lÃ  cost Ä‘Äƒng kÃ½ 1 nÄƒm RIs vÃ  sá»­ dá»¥ng Ä‘Ä©a vá»›i 14TB (lÆ°u 10TB dá»¯ liá»‡u + binary log). Chi tiáº¿t nhÆ° sau:</p>
<p>r4.4xlarge, 122GB RAM, 16 vCPUs + EBS, 14TB volume</p>
<pre tabindex="0"><code>Amazon EC2 Service (US East (N. Virginia)) $ 1890.56 / month
Compute: $ 490.56
EBS Volumes: $1400.00
</code></pre><p>Local storage price estimate:
i3.4xlarge, 122GB RAM, 16 vCPUs, 3800 GiB disk (2 x 1900 NVMe SSD)</p>
<pre tabindex="0"><code>Amazon EC2 Service (US East (N. Virginia)) $ 627.21 / month
Compute: $625.61
</code></pre><p>i3.8xlarge, 244GB RAM, 32 vCPUs, 7600 GiB disk (4 x 1900 NVMe SSD)</p>
<pre tabindex="0"><code>Amazon EC2 Service (US East (N. Virginia)) $1252.82 / month
Compute: $ 1251.22
</code></pre><p>NhÆ° trÃªn ta tháº¥y náº¿u sá»­ dá»¥ng <strong>i3.8xlarge</strong> ta Ä‘Æ°á»£c:</p>
<ul>
<li>x2 RAM.</li>
<li>x2 virtual CPUs</li>
<li>ÄÄ©a nhanh hÆ¡n.</li>
<li>10 Gb network</li>
</ul>
<p>NhÆ°ng váº«n ráº» hÆ¡n 1.5 láº§n so vá»›i r4.4xlarge instance trÃªn cÃ¹ng.</p>
<h3 id="22-how-to-migrate-from-ebs-to-local-storage">2.2 How to migrate from EBS to local storage</h3>
<p>á» Ä‘Ã¢y ta cÃ³ má»™t vÃ i váº¥n Ä‘á» khÃ¡c cáº§n giáº£i quyáº¿t:</p>
<ul>
<li>Total data size lÃ  10TB vÃ  i3.8xlarge cÃ³ 7,600GB Ä‘Ä©a. Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y thÃ¬ cÃ¢u tráº£ lá»i lÃ  <strong>compression</strong>.</li>
<li>Local storage thÃ¬ ephemeral, khÃ´ng thá»ƒ cháº¥p nháº­n chuyá»‡n máº¥t dá»¯ liá»‡u -&gt; dÃ¹ng replication Ä‘á»ƒ Ä‘á»“ng bá»™ dá»¯ liá»‡u sang má»™t slave khÃ¡c (slave nÃ y cÅ©ng xÃ i instance storage) -&gt; Ä‘á»ƒ scale read vÃ  tÄƒng Ä‘á»™ an toÃ n cho dá»¯ liá»‡u.</li>
<li>Cáº§n EBS snapshot Ä‘á»ƒ backup -&gt; dÃ¹ng thÃªm 1 slave khÃ¡c + EBS Ä‘á»ƒ persistence dá»¯ liá»‡u (nhÆ°ng xÃ i EBS thÃ¬ sáº½ máº¯c) nÃªn ta cÃ³ thá»ƒ dÃ¹ng Ä‘Ä©a vá»›i IOPS tÆ°Æ¡ng Ä‘á»‘i vÃ  chá»‰ dÃ¹ng slave nÃ y cho backup hoáº·c phá»¥c vá»¥ má»™t lÆ°á»£ng nhá» traffic (vÃ­ dá»¥ analytic &hellip;). -&gt; cÃ³ thá»ƒ dÃ¹ng EBS snapshot cho instance nÃ y.</li>
</ul>
<p>Vá» <strong>compression data</strong>, vá»›i i3.x8large thÃ¬ chá»‰ cáº§n 2x compression, cÆ¡ báº£n cÃ³ 2 cÃ¡ch:</p>
<p><em><strong>InnoDB compression</strong></em></p>
<ul>
<li>InnoDB row compresssion (<a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-row-format-dynamic.html">row_format=compressed</a>) hoáº·c <a href="https://mariadb.com/kb/en/library/compression">InnoDB page compression</a>.</li>
<li>YÃªu cáº§u lÃ  filesystem pháº£i há»— trá»£ <a href="https://en.wikipedia.org/wiki/Sparse_file">sparse file</a> vÃ  <a href="https://stackoverflow.com/a/13982618">hole punching</a>, cÃ¡c filesystem hiá»‡n Ä‘áº¡i hiá»‡n nÃ y Ä‘á»u há»— trá»£ nhÆ° ext3, ext4 &hellip; hay NTFS. Hiá»ƒu má»™t cÃ¡ch Ä‘Æ¡n giáº£n thÃ¬ nÃ³ hoáº¡t Ä‘á»™ng nhÆ° cÃ¡ch mÃ  ta cáº¥p Ä‘Ä©a cá»©ng cho mÃ¡y áº£o, init 10GB nhÆ°ng náº¿u thá»±c sá»± chá»‰ dÃ¹ng 2GB thÃ¬ file image sáº½ chá»‰ cÃ³ kÃ­ch thÆ°á»›c 2GB -&gt; tá»‘i Æ°u viá»‡c lÆ°u trá»¯. Báº£n cháº¥t Ä‘Ã¢y lÃ  yÃªu cáº§u cá»§a compression chá»© khÃ´ng pháº£i cá»§a filesystem.</li>
<li>Tuy nhiÃªn InooDB compression cÃ³ thá»ƒ cháº­m hÆ¡n so vá»›i khÃ´ng compression vÃ  vÃ  nhÆ°á»£c Ä‘iá»ƒm lÃ  chá»‰ há»— trá»£ compress <code>ibd</code> file cÃ²n cÃ¡c file binary log, frm &hellip; thÃ¬ khÃ´ng há»— trá»£.</li>
</ul>
<p><em><strong>ZFS compression</strong></em></p>
<ul>
<li>ÄÃ¢y lÃ  compression trÃªn level filesystem, ZFS compression sáº½ compress táº¥t cáº£ cÃ¡c file bao gá»“m cáº£ binary log, frm &hellip;</li>
<li>Há»¯u Ã­ch náº¿u náº¿u dÃ¹ng nhiá»u tablespace hoáº·c khi sá»­ dá»¥ng <em>schema per customer</em>, <em>table per customer</em> &hellip;</li>
</ul>
<p>Má»™t sá»‘ thÃ´ng tin vá» zfs compression nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; du -sh --apparent-size /mysqldata/mysql/data
8.6T	/mysqldata/mysql/data
&gt; du -sh /mysqldata/mysql/data
3.2T	/mysqldata/mysql/data
</code></pre></div><p>=&gt; lÆ°u Ã½ Ä‘Ã¢y lÃ  dá»¯ liá»‡u tháº­t mÃ  tÃ¡c giáº£ Ä‘ang váº­n hÃ nh chá»© khÃ´ng pháº£i generated data Ä‘á»ƒ test.</p>
<p>Vá»›i tá»‰ lá»‡ nÃ©n lÃ  2.42x cho table vÃ  3.75x cho binary log, giÃºp giáº£m tá»« 8.6T -&gt; 3.2T sáº½ vá»«a Ä‘á»§ trÃªn i3.8xlarge instance.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; zfs get all | grep -i compress
...
mysqldata/mysql/data  compressratio         2.42x                  -
mysqldata/mysql/data  compression           gzip                   inherited from mysqldata/mysql
mysqldata/mysql/data  refcompressratio      2.42x                  -
mysqldata/mysql/log   compressratio         3.75x                  -
mysqldata/mysql/log   compression           gzip                   inherited from mysqldata/mysql
mysqldata/mysql/log   refcompressratio      3.75x    
</code></pre></div><p>=&gt; TÃ³m láº¡i thÃ¬ ZFS cung cáº¥p má»™t tá»‰ lá»‡ nÃ©n khÃ¡ tá»‘t vÃ  do nÃ©n á»Ÿ level filesystem nÃªn cÃ³ thá»ƒ nÃ©n táº¥t cáº£ má»i thá»© trÃªn filesystem, giÃºp tiáº¿t kiá»‡m má»™t sá»‘ tiá»n Ä‘Ã¡ng ká»ƒ. Tuy nhiÃªn thÃ¬ compression khÃ´ng miá»…n phÃ­ <a href="https://www.percona.com/blog/2018/02/16/why-zfs-affects-mysql-performance">ZFS scan sáº½ cháº­m hÆ¡n á»Ÿ má»™t sá»‘ workload</a>, sá»­ dá»¥ng local NVMe storage Ä‘á»ƒ bÃ¹ láº¡i hiá»‡u suáº¥t.</p>
<p>NgoÃ i ra báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm vá» má»™t sá»‘ performance testing dÃ nh cho ZFS trÃªn linux á»Ÿ bÃ i viáº¿t <a href="https://www.percona.com/blog/2018/05/15/about-zfs-performance">About ZFS Performance</a>.</p>
<p><em><strong>MyRock</strong></em></p>
<p>NgoÃ i 2 cÃ¡ch trÃªn Ä‘á»ƒ nÃ©n dá»¯ liá»‡u thÃ¬ má»™t lá»±a chá»n khÃ¡c lÃ  sá»­ dá»¥ng <a href="http://myrocks.io">MyRocks storage engine</a>, Ä‘Ã¢y lÃ  storage engine do Facebook phÃ¡t triá»ƒn nháº±m giáº£i quyáº¿t bÃ i toÃ¡n kÃ­ch thÆ°á»›c lÆ°u trá»¯ vÃ  hiá»‡u nÄƒng ghi dá»¯ liá»‡u.</p>
<p><strong>Replication &amp; local volumes</strong>: NhÆ° nÃ³i á»Ÿ trÃªn thÃ¬ ta sáº½ cáº§n vÃ i server replication Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»™ an toÃ n cá»§a dá»¯ liá»‡u, mÃ´ hÃ¬nh sáº½ nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">master - local storage <span style="color:#f92672">(</span>AZ 1, i.e. 1a<span style="color:#f92672">)</span>
-&gt; slave1 - local storage <span style="color:#f92672">(</span>AZ 2, i.e. 1b<span style="color:#f92672">)</span>
-&gt; slave2 - local storage with delayed replication <span style="color:#f92672">(</span>AZ 3, i.e. 1b<span style="color:#f92672">)</span>
-&gt; slave3 - ebs storage <span style="color:#f92672">(</span>AZ 3, i.e. 1c<span style="color:#f92672">)</span>
   <span style="color:#f92672">(</span>other replication slaves <span style="color:#66d9ef">if</span> needed with local storage - optional<span style="color:#f92672">)</span>
</code></pre></div><p><img src="https://www.percona.com/blog/wp-content/uploads/2018/08/master-slave.png" alt="master-slave"></p>
<p>Má»™t sá»‘ lÆ°u Ã½:</p>
<ul>
<li>Äáº·t cÃ¡c replication á»Ÿ cÃ¡c availability zone khÃ¡c nhau.</li>
<li>CÃ¡c local storage thÃ¬ khÃ´ng bá»n (not durable) nghÄ©a lÃ  náº¿u ta <strong>stop instance</strong> vÃ  <strong>start instance láº¡i</strong> thÃ¬ <strong>dá»¯ liá»‡u sáº½ máº¥t</strong>. TUY NHIÃŠN reboot dÃ¹ vÃ´ tÃ¬nh hay cá»‘ Ã½ (instance reboots intentionally or unintentionally) lÃ  ngoáº¡i lá»‡, báº¡n cÃ³ thá»ƒ reboot instance vÃ  local storage váº«n sáº½ Ä‘Æ°á»£c giá»¯ láº¡i.</li>
<li>Failover cho master báº±ng slave khi master cháº¿t cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng <a href="https://www.percona.com/blog/2016/09/02/mha-quickstart-guide">MHA</a> hoáº·c <a href="https://www.percona.com/blog/2016/03/08/orchestrator-mysql-replication-topology-manager">Orchestrator</a>.</li>
<li>CÃ³ thá»ƒ clone slave báº±ng cÃ¡ch dÃ¹ng <code>xtrabackup</code> hoáº·c <code>zfs snapshot</code>, vá»›i <code>xtrabackup</code> cÃ³ thá»ƒ Ä‘á»c má»™t sá»‘ bÃ i viáº¿t khÃ¡c vá» clone slave trÃªn blog cá»§a mÃ¬nh.</li>
<li>NÃªn xÃ i <a href="https://xluffy.github.io/post/delayed-replication-in-mysql"><strong>delayed replication</strong></a> vá»›i Ä‘á»™ trá»… sync dá»¯ liá»‡u tá»« 30 phÃºt - 60 phÃºt Ä‘á»ƒ trÃ¡nh human-error.</li>
</ul>
<h2 id="3-tá»•ng-káº¿t">3. Tá»•ng káº¿t</h2>
<ul>
<li>Sá»­ dá»¥ng <code>io1</code> cho IOPS tá»‘t nhÆ°ng siÃªu máº¯c.</li>
<li>Sá»­ dá»¥ng local storage vÃ  i3 instance giÃºp tiáº¿t kiá»‡m tiá»n nhÆ°ng pháº£i aware cÃ¡c giáº£i phÃ¡p vá» an toÃ n dá»¯ liá»‡u vÃ  Ä‘á»™ tiá»‡n dá»¥ng, operation.</li>
<li>CÃ³ thá»ƒ sá»­ dá»¥ng MyRock, nhÆ°ng Ä‘á»•i storage engine lÃ  má»™t bigger task yÃªu cáº§u nhiá»u thá»i gian vÃ  kiá»ƒm thá»­.</li>
<li>CÃ³ thá»ƒ Ä‘á»•i qua sá»­ dá»¥ng <a href="https://www.percona.com/blog/2018/07/17/when-should-i-use-amazon-aurora-and-when-should-i-use-rds-mysql">AWS Aurora</a> nhÆ°ng chi phÃ­ cÅ©ng sáº½ ráº¥t máº¯c vÃ  cÅ©ng lÃ  má»™t bigger task.</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xluffy.github.io/post/who-owns-my-encrypt-keys-on-cloud/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Who owns my encrypt keys on cloud?</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xluffy.github.io/post/alb-vs-nginx/">
                  <span class="button__text">ALB vs nginx</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">hÃ ng nhÃ  trá»“ng ğŸŒ´ theo giáº¥y phÃ©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://xluffy.github.io/assets/main.js"></script>
<script src="https://xluffy.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
