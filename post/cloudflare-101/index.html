<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloudflare 101 | xluffy&#39;s page</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
    <header>

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://xluffy.github.io">/home/xluffy&#39;s page</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/categories/">~/categories</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://github.com/xluffy/til/issues">~/til</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="#">~/books</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

    
    
      
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-K4LWNXV');</script>
      
    
  </head>

  <body>
    
      
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K4LWNXV" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      
    
    <br/>

<div class="article-meta">
<h1><span class="title">Cloudflare 101</span></h1>

<h2 class="date">2019/07/11</h2>
<p class="terms">
  
  
  Categories: <a href="/categories/security">security</a> <a href="/categories/cdn">cdn</a> 
  
  
  
  
</p>
</div>



<main>


<h2 id="1-ddos-101">1. DDoS 101</h2>

<p>V·ªÅ DDoS d√π m·ª•c ƒë√≠ch cu·ªëi c√πng l√† l√†m cho d·ªãch v·ª• c·ªßa b·∫°n kh√¥ng th·ªÉ cung c·∫•p t·ªõi ng∆∞·ªùi d√πng nh∆∞ng n√≥ c√≥ th·ªÉ ƒë∆∞·ª£c chia th√†nh 3 nh√≥m:</p>

<ul>
<li><strong>Application Layer Attacks</strong>: m·ª•c ti√™u l√† khi·∫øn ·ª©ng d·ª•ng ph·∫£i x·ª≠ l√Ω m·ªôt l∆∞·ª£ng l·ªõn c√°c request <em>c√≥ v·∫ª h·ª£p l·ªá</em>, l√†m c·∫°n ki·ªát t√†i nguy√™n c·ªßa ·ª©ng d·ª•ng, khi·∫øn ·ª©ng d·ª•ng kh√¥ng th·ªÉ ph·ª•c v·ª• c√°c user h·ª£p l·ªá kh√°c. V√≠ d·ª• trong ·ª©ng d·ª•ng TMƒêT, m·ªôt API ƒë·ªçc database tr·∫£ v·ªÅ m·ªôt danh s√°ch chi ti·∫øt c·ªßa c√°c s·∫£n ph·∫©m thu·ªôc m·ªôt nh√≥m ng√†nh. Attacker c√≥ th·ªÉ vi·∫øt m·ªôt tools ƒë·ªÉ crawl h·∫øt d·ªØ li·ªáu c·ªßa t·ª´ng ng√†nh h√†ng, khi·∫øn server kh√¥ng ƒë·ªß t√†i nguy√™n ƒë·ªÉ ph·ª•c v·ª•. Vi·ªác c·∫£n l·ªçc request thu·ªôc nh√≥m n√†y kh√¥ng d·ªÖ v√¨ n√≥ s·∫Ω kh√° gi·ªëng v·ªõi request c·ªßa user th√¥ng th∆∞·ªùng v√† c√≥ th·ªÉ c·∫£n l·ªçc nh·∫ßm nh·ªØng user h·ª£p l·ªá.</li>
<li><strong>Protocol Attacks</strong>: t∆∞∆°ng t·ª± application layer attack nh∆∞ng nh·∫Øm v√†o layer 3 v√† layer 4 trong m√¥ h√¨nh OSI. V√≠ d·ª• ƒëi·ªÉn h√¨nh l√† SYN Flood, l·ª£i d·ª•ng vi·ªác b·∫Øt-tay-3-b∆∞·ªõc trong giao th·ª©c TCP, attacker s·∫Ω g·ª≠i m·ªôt m·ªôt g√≥i SYN ƒë·ªÉ thi·∫øt l·∫≠p k·∫øt n·ªëi TCP, server s·∫Ω tr·∫£ v·ªÅ m·ªôt g√≥i SYN-ACK v√† ch·ªù ƒë·ª£i m·ªôt g√≥i ACK ƒë·ªÉ k·∫øt th√∫c qu√° tr√¨nh b·∫Øt tay. Nh∆∞ng sau ƒë√≥ attacker s·∫Ω kh√¥ng bao gi·ªù tr·∫£ v·ªÅ ACK, khi·∫øn server ph·∫£i ti√™u t·ªën t√†i nguy√™n cho vi·ªác ch·ªù ƒë·ª£i ph·∫£n h·ªìi.</li>
<li><strong>Volumetric Attacks</strong>: Hai lo·∫°i tr√™n ƒë·ªÅu nh·∫Øm t·ªõi ·ª©ng d·ª•ng, h·ªá ƒëi·ªÅu h√†nh ph·∫£i ti√™u t·ªën t√†i nguy√™n x·ª≠ l√Ω. Ri√™ng volumetric attack nh·∫Øm t·ªõi bƒÉng th√¥ng c·ªßa h·ªá th·ªëng victim. V√≠ d·ª• kh√°ch h√†ng ch·ªâ c√≥ kh·∫£ nƒÉng thu√™ m·ªôt ƒë∆∞·ªùng truy·ªÅn c√≥ bƒÉng th√¥ng 100Mbps, attacker s·∫Ω t√¨m c√°ch flood m·ªôt l∆∞·ª£ng l·ªõn traffic l·ªõn h∆°n 100Mbps, khi·∫øn con ƒë∆∞·ªùng t·ªõi server c·ªßa victim b·ªã ngh·∫Ωn (t∆∞∆°ng t·ª± ƒë∆∞·ªùng 2 l√†n, nh∆∞ng c√≥ t·ªõi 10 l√†n xe c√πng v√†o m·ªôt l√∫c s·∫Ω g√¢y ng·∫Ωn v√† nh·ªØng xe c·∫ßn ƒëi th·∫≠t s·∫Ω kh√¥ng th·ªÉ di chuy·ªÉn). V√≠ d·ª• <a href="https://blog.cloudflare.com/memcrashed-major-amplification-attacks-from-port-11211">Memcrashed</a>, l·ª£i d·ª•ng c√°c memcached server m·ªü UDP port ra ngo√†i public, attacker g·ª≠i m·ªôt g√≥i tin v·ªõi <code>source_ip</code> ƒë∆∞·ª£c gi·∫£ m·∫°o th√†nh <code>source_ip</code> c·ªßa victim t·ªõi c√°c server memcached zoombie n√†y. M·ªôt request g·ª≠i ƒëi ch·ªâ v·ªõi 15 bytes nh∆∞ng memcached tr·∫£ v·ªÅ 134KB d·ªØ li·ªáu, v√† khu·∫øch ƒë·∫°i l√™n th√¨ Cloudflare ghi nh·∫≠n peak t·ªõi <strong>260Gbps</strong> UDP traffic, ƒë·ªß l√† ngh·∫Ωn network c·ªßa b·∫•t c·ª© h·ªá th·ªëng n√†o.</li>
</ul>

<p>ƒê·ªÉ ch·ªëng l·∫°i m·ªôt cu·ªôc t·∫•n c√¥ng DDoS th√¨ t√πy v√†o lo·∫°i attack. Tuy nhi√™n ƒë·ª©ng ·ªü g√≥c ƒë·ªô l√†m s·∫£n ph·∫©m th√¨ lu√¥n c·ªë g·∫Øng ph·ª•c v·ª• t·∫•t c·∫£ c√°c request k·ªÉ c·∫£ b·∫•t h·ª£p l·ªá thay v√¨ <strong>block</strong> request v√¨ n·∫øu block nh·∫ßm user h·ª£p l·ªá c≈©ng coi nh∆∞ t·ª´ ch·ªëi ph·ª•c v·ª• d·ªãch v·ª• cho kh√°ch h√†ng -&gt; gi√∫p k·∫ª t·∫•n c√¥ng ƒë·∫°t ƒë∆∞·ª£c m·ª•c ƒë√≠ch l√† ·ª©ng d·ª•ng c·ªßa ch√∫ng ta kh√¥ng th·ªÉ cung c·∫•p d·ªãch v·ª• t·ªõi kh√°ch h√†ng. T·∫•t nhi√™n ta c≈©ng ph·∫£i ƒë√°nh ƒë·ªïi gi·ªØa vi·ªác b·∫£o v·ªá ph·∫ßn l·ªõn user hay c·∫£n l·ªçc nh·∫ßm c√°c user h·ª£p l·ªá ƒë·ªÉ ƒë∆∞a ra quy·∫øt ƒë·ªãnh ƒë√∫ng ƒë·∫Øn.</p>

<p>M·ªôt s·ªë ph∆∞∆°ng ph√°p ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t ƒë·ªÉ gi·∫£m thi·ªÉu c·∫£n l·ªçc DDoS attack nh∆∞ sau:</p>

<ul>
<li><strong>Black Hole Routing</strong>: t∆∞∆°ng t·ª± nh∆∞ <code>&amp;&gt; /dev/null</code> ƒë·∫©y to√†n b·ªô traffic c·∫£ h·ª£p l·ªá l·∫´n kh√¥ng h·ª£p l·ªá v√†o h·ªë ƒëen.</li>
<li><strong>Rate limit request</strong>: gi·ªõi h·∫°n s·ªë l∆∞·ª£ng request m√† server ch·∫•p nh·∫≠n x·ª≠ l√Ω trong m·ªôt khung th·ªùi gian. H·ªØu √≠ch khi ch·ªëng crawler ho·∫∑c brute-force login.</li>
<li><strong>WAF (Web Application Firewall)</strong>: b·∫£o v·ªá server, ·ª©ng d·ª•ng b·ªüi c√°c l·ªó h·ªïng th√¥ng th∆∞·ªùng nh∆∞ SQL injection, XSS&hellip;</li>
<li><strong>Anycast Network Diffusion</strong>: m·ªôt gi·∫£i th√≠ch d·ªÖ hi·ªÉu h∆°n t·ª´ anh <a href="https://github.com/lebinh">lebinh</a>, b·∫°n c√≥ th·ªÉ ƒë·ªçc th√™m n√≥ ·ªü ƒë√¢y <a href="https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5">https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5</a>.</li>
</ul>

<h2 id="2-rate-limit">2. Rate Limit</h2>

<p>Cloudflare cung c·∫•p m·ªôt t√≠nh nƒÉng cho ph√©p control v√† block c√°c traffic ƒë√°ng ng·ªù. T√≠nh nƒÉng n√†y gi√∫p <strong>t·ª± ƒë·ªông</strong> b·∫£o v·ªá website c·ªßa b·∫°n kh·ªèi:</p>

<ul>
<li>DDoS attack.</li>
<li>brute-force login.</li>
<li>‚Ä¶.</li>
</ul>

<p>C√¢u h·ªèi ƒë·∫∑t ra l√† t·∫°i sao tui ph·∫£i tr·∫£ ti·ªÅn Cloudflare ƒë·ªÉ x√†i t√≠nh nƒÉng n√†y? C√≥ gi·∫£i ph√°p n√†o thay th·∫ø mi·ªÖn ph√≠, ƒë∆°n gi·∫£n hay kh√¥ng?</p>

<p>T√≠nh nƒÉng limit request/minute ho·∫∑c block request kh√¥ng c√≥ g√¨ m·ªõi. Ta c√≥ th·ªÉ gi·∫£i quy·∫øt b·∫±ng c√°c gi·∫£i ph√°p sau:</p>

<ul>
<li>Limit request ·ªü t·∫ßng application, v√≠ d·ª• <a href="https://github.com/kickstarter/rack-attack">rack-attack</a>.</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html">ngx_http_limit_req_module</a>, block ip, limit request d·ª±a tr√™n ng∆∞·ª°ng v√† th·ªùi gian.</li>
<li>nginx + lua + redis, t∆∞∆°ng t·ª± nh∆∞ tr√™n, nh∆∞ng ta c√≥ th·ªÉ t·∫≠n d·ª•ng expire/ttl c·ªßa redis ƒë·ªÉ ban/block m·ªôt IP v√† sau ƒë√≥ unban IP ƒë√≥ theo expire c·ªßa m·ªôt key trong redis. M·ªôt ∆∞u ƒëi·ªÉm kh√°c l√† ta c√≥ th·ªÉ query d·ªØ li·ªáu trong redis ƒë·ªÉ report.</li>
<li>Host-based firewall nh∆∞ iptables/ufw -&gt; block/limit request ·ªü c√°c layer th·∫•p h∆°n application layer:

<ul>
<li>∆Øu ƒëi·ªÉm l√† block ·ªü c√°c layer th·∫•p nh∆∞ transport layer tr·ªü xu·ªëng, request s·∫Ω ch∆∞a k·ªãp t·ªõi application layer, gi·∫£m t·∫£i cho web server.</li>
<li>V·ªõi limit request, ta s·∫Ω c·∫ßn load th√™m m·ªôt s·ªë module h·ªó tr·ª£ iptable -&gt; firewall stateful -&gt; b·∫°n c√≥ th·ªÉ ƒë·ªçc th√™m m·ªôt b√†i r·∫•t hay v·ªÅ <a href="https://making.pusher.com/per-ip-rate-limiting-with-iptables">rate-limit v·ªõi iptables t·ª´ Pusher</a>.</li>
<li>Nh∆∞·ª£c ƒëi·ªÉm l√† kh√¥ng t·ª± ƒë·ªông c·∫≠p nh·∫≠t danh s√°ch IP m·ªõi b·ªã ban/block/limit. ƒê·ªÉ gi·∫£i quy·∫øt vi·ªác c·∫≠p nh·∫≠t t·ª± ƒë·ªông c√≥ th·ªÉ <a href="https://vnhacker.blogspot.com/2009/12/giam-sat-ninh-mang-hay-la-lam-nao-e.html">build m·ªôt h·ªá th·ªëng offline ƒë·ªÉ ph√¢n t√≠ch v√† update l·∫°i v√†o h·ªá th·ªëng firewall</a>. ∆Øu ƒëi·ªÉm c·ªßa vi·ªác build m·ªôt h·ªá th·ªëng offline l√† impact t·ªõi h·ªá th·ªëng kh√¥ng l·ªõn, qu√° tr√¨nh ph√¢n t√≠ch di·ªÖn ra ·ªü m·ªôt c·ª•m m√°y t√≠nh kh√°c, nh∆∞·ª£c ƒëi·ªÉm l√† b·∫°n ph·∫£i c√≥ traffic v√† ƒÉn m·ªôt v√†i ƒë·ª£t t·∫•n c√¥ng ƒë·ªÉ c√≥ ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n.</li>
</ul></li>
<li>Network-based firewall: c√°c firewall n·∫±m ngo√†i host nh∆∞ hardware firewall ho·∫∑c security group c·ªßa AWS (nh∆∞ng v·ªÅ l√Ω thuy·∫øt n√≥ kh√¥ng ƒë∆∞·ª£c x·∫øp v√†o network-based firewall). C≈©ng t∆∞∆°ng t·ª± host-based firewall l√† vi·ªác c·∫≠p nh·∫≠t danh s√°ch IP s·∫Ω kh√≥ khƒÉn. V√† v·ªõi security group c·ªßa AWS th√¨ kh√¥ng th·ªÉ limit request (ch·ªâ c√≥ ch·∫∑n).</li>
</ul>

<p><strong>Nh∆∞·ª£c ƒëi·ªÉm</strong> c·ªßa t·∫•t c·∫£ c√°c ph∆∞∆°ng ph√°p tr√™n l√†:</p>

<ul>
<li>Request c·ªßa attacker <strong>ƒë√£ t·ªõi h·ªá th·ªëng</strong> c·ªßa b·∫°n, n·∫øu x√†i network-base firewall th√¨ request ƒë√£ v√†o t·ªõi router/hardware-firewall, n·∫øu x√†i host-based firewall (iptables) th√¨ request ƒë√£ t·ªõi server (OS ƒë√£ ph·∫£i handle), n·∫øu b·∫°n limit ·ªü t·∫ßng application th√¨ web server (nginx ho·∫∑c Apache) ƒë√£ ph·∫£i x·ª≠ l√Ω (tuy nhi√™n n·∫øu x√†i nginx nh∆∞ m·ªôt proxy th√¨ c≈©ng kh√¥ng t·ªën th√™m bao nhi√™u resource) v√† n·∫øu b·∫°n x√†i m·ªôt th∆∞ vi·ªán nh∆∞ <a href="https://github.com/kickstarter/rack-attack">rack-attach</a> th√¨ Rails ph·∫£i handle th√™m vi·ªác gi·ªõi h·∫°n request.</li>
<li>Th√™m thi·∫øt b·ªã, software ƒë·ªÉ x·ª≠ l√Ω v·∫•n ƒë·ªÅ (s·∫Ω kh√¥ng ph√π h·ª£p v·ªõi h·ªá th·ªëng nh·ªè).</li>
</ul>

<p>V·∫≠y n·∫øu x√†i rate-limit c·ªßa Cloudflare th√¨ c√≥ l·ª£i g√¨?</p>

<ul>
<li>T∆∞·ªüng t∆∞·ª£ng Cloudflare s·∫Ω nh∆∞ m·ªôt reverse proxy m·ªçi request tr∆∞·ªõc khi ƒëi t·ªõi origin server c·ªßa b·∫°n ƒë·ªÅu s·∫Ω ƒëi qua Cloudflare.</li>
<li>BƒÉng th√¥ng c·ªßa Cloudflare l√† <strong>30Tbps</strong>, g·∫•p <strong>15 l·∫ßn</strong> cu·ªôc t·∫•n c√¥ng DDoS l·ªõn nh·∫•t t·ª´ng ƒë∆∞·ª£c ghi nh·∫≠n (ch·∫Øc l√† memcrashed), v·ªõi con nh√† ngh√®o, b·∫°n ch·ªâ thu√™ ƒë∆∞·ª£c bƒÉng th√¥ng 100Mbps. Cloudflare ho·∫°t ƒë·ªông nh∆∞ BOT (tr·∫°m thu ph√≠) gi·ªØa qu·ªëc l·ªô v√† ƒë∆∞·ªùng l√†ng, gi√∫p b√≥p nh·ªè / c·∫£n l·ªçc b·ªõt traffic tr∆∞·ªõc khi t·ªõi server c·ªßa b·∫°n, kh√¥ng l√†m overload network c·ªßa b·∫°n. (th√¥ng th∆∞·ªùng n·∫øu b·∫°n host server ·ªü DC, khi g·∫∑p m·ªôt cu·ªôc t·∫•n c√¥ng volumetric attacks, b·∫°n c√≥ th·ªÉ nh·ªù DC tƒÉng bƒÉng th√¥ng ƒë·ªÉ ch·ªëng ch·ªçi ho·∫∑c nh·ªù Firewall/Router c·ªßa DC c·∫£n l·ªçc b·ªõt traffic tr∆∞·ªõc khi v√†o server c·ªßa b·∫°n, t∆∞∆°ng t·ª± nh∆∞ Cloudflare).</li>
<li>D·ªÖ c·∫•u h√¨nh ng∆∞·ª°ng, URL v√† c√≥ report ƒë·ªÉ xem.</li>
<li>Th√¥ng minh, t·ª± ƒë·ªông nh·∫≠n bi·∫øt c√°c request kh√¥ng h·ª£p l·ªá, c√≥ th·ªÉ expire sau m·ªôt kho·∫£ng th·ªùi gian (t∆∞∆°ng t·ª± lua+redis), cho ph√©p user t·ª± bypass b·∫±ng c√°ch pass <em>challenge</em> ho·∫∑c <em>js challenge</em> thay v√¨ block ngay.</li>
</ul>

<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/49gHcPDvyg0AcS4sy6qWao/e890866ea6582fb7a63f30e0ed34bdb9/rate-limiting-rules.png" alt="rate-limit" /></p>

<p>N√≥i t√≥m l·∫°i th√¨ Cloudflare v·ªõi chi ph√≠ t·∫ßm 20$/th√°ng l√† m·ªôt l·ª±a ch·ªçn kh√¥ng t·ªìi ƒë·ªÉ ch·ªëng DDoS, t·∫•t nhi√™n b·∫°n ph·∫£i hi·ªÉu v·∫•n ƒë·ªÅ c·ªßa m√¨nh l√† g√¨ v√† ƒë√°nh gi√° c√°c l·ª±a ch·ªçn.</p>

<h2 id="3-proxy">3. Proxy</h2>

<h3 id="3-1-proxy-101">3.1 Proxy 101</h3>

<p>ƒê·ªÉ x√†i ƒë∆∞·ª£c t√≠nh nƒÉng nh∆∞ <strong>rate-limit</strong> th√¨ b·∫°n ph·∫£i cho ph√©p request c·ªßa user ƒëi qua h·ªá th·ªëng Cloudflare tr∆∞·ªõc khi t·ªõi server c·ªßa b·∫°n, ƒë√≥ ch√≠nh l√† Proxy trong Cloudflare.</p>

<p>Proxy c√≥ th·ªÉ ƒë∆∞·ª£c chia l√†m 2 lo·∫°i, kh√°c nhau ·ªü v·ªã tr√≠ ƒë·∫∑t v√† m·ª•c ƒë√≠ch s·ª≠ d·ª•ng:</p>

<p><strong>Forward Proxy</strong>:</p>

<pre><code class="language-asciiarmor">{clientA, clientB, clientC} ‚Äî‚Äî&gt; forward proxy (F) ‚Äî‚Äî&gt; Internet (I) ‚Äî‚Äî&gt; {origin-serverA, origin-serverB}
</code></pre>

<ul>
<li>V·ªõi ng∆∞·ªùi d√πng, d√πng forward proxy gi√∫p h·ªç bypass ƒë∆∞·ª£c c√°c gi·ªõi h·∫°n truy c·∫≠p website. N√≥ h∆°i gi·ªëng v·ªõi VPN, forward proxy s·∫Ω thay ng∆∞·ªùi d√πng g·ª≠i request t·ªõi website b·∫°n mu·ªën truy c·∫≠p thay v√¨ k·∫øt n·ªëi tr·ª±c ti·∫øp.</li>
<li>V·ªõi ng∆∞·ªùi qu·∫£n tr·ªã h·ªá th·ªëng, h·ªç c√≥ th·ªÉ ƒë·∫∑t m·ªôt forward proxy trong m·∫°ng n·ªôi b·ªô c·ªßa h·ªç v√† <strong>√©p</strong> t·∫•t c·∫£ c√°c client ph·∫£i ƒëi qua forward proxy n√†y tr∆∞·ªõc khi k·∫øt n·ªëi ra Internet. Vi·ªác n√†y ƒëem l·∫°i 2 l·ª£i √≠ch, th·ª© nh·∫•t ƒë√≥ l√† caching c√°c d·ªØ li·ªáu m√† ng∆∞·ªùi d√πng th∆∞·ªùng xuy√™n truy c·∫≠p v√† th·ª© hai l√† c√≥ th·ªÉ c·∫£n l·ªçc, ch·∫∑n truy c·∫≠p m·ªôt s·ªë website, ·ª©ng d·ª•ng (v√≠ d·ª• ch·∫∑n kh√¥ng c√≥ user trong m·∫°ng n·ªôi b·ªô truy c·∫≠p Facebook.com).</li>
<li>·∫®n danh, t∆∞∆°ng t·ª± nh∆∞ VPN.</li>
</ul>

<p><strong>Reverse proxy</strong></p>

<pre><code class="language-asciiarmor">{clientA, clientB, clientC} ‚Äî‚Äî&gt; Internet (I) ‚Äî‚Äî&gt; reverse proxy (R)‚Äî‚Äî&gt; {origin-serverA, origin-serverB}
</code></pre>

<p>M·ªôt v√≠ d·ª• quen thu·ªôc c·ªßa reverse proxy ƒë√≥ l√† b·∫°n x√†i nginx upstream tr∆∞·ªõc c√°c backend server. L·ª£i ƒëi·ªÉm c·ªßa vi·ªác d√πng reverse proxy ƒë√≥ l√†:</p>

<ul>
<li><strong>Load balacing</strong> -&gt; chia request t·ª´ client t·ªõi nhi·ªÅu backend server v·ªõi c√°c thu·∫≠t to√°n kh√°c nhau. Gi√∫p ƒëi·ªÅu ti·∫øt l∆∞·ª£ng request t·ªõi backend server.</li>
<li><strong>Protection from attack</strong> -&gt; m·ªçi request t·ª´ client s·∫Ω ph·∫£i ƒëi qua reverse proxy, b·∫°n c√≥ th·ªÉ apply c√°c rule tr√™n reverse proxy ƒë·ªÉ c·∫£n l·ªçc request tr∆∞·ªõc khi t·ªõi backend server (t∆∞∆°ng t·ª± nh∆∞ rate-limit ·ªü tr√™n). B·∫£n ch·∫•t c·ªßa proxy l√† nh·∫≠n v√† pass request ƒëi n√™n c√°c x·ª≠ l√Ω tr√™n proxy l√† kh√° nh·∫π nh√†ng.</li>
<li><strong>Global Server Load Balancing</strong> -&gt; t∆∞∆°ng t·ª± nh∆∞ load balacing nh∆∞ng ·ªü c·∫•p ƒë·ªô global, reverse proxy s·∫Ω nh·∫≠n bi·∫øt ƒë∆∞·ª£c l√† backend server n√†o g·∫ßn v·ªõi client v√† chuy·ªÉn h∆∞·ªõng request c·ªßa client t·ªõi backend server g·∫ßn nh·∫•t ƒë·ªÉ gi·∫£m latency, load time.</li>
<li><strong>Caching</strong> -&gt; request c·ªßa client v·∫´n ph·∫£i t·ªõi infra c·ªßa site, tuy nhi√™n vi·ªác caching s·∫Ω n·∫±m ·ªü infra c·ªßa site (kh√°c v·ªõi caching ·ªü forward proxy n·∫±m ·ªü network c·ªßa client), m·ª•c ƒë√≠ch c≈©ng t∆∞∆°ng t·ª± l√† gi·∫£m response time.</li>
<li><strong>SSL encryption</strong> -&gt; ƒë·∫©y ph·∫ßn encrypt/decrypt ra reverse proxy, k·∫øt n·ªëi t·ª´ reverse proxy t·ªõi backend server l√† HTTP.</li>
</ul>

<p>·ªû ƒë√¢y ta s·∫Ω ch·ªâ n√≥i t·ªõi reverse proxy, th·ª© m√† r·∫•t quen thu·ªôc khi v·∫≠n h√†nh m·ªôt h·ªá th·ªëng website/api. Tuy nhi√™n ƒëi·ªÉm kh√°c bi·ªát l√† b·∫°n th∆∞·ªùng ƒë·∫∑t reverse proxy <strong>trong h·ªá th·ªëng m·∫°ng c·ªßa b·∫°n</strong>, c√≤n v·ªõi Cloudflare th√¨ ch·ª©c nƒÉng t∆∞∆°ng t·ª±, nh∆∞ng proxy n·∫±m b√™n ngo√†i h·ªá th·ªëng m·∫°ng c·ªßa b·∫°n v√† v·ªõi bƒÉng th√¥ng 30Tbps, Cloudflare ƒë·ªß s·ª©c h·ª©ng m·ªçi ƒë·ª£t t·∫•n c√¥ng tr∆∞·ªõc khi t·ªõi origin server c·ªßa b·∫°n.</p>

<p><img src="https://blog.cloudflare.com/content/images/ddos-illustrations-2.png" alt="cloudflare-reverse-proxy" /></p>

<p>V√≠ d·ª• website c·ªßa b·∫°n c√≥ ƒë·ªãa ch·ªâ IP l√† <a href="1.2.3.4">1.2.3.4</a>, khi b·∫≠t t√≠nh nƒÉng proxy, domain website c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ph√¢n gi·∫£i IP th√†nh m·ªôt ƒë·ªãa ch·ªâ IP thu·ªôc l·ªõp m·∫°ng c·ªßa Cloudflare, v√≠ d·ª• <a href="104.20.148.78">104.20.148.78</a>, v√† user s·∫Ω kh√¥ng bi·∫øt origin server c·ªßa b·∫°n. V·ªõi attacker, m·ªçi request c≈©ng s·∫Ω ƒëi qua h·ªá th·ªëng c·ªßa Cloudflare tr∆∞·ªõc khi t·ªõi h·ªá th·ªëng m·∫°ng c·ªßa b·∫°n.</p>

<h3 id="3-2-ssl-tls">3.2 SSL/TLS</h3>

<p>ƒêi k√®m v·ªõi Proxy, Cloudflare cung c·∫•p m·ªôt gi·∫£i ph√°p SSL/TLS mi·ªÖn ph√≠ cho c√°c kh√°ch h√†ng nh·ªè gi√∫p tƒÉng c∆∞·ªùng b·∫£o m·∫≠t cho website. <strong>Traffic t·ª´ client t·ªõi Cloudflare s·∫Ω lu√¥n lu√¥n ƒë∆∞·ª£c m√£ h√≥a</strong>, traffic t·ª´ Cloudflare t·ªõi Origin server th√¨ ph·ª• thu·ªôc v√†o c·∫•u h√¨nh v·ªõi c√°c t√πy ch·ªçn nh∆∞ sau:</p>

<ul>
<li>Flexible SSL</li>
<li>Full SSL

<ul>
<li>Strict (cert issued by Certificate Authority).</li>
<li>Full (cert issued by Cloudflare (Origin CA)).</li>
<li>Self-signed certificate.</li>
</ul></li>
</ul>

<p><strong>Flexible SSL</strong> s·∫Ω m√£ h√≥a traffic t·ª´ Cloudflare t·ªõi end-user, nh∆∞ng kh√¥ng m√£ h√≥a traffic t·ª´ Cloudflare t·ªõi origin server c·ªßa b·∫°n. ∆Øu ƒëi·ªÉm l√† d·ªÖ d√†ng c√†i ƒë·∫∑t HTTPs cho user nh∆∞ng kh√¥ng y√™u c·∫ßu ph·∫£i c√†i ƒë·∫∑t SSL certificate tr√™n server c·ªßa b·∫°n. M·∫∑c d√π kh√¥ng an to√†n nh∆∞ c√°c t√πy ch·ªçn kh√°c nh∆∞ng Flexsible SSL l√† c√°ch nhanh ch√≥ng, d·ªÖ d√†ng ƒë·ªÉ b·∫£o v·ªá user kh·ªèi c√°c m·ªëi nguy hi·ªÉm t·ª´ public Wifi ho·∫∑c ad injection over HTTP. V·ªÅ traffic t·ª´ Cloudflare t·ªõi origin server c·ªßa b·∫°n, ƒë·∫∑t ni·ªÅm tin ho√†n to√†n v√†o Cloudflare r·∫±ng traffic c·ªßa b·∫°n s·∫Ω kh√¥ng b·ªã l·ªô ra b√™n ngo√†i (capture traffic khi v·ª´a ra kh·ªèi Cloudflare).</p>

<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/3G3ciVwoNO4YmqiWaUwi8e/be14a50ee11f34204c831c824eb5fcb6/flexible-ssl.svg" alt="flexible-ssl" /></p>

<p><strong>Full SSL</strong> s·∫Ω m√£ h√≥a traffic ·ªü c·∫£ 2 ƒë·∫ßu l√† t·ª´ Cloudflare t·ªõi end-user v√† t·ª´ Cloudflare t·ªõi origin server c·ªßa b·∫°n, c√≥ ba t√πy ch·ªçn kh√°c nhau cho vi·ªác c√†i ƒë·∫∑t cerfiticate tr√™n server c·ªßa b·∫°n l√†:</p>

<ul>
<li>Full SSL Strict -&gt; certificate c√†i ƒë·∫∑t tr√™n origin server c·ªßa b·∫°n ƒë∆∞·ª£c c·∫•p b·ªüi m·ªôt public Certificate Authority (v√≠ d·ª• Verisign, Digicert ho·∫∑c Comodo).</li>
<li>Full SSL, Origin CA -&gt; certificate c√†i ƒë·∫∑t tr√™n origin server c·ªßa b·∫°n ƒë∆∞·ª£c c·∫•p b·ªüi Cloudflare.</li>
<li>Full SSL, self-signed certificate -&gt; certificate t·ª± gen.</li>
</ul>

<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/13hJjEZmQGA6ukiIw2iIEA/ea5b30e43d76ceed34a79e25837f76c9/full-ssl-strict.svg" alt="full-ssl" /></p>

<p>V·ªõi Strict, certificate ƒë∆∞·ª£c c·∫•p b·ªüi CA c·∫ßn t·ªën chi ph√≠ ƒë·ªÉ mua v√† gia h·∫°n. V·ªõi Origin CA, cert ƒë∆∞·ª£c c·∫•p b·ªüi Cloudflare, mi·ªÖn ph√≠ v√† c√≥ expire time kh√° l√¢u, d·ªÖ d√†ng rotate n√™n Cloudflare recomment x√†i Origin CA.</p>

<h3 id="3-3-cloudflarefuck">3.3 Cloudflarefuck?</h3>

<p>N·∫øu b·∫°n t·ª´ng v√†o trang tuy·ªÉn d·ª•ng c·ªßa Cloudflare, ƒë·ªçc th·ª≠ m·ªôt job description, b·∫°n s·∫Ω th·∫•y m·ªôt c√¢u <strong>Cloudflare powers Internet requests for ~10% of the Fortune 1,000 for more than 1 billion unique IP addresses per day.</strong></p>

<p><img src="https://www.cloudflare.com/img/learning/what-is-cloudflare/cloudflare-stats-01.svg" alt="cloudflare-stats" /></p>

<p>V·∫≠y c√¢u h·ªèi l√† <strong>n·∫øu Cloudflare s·∫≠p</strong> th√¨ chuy·ªán g√¨ x·∫£y ra üò≥ üî• üöí, s·∫Ω <strong>ch·ªâ c√≥ 10% traffic</strong> tr√™n to√†n th·∫ø gi·ªõi b·ªã ·∫£nh h∆∞·ªüng. Nghe m√† ƒë√£ r·ª•ng cmn r·ªùi.</p>

<p>Trong t·∫ßm kho·∫£ng 10 ng√†y, Cloudflare x·∫£y ra 2 network issues l·ªõn:</p>

<ul>
<li><a href="https://blog.cloudflare.com/how-verizon-and-a-bgp-optimizer-knocked-large-parts-of-the-internet-offline-today/">Massive route leak</a>: theo post-mortem t·ª´ Cloudflare th√¨ l·ªói l√† do Verizon (m·ªôt nh√† m·∫°ng r·∫•t l·ªõn), ·∫£nh h∆∞·ªüng t·ªõi r·∫•t nhi·ªÅu provider l·ªõn nh∆∞ <a href="https://twitter.com/atoonk/status/1143143943531454464">Amazon,  Linode and Cloudflare</a>. S·ª± c·ªë n√†y m·∫•t <a href="https://www.cloudflarestatus.com/incidents/46z55mdhg0t5">2 ti·∫øng ƒë·ªìng h·ªì</a> ƒë·ªÉ gi·∫£i quy·∫øt.</li>
<li><a href="https://blog.cloudflare.com/cloudflare-outage/">Cloudflare outage caused by bad software deploy</a>: issue n√†y ƒë∆∞·ª£c Cloudflare m√¥ t·∫£ l√† do:

<ul>
<li>Deploy m·ªôt b·ªô rule cho d·ªãch v·ª• WAF ƒë·ªÉ t·ªëi ∆∞u vi·ªác block inline Javascript th∆∞·ªùng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√°c cu·ªôc t·∫•n c√¥ng.</li>
<li>C√≥ m·ªôt rule x√†i regular expression khi·∫øn CPU spike l√™n 100%.</li>
<li>Drop 82% traffic c·ªßa Cloudflare v√† ·∫£nh h∆∞·ªüng t·ªõi r·∫•t r·∫•t nhi·ªÅu region tr√™n to√†n th·∫ø gi·ªõi.</li>
<li>M·ªôt l∆∞·ª£ng l·ªõn c√°c c√¥ng ty l·ªõn b·ªã ·∫£nh h∆∞·ªüng nh∆∞ <a href="https://twitter.com/JacobCanfield/status/1146057756400504837">Coinbase, Authy, Discord, Medium, Zendesk ‚Ä¶</a>.</li>
<li>ƒê√£ test ·ªü m·ªôt m√¥i tr∆∞·ªùng gi·∫£ ƒë·ªãnh, nh∆∞ng kh√¥ng c√≥ ƒë·ªß traffic ƒë·ªÉ ƒë√°nh gi√° impact tr√™n production.</li>
<li>Gi·∫£i ph√°p l√† rollback l·∫°i b·∫£n deployment, nh∆∞ng s·ª± c·ªë n√†y c≈©ng m·∫•t <a href="https://www.cloudflarestatus.com/incidents/tx4pgxs6zxdr">1 ti·∫øng ƒë·ªÉ ƒëi·ªÅu tra v√† gi·∫£i quy·∫øt</a>.</li>
</ul></li>
</ul>

<p>·∫¢nh h∆∞·ªüng c·ªßa 2 s·ª± c·ªë tr√™n l√† <strong>request t·ª´ user ƒëi qua Cloudflare kh√¥ng th·ªÉ t·ªõi ƒë∆∞·ª£c origin server</strong> (t√≠nh nƒÉng proxy c·ªßa Cloudflare). Ri√™ng v·ªõi issue th·ª© hai, do h·ªá th·ªëng c·ªßa ch√≠nh Cloudflare c≈©ng s·∫≠p n√™n ng∆∞·ªùi d√πng c≈©ng kh√¥ng th·ªÉ access ƒë∆∞·ª£c dashboard c·ªßa Cloudflare.</p>

<p>V·∫≠y <strong>gi·∫£i ph√°p</strong> l√† g√¨ khi g·∫∑p t√¨nh hu·ªëng nh∆∞ tr√™n?</p>

<ul>
<li>N·∫±m ch·ªãu ch·∫øt, ch·ªù cho t·ªõi khi d·ªãch v·ª• Cloudflare ph·ª•c h·ªìi.</li>
<li>N·∫øu x√†i SSL/TLS <strong>Full Strict</strong> th√¨ c√≥ th·ªÉ <strong>t·∫Øt t√≠nh nƒÉng proxy</strong> c·ªßa Cloudflare ƒëi

<ul>
<li>Traffic s·∫Ω ƒëi tr·ª±c ti·∫øp t·ª´ user t·ªõi origin server c·ªßa b·∫°n.</li>
<li>C√°c rule v·ªÅ c·∫£n l·ªçc bad request tr√™n Cloudflare s·∫Ω kh√¥ng c√≤n t√°c d·ª•ng.</li>
<li>S·∫Ω kh√¥ng th·ªÉ th·ª±c hi·ªán n·∫øu b·∫£n th√¢n dashboard c·ªßa Cloudflare c≈©ng ch·∫øt üòë.</li>
<li>Li·ªáu h·∫° t·∫ßng DNS c·ªßa Cloudflare c√≥ ch·∫øt lu√¥n hay kh√¥ng? üòë</li>
<li>V√† b·∫Øt bu·ªôc b·∫°n ko ƒë∆∞·ª£c x√†i Flexsible SSL ho·∫∑c self-sign cert v√¨ khi b·∫°n t·∫Øt proxy, HTTPS tr√™n site c·ªßa b·∫°n s·∫Ω kh√¥ng ƒë√°ng tin c·∫≠y v√† d·ªãch v·ª• c·ªßa b·∫°n c≈©ng kh√¥ng th·ªÉ cung c·∫•p.</li>
</ul></li>
</ul>

<p>V·∫•n ƒë·ªÅ ti·∫øp theo l√† li·ªáu <strong>T·∫ÆT PROXY</strong> c√≥ ph·∫£i l√† gi·∫£i ph√°p?</p>

<h3 id="3-4-find-ip-origin-server">3.4 Find IP origin server</h3>

<p>M·ª•c ti√™u c·ªßa vi·ªác x√†i Cloudflare proxy l√† ƒë·ªÉ ·∫©n IP c·ªßa origin server v√† kh√¥ng cho k·∫ª t·∫•n c√¥ng bi·∫øt ƒë∆∞·ª£c origin server, tr√°nh tr∆∞·ªùng h·ª£p b·ªã attack tr·ª±c ti·∫øp v√†o server thay v√¨ ƒëi qua b·ªô l·ªçc c·ªßa Cloudflare (ho·∫∑c crawler bypass b·ªô l·ªçc). Th·∫ø n√™n khi Cloudflare g·∫∑p s·ª± c·ªë, b·∫°n t·∫Øt Proxy ƒëi nghƒ©a l√† ƒë√£ t·∫°o ra m·ªôt l·ªó h·ªïng ƒë·ªÉ attacker t·∫•n c√¥ng tr·ª±c ti·∫øp v√†o h·ªá th·ªëng, l√∫c n√†y vi·ªác c√≥ Cloudflare c≈©ng kh√¥ng c√≤n m·∫•y t√°c d·ª•ng.</p>

<p>ƒê·ª©ng ·ªü g√≥c ƒë·ªô attacker, n·∫øu site ƒë√£ x√†i Cloudflare proxy th√¨ c√≥ c√°ch n√†o ƒë·ªÉ bi·∫øt ƒë∆∞·ª£c IP c·ªßa orgin server hay kh√¥ng?</p>

<p>Vi·ªác x√°c ƒë·ªãnh m·ªôt site c√≥ s·ª≠ d·ª•ng d·ªãch v·ª• Cloudflare c≈©ng kh√° d·ªÖ d√†ng, ta c√≥ th·ªÉ:</p>

<pre><code class="language-bash">&gt; curl -I https://medium.com
HTTP/2 200
date: Fri, 12 Jul 2019 05:55:11 GMT
content-type: text/html; charset=utf-8
set-cookie: __cfduid=dd3119117ce323927a453c7b298401b0e1562910911; expires=Sat, 11-Jul-20 05:55:11 GMT; path=/; domain=.medium.com; HttpOnly
content-security-policy: default-src 'self'; connect-src https://localhost https://*.instapaper.com https://*.stripe.com https://glyph.medium.com https://*.paypal.com https://getpocket.com https://medium.com https://*.medium.com https://*.medium.com https://medium.com https://*.medium.com https://*.algolia.net https://cdn-static-1.medium.com https://dnqgz544uhbo8.cloudfront.net https://cdn-videos-1.medium.com https://cdn-audio-1.medium.com https://*.lightstep.com https://*.branch.io https://app.zencoder.com 'self'; font-src data: https://*.amazonaws.com https://*.medium.com https://glyph.medium.com https://medium.com https://*.gstatic.com https://dnqgz544uhbo8.cloudfront.net https://use.typekit.net https://cdn-static-1.medium.com 'self'; frame-src chromenull: https: webviewprogressproxy: medium: 'self'; img-src blob: data: https: 'self'; media-src https://*.cdn.vine.co https://d1fcbxp97j4nb2.cloudfront.net https://d262ilb51hltx0.cloudfront.net https://*.medium.com https://gomiro.medium.com https://miro.medium.com https://pbs.twimg.com 'self' blob:; object-src 'self'; script-src 'unsafe-eval' 'unsafe-inline' about: https: 'self'; style-src 'unsafe-inline' data: https: 'self'; report-uri https://csp.medium.com
x-frame-options: sameorigin
x-content-type-options: nosniff
x-xss-protection: 1; mode=block
x-ua-compatible: IE=edge, Chrome=1
x-powered-by: Medium
x-obvious-tid: 1562910911357:c3d601539378
x-obvious-info: 38086-f2efc7b,f2efc7bd3f5
link: &lt;https://medium.com/humans.txt&gt;; rel=&quot;humans&quot;
cache-control: no-cache, no-store, max-age=0, must-revalidate
expires: Thu, 09 Sep 1999 09:09:09 GMT
pragma: no-cache
tk: T
strict-transport-security: max-age=15552000; includeSubDomains; preload
set-cookie: uid=lo_L3g8wBpz5tvb; Expires=Sat, 11-Jul-20 05:55:11 GMT; Domain=.medium.com; Path=/; Secure; HttpOnly
set-cookie: sid=1:5/Xr4XX2PjlG2TtQTn1ERsmMMjpOJ71eZvf4NMZMLbseEW3NrI5Yb2WFRlOsXXe8; path=/; expires=Sat, 11 Jul 2020 05:55:11 GMT; domain=.medium.com; secure; httponly
set-cookie: __cfruid=0b37c1d5c8324ea472c0072a4c6f285ffc596078-1562910911; path=/; domain=.medium.com; HttpOnly
expect-ct: max-age=604800, report-uri=&quot;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct&quot;
server: cloudflare
cf-ray: 4f50c44b398ad1e7-HKG
</code></pre>

<p>M·ªôt s·ªë header d√πng ƒë·ªÉ x√°c ƒë·ªãnh nh∆∞ <code>cf-ray</code>, <code>__cfduid</code> ho·∫∑c check IP ph√¢n gi·∫£i c√≥ thu·ªôc l·ªõp m·∫°ng c·ªßa Cloudflare hay kh√¥ng:</p>

<pre><code>&gt; dig +short medium.com
104.16.121.127
104.16.124.127
104.16.122.127
104.16.120.127
104.16.123.127
</code></pre>

<h4 id="3-4-1-ssl-certificate">3.4.1 SSL certificate</h4>

<p>M·ªói Domain Valiadtion SSL certificate m√† b·∫°n mua s·∫Ω valid v·ªõi m·ªôt domain name. √ù t∆∞·ªüng l√† b·∫°n c·∫ßn scan to√†n b·ªô internet ƒë·ªÉ t√¨m m·ªôt ƒë·ªãa ch·ªâ IP n√†o ƒë√≥ tr√™n c·ªïng 443 c√≥ SSL certificate match v·ªõi domain-name m√† b·∫°n ƒëang t√¨m ki·∫øm.</p>

<p><a href="https://censys.io/">Censys</a> l√† m·ªôt d·ªãch v·ª• cho ph√©p query c√°c d·ªØ li·ªáu ki·ªÉu nh∆∞ v·∫≠y. Mi·ªÖn ph√≠ 10 query cho un-login user v√† 200 query/th√°ng cho free user.</p>

<p>V√≠ d·ª• v·ªõi site <a href="https://viblo.asia">https://viblo.asia</a>, domain c·ªßa h·ªç ph√¢n gi·∫£i th√†nh ƒë·ªãa ch·ªâ c·ªßa Cloudflare</p>

<pre><code class="language-bash">&gt; dig +short viblo.asia
104.27.188.151
104.27.189.151
</code></pre>

<p>Tuy nhi√™n khi query tr√™n Censys <code>(443.https.tls.certificate.parsed.names: viblo.asia OR 443.https.tls.certificate.parsed.subject.common_name: viblo.asia)</code> th√¨ k·∫øt qu·∫£ l√†:</p>

<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/censys_viblo.png" alt="censys_viblo" /></p>

<p>Tr√¥ng c√≥ v·∫ª h·ªç c√≥ 3 server ph√≠a sau Cloudflare v√† host tr√™n Linode, ngo√†i ra h·ªç c≈©ng m·ªü c·ªïng 22 v√† 8080 tr√™n c√°c node.</p>

<p>M·ªôt v√≠ d·ª• kh√°c l√† Medium, b·∫°n c√≥ th·ªÉ xem k·∫øt qu·∫£ search t·ª´ Censys t·ª´ file <a href="https://github.com/xluffy/assets/blob/master/medium.txt">medium.txt</a>. M·ªôt ƒëi·ªÉm th√∫ v·ªã ·ªü ƒë√¢y l√† m√¨nh nh√¨n th·∫•y c√≥ 17 node EC2 t·ª´ d·ªãch v·ª• AWS public ra ngo√†i Internet, kh√¥ng r√µ m·ª•c ƒë√≠ch c·ªßa h·ªç khi thi·∫øt k·∫ø Infra nh∆∞ v·∫≠y l√† c√≥ d·ª•ng √Ω g√¨.</p>

<pre><code class="language-bash">&gt; grep '.amazonaws' medium.txt
 52.1.147.205 (ec2-52-1-147-205.compute-1.amazonaws.com)
 52.6.3.192 (ec2-52-6-3-192.compute-1.amazonaws.com)
 54.167.232.247 (ec2-54-167-232-247.compute-1.amazonaws.com)
 52.4.175.111 (ec2-52-4-175-111.compute-1.amazonaws.com)
 3.94.121.79 (ec2-3-94-121-79.compute-1.amazonaws.com)
 52.5.181.79 (ec2-52-5-181-79.compute-1.amazonaws.com)
 52.1.173.203 (ec2-52-1-173-203.compute-1.amazonaws.com)
 52.4.145.119 (ec2-52-4-145-119.compute-1.amazonaws.com)
 52.6.46.142 (ec2-52-6-46-142.compute-1.amazonaws.com)
 52.0.16.118 (ec2-52-0-16-118.compute-1.amazonaws.com)
 52.4.225.124 (ec2-52-4-225-124.compute-1.amazonaws.com)
 52.6.25.83 (ec2-52-6-25-83.compute-1.amazonaws.com)
 52.206.109.232 (ec2-52-206-109-232.compute-1.amazonaws.com)
 54.208.127.235 (ec2-54-208-127-235.compute-1.amazonaws.com)
 52.4.38.70 (ec2-52-4-38-70.compute-1.amazonaws.com)
 34.204.47.92 (ec2-34-204-47-92.compute-1.amazonaws.com)
 52.1.119.170 (ec2-52-1-119-170.compute-1.amazonaws.com)
</code></pre>

<p>N√≥i chung c√≥ th·ªÉ search nhi·ªÅu th·ª© v·ªõi Censys, ngo√†i domain-name validate v·ªõi certificate, ta c≈©ng c√≥ th·ªÉ search fingerprint c·ªßa SSL certificate.</p>

<h4 id="3-4-2-dns-records">3.4.2 DNS records</h4>

<p>Sau m·ªôt v√†i ƒë·ª£t ch·ªëng ch·ªçi v·ªõi c√°c cu·ªôc t·∫•n c√¥ng, b·∫°n qu√° m·ªát m·ªèi v√† quy·∫øt ƒë·ªãnh chuy·ªÉn sang x√†i Cloudflare. V·∫•n ƒë·ªÅ l√† history v·ªÅ DNS records c·ªßa b·∫°n v·∫´n c√≤n l∆∞u ƒë√¢u ƒë√≥ tr√™n Internet v√† <a href="https://securitytrails.com/">SecurityTrails</a> l√† d·ªãch v·ª• cho ph√©p query history c·ªßa DNS record.</p>

<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/security_trails_medimum.jpg" alt="security_trails_medium" /></p>

<p>Ngo√†i th√¥ng tin v·ªÅ history DNS record, c√≤n c√≥ c√°c th√¥ng tin kh√°c nh∆∞:</p>

<ul>
<li>Subdomain -&gt; c√≥ th·ªÉ s·∫Ω c√≥ nh·ªØng subdomain kh√¥ng ƒëi qua Cloudflare nh∆∞ng chung origin server.</li>
<li>C√°c history c·ªßa c√°c record kh√°c nh∆∞ MX (mail), NS (m√°y ch·ªß DNS)</li>
</ul>

<h4 id="3-4-3-http-header-ho·∫∑c-content">3.4.3 HTTP header ho·∫∑c Content</h4>

<p>V√≠ d·ª• search v·ªõi <strong>title</strong> c·ªßa Medium b·∫±ng Censys.</p>

<pre><code>443.https.get.title: &quot;Medium ‚Äì a place to read and write big ideas and important stories&quot;
</code></pre>

<p>Ho·∫∑c c√°c content unique tr√™n website nh∆∞ Google Analytics tracking code:</p>

<pre><code class="language-bash">googleAnalyticsTrackingCode&quot;:&quot;UA-24232453-2&quot;
</code></pre>

<p>C√¥ng c·ª• nh∆∞ <a href="https://www.shodan.io">https://www.shodan.io</a> cho ph√©p search c√°c th√¥ng tin nh∆∞ v·∫≠y tuy nhi√™n n√≥ y√™u c·∫ßu b·∫°n ph·∫£i tr·∫£ ph√≠ ƒë·ªÉ truy c·∫≠p c√°c d·ªØ li·ªáu tr√™n.</p>

<h2 id="4-prevention">4. Prevention</h2>

<p>C√¢u h·ªèi b√¢y gi·ªù l√† l√†m th·∫ø n√†o ƒë·ªÉ ·∫©n danh IP origin server b·ªüi c√°c c√¥ng c·ª• t√¨m ki·∫øm ho·∫∑c historical DNS record? V√† c√°ch c·∫•u h√¨nh Cloudflare ƒë·ªÉ ch·ªëng l·∫°i c√°c t·∫•n c√¥ng v√†o origin server l√† nh∆∞ th·∫ø n√†o?</p>

<ul>
<li>Log real client-ip c·ªßa user khi ƒëi qua Cloudflare.</li>
<li>Remove t·∫•t c·∫£ c√°c DNS record kh√¥ng c√≤n s·ª≠ d·ª•ng (tr√°nh ƒë·ªÉ l·ªô origin server c≈©).</li>
<li>Ch·∫°y email tr√™n c√°c server ho·∫∑c d·ªãch v·ª• ri√™ng (gsuite, sendgrid).</li>
<li>Sau khi chuy·ªÉn sang Cloudflare, n√™n ƒë·ªïi t·∫•t c·∫£ c√°c IP server c≈©.</li>
<li>Whitelist c√°c request t·ª´ h·ªá th·ªëng Cloudflare (<a href="https://www.cloudflare.com/ips-v4">IPv4</a> v√† <a href="https://www.cloudflare.com/ips-v6">IPv6</a>) v√† c√°c IP t·ª´ h·ªá th·ªëng c·ªßa b·∫°n (n·∫øu c√≥ nhu c·∫ßu testing), ph·∫ßn c√≤n l·∫°i n√™n block.</li>
</ul>

<p>C√≥ th·ªÉ block ·ªü t·∫ßng firewall nh∆∞ security group ho·∫∑c transport layer (iptables) ho·∫∑c block ·ªü nginx c·ªßa site, v√≠ d·ª• v·ªõi iptables.</p>

<pre><code class="language-bash">sudo iptables -I INPUT 1 -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

sudo iptables -A INPUT -p tcp -s 103.21.244.0/22 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 103.22.200.0/22 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 103.31.4.0/22 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 104.16.0.0/12 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 108.162.192.0/18 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 131.0.72.0/22 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 141.101.64.0/18 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 162.158.0.0/15 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 172.64.0.0/13 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 173.245.48.0/20 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 188.114.96.0/20 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 190.93.240.0/20 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 197.234.240.0/22 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 198.41.128.0/17 --dport 443 -j ACCEPT
sudo iptables -A INPUT -p tcp -s 199.27.128.0/21 --dport 443 -j ACCEPT

sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT
sudo iptables -A INPUT -j REJECT
</code></pre>

<p>V·ªõi nginx c√≥ th·ªÉ block nh∆∞ sau:</p>

<pre><code class="language-bash">map $remote_addr $bad_ip {
  default 1;
  cloudflare_ip_v4 0;
  cloudflare_ip_v3 0;
}

server {
  if ($bad_ip) {
    return 499;
  }
}
</code></pre>

<p>Ngo√†i c√°c gi·∫£i ph√°p tr√™n, Cloudflare cung c·∫•p m·ªôt d·ªãch v·ª• g·ªçi l√† <a href="https://www.cloudflare.com/products/argo-tunnel">Argo tunnel</a>, hi·ªÉu m·ªôt c√°ch ƒë∆°n gi·∫£n th√¨ argo-tunnel s·∫Ω t·∫°o m·ªôt encrypted-tunnel gi·ªØa origin server t·ªõi Cloudflare data-center g·∫ßn nh·∫•t (k√®m theo smart routing), m·ªçi k·∫øt n·ªëi t·ª´ client ƒë∆∞·ª£c Cloudflare pass qua origin server s·∫Ω ƒëi qua tunnel n√†y, t·∫•t c·∫£ c√°c request c√≤n l·∫°i s·∫Ω b·ªã block.</p>

<h2 id="5-ref">5. Ref</h2>

<ul>
<li><a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks">https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks</a></li>
<li><a href="https://www.cloudflare.com/rate-limiting">https://www.cloudflare.com/rate-limiting</a></li>
<li><a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy">https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy</a></li>
<li><a href="https://www.secjuice.com/finding-real-ips-of-origin-servers-behind-cloudflare-or-tor">https://www.secjuice.com/finding-real-ips-of-origin-servers-behind-cloudflare-or-tor</a></li>
<li><a href="https://blog.christophetd.fr/bypassing-cloudflare-using-internet-wide-scan-data">https://blog.christophetd.fr/bypassing-cloudflare-using-internet-wide-scan-data</a></li>
<li><a href="https://chris-knight.net/blog/2017/02/effectively-hiding-behind-cloudflare">https://chris-knight.net/blog/2017/02/effectively-hiding-behind-cloudflare</a></li>
<li><a href="https://citadelo.com/en/blog/cloudflare-how-to-do-it-right-and-do-not-reveal-your-real-ip/">https://citadelo.com/en/blog/cloudflare-how-to-do-it-right-and-do-not-reveal-your-real-ip/</a></li>
</ul>

</main>
<section>
  <hr>
<script src="https://utteranc.es/client.js"
        repo="xluffy/xluffy.github.io"
        issue-term="url"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>

    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/xluffy">Github</a> | <a href="https://twitter.com/min0lta">Twitter</a> | <a href="https://t.me/xluffy">Telegram</a>
      
      <br><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
    </footer>
  </body>
</html>

