<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Cloudflare 101 ::
        /dev/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="1. DDoS 101 Vá» DDoS dÃ¹ má»¥c Ä‘Ã­ch cuá»‘i cÃ¹ng lÃ  lÃ m cho dá»‹ch vá»¥ cá»§a báº¡n khÃ´ng thá»ƒ cung cáº¥p tá»›i ngÆ°á»i dÃ¹ng nhÆ°ng nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh 3 nhÃ³m:"
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xluffy.github.io/post/cloudflare-101/" />





<link rel="stylesheet" href="https://xluffy.github.io/assets/style.css" />

<link rel="stylesheet" href="https://xluffy.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://xluffy.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://xluffy.github.io/img/favicon.png" />


<link href="https://xluffy.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cloudflare 101"/>
<meta name="twitter:description" content="1. DDoS 101 Vá» DDoS dÃ¹ má»¥c Ä‘Ã­ch cuá»‘i cÃ¹ng lÃ  lÃ m cho dá»‹ch vá»¥ cá»§a báº¡n khÃ´ng thá»ƒ cung cáº¥p tá»›i ngÆ°á»i dÃ¹ng nhÆ°ng nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh 3 nhÃ³m:"/>



<meta property="og:title" content="Cloudflare 101" />
<meta property="og:description" content="1. DDoS 101 Vá» DDoS dÃ¹ má»¥c Ä‘Ã­ch cuá»‘i cÃ¹ng lÃ  lÃ m cho dá»‹ch vá»¥ cá»§a báº¡n khÃ´ng thá»ƒ cung cáº¥p tá»›i ngÆ°á»i dÃ¹ng nhÆ°ng nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh 3 nhÃ³m:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xluffy.github.io/post/cloudflare-101/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2019-07-11T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-07-11T00:00:00+00:00" /><meta property="og:site_name" content="/dev/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/dev/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Cloudflare 101</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2019-07-11
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://xluffy.github.io/tags/cloudflare/">#cloudflare</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/security/">#security</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/proxy/">#proxy</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h2 id="1-ddos-101">1. DDoS 101</h2>
<p>Vá» DDoS dÃ¹ má»¥c Ä‘Ã­ch cuá»‘i cÃ¹ng lÃ  lÃ m cho dá»‹ch vá»¥ cá»§a báº¡n khÃ´ng thá»ƒ cung cáº¥p tá»›i ngÆ°á»i dÃ¹ng nhÆ°ng nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh 3 nhÃ³m:</p>
<ul>
<li><strong>Application Layer Attacks</strong>: má»¥c tiÃªu lÃ  khiáº¿n á»©ng dá»¥ng pháº£i xá»­ lÃ½ má»™t lÆ°á»£ng lá»›n cÃ¡c request <em>cÃ³ váº» há»£p lá»‡</em>, lÃ m cáº¡n kiá»‡t tÃ i nguyÃªn cá»§a á»©ng dá»¥ng, khiáº¿n á»©ng dá»¥ng khÃ´ng thá»ƒ phá»¥c vá»¥ cÃ¡c user há»£p lá»‡ khÃ¡c. VÃ­ dá»¥ trong á»©ng dá»¥ng TMÄT, má»™t API Ä‘á»c database tráº£ vá» má»™t danh sÃ¡ch chi tiáº¿t cá»§a cÃ¡c sáº£n pháº©m thuá»™c má»™t nhÃ³m ngÃ nh. Attacker cÃ³ thá»ƒ viáº¿t má»™t tools Ä‘á»ƒ crawl háº¿t dá»¯ liá»‡u cá»§a tá»«ng ngÃ nh hÃ ng, khiáº¿n server khÃ´ng Ä‘á»§ tÃ i nguyÃªn Ä‘á»ƒ phá»¥c vá»¥. Viá»‡c cáº£n lá»c request thuá»™c nhÃ³m nÃ y khÃ´ng dá»… vÃ¬ nÃ³ sáº½ khÃ¡ giá»‘ng vá»›i request cá»§a user thÃ´ng thÆ°á»ng vÃ  cÃ³ thá»ƒ cáº£n lá»c nháº§m nhá»¯ng user há»£p lá»‡.</li>
<li><strong>Protocol Attacks</strong>: tÆ°Æ¡ng tá»± application layer attack nhÆ°ng nháº¯m vÃ o layer 3 vÃ  layer 4 trong mÃ´ hÃ¬nh OSI. VÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  SYN Flood, lá»£i dá»¥ng viá»‡c báº¯t-tay-3-bÆ°á»›c trong giao thá»©c TCP, attacker sáº½ gá»­i má»™t má»™t gÃ³i SYN Ä‘á»ƒ thiáº¿t láº­p káº¿t ná»‘i TCP, server sáº½ tráº£ vá» má»™t gÃ³i SYN-ACK vÃ  chá» Ä‘á»£i má»™t gÃ³i ACK Ä‘á»ƒ káº¿t thÃºc quÃ¡ trÃ¬nh báº¯t tay. NhÆ°ng sau Ä‘Ã³ attacker sáº½ khÃ´ng bao giá» tráº£ vá» ACK, khiáº¿n server pháº£i tiÃªu tá»‘n tÃ i nguyÃªn cho viá»‡c chá» Ä‘á»£i pháº£n há»“i.</li>
<li><strong>Volumetric Attacks</strong>: Hai loáº¡i trÃªn Ä‘á»u nháº¯m tá»›i viá»‡c báº¯t á»©ng dá»¥ng, há»‡ Ä‘iá»u hÃ nh pháº£i tiÃªu tá»‘n tÃ i nguyÃªn xá»­ lÃ½. RiÃªng volumetric attack nháº¯m tá»›i bÄƒng thÃ´ng cá»§a há»‡ thá»‘ng victim. VÃ­ dá»¥ khÃ¡ch hÃ ng chá»‰ cÃ³ kháº£ nÄƒng thuÃª má»™t Ä‘Æ°á»ng truyá»n cÃ³ bÄƒng thÃ´ng 100Mbps, attacker sáº½ tÃ¬m cÃ¡ch flood má»™t lÆ°á»£ng lá»›n traffic lá»›n hÆ¡n 100Mbps, khiáº¿n con Ä‘Æ°á»ng tá»›i server cá»§a victim bá»‹ ngháº½n (tÆ°Æ¡ng tá»± Ä‘Æ°á»ng 2 lÃ n, nhÆ°ng cÃ³ tá»›i 10 lÃ n xe cÃ¹ng vÃ o má»™t lÃºc sáº½ gÃ¢y ngáº½n vÃ  nhá»¯ng xe cáº§n Ä‘i tháº­t sáº½ khÃ´ng thá»ƒ di chuyá»ƒn). VÃ­ dá»¥ <a href="https://blog.cloudflare.com/memcrashed-major-amplification-attacks-from-port-11211">Memcrashed</a>, lá»£i dá»¥ng cÃ¡c memcached server má»Ÿ UDP port ra ngoÃ i public, attacker gá»­i má»™t gÃ³i tin vá»›i <code>source_ip </code> Ä‘Æ°á»£c giáº£ máº¡o thÃ nh <code>source_ip</code> cá»§a victim tá»›i cÃ¡c server memcached zoombie nÃ y. Má»™t request gá»­i Ä‘i chá»‰ vá»›i 15 bytes nhÆ°ng memcached tráº£ vá» 134KB dá»¯ liá»‡u, vÃ  khuáº¿ch Ä‘áº¡i lÃªn thÃ¬ Cloudflare ghi nháº­n peak tá»›i <strong>260Gbps</strong> UDP traffic, Ä‘á»§ lÃ  ngháº½n network cá»§a báº¥t cá»© há»‡ thá»‘ng nÃ o.</li>
</ul>
<p>Äá»ƒ chá»‘ng láº¡i má»™t cuá»™c táº¥n cÃ´ng DDoS thÃ¬ tÃ¹y vÃ o loáº¡i attack. Tuy nhiÃªn Ä‘á»©ng á»Ÿ gÃ³c Ä‘á»™ lÃ m sáº£n pháº©m thÃ¬ luÃ´n cá»‘ gáº¯ng phá»¥c vá»¥ táº¥t cáº£ cÃ¡c request ká»ƒ cáº£ báº¥t há»£p lá»‡ thay vÃ¬ <strong>block</strong> request vÃ¬ náº¿u block nháº§m user há»£p lá»‡ cÅ©ng coi nhÆ° tá»« chá»‘i phá»¥c vá»¥ dá»‹ch vá»¥ cho khÃ¡ch hÃ ng -&gt; giÃºp káº» táº¥n cÃ´ng Ä‘áº¡t Ä‘Æ°á»£c má»¥c Ä‘Ã­ch lÃ  á»©ng dá»¥ng cá»§a chÃºng ta khÃ´ng thá»ƒ cung cáº¥p dá»‹ch vá»¥ tá»›i khÃ¡ch hÃ ng. Táº¥t nhiÃªn ta cÅ©ng pháº£i Ä‘Ã¡nh Ä‘á»•i giá»¯a viá»‡c báº£o vá»‡ pháº§n lá»›n user hay cáº£n lá»c nháº§m cÃ¡c user há»£p lá»‡ Ä‘á»ƒ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh Ä‘Ãºng Ä‘áº¯n.</p>
<p>Má»™t sá»‘ phÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c Ä‘á» xuáº¥t Ä‘á»ƒ giáº£m thiá»ƒu hoáº·c cáº£n lá»c DDoS attack nhÆ° sau:</p>
<ul>
<li><strong>Black Hole Routing</strong>: tÆ°Æ¡ng tá»± nhÆ° <code>&amp;&gt; /dev/null</code> Ä‘áº©y toÃ n bá»™ traffic cáº£ há»£p lá»‡ láº«n khÃ´ng há»£p lá»‡ vÃ o há»‘ Ä‘en. NÃ³i cho vui, chá»© mÃ©o ai láº¡i lÃ m nhÆ° váº§y, cháº³ng khÃ¡c gÃ¬ anh Quáº£ng ná»• rÃºt dÃ¢y Ä‘iá»‡n, táº¯t server.</li>
<li><strong>Rate limit request</strong>: giá»›i háº¡n sá»‘ lÆ°á»£ng request mÃ  server cháº¥p nháº­n xá»­ lÃ½ trong má»™t khung thá»i gian. Há»¯u Ã­ch khi chá»‘ng crawler hoáº·c brute-force login.</li>
<li><strong>WAF (Web Application Firewall)</strong>: báº£o vá»‡ server, á»©ng dá»¥ng bá»Ÿi cÃ¡c lá»— há»•ng thÃ´ng thÆ°á»ng nhÆ° SQL injection, XSS&hellip;</li>
<li><strong>Anycast Network Diffusion</strong>: má»™t giáº£i thÃ­ch khÃ¡ lÃ  dá»… hiá»ƒu tá»« anh <a href="https://github.com/lebinh">lebinh</a>, báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm nÃ³ á»Ÿ Ä‘Ã¢y <a href="https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5">https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5</a>.</li>
</ul>
<h2 id="2-rate-limit">2. Rate Limit</h2>
<p>Cloudflare cung cáº¥p má»™t tÃ­nh nÄƒng cho phÃ©p control vÃ  block cÃ¡c traffic Ä‘Ã¡ng ngá». TÃ­nh nÄƒng nÃ y giÃºp <strong>tá»± Ä‘á»™ng</strong> báº£o vá»‡ website cá»§a báº¡n khá»i:</p>
<ul>
<li>DDoS attack.</li>
<li>brute-force login.</li>
<li>â€¦.</li>
</ul>
<p>CÃ¢u há»i Ä‘áº·t ra lÃ  táº¡i sao tui pháº£i tráº£ tiá»n Cloudflare Ä‘á»ƒ xÃ i tÃ­nh nÄƒng nÃ y? CÃ³ giáº£i phÃ¡p nÃ o thay tháº¿ miá»…n phÃ­, Ä‘Æ¡n giáº£n hay khÃ´ng?</p>
<p>TÃ­nh nÄƒng limit request/minute hoáº·c block request khÃ´ng cÃ³ gÃ¬ má»›i. Ta cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng cÃ¡c giáº£i phÃ¡p sau:</p>
<ul>
<li>Limit request á»Ÿ táº§ng application, vÃ­ dá»¥ <a href="https://github.com/kickstarter/rack-attack">rack-attack</a>.</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html">ngx_http_limit_req_module</a>, block ip, limit request dá»±a trÃªn ngÆ°á»¡ng vÃ  thá»i gian. CÃ³ má»™t nhÆ°á»£c Ä‘iá»ƒm cá»§a phÆ°Æ¡ng phÃ¡p nÃ y, dáº«n tá»›i cÃ³ thá»ƒ dá»… dÃ ng bypass Ä‘Ã³ lÃ  náº¿u sau LB cÃ³ nhiá»u nginx, má»—i nginx sáº½ cÃ³ má»™t vÃ¹ng nhá»› Ä‘á»ƒ lÆ°u cÃ¡c IP block riÃªng, dáº«n tá»›i cÃ³ thá»ƒ block trÃªn server nÃ y nhÆ°ng khÃ´ng block trÃªn server kia. ÄÃ³ lÃ  lÃ½ do cáº§n má»™t nÆ¡i lÆ°u chung nhÆ° redis á»Ÿ cÃ¡ch tiáº¿p cáº­n tiáº¿p theo.</li>
<li>nginx + lua + redis, tÆ°Æ¡ng tá»± nhÆ° trÃªn, nhÆ°ng ta cÃ³ thá»ƒ táº­n dá»¥ng expire/ttl cá»§a redis Ä‘á»ƒ ban/block má»™t IP vÃ  sau Ä‘Ã³ unban IP Ä‘Ã³ theo expire cá»§a má»™t key trong redis. Má»™t Æ°u Ä‘iá»ƒm khÃ¡c lÃ  ta cÃ³ thá»ƒ query dá»¯ liá»‡u trong redis Ä‘á»ƒ report. <strong><a href="https://github.com/leandromoreira/nginx-lua-redis-rate-measuring">nginx-lua-redis-rate-measuring</a></strong> lÃ  má»™t vÃ­ dá»¥ vá» viá»‡c share counter trong redis vÃ  block báº±ng nginx, repo nÃ y inspired tá»« Cloudflare&rsquo;s post <a href="https://blog.cloudflare.com/counting-things-a-lot-of-different-things/">How we built rate limiting capable of scaling to millions of domains.</a></li>
<li>Host-based firewall nhÆ° iptables/ufw -&gt; block/limit request á»Ÿ cÃ¡c layer tháº¥p hÆ¡n application layer:
<ul>
<li>Æ¯u Ä‘iá»ƒm lÃ  block á»Ÿ cÃ¡c layer tháº¥p nhÆ° transport layer trá»Ÿ xuá»‘ng, request sáº½ chÆ°a ká»‹p tá»›i application layer, giáº£m táº£i cho web server.</li>
<li>Vá»›i limit request, ta sáº½ cáº§n load thÃªm má»™t sá»‘ module há»— trá»£ iptable -&gt; firewall stateful -&gt; báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm má»™t bÃ i ráº¥t hay vá» <a href="https://making.pusher.com/per-ip-rate-limiting-with-iptables">rate-limit vá»›i iptables tá»« Pusher</a>.</li>
<li>NhÆ°á»£c Ä‘iá»ƒm lÃ  khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t danh sÃ¡ch IP má»›i bá»‹ ban/block/limit. Äá»ƒ giáº£i quyáº¿t viá»‡c cáº­p nháº­t tá»± Ä‘á»™ng cÃ³ thá»ƒ <a href="https://vnhacker.blogspot.com/2009/12/giam-sat-ninh-mang-hay-la-lam-nao-e.html">build má»™t há»‡ thá»‘ng offline Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  update láº¡i vÃ o há»‡ thá»‘ng firewall</a>. Æ¯u Ä‘iá»ƒm cá»§a viá»‡c build má»™t há»‡ thá»‘ng offline lÃ  impact tá»›i há»‡ thá»‘ng khÃ´ng lá»›n, quÃ¡ trÃ¬nh phÃ¢n tÃ­ch diá»…n ra á»Ÿ má»™t cá»¥m mÃ¡y tÃ­nh khÃ¡c, nhÆ°á»£c Ä‘iá»ƒm lÃ  báº¡n pháº£i cÃ³ traffic vÃ  Äƒn má»™t vÃ i Ä‘á»£t táº¥n cÃ´ng Ä‘á»ƒ cÃ³ Ä‘á»§ dá»¯ liá»‡u Ä‘á»ƒ tÃ­nh toÃ¡n.</li>
</ul>
</li>
<li>Network-based firewall: cÃ¡c firewall náº±m ngoÃ i host nhÆ° hardware firewall hoáº·c security group cá»§a AWS (nhÆ°ng vá» lÃ½ thuyáº¿t nÃ³ khÃ´ng Ä‘Æ°á»£c xáº¿p vÃ o network-based firewall). CÅ©ng tÆ°Æ¡ng tá»± host-based firewall lÃ  viá»‡c cáº­p nháº­t danh sÃ¡ch IP sáº½ khÃ³ khÄƒn. VÃ  vá»›i security group cá»§a AWS thÃ¬ khÃ´ng thá»ƒ limit request (chá»‰ cÃ³ cháº·n).</li>
</ul>
<p><strong>NhÆ°á»£c Ä‘iá»ƒm</strong> cá»§a táº¥t cáº£ cÃ¡c phÆ°Æ¡ng phÃ¡p trÃªn lÃ :</p>
<ul>
<li>Request cá»§a attacker <strong>Ä‘Ã£ tá»›i há»‡ thá»‘ng</strong> cá»§a báº¡n, náº¿u xÃ i network-base firewall thÃ¬ request Ä‘Ã£ vÃ o tá»›i router/hardware-firewall, náº¿u xÃ i host-based firewall (iptables) thÃ¬ request Ä‘Ã£ tá»›i server (OS Ä‘Ã£ pháº£i handle), náº¿u báº¡n limit á»Ÿ táº§ng application thÃ¬ web server (nginx hoáº·c Apache) Ä‘Ã£ pháº£i xá»­ lÃ½ (tuy nhiÃªn náº¿u xÃ i nginx nhÆ° má»™t proxy thÃ¬ cÅ©ng khÃ´ng tá»‘n thÃªm bao nhiÃªu resource) vÃ  náº¿u báº¡n xÃ i má»™t thÆ° viá»‡n nhÆ° <a href="https://github.com/kickstarter/rack-attack">rack-attack</a> thÃ¬ Rails pháº£i handle thÃªm viá»‡c giá»›i háº¡n request.</li>
<li>ThÃªm thiáº¿t bá»‹, mÃ¡y tÃ­nh, software Ä‘á»ƒ xá»­ lÃ½ váº¥n Ä‘á» (sáº½ khÃ´ng phÃ¹ há»£p vá»›i há»‡ thá»‘ng nhá»).</li>
</ul>
<p>Váº­y náº¿u xÃ i rate-limit cá»§a Cloudflare thÃ¬ cÃ³ lá»£i gÃ¬?</p>
<ul>
<li>Cloudflare sáº½ hoáº¡t Ä‘á»™ng nhÆ° má»™t reverse proxy, má»i request trÆ°á»›c khi Ä‘i tá»›i origin server cá»§a báº¡n Ä‘á»u sáº½ Ä‘i qua Cloudflare.</li>
<li>BÄƒng thÃ´ng cá»§a Cloudflare lÃ  <strong>30Tbps</strong>, gáº¥p <strong>15 láº§n</strong> cuá»™c táº¥n cÃ´ng DDoS lá»›n nháº¥t tá»«ng Ä‘Æ°á»£c ghi nháº­n (cháº¯c lÃ  memcrashed), vá»›i sá»• há»™ nghÃ¨o, báº¡n chá»‰ thuÃª Ä‘Æ°á»£c bÄƒng thÃ´ng 100Mbps. Cloudflare sáº½ hoáº¡t Ä‘á»™ng nhÆ° BOT (tráº¡m thu phÃ­) giá»¯a quá»‘c lá»™ vÃ  Ä‘Æ°á»ng lÃ ng, giÃºp bÃ³p nhá» / cáº£n lá»c bá»›t traffic trÆ°á»›c khi tá»›i server cá»§a báº¡n, khÃ´ng lÃ m overload network cá»§a báº¡n (thÃ´ng thÆ°á»ng náº¿u báº¡n host server á»Ÿ DC, khi gáº·p má»™t cuá»™c táº¥n cÃ´ng volumetric attacks, báº¡n cÅ©ng cÃ³ thá»ƒ nhá» DC tÄƒng bÄƒng thÃ´ng Ä‘á»ƒ chá»‘ng chá»i hoáº·c nhá» Firewall/Router cá»§a DC cáº£n lá»c bá»›t traffic trÆ°á»›c khi vÃ o server cá»§a báº¡n, tÆ°Æ¡ng tá»± nhÆ° Cloudflare).</li>
<li>Dá»… cáº¥u hÃ¬nh ngÆ°á»¡ng, URL vÃ  cÃ³ report Ä‘á»ƒ xem.</li>
<li>ThÃ´ng minh, tá»± Ä‘á»™ng nháº­n biáº¿t cÃ¡c request khÃ´ng há»£p lá»‡, cÃ³ thá»ƒ expire sau má»™t khoáº£ng thá»i gian (tÆ°Æ¡ng tá»± lua+redis), cho phÃ©p user tá»± bypass báº±ng cÃ¡ch pass <em>challenge</em> hoáº·c <em>js challenge</em> thay vÃ¬ block ngay.</li>
<li><strong>NhÆ°á»£c Ä‘iá»ƒm</strong> lÃ  pháº£i tráº£ tiá»n cho tÃ­nh nÄƒng nÃ y vÃ  Cloudflare offer sá»‘ lÆ°á»£ng rule khÃ¡ tháº¥p (Pro lÃ  10 rule, Business 15 rule vÃ  Enterprise rule), nÃªn cáº§n nhiá»u rule limit thÃ¬ Cloudflare lÃ  má»™t lá»±a chá»n khÃ¡ Ä‘áº¯t Ä‘á».s</li>
</ul>
<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/49gHcPDvyg0AcS4sy6qWao/e890866ea6582fb7a63f30e0ed34bdb9/rate-limiting-rules.png" alt="rate-limit"></p>
<p>NÃ³i tÃ³m láº¡i thÃ¬ Cloudflare vá»›i chi phÃ­ táº§m 20$/thÃ¡ng lÃ  má»™t lá»±a chá»n khÃ´ng tá»“i Ä‘á»ƒ chá»‘ng/giáº£m DDoS, táº¥t nhiÃªn báº¡n pháº£i hiá»ƒu váº¥n Ä‘á» cá»§a mÃ¬nh lÃ  gÃ¬ vÃ  Ä‘Ã¡nh giÃ¡ cÃ¡c lá»±a chá»n Ä‘á»ƒ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh phÃ¹ há»£p.</p>
<p>Náº¿u báº¡n xÃ i terraform thÃ¬ nÃ³ sáº½ nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-hcl" data-lang="hcl"><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;cloudflare_rate_limit&#34; &#34;rl_login&#34;</span> {
  zone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${var.domain}&#34;</span>

  threshold <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>
  period <span style="color:#f92672">=</span> <span style="color:#ae81ff">60</span>
  
  <span style="color:#66d9ef">match</span> {
    <span style="color:#66d9ef">request</span> {
      url_pattern <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${var.domain}/login&#34;</span>
      schemes <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;HTTP&#34;, &#34;HTTPS&#34;</span>]
      methods <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;POST&#34;</span>]
    }
    <span style="color:#66d9ef">response</span> {
      statuses <span style="color:#f92672">=</span> [<span style="color:#ae81ff">401</span>, <span style="color:#ae81ff">403</span>]
      origin_traffic <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    }
  }
  
  <span style="color:#66d9ef">action</span> {
    mode <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ban&#34;</span>
    timeout <span style="color:#f92672">=</span> <span style="color:#ae81ff">3600</span>
  }
  disabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Block IPs exceeding 20 request per minutes (20 in 60) for 1 hour to login pattern.&#34;</span>
}
</code></pre></div><p><strong>Update cá»±c máº¡nh:</strong></p>
<ul>
<li>Vá»›i tÃ­nh nÄƒng rate-limit nhÆ° mÃ´ táº£ á»Ÿ trÃªn, cÃ³ váº» lÃ  má»™t giáº£i phÃ¡p hoÃ n háº£o khi giá»›i háº¡n kháº£ nÄƒng gá»­i request cá»§a attacker ngay láº¡i level proxy. NHÆ¯NG <strong>toy Ä‘Ã£ láº§m</strong> khi nhÃ¬n tháº¥y billing cá»§a Cloudflare.</li>
</ul>
<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/cf_billing.png" alt="cf_billing"></p>
<ul>
<li>Theo mÃ´ táº£ vá» giÃ¡ cá»§a Cloudflare thÃ¬ &ldquo;<strong><a href="https://www.cloudflare.com/rate-limiting/">Only Pay for Good Traffic. Not Bad</a></strong>&rdquo;, nghÄ©a lÃ  vá»›i cÃ¡c rule Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a, thÃ¬ tiá»n sáº½ chá»‰ tÃ­nh trÃªn cÃ¡c request match vá»›i rule vÃ  khÃ´ng bá»‹ cháº·n bá»Ÿi Cloudflare. Free cho 10_000 good request Ä‘áº§u tiÃªn vÃ  má»—i  $0.05 cho 10_000 good request tiáº¿p theo.</li>
<li>Giáº£ sá»­ toy mÃ  biáº¿t Ã´ng nÃ o xÃ i tÃ­nh nÄƒng nÃ y cá»§a Cloudflare, Ä‘áº·c biá»‡t cÃ¡c request Ä‘Æ¡n giáº£n khÃ´ng yÃªu cáº§u header/method gÃ¬ Ä‘áº·c biá»‡t, toy lÃ m má»™t cá»¥m proxy Ä‘á»ƒ rotate-ip, send slow request thÃ¬ thÃ¡ng Ä‘Ã³ cÃ´ng ti Ä‘Ã³ cháº¯c cÅ©ng toangggg ğŸ˜‘ğŸ˜‘ğŸ˜‘.</li>
</ul>
<h2 id="3-proxy">3. Proxy</h2>
<h3 id="31-proxy-101">3.1 Proxy 101</h3>
<p>Äá»ƒ xÃ i Ä‘Æ°á»£c tÃ­nh nÄƒng nhÆ° <strong>rate-limit</strong> thÃ¬ báº¡n pháº£i cho phÃ©p request cá»§a user Ä‘i qua há»‡ thá»‘ng Cloudflare trÆ°á»›c khi tá»›i server cá»§a báº¡n, Ä‘Ã³ chÃ­nh lÃ  Proxy trong Cloudflare.</p>
<p>Proxy cÃ³ thá»ƒ Ä‘Æ°á»£c chia lÃ m 2 loáº¡i, khÃ¡c nhau á»Ÿ vá»‹ trÃ­ Ä‘áº·t vÃ  má»¥c Ä‘Ã­ch sá»­ dá»¥ng:</p>
<p><strong>Forward Proxy</strong>:</p>
<pre tabindex="0"><code class="language-asciiarmor" data-lang="asciiarmor">{clientA, clientB, clientC} â€”â€”&gt; forward proxy (F) â€”â€”&gt; Internet (I) â€”â€”&gt; {origin-serverA, origin-serverB}
</code></pre><ul>
<li>Vá»›i ngÆ°á»i dÃ¹ng, dÃ¹ng forward proxy giÃºp há» bypass Ä‘Æ°á»£c cÃ¡c giá»›i háº¡n truy cáº­p website. NÃ³ hÆ¡i giá»‘ng vá»›i VPN, forward proxy sáº½ thay ngÆ°á»i dÃ¹ng gá»­i request tá»›i website báº¡n muá»‘n truy cáº­p thay vÃ¬ káº¿t ná»‘i trá»±c tiáº¿p.</li>
<li>Vá»›i ngÆ°á»i quáº£n trá»‹ há»‡ thá»‘ng, há» cÃ³ thá»ƒ Ä‘áº·t má»™t forward proxy trong máº¡ng ná»™i bá»™ cá»§a há» vÃ  <strong>Ã©p</strong> táº¥t cáº£ cÃ¡c client pháº£i Ä‘i qua forward proxy nÃ y trÆ°á»›c khi káº¿t ná»‘i ra Internet. Viá»‡c nÃ y Ä‘em láº¡i 2 lá»£i Ã­ch, thá»© nháº¥t Ä‘Ã³ lÃ  caching cÃ¡c dá»¯ liá»‡u mÃ  ngÆ°á»i dÃ¹ng thÆ°á»ng xuyÃªn truy cáº­p vÃ  thá»© hai lÃ  cÃ³ thá»ƒ cáº£n lá»c, cháº·n truy cáº­p má»™t sá»‘ website, á»©ng dá»¥ng (vÃ­ dá»¥ cháº·n khÃ´ng cÃ³ user trong máº¡ng ná»™i bá»™ truy cáº­p Facebook.com).</li>
<li>áº¨n danh, tÆ°Æ¡ng tá»± nhÆ° VPN.</li>
</ul>
<p><strong>Reverse proxy</strong></p>
<pre tabindex="0"><code class="language-asciiarmor" data-lang="asciiarmor">{clientA, clientB, clientC} â€”â€”&gt; Internet (I) â€”â€”&gt; reverse proxy (R)â€”â€”&gt; {origin-serverA, origin-serverB}
</code></pre><p>Má»™t vÃ­ dá»¥ quen thuá»™c cá»§a reverse proxy Ä‘Ã³ lÃ  báº¡n xÃ i nginx upstream trÆ°á»›c cÃ¡c backend server. Lá»£i Ä‘iá»ƒm cá»§a viá»‡c dÃ¹ng reverse proxy Ä‘Ã³ lÃ :</p>
<ul>
<li><strong>Load balancing</strong> -&gt; chia request tá»« client tá»›i nhiá»u backend server vá»›i cÃ¡c thuáº­t toÃ¡n khÃ¡c nhau. GiÃºp Ä‘iá»u tiáº¿t lÆ°á»£ng request tá»›i backend server.</li>
<li><strong>Protection from attack</strong> -&gt; má»i request tá»« client sáº½ pháº£i Ä‘i qua reverse proxy, báº¡n cÃ³ thá»ƒ apply cÃ¡c rule trÃªn reverse proxy Ä‘á»ƒ cáº£n lá»c request trÆ°á»›c khi tá»›i backend server (tÆ°Æ¡ng tá»± nhÆ° rate-limit/WAF á»Ÿ trÃªn). Báº£n cháº¥t cá»§a proxy lÃ  nháº­n vÃ  pass request Ä‘i nÃªn cÃ¡c xá»­ lÃ½ trÃªn proxy lÃ  khÃ¡ nháº¹ nhÃ ng.</li>
<li><strong>Global Server Load Balancing</strong> -&gt; tÆ°Æ¡ng tá»± nhÆ° load balacing nhÆ°ng á»Ÿ cáº¥p Ä‘á»™ global, reverse proxy sáº½ nháº­n biáº¿t Ä‘Æ°á»£c lÃ  backend server nÃ o gáº§n vá»›i client vÃ  chuyá»ƒn hÆ°á»›ng request cá»§a client tá»›i backend server gáº§n nháº¥t Ä‘á»ƒ giáº£m latency, load time.</li>
<li><strong>Caching</strong> -&gt; request cá»§a client váº«n pháº£i tá»›i infra cá»§a site, tuy nhiÃªn viá»‡c caching sáº½ náº±m á»Ÿ infra cá»§a site (khÃ¡c vá»›i caching á»Ÿ forward proxy náº±m á»Ÿ network cá»§a client), má»¥c Ä‘Ã­ch cÅ©ng tÆ°Æ¡ng tá»± lÃ  giáº£m response time.</li>
<li><strong>SSL encryption</strong> -&gt; Ä‘áº©y pháº§n encrypt/decrypt ra reverse proxy, káº¿t ná»‘i tá»« reverse proxy tá»›i backend server lÃ  HTTP.</li>
</ul>
<p>á» Ä‘Ã¢y ta sáº½ chá»‰ nÃ³i tá»›i reverse proxy, thá»© mÃ  ráº¥t quen thuá»™c khi váº­n hÃ nh má»™t há»‡ thá»‘ng website/api. Tuy nhiÃªn Ä‘iá»ƒm khÃ¡c biá»‡t lÃ  báº¡n thÆ°á»ng Ä‘áº·t reverse proxy <strong>trong há»‡ thá»‘ng máº¡ng cá»§a báº¡n</strong>, cÃ²n vá»›i Cloudflare thÃ¬ chá»©c nÄƒng tÆ°Æ¡ng tá»±, nhÆ°ng proxy náº±m bÃªn ngoÃ i há»‡ thá»‘ng máº¡ng cá»§a báº¡n vÃ  vá»›i bÄƒng thÃ´ng 30Tbps, Cloudflare Ä‘á»§ sá»©c há»©ng má»i Ä‘á»£t táº¥n cÃ´ng trÆ°á»›c khi tá»›i origin server cá»§a báº¡n.</p>
<p><img src="https://blog.cloudflare.com/content/images/ddos-illustrations-2.png" alt="cloudflare-reverse-proxy"></p>
<p>VÃ­ dá»¥ website cá»§a báº¡n cÃ³ Ä‘á»‹a chá»‰ IP lÃ  <a href="1.2.3.4">1.2.3.4</a>, khi báº­t tÃ­nh nÄƒng proxy, domain website cá»§a báº¡n sáº½ Ä‘Æ°á»£c phÃ¢n giáº£i IP thÃ nh má»™t Ä‘á»‹a chá»‰ IP thuá»™c lá»›p máº¡ng cá»§a Cloudflare nhÆ° <a href="104.20.148.78">104.20.148.78</a>, vÃ  user/attacker sáº½ khÃ´ng biáº¿t Ä‘Æ°á»£c Ä‘á»‹a chá»‰ origin server cá»§a báº¡n.</p>
<h3 id="32-ssltls">3.2 SSL/TLS</h3>
<p>Äi kÃ¨m vá»›i Proxy, Cloudflare cung cáº¥p má»™t giáº£i phÃ¡p SSL/TLS miá»…n phÃ­ cho cÃ¡c khÃ¡ch hÃ ng nhá» giÃºp tÄƒng cÆ°á»ng báº£o máº­t cho website. <strong>Traffic tá»« client tá»›i Cloudflare sáº½ luÃ´n luÃ´n Ä‘Æ°á»£c mÃ£ hÃ³a</strong>, traffic tá»« Cloudflare tá»›i Origin server thÃ¬ phá»¥ thuá»™c vÃ o cáº¥u hÃ¬nh vá»›i cÃ¡c tÃ¹y chá»n nhÆ° sau:</p>
<ul>
<li>Flexible SSL</li>
<li>Full SSL
<ul>
<li>Strict (cert issued by Certificate Authority).</li>
<li>Full (cert issued by Cloudflare (Origin CA)).</li>
<li>Self-signed certificate.</li>
</ul>
</li>
</ul>
<p><strong>Flexible SSL</strong> sáº½ mÃ£ hÃ³a traffic tá»« Cloudflare tá»›i end-user, nhÆ°ng khÃ´ng mÃ£ hÃ³a traffic tá»« Cloudflare tá»›i origin server cá»§a báº¡n. Æ¯u Ä‘iá»ƒm lÃ  dá»… dÃ ng cÃ i Ä‘áº·t HTTPs cho user nhÆ°ng khÃ´ng yÃªu cáº§u pháº£i cÃ i Ä‘áº·t SSL certificate trÃªn server cá»§a báº¡n. Máº·c dÃ¹ khÃ´ng an toÃ n nhÆ° cÃ¡c tÃ¹y chá»n khÃ¡c nhÆ°ng Flexsible SSL lÃ  cÃ¡ch nhanh chÃ³ng, dá»… dÃ ng Ä‘á»ƒ báº£o vá»‡ user khá»i cÃ¡c má»‘i nguy hiá»ƒm tá»« public Wifi hoáº·c ad injection over HTTP. Vá» traffic tá»« Cloudflare tá»›i origin server cá»§a báº¡n, Ä‘áº·t niá»m tin hoÃ n toÃ n vÃ o Cloudflare ráº±ng traffic cá»§a báº¡n sáº½ khÃ´ng bá»‹ lá»™ ra bÃªn ngoÃ i (capture traffic khi vá»«a ra khá»i Cloudflare).</p>
<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/3G3ciVwoNO4YmqiWaUwi8e/be14a50ee11f34204c831c824eb5fcb6/flexible-ssl.svg" alt="flexible-ssl"></p>
<p><strong>Full SSL</strong> sáº½ mÃ£ hÃ³a traffic á»Ÿ cáº£ 2 Ä‘áº§u lÃ  tá»« Cloudflare tá»›i end-user vÃ  tá»« Cloudflare tá»›i origin server cá»§a báº¡n, cÃ³ ba tÃ¹y chá»n khÃ¡c nhau cho viá»‡c cÃ i Ä‘áº·t cerfiticate trÃªn server cá»§a báº¡n lÃ :</p>
<ul>
<li>Full SSL Strict -&gt; certificate cÃ i Ä‘áº·t trÃªn origin server cá»§a báº¡n Ä‘Æ°á»£c cáº¥p bá»Ÿi má»™t public Certificate Authority (vÃ­ dá»¥ Verisign, Digicert hoáº·c Comodo).</li>
<li>Full SSL, Origin CA -&gt; certificate cÃ i Ä‘áº·t trÃªn origin server cá»§a báº¡n Ä‘Æ°á»£c cáº¥p bá»Ÿi Cloudflare.</li>
<li>Full SSL, self-signed certificate -&gt; certificate tá»± gen.</li>
</ul>
<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/13hJjEZmQGA6ukiIw2iIEA/ea5b30e43d76ceed34a79e25837f76c9/full-ssl-strict.svg" alt="full-ssl"></p>
<p>Vá»›i Strict, certificate Ä‘Æ°á»£c cáº¥p bá»Ÿi CA cáº§n tá»‘n chi phÃ­ Ä‘á»ƒ mua vÃ  gia háº¡n. Vá»›i Origin CA, cert Ä‘Æ°á»£c cáº¥p bá»Ÿi Cloudflare, miá»…n phÃ­ vÃ  cÃ³ expire time khÃ¡ lÃ¢u, dá»… dÃ ng rotate nÃªn Cloudflare recomment xÃ i Origin CA.</p>
<h3 id="33-cloudflarefuck">3.3 Cloudflarefuck?</h3>
<p>Náº¿u báº¡n tá»«ng vÃ o trang tuyá»ƒn dá»¥ng cá»§a Cloudflare, Ä‘á»c thá»­ má»™t job description, báº¡n sáº½ tháº¥y má»™t cÃ¢u <strong>Cloudflare powers Internet requests for ~10% of the Fortune 1,000 for more than 1 billion unique IP addresses per day.</strong></p>
<p><img src="https://www.cloudflare.com/img/learning/what-is-cloudflare/cloudflare-stats-01.svg" alt="cloudflare-stats"></p>
<p>Váº­y cÃ¢u há»i lÃ  <strong>náº¿u Cloudflare sáº­p</strong> thÃ¬ chuyá»‡n gÃ¬ xáº£y ra ğŸ˜³ ğŸ”¥ ğŸš’, sáº½ <strong>chá»‰ cÃ³ 10% traffic</strong> trÃªn toÃ n tháº¿ giá»›i bá»‹ áº£nh hÆ°á»Ÿng. Nghe mÃ  Ä‘Ã£ rá»¥ng cmn rá»i.</p>
<p>Trong táº§m khoáº£ng 10 ngÃ y, Cloudflare xáº£y ra 2 network issues lá»›n:</p>
<ul>
<li><a href="https://blog.cloudflare.com/how-verizon-and-a-bgp-optimizer-knocked-large-parts-of-the-internet-offline-today/">Massive route leak</a>: theo post-mortem tá»« Cloudflare thÃ¬ lá»—i lÃ  do Verizon (má»™t nhÃ  máº¡ng ráº¥t lá»›n), áº£nh hÆ°á»Ÿng tá»›i ráº¥t nhiá»u provider lá»›n nhÆ° <a href="https://twitter.com/atoonk/status/1143143943531454464">Amazon,  Linode and Cloudflare</a>. Sá»± cá»‘ nÃ y máº¥t <a href="https://www.cloudflarestatus.com/incidents/46z55mdhg0t5">2 tiáº¿ng Ä‘á»“ng há»“</a> Ä‘á»ƒ giáº£i quyáº¿t.</li>
<li><a href="https://blog.cloudflare.com/cloudflare-outage/">Cloudflare outage caused by bad software deploy</a>: issue nÃ y Ä‘Æ°á»£c Cloudflare mÃ´ táº£ lÃ  do:
<ul>
<li>Deploy má»™t bá»™ rule cho dá»‹ch vá»¥ WAF Ä‘á»ƒ tá»‘i Æ°u viá»‡c block inline Javascript thÆ°á»ng Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c cuá»™c táº¥n cÃ´ng.</li>
<li>CÃ³ má»™t rule xÃ i regular expression khiáº¿n CPU spike lÃªn 100%.</li>
<li>Drop 82% traffic cá»§a Cloudflare vÃ  áº£nh hÆ°á»Ÿng tá»›i ráº¥t ráº¥t nhiá»u region trÃªn toÃ n tháº¿ giá»›i.</li>
<li>Má»™t lÆ°á»£ng lá»›n cÃ¡c cÃ´ng ty lá»›n bá»‹ áº£nh hÆ°á»Ÿng nhÆ° <a href="https://twitter.com/JacobCanfield/status/1146057756400504837">Coinbase, Authy, Discord, Medium, Zendesk â€¦</a>.</li>
<li>ÄÃ£ test á»Ÿ má»™t mÃ´i trÆ°á»ng giáº£ Ä‘á»‹nh, nhÆ°ng khÃ´ng cÃ³ Ä‘á»§ traffic Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ impact trÃªn production.</li>
<li>Giáº£i phÃ¡p lÃ  rollback láº¡i báº£n deployment, nhÆ°ng sá»± cá»‘ nÃ y cÅ©ng máº¥t <a href="https://www.cloudflarestatus.com/incidents/tx4pgxs6zxdr">1 tiáº¿ng Ä‘á»ƒ Ä‘iá»u tra vÃ  giáº£i quyáº¿t</a>.</li>
</ul>
</li>
</ul>
<p>áº¢nh hÆ°á»Ÿng cá»§a 2 sá»± cá»‘ trÃªn lÃ  <strong>request tá»« user Ä‘i qua Cloudflare khÃ´ng thá»ƒ tá»›i Ä‘Æ°á»£c origin server</strong> (tÃ­nh nÄƒng proxy cá»§a Cloudflare). RiÃªng vá»›i issue thá»© hai, do há»‡ thá»‘ng cá»§a chÃ­nh Cloudflare cÅ©ng sáº­p nÃªn ngÆ°á»i dÃ¹ng cÅ©ng khÃ´ng thá»ƒ access Ä‘Æ°á»£c dashboard cá»§a Cloudflare.</p>
<p>Váº­y <strong>giáº£i phÃ¡p</strong> lÃ  gÃ¬ khi gáº·p tÃ¬nh huá»‘ng nhÆ° trÃªn?</p>
<ul>
<li>Náº±m chá»‹u cháº¿t, chá» cho tá»›i khi dá»‹ch vá»¥ Cloudflare phá»¥c há»“i.</li>
<li>Náº¿u xÃ i SSL/TLS <strong>Full Strict</strong> thÃ¬ cÃ³ thá»ƒ <strong>táº¯t tÃ­nh nÄƒng proxy</strong> cá»§a Cloudflare Ä‘i
<ul>
<li>Traffic sáº½ Ä‘i trá»±c tiáº¿p tá»« user tá»›i origin server cá»§a báº¡n.</li>
<li>CÃ¡c rule vá» cáº£n lá»c bad request trÃªn Cloudflare sáº½ khÃ´ng cÃ²n tÃ¡c dá»¥ng.</li>
<li>Sáº½ khÃ´ng thá»ƒ thá»±c hiá»‡n náº¿u báº£n thÃ¢n dashboard cá»§a Cloudflare cÅ©ng cháº¿t ğŸ˜‘.</li>
<li>Liá»‡u háº¡ táº§ng DNS cá»§a Cloudflare cÃ³ cháº¿t luÃ´n hay khÃ´ng? ğŸ˜‘</li>
<li>VÃ  báº¯t buá»™c báº¡n ko Ä‘Æ°á»£c xÃ i Flexsible SSL hoáº·c self-sign cert vÃ¬ khi báº¡n táº¯t proxy, HTTPS trÃªn site cá»§a báº¡n sáº½ khÃ´ng Ä‘Ã¡ng tin cáº­y vÃ  dá»‹ch vá»¥ cá»§a báº¡n cÅ©ng khÃ´ng thá»ƒ cung cáº¥p.</li>
</ul>
</li>
</ul>
<p>Váº¥n Ä‘á» tiáº¿p theo lÃ  liá»‡u <strong>Táº®T PROXY</strong> cÃ³ pháº£i lÃ  giáº£i phÃ¡p?</p>
<h3 id="34-find-ip-origin-server">3.4 Find IP origin server</h3>
<p>Má»¥c tiÃªu cá»§a viá»‡c xÃ i Cloudflare proxy lÃ  Ä‘á»ƒ áº©n IP cá»§a origin server vÃ  khÃ´ng cho káº» táº¥n cÃ´ng biáº¿t Ä‘Æ°á»£c origin server, trÃ¡nh trÆ°á»ng há»£p bá»‹ attack trá»±c tiáº¿p vÃ o server thay vÃ¬ Ä‘i qua bá»™ lá»c cá»§a Cloudflare (hoáº·c crawler bypass bá»™ lá»c). Tháº¿ nÃªn khi Cloudflare gáº·p sá»± cá»‘, báº¡n táº¯t Proxy Ä‘i nghÄ©a lÃ  Ä‘Ã£ táº¡o ra má»™t lá»— há»•ng Ä‘á»ƒ attacker táº¥n cÃ´ng trá»±c tiáº¿p vÃ o há»‡ thá»‘ng, lÃºc nÃ y viá»‡c cÃ³ Cloudflare cÅ©ng khÃ´ng cÃ²n máº¥y tÃ¡c dá»¥ng.</p>
<p>Äá»©ng á»Ÿ gÃ³c Ä‘á»™ attacker, náº¿u site Ä‘Ã£ xÃ i Cloudflare proxy thÃ¬ cÃ³ cÃ¡ch nÃ o Ä‘á»ƒ biáº¿t Ä‘Æ°á»£c IP cá»§a orgin server hay khÃ´ng?</p>
<p>Viá»‡c xÃ¡c Ä‘á»‹nh má»™t site cÃ³ sá»­ dá»¥ng dá»‹ch vá»¥ Cloudflare cÅ©ng khÃ¡ dá»… dÃ ng, ta cÃ³ thá»ƒ:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; curl -I https://medium.com
HTTP/2 <span style="color:#ae81ff">200</span>
date: Fri, <span style="color:#ae81ff">12</span> Jul <span style="color:#ae81ff">2019</span> 05:55:11 GMT
content-type: text/html; charset<span style="color:#f92672">=</span>utf-8
set-cookie: __cfduid<span style="color:#f92672">=</span>dd3119117ce323927a453c7b298401b0e1562910911; expires<span style="color:#f92672">=</span>Sat, 11-Jul-20 05:55:11 GMT; path<span style="color:#f92672">=</span>/; domain<span style="color:#f92672">=</span>.medium.com; HttpOnly
content-security-policy: default-src <span style="color:#e6db74">&#39;self&#39;</span>; connect-src https://localhost https://*.instapaper.com https://*.stripe.com https://glyph.medium.com https://*.paypal.com https://getpocket.com https://medium.com https://*.medium.com https://*.medium.com https://medium.com https://*.medium.com https://*.algolia.net https://cdn-static-1.medium.com https://dnqgz544uhbo8.cloudfront.net https://cdn-videos-1.medium.com https://cdn-audio-1.medium.com https://*.lightstep.com https://*.branch.io https://app.zencoder.com <span style="color:#e6db74">&#39;self&#39;</span>; font-src data: https://*.amazonaws.com https://*.medium.com https://glyph.medium.com https://medium.com https://*.gstatic.com https://dnqgz544uhbo8.cloudfront.net https://use.typekit.net https://cdn-static-1.medium.com <span style="color:#e6db74">&#39;self&#39;</span>; frame-src chromenull: https: webviewprogressproxy: medium: <span style="color:#e6db74">&#39;self&#39;</span>; img-src blob: data: https: <span style="color:#e6db74">&#39;self&#39;</span>; media-src https://*.cdn.vine.co https://d1fcbxp97j4nb2.cloudfront.net https://d262ilb51hltx0.cloudfront.net https://*.medium.com https://gomiro.medium.com https://miro.medium.com https://pbs.twimg.com <span style="color:#e6db74">&#39;self&#39;</span> blob:; object-src <span style="color:#e6db74">&#39;self&#39;</span>; script-src <span style="color:#e6db74">&#39;unsafe-eval&#39;</span> <span style="color:#e6db74">&#39;unsafe-inline&#39;</span> about: https: <span style="color:#e6db74">&#39;self&#39;</span>; style-src <span style="color:#e6db74">&#39;unsafe-inline&#39;</span> data: https: <span style="color:#e6db74">&#39;self&#39;</span>; report-uri https://csp.medium.com
x-frame-options: sameorigin
x-content-type-options: nosniff
x-xss-protection: 1; mode<span style="color:#f92672">=</span>block
x-ua-compatible: IE<span style="color:#f92672">=</span>edge, Chrome<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
x-powered-by: Medium
x-obvious-tid: 1562910911357:c3d601539378
x-obvious-info: 38086-f2efc7b,f2efc7bd3f5
link: &lt;https://medium.com/humans.txt&gt;; rel<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;humans&#34;</span>
cache-control: no-cache, no-store, max-age<span style="color:#f92672">=</span>0, must-revalidate
expires: Thu, <span style="color:#ae81ff">09</span> Sep <span style="color:#ae81ff">1999</span> 09:09:09 GMT
pragma: no-cache
tk: T
strict-transport-security: max-age<span style="color:#f92672">=</span>15552000; includeSubDomains; preload
set-cookie: uid<span style="color:#f92672">=</span>lo_L3g8wBpz5tvb; Expires<span style="color:#f92672">=</span>Sat, 11-Jul-20 05:55:11 GMT; Domain<span style="color:#f92672">=</span>.medium.com; Path<span style="color:#f92672">=</span>/; Secure; HttpOnly
set-cookie: sid<span style="color:#f92672">=</span>1:5/Xr4XX2PjlG2TtQTn1ERsmMMjpOJ71eZvf4NMZMLbseEW3NrI5Yb2WFRlOsXXe8; path<span style="color:#f92672">=</span>/; expires<span style="color:#f92672">=</span>Sat, <span style="color:#ae81ff">11</span> Jul <span style="color:#ae81ff">2020</span> 05:55:11 GMT; domain<span style="color:#f92672">=</span>.medium.com; secure; httponly
set-cookie: __cfruid<span style="color:#f92672">=</span>0b37c1d5c8324ea472c0072a4c6f285ffc596078-1562910911; path<span style="color:#f92672">=</span>/; domain<span style="color:#f92672">=</span>.medium.com; HttpOnly
expect-ct: max-age<span style="color:#f92672">=</span>604800, report-uri<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://report-uri.cloudflare.com/cdn-cgi/beacon/expect-ct&#34;</span>
server: cloudflare
cf-ray: 4f50c44b398ad1e7-HKG
</code></pre></div><p>Má»™t sá»‘ header dÃ¹ng Ä‘á»ƒ xÃ¡c Ä‘á»‹nh nhÆ° <code>cf-ray</code>, <code>__cfduid</code> hoáº·c check IP phÃ¢n giáº£i cÃ³ thuá»™c lá»›p máº¡ng cá»§a Cloudflare hay khÃ´ng:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; dig +short medium.com
104.16.121.127
104.16.124.127
104.16.122.127
104.16.120.127
104.16.123.127
</code></pre></div><h4 id="341-ssl-certificate">3.4.1 SSL certificate</h4>
<p>Má»—i Domain Validation SSL certificate mÃ  báº¡n mua sáº½ valid vá»›i má»™t domain name. Ã tÆ°á»Ÿng lÃ  báº¡n cáº§n scan toÃ n bá»™ internet Ä‘á»ƒ tÃ¬m má»™t Ä‘á»‹a chá»‰ IP nÃ o Ä‘Ã³ trÃªn cá»•ng 443 cÃ³ SSL certificate match vá»›i domain-name mÃ  báº¡n Ä‘ang tÃ¬m kiáº¿m.</p>
<p><a href="https://censys.io/">Censys</a> lÃ  má»™t dá»‹ch vá»¥ cho phÃ©p query cÃ¡c dá»¯ liá»‡u kiá»ƒu nhÆ° váº­y. Miá»…n phÃ­ 10 query cho un-login user vÃ  200 query/thÃ¡ng cho free user.</p>
<p>VÃ­ dá»¥ vá»›i site <a href="https://viblo.asia">https://viblo.asia</a>, domain cá»§a há» phÃ¢n giáº£i thÃ nh Ä‘á»‹a chá»‰ cá»§a Cloudflare</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; dig +short viblo.asia
104.27.188.151
104.27.189.151
</code></pre></div><p>Tuy nhiÃªn khi query trÃªn Censys <code>(443.https.tls.certificate.parsed.names: viblo.asia OR 443.https.tls.certificate.parsed.subject.common_name: viblo.asia)</code> thÃ¬ káº¿t quáº£ lÃ :</p>
<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/censys_viblo.png" alt="censys_viblo"></p>
<p>TrÃ´ng cÃ³ váº» há» cÃ³ 3 server phÃ­a sau Cloudflare vÃ  host trÃªn Linode, ngoÃ i ra há» cÅ©ng má»Ÿ cá»•ng 22 vÃ  8080 trÃªn cÃ¡c node.</p>
<p>Má»™t vÃ­ dá»¥ khÃ¡c lÃ  Medium, báº¡n cÃ³ thá»ƒ xem káº¿t quáº£ search tá»« Censys tá»« file <a href="https://raw.githubusercontent.com/xluffy/assets/master/medium.txt">medium.txt</a>. Má»™t Ä‘iá»ƒm thÃº vá»‹ á»Ÿ Ä‘Ã¢y lÃ  mÃ¬nh nhÃ¬n tháº¥y cÃ³ 17 node EC2 tá»« dá»‹ch vá»¥ AWS public ra ngoÃ i Internet, khÃ´ng rÃµ má»¥c Ä‘Ã­ch cá»§a há» khi thiáº¿t káº¿ Infra nhÆ° váº­y lÃ  cÃ³ dá»¥ng Ã½ gÃ¬, mÃ¬nh Ä‘oÃ¡n lÃ  há» Ä‘ang xÃ i Global Load Balancing cá»§a Cloudflare thay vÃ¬ ALB cá»§a AWS, nhÆ°ng khÃ³ hiá»ƒu lÃ  cÃ¡c EC2 nÃ y Ä‘á»u náº±m á»Ÿ 1 AS vÃ  cÃ¹ng má»™t region lÃ  Ashburn, Virginia ğŸ¤”.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; grep <span style="color:#e6db74">&#39;.amazonaws&#39;</span> medium.txt
 52.1.147.205 <span style="color:#f92672">(</span>ec2-52-1-147-205.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.6.3.192 <span style="color:#f92672">(</span>ec2-52-6-3-192.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 54.167.232.247 <span style="color:#f92672">(</span>ec2-54-167-232-247.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.4.175.111 <span style="color:#f92672">(</span>ec2-52-4-175-111.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 3.94.121.79 <span style="color:#f92672">(</span>ec2-3-94-121-79.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.5.181.79 <span style="color:#f92672">(</span>ec2-52-5-181-79.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.1.173.203 <span style="color:#f92672">(</span>ec2-52-1-173-203.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.4.145.119 <span style="color:#f92672">(</span>ec2-52-4-145-119.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.6.46.142 <span style="color:#f92672">(</span>ec2-52-6-46-142.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.0.16.118 <span style="color:#f92672">(</span>ec2-52-0-16-118.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.4.225.124 <span style="color:#f92672">(</span>ec2-52-4-225-124.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.6.25.83 <span style="color:#f92672">(</span>ec2-52-6-25-83.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.206.109.232 <span style="color:#f92672">(</span>ec2-52-206-109-232.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 54.208.127.235 <span style="color:#f92672">(</span>ec2-54-208-127-235.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.4.38.70 <span style="color:#f92672">(</span>ec2-52-4-38-70.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 34.204.47.92 <span style="color:#f92672">(</span>ec2-34-204-47-92.compute-1.amazonaws.com<span style="color:#f92672">)</span>
 52.1.119.170 <span style="color:#f92672">(</span>ec2-52-1-119-170.compute-1.amazonaws.com<span style="color:#f92672">)</span>
</code></pre></div><p>NÃ³i chung cÃ³ thá»ƒ search nhiá»u thá»© vá»›i Censys, ngoÃ i domain-name validate vá»›i certificate, ta cÅ©ng cÃ³ thá»ƒ search fingerprint cá»§a SSL certificate.</p>
<h4 id="342-dns-records">3.4.2 DNS records</h4>
<p>Sau má»™t vÃ i Ä‘á»£t chá»‘ng chá»i vá»›i cÃ¡c cuá»™c táº¥n cÃ´ng, báº¡n quÃ¡ má»‡t má»i vÃ  quyáº¿t Ä‘á»‹nh chuyá»ƒn sang xÃ i Cloudflare. Váº¥n Ä‘á» lÃ  history vá» DNS records cá»§a báº¡n váº«n cÃ²n lÆ°u Ä‘Ã¢u Ä‘Ã³ trÃªn Internet vÃ  <a href="https://securitytrails.com/">SecurityTrails</a> lÃ  dá»‹ch vá»¥ cho phÃ©p query history cá»§a DNS record.</p>
<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/security_trails_medimum.jpg" alt="security_trails_medium"></p>
<p>NgoÃ i thÃ´ng tin vá» history DNS record, cÃ²n cÃ³ cÃ¡c thÃ´ng tin khÃ¡c nhÆ°:</p>
<ul>
<li>Subdomain -&gt; cÃ³ thá»ƒ sáº½ cÃ³ nhá»¯ng subdomain khÃ´ng Ä‘i qua Cloudflare nhÆ°ng chung origin server.</li>
<li>CÃ¡c history cá»§a cÃ¡c record khÃ¡c nhÆ° MX (mail), NS (mÃ¡y chá»§ DNS)</li>
</ul>
<h4 id="343-http-header-hoáº·c-content">3.4.3 HTTP header hoáº·c Content</h4>
<p>VÃ­ dá»¥ search vá»›i <strong>title</strong> cá»§a Medium báº±ng Censys.</p>
<pre tabindex="0"><code>443.https.get.title: &quot;Medium â€“ a place to read and write big ideas and important stories&quot;
</code></pre><p>Hoáº·c cÃ¡c content unique trÃªn website nhÆ° Google Analytics tracking code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">googleAnalyticsTrackingCode<span style="color:#e6db74">&#34;:&#34;</span>UA-24232453-2<span style="color:#e6db74">&#34;
</span></code></pre></div><p>CÃ´ng cá»¥ nhÆ° <a href="https://www.shodan.io">https://www.shodan.io</a> cho phÃ©p search cÃ¡c thÃ´ng tin nhÆ° váº­y tuy nhiÃªn nÃ³ yÃªu cáº§u báº¡n pháº£i tráº£ phÃ­ Ä‘á»ƒ truy cáº­p cÃ¡c dá»¯ liá»‡u trÃªn.</p>
<h2 id="4-prevention">4. Prevention</h2>
<p>CÃ¢u há»i bÃ¢y giá» lÃ  lÃ m tháº¿ nÃ o Ä‘á»ƒ áº©n danh IP origin server bá»Ÿi cÃ¡c cÃ´ng cá»¥ tÃ¬m kiáº¿m hoáº·c historical DNS record? VÃ  cÃ¡ch cáº¥u hÃ¬nh Cloudflare Ä‘á»ƒ chá»‘ng láº¡i cÃ¡c táº¥n cÃ´ng vÃ o origin server lÃ  nhÆ° tháº¿ nÃ o?</p>
<ul>
<li>Log real client-ip cá»§a user khi Ä‘i qua Cloudflare.</li>
<li>Remove táº¥t cáº£ cÃ¡c DNS record khÃ´ng cÃ²n sá»­ dá»¥ng (trÃ¡nh Ä‘á»ƒ lá»™ origin server cÅ©).</li>
<li>Cháº¡y email trÃªn cÃ¡c server hoáº·c dá»‹ch vá»¥ riÃªng (gsuite, sendgrid).</li>
<li>Sau khi chuyá»ƒn sang Cloudflare, nÃªn Ä‘á»•i táº¥t cáº£ cÃ¡c IP server cÅ©.</li>
<li>Whitelist cÃ¡c request tá»« há»‡ thá»‘ng Cloudflare (<a href="https://www.cloudflare.com/ips-v4">IPv4</a> vÃ  <a href="https://www.cloudflare.com/ips-v6">IPv6</a>) vÃ  cÃ¡c IP tá»« há»‡ thá»‘ng cá»§a báº¡n (náº¿u cÃ³ nhu cáº§u testing), pháº§n cÃ²n láº¡i nÃªn block.</li>
</ul>
<p>CÃ³ thá»ƒ block á»Ÿ táº§ng firewall nhÆ° security group hoáº·c transport layer (iptables) hoáº·c block á»Ÿ nginx cá»§a site, vÃ­ dá»¥ vá»›i iptables.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo iptables -I INPUT <span style="color:#ae81ff">1</span> -i lo -j ACCEPT
sudo iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

sudo iptables -A INPUT -p tcp -s 103.21.244.0/22 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 103.22.200.0/22 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 103.31.4.0/22 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 104.16.0.0/12 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 108.162.192.0/18 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 131.0.72.0/22 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 141.101.64.0/18 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 162.158.0.0/15 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 172.64.0.0/13 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 173.245.48.0/20 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 188.114.96.0/20 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 190.93.240.0/20 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 197.234.240.0/22 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 198.41.128.0/17 --dport <span style="color:#ae81ff">443</span> -j ACCEPT
sudo iptables -A INPUT -p tcp -s 199.27.128.0/21 --dport <span style="color:#ae81ff">443</span> -j ACCEPT

sudo iptables -A INPUT -p tcp --dport <span style="color:#ae81ff">22</span> -j ACCEPT
sudo iptables -A INPUT -j REJECT
</code></pre></div><p>Vá»›i nginx cÃ³ thá»ƒ block nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">map $remote_addr $bad_ip <span style="color:#f92672">{</span>
  default 1;
  cloudflare_ip_v4 0;
  cloudflare_ip_v6 0;
<span style="color:#f92672">}</span>

server <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>$bad_ip<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> 499;
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>NgoÃ i cÃ¡c giáº£i phÃ¡p trÃªn, Cloudflare cung cáº¥p má»™t dá»‹ch vá»¥ gá»i lÃ  <a href="https://www.cloudflare.com/products/argo-tunnel">Argo tunnel</a>, hiá»ƒu má»™t cÃ¡ch Ä‘Æ¡n giáº£n thÃ¬ argo-tunnel sáº½ táº¡o má»™t encrypted-tunnel giá»¯a origin server tá»›i Cloudflare data-center gáº§n nháº¥t (kÃ¨m theo smart routing), má»i káº¿t ná»‘i tá»« client Ä‘Æ°á»£c Cloudflare pass qua origin server sáº½ Ä‘i qua tunnel nÃ y, táº¥t cáº£ cÃ¡c request cÃ²n láº¡i sáº½ bá»‹ block.</p>
<h2 id="5-end">5. End</h2>
<p>Yeah, quÃ¡ nhiá»u cÃ¢u há»i, quÃ¡ nhiá»u chá»¯ rá»“i, váº­y náº¿u lá»¡ Cloudflare táº¡ch proxy thÃ¬ pháº£i lÃ m sao? Tháº­t ra toy cÅ©ng Ä‘Ã­u biáº¿t ae áº¡ ğŸ–•ğŸ½ğŸ–•ğŸ½ğŸ–•ğŸ½, lÃªn Twitter xem dÃ¢n tÃ¬nh chá»­i nhau vÃ  náº±m chá» Cloudflare sá»‘ng dáº­y thÃ´i.</p>
<p><img src="https://raw.githubusercontent.com/xluffy/assets/master/notlikethis.png" alt="notlikethis"></p>
<h2 id="6-ref">6. Ref</h2>
<ul>
<li><a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks">https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks</a></li>
<li><a href="https://www.cloudflare.com/rate-limiting">https://www.cloudflare.com/rate-limiting</a></li>
<li><a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy">https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy</a></li>
<li><a href="https://www.secjuice.com/finding-real-ips-of-origin-servers-behind-cloudflare-or-tor">https://www.secjuice.com/finding-real-ips-of-origin-servers-behind-cloudflare-or-tor</a></li>
<li><a href="https://blog.christophetd.fr/bypassing-cloudflare-using-internet-wide-scan-data">https://blog.christophetd.fr/bypassing-cloudflare-using-internet-wide-scan-data</a></li>
<li><a href="https://chris-knight.net/blog/2017/02/effectively-hiding-behind-cloudflare">https://chris-knight.net/blog/2017/02/effectively-hiding-behind-cloudflare</a></li>
<li><a href="https://citadelo.com/en/blog/cloudflare-how-to-do-it-right-and-do-not-reveal-your-real-ip/">https://citadelo.com/en/blog/cloudflare-how-to-do-it-right-and-do-not-reveal-your-real-ip/</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xluffy.github.io/post/change-schema-of-huge-table-in-mysql/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Change schema of huge table in MySQL</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xluffy.github.io/post/vpc-architecture/">
                  <span class="button__text">VPC architecture</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">hÃ ng nhÃ  trá»“ng ğŸŒ´ theo giáº¥y phÃ©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://xluffy.github.io/assets/main.js"></script>
<script src="https://xluffy.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
