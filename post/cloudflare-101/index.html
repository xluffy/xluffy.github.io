<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Cloudflare 101 | xluffy&#39;s page</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
    <header>

  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://xluffy.github.io">/home/xluffy&#39;s page</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="/categories/">~/categories</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="https://github.com/xluffy/til/issues">~/til</a>
      </li>
      
      
      <li class="pull-left ">
        <a href="#">~/books</a>
      </li>
      

      
      
      <li class="pull-right">
        <a href="/index.xml">~/subscribe</a>
      </li>
      

    </ul>
  </nav>
</header>

    
    
      
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
          new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-K4LWNXV');</script>
      
    
  </head>

  <body>
    
      
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K4LWNXV" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
      
    
    <br/>

<div class="article-meta">
<h1><span class="title">Cloudflare 101</span></h1>

<h2 class="date">2019/07/11</h2>
<p class="terms">
  
  
  Categories: <a href="/categories/security">security</a> <a href="/categories/cdn">cdn</a> 
  
  
  
  
</p>
</div>



<main>


<h2 id="1-ddos-101">1. DDoS 101</h2>

<p>Vá» DDoS dÃ¹ má»¥c Ä‘Ã­ch cuá»‘i cÃ¹ng lÃ  lÃ m cho dá»‹ch vá»¥ cá»§a báº¡n khÃ´ng thá»ƒ cung cáº¥p tá»›i ngÆ°á»i dÃ¹ng nhÆ°ng nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh 3 nhÃ³m:</p>

<ul>
<li><strong>Application Layer Attacks</strong>: má»¥c tiÃªu lÃ  khiáº¿n á»©ng dá»¥ng pháº£i xá»­ lÃ½ má»™t lÆ°á»£ng lá»›n cÃ¡c request <em>cÃ³ váº» há»£p lá»‡</em>, lÃ m cáº¡n kiá»‡t tÃ i nguyÃªn cá»§a á»©ng dá»¥ng, khiáº¿n á»©ng dá»¥ng khÃ´ng thá»ƒ phá»¥c vá»¥ cÃ¡c user há»£p lá»‡ khÃ¡c. VÃ­ dá»¥ trong á»©ng dá»¥ng TMÄT, má»™t API Ä‘á»c database tráº£ vá» má»™t danh sÃ¡ch chi tiáº¿t cá»§a cÃ¡c sáº£n pháº©m thuá»™c má»™t nhÃ³m ngÃ nh. Attacker cÃ³ thá»ƒ viáº¿t má»™t tools Ä‘á»ƒ crawl háº¿t dá»¯ liá»‡u cá»§a tá»«ng ngÃ nh hÃ ng, khiáº¿n server khÃ´ng Ä‘á»§ tÃ i nguyÃªn Ä‘á»ƒ phá»¥c vá»¥. Viá»‡c cáº£n lá»c request thuá»™c nhÃ³m nÃ y khÃ´ng dá»… vÃ¬ nÃ³ sáº½ khÃ¡ giá»‘ng vá»›i request cá»§a user thÃ´ng thÆ°á»ng vÃ  cÃ³ thá»ƒ cáº£n lá»c nháº§m nhá»¯ng user há»£p lá»‡.</li>
<li><strong>Protocol Attacks</strong>: tÆ°Æ¡ng tá»± application layer attack nhÆ°ng nháº¯m vÃ o layer 3 vÃ  layer 4 trong mÃ´ hÃ¬nh OSI. VÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh lÃ  SYN Flood, lá»£i dá»¥ng viá»‡c báº¯t-tay-3-bÆ°á»›c trong giao thá»©c TCP, attacker sáº½ gá»­i má»™t má»™t gÃ³i SYN Ä‘á»ƒ thiáº¿t láº­p káº¿t ná»‘i TCP, server sáº½ tráº£ vá» má»™t gÃ³i SYN-ACK vÃ  chá» Ä‘á»£i má»™t gÃ³i ACK Ä‘á»ƒ káº¿t thÃºc quÃ¡ trÃ¬nh báº¯t tay. NhÆ°ng sau Ä‘Ã³ attacker sáº½ khÃ´ng bao giá» tráº£ vá» ACK, khiáº¿n server pháº£i tiÃªu tá»‘n tÃ i nguyÃªn cho viá»‡c chá» Ä‘á»£i pháº£n há»“i.</li>
<li><strong>Volumetric Attacks</strong>: Hai loáº¡i trÃªn Ä‘á»u nháº¯m tá»›i viá»‡c á»©ng dá»¥ng, há»‡ Ä‘iá»u hÃ nh pháº£i tiÃªu tá»‘n tÃ i nguyÃªn xá»­ lÃ½. RiÃªng volumetric attack nháº¯m tá»›i bÄƒng thÃ´ng cá»§a há»‡ thá»‘ng victim. VÃ­ dá»¥ khÃ¡ch hÃ ng chá»‰ cÃ³ kháº£ nÄƒng thuÃª má»™t Ä‘Æ°á»ng truyá»n cÃ³ bÄƒng thÃ´ng 100Mpbs, attacker sáº½ tÃ¬m cÃ¡ch flood má»™t lÆ°á»£ng lá»›n traffic lá»›n hÆ¡n 100Mbps, khiáº¿n con Ä‘Æ°á»ng tá»›i server cá»§a victim bá»‹ ngháº½n (tÆ°Æ¡ng tá»± Ä‘Æ°á»ng 2 lÃ n, nhÆ°ng cÃ³ tá»›i 10 lÃ n xe cÃ¹ng vÃ o). VÃ­ dá»¥ <a href="https://blog.cloudflare.com/memcrashed-major-amplification-attacks-from-port-11211">Memcrashed</a>, lá»£i dá»¥ng cÃ¡c memcached server má»Ÿ UDP port ra ngoÃ i public, attacker gá»­i má»™t gÃ³i tin vá»›i <code>source_ip</code>Ä‘Æ°á»£c giáº£ máº¡o thÃ nh <code>source_ip</code> cá»§a victim tá»›i cÃ¡c server memcached nÃ y. Má»™t request gá»­i Ä‘i chá»‰ vá»›i 15 bytes nhÆ°ng memcached tráº£ vá» 134KB dá»¯ liá»‡u, vÃ  khuáº¿ch Ä‘áº¡i lÃªn thÃ¬ Cloudflare ghi nháº­n peak tá»›i <strong>260Gbps</strong> UDP traffic, Ä‘á»§ lÃ  ngháº½n network cá»§a báº¥t cá»© há»‡ thá»‘ng nÃ o.</li>
</ul>

<p>Äá»ƒ chá»‘ng láº¡i má»™t cuá»™c táº¥n cÃ´ng DDoS thÃ¬ tÃ¹y vÃ o loáº¡i attack. Tuy nhiÃªn Ä‘á»©ng á»Ÿ gÃ³c Ä‘á»™ lÃ m sáº£n pháº©m thÃ¬ luÃ´n cá»‘ gáº¯ng phá»¥c vá»¥ request ká»ƒ cáº£ báº¥t há»£p lá»‡ thay vÃ¬ <strong>block</strong> request vÃ¬ náº¿u block nháº§m user há»£p lá»‡ cÅ©ng coi nhÆ° tá»« chá»‘i phá»¥c vá»¥ dá»‹ch vá»¥ cho khÃ¡ch hÃ ng, giÃºp káº» táº¥n cÃ´ng Ä‘áº¡t Ä‘Æ°á»£c má»¥c Ä‘Ã­ch. Táº¥t nhiÃªn cÅ©ng pháº£i Ä‘Ã¡nh Ä‘á»•i giá»¯a viá»‡c báº£o vá»‡ pháº§n lá»›n user hay cáº£n lá»c nháº§m cÃ¡c user há»£p lá»‡.</p>

<p>Má»™t sá»‘ phÆ°Æ¡ng phÃ¡p Ä‘Æ°á»£c Ä‘á» xuáº¥t Ä‘á»ƒ giáº£m thiá»ƒu cáº£n lá»c DDoS attack nhÆ° sau:</p>

<ul>
<li><strong>Black Hole Routing</strong>: tÆ°Æ¡ng tá»± nhÆ° <code>&amp;&gt; /dev/null</code> Ä‘áº©y toÃ n bá»™ traffic cáº£ há»£p lá»‡ láº«n khÃ´ng há»£p lá»‡ vÃ o há»‘ Ä‘en.</li>
<li><strong>Rate limit request</strong>: giá»›i háº¡n sá»‘ lÆ°á»£ng request mÃ  server cháº¥p nháº­n xá»­ lÃ½ trong má»™t khung thá»i gian. Há»¯u Ã­ch khi chá»‘ng crawler hoáº·c brute-force login.</li>
<li><strong>WAF (Web Application Firewall)</strong>: báº£o vá»‡ server, á»©ng dá»¥ng bá»Ÿi cÃ¡c lá»— há»•ng thÃ´ng thÆ°á»ng nhÆ° SQL injection, XSS&hellip;</li>
<li><strong>Anycast Network Diffusion</strong>: mÃ¬nh tháº¥y khÃ´ng cÃ³ má»™t giáº£i thÃ­ch nÃ o dá»… hiá»ƒu hÆ¡n tá»« anh <a href="https://github.com/lebinh">lebinh</a>, báº¡n cÃ³ thá»ƒ Ä‘á»c thÃªm nÃ³ á»Ÿ Ä‘Ã¢y <a href="https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5">https://discuss.grokking.org/t/dung-trang-tinh-d-ngan-ch-n-ddos/271/5</a>.</li>
</ul>

<h2 id="2-rate-limit">2. Rate Limit</h2>

<p>Cloudflare cung cáº¥p má»™t tÃ­nh nÄƒng cho phÃ©p control vÃ  block cÃ¡c traffic Ä‘Ã¡ng ngá». TÃ­nh nÄƒng nÃ y giÃºp <strong>tá»± Ä‘á»™ng</strong> báº£o vá»‡ website cá»§a báº¡n khá»i:</p>

<ul>
<li>DDoS attack.</li>
<li>brute-force login.</li>
<li>â€¦.</li>
</ul>

<p>CÃ¢u há»i Ä‘áº·t ra lÃ  táº¡i sao tui pháº£i tráº£ tiá»n Cloudflare Ä‘á»ƒ xÃ i tÃ­nh nÄƒng nÃ y? CÃ³ giáº£i phÃ¡p nÃ o thay tháº¿ miá»…n phÃ­, Ä‘Æ¡n giáº£n hay khÃ´ng?</p>

<p>TÃ­nh nÄƒng limit request/minute hoáº·c block request khÃ´ng cÃ³ gÃ¬ má»›i. Ta cÃ³ thá»ƒ giáº£i quyáº¿t báº±ng cÃ¡c giáº£i phÃ¡p sau:</p>

<ul>
<li>Limit request á»Ÿ táº§ng application, vÃ­ dá»¥ <a href="https://github.com/kickstarter/rack-attack">rack-attack</a>.</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html">ngx_http_limit_req_module</a>, block ip, limit request dá»±a trÃªn ngÆ°á»¡ng vÃ  thá»i gian.</li>
<li>nginx + lua + redis, tÆ°Æ¡ng tá»± nhÆ° trÃªn, nhÆ°ng ta cÃ³ thá»ƒ táº­n dá»¥ng expire/ttl cá»§a redis Ä‘á»ƒ ban/block má»™t IP vÃ  sau Ä‘Ã³ unban IP Ä‘Ã³ theo expire cá»§a má»™t key trong redis. Má»™t Æ°u Ä‘iá»ƒm khÃ¡c lÃ  ta cÃ³ thá»ƒ query dá»¯ liá»‡u trong redis Ä‘á»ƒ report.</li>
<li>Host-based firewall nhÆ° iptables/ufw -&gt; block/limit request á»Ÿ cÃ¡c layer tháº¥p hÆ¡n application layer:

<ul>
<li>Æ¯u Ä‘iá»ƒm lÃ  block á»Ÿ cÃ¡c layer tháº¥p nhÆ° transport layer trá»Ÿ xuá»‘ng, request sáº½ chÆ°a ká»‹p tá»›i application layer, giáº£m táº£i cho web server.</li>
<li>Vá»›i limit request, ta sáº½ cáº§n load thÃªm má»™t sá»‘ module há»— trá»£ iptable -&gt; firewall stateful -&gt; <a href="https://making.pusher.com/per-ip-rate-limiting-with-iptables">thanks-for-pusher</a>.</li>
<li>NhÆ°á»£c Ä‘iá»ƒm lÃ  khÃ´ng tá»± Ä‘á»™ng cáº­p nháº­t danh sÃ¡ch IP má»›i bá»‹ ban/block/limit. Äá»ƒ giáº£i quyáº¿t viá»‡c cáº­p nháº­t tá»± Ä‘á»™ng cÃ³ thá»ƒ <a href="https://vnhacker.blogspot.com/2009/12/giam-sat-ninh-mang-hay-la-lam-nao-e.html">build má»™t há»‡ thá»‘ng offline Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  update láº¡i vÃ o há»‡ thá»‘ng firewall</a>.</li>
</ul></li>
<li>Network-based firewall: cÃ¡c firewall náº±m ngoÃ i host nhÆ° hardware firewall hoáº·c security group cá»§a AWS (nhÆ°ng vá» lÃ½ thuyáº¿t nÃ³ khÃ´ng Ä‘Æ°á»£c xáº¿p vÃ o network-based firewall). CÅ©ng tÆ°Æ¡ng tá»± host-based firewall lÃ  viá»‡c cáº­p nháº­t danh sÃ¡ch IP sáº½ khÃ³ khÄƒn. VÃ  vá»›i security group cá»§a AWS thÃ¬ khÃ´ng thá»ƒ limit request (chá»‰ cÃ³ cháº·n).</li>
</ul>

<p><strong>NhÆ°á»£c Ä‘iá»ƒm</strong> cá»§a táº¥t cáº£ cÃ¡c phÆ°Æ¡ng phÃ¡p trÃªn lÃ :</p>

<ul>
<li>Request cá»§a attacker <strong>Ä‘Ã£ tá»›i há»‡ thá»‘ng</strong> cá»§a báº¡n, náº¿u xÃ i network-base firewall thÃ¬ request Ä‘Ã£ vÃ o tá»›i router/hardware-firewall, náº¿u xÃ i host-based firewall (iptables) thÃ¬ request Ä‘Ã£ tá»›i server (OS Ä‘Ã£ pháº£i handle), náº¿u báº¡n limit á»Ÿ táº§ng application thÃ¬ web server (nginx hoáº·c Apache) Ä‘Ã£ pháº£i xá»­ lÃ½ vÃ  náº¿u báº¡n xÃ i má»™t thÆ° viá»‡n nhÆ° <a href="https://github.com/kickstarter/rack-attack">rack-attach</a> thÃ¬ Rails pháº£i handle thÃªm viá»‡c giá»›i háº¡n request.</li>
<li>ThÃªm thiáº¿t bá»‹, software Ä‘á»ƒ xá»­ lÃ½ váº¥n Ä‘á» (sáº½ khÃ´ng phÃ¹ há»£p vá»›i há»‡ thá»‘ng nhá»).</li>
</ul>

<p>Váº­y náº¿u xÃ i rate-limit cá»§a Cloudflare thÃ¬ cÃ³ lá»£i gÃ¬?</p>

<ul>
<li>TÆ°á»Ÿng tÆ°á»£ng Cloudflare sáº½ nhÆ° má»™t reverse proxy má»i request trÆ°á»›c khi Ä‘i tá»›i origin server cá»§a báº¡n Ä‘á»u sáº½ Ä‘i qua Cloudflare.</li>
<li>BÄƒng thÃ´ng cá»§a Cloudflare lÃ  30Tbps, gáº¥p 15 láº§n cuá»™c táº¥n cÃ´ng DDoS lá»›n nháº¥t tá»«ng Ä‘Æ°á»£c ghi nháº­n (cháº¯c lÃ  memcrashed), vá»›i con nhÃ  nghÃ¨o, báº¡n chá»‰ thuÃª Ä‘Æ°á»£c bÄƒng thÃ´ng 100Mbps. Cloudflare hoáº¡t Ä‘á»™ng nhÆ° BOT (tráº¡m thu phÃ­) giá»¯a quá»‘c lá»™ vÃ  Ä‘Æ°á»ng lÃ ng, giÃºp bÃ³p nhá» / cáº£n lá»c bá»›t traffic trÆ°á»›c khi tá»›i server cá»§a báº¡n, khÃ´ng lÃ m overload network cá»§a báº¡n. (thÃ´ng thÆ°á»ng náº¿u báº¡n host server á»Ÿ DC, khi gáº·p má»™t cuá»™c táº¥n cÃ´ng volumetric attacks, báº¡n cÃ³ thá»ƒ nhá» DC tÄƒng bÄƒng thÃ´ng Ä‘á»ƒ chá»‘ng chá»i hoáº·c nhá» Firewall/Router cá»§a DC cáº£n lá»c bá»›t traffic trÆ°á»›c khi vÃ o server cá»§a báº¡n, tÆ°Æ¡ng tá»± nhÆ° Cloudflare).</li>
<li>Dá»… cáº¥u hÃ¬nh ngÆ°á»¡ng, URL vÃ  cÃ³ report Ä‘á»ƒ xem.</li>
<li>ThÃ´ng minh, tá»± Ä‘á»™ng nháº­n biáº¿t cÃ¡c request khÃ´ng há»£p lá»‡, cÃ³ thá»ƒ expire sau má»™t khoáº£ng thá»i gian (tÆ°Æ¡ng tá»± lua+redis), cho phÃ©p user tá»± bypass báº±ng cÃ¡ch pass <em>challenge</em> hoáº·c <em>js challenge</em> thay vÃ¬ block ngay.</li>
</ul>

<p><img src="https://www.cloudflare.com/resources/images/slt3lc6tev37/49gHcPDvyg0AcS4sy6qWao/e890866ea6582fb7a63f30e0ed34bdb9/rate-limiting-rules.png" alt="rate-limit" /></p>

<p>NÃ³i tÃ³m láº¡i thÃ¬ Cloudflare vá»›i chi phÃ­ táº§m 20$/thÃ¡ng lÃ  má»™t lá»±a chá»n khÃ´ng tá»“i Ä‘á»ƒ chá»‘ng DDoS, táº¥t nhiÃªn báº¡n pháº£i hiá»ƒu váº¥n Ä‘á» cá»§a mÃ¬nh lÃ  gÃ¬ vÃ  Ä‘Ã¡nh giÃ¡ cÃ¡c lá»±a chá»n.</p>

<p>BÃ i tiáº¿p theo mÃ¬nh sáº½ nÃ³i vá» 2 sá»± cá»‘ gáº§n Ä‘Ã¢y cá»§a Cloudflare vá»›i dá»‹ch vá»¥ Proxy (báº¡n pháº£i báº­t proxy má»›i dÃ¹ng Ä‘Æ°á»£c cÃ¡c tÃ­nh nÄƒng nhÆ° rate-limit hoáº·c WAF cá»§a Cloudflare) vÃ  phÃ¢n tÃ­ch cÃ¡ch giáº£i quyáº¿t vá»›i 2 sá»± cá»‘ trÃªn.</p>

<h2 id="3-ref">3. Ref</h2>

<ul>
<li><a href="https://www.cloudflare.com/rate-limiting">https://www.cloudflare.com/rate-limiting</a></li>
<li><a href="https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks">https://www.cloudflare.com/learning/ddos/what-is-a-ddos-attacks</a></li>
</ul>

<p></p>

</main>
<section>
  <hr>
<script src="https://utteranc.es/client.js"
        repo="xluffy/xluffy.github.io"
        issue-term="url"
        label="comments"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</section>

    <footer>
      
<script>
(function() {
  function center_el(tagName) {
    var tags = document.getElementsByTagName(tagName), i, tag;
    for (i = 0; i < tags.length; i++) {
      tag = tags[i];
      var parent = tag.parentElement;
      
      if (parent.childNodes.length === 1) {
        
        if (parent.nodeName === 'A') {
          parent = parent.parentElement;
          if (parent.childNodes.length != 1) continue;
        }
        if (parent.nodeName === 'P') parent.style.textAlign = 'center';
      }
    }
  }
  var tagNames = ['img', 'embed', 'object'];
  for (var i = 0; i < tagNames.length; i++) {
    center_el(tagNames[i]);
  }
})();
</script>

      
      <hr/>
      <a href="https://github.com/xluffy">Github</a> | <a href="https://twitter.com/min0lta">Twitter</a> | <a href="https://t.me/xluffy">Telegram</a>
      
      <br><a href="https://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" src="https://i.creativecommons.org/l/by-nc-nd/4.0/80x15.png"></a>
    </footer>
  </body>
</html>

