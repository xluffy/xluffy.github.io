<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Rails for DevOps engineer ::
        /dev/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="M·ªôt s·ªë c√∫ ph√°p, best practice khi s·ª≠ d·ª•ng Active Record c∆° b·∫£n cho m·∫•y b·∫°n d√©p-·ªôp engineer."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://xluffy.github.io/post/rails-for-devops-engineer/" />





<link rel="stylesheet" href="https://xluffy.github.io/assets/style.css" />

<link rel="stylesheet" href="https://xluffy.github.io/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://xluffy.github.io/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://xluffy.github.io/img/favicon.png" />


<link href="https://xluffy.github.io/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://xluffy.github.io/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rails for DevOps engineer"/>
<meta name="twitter:description" content="M·ªôt s·ªë c√∫ ph√°p, best practice khi s·ª≠ d·ª•ng Active Record c∆° b·∫£n cho m·∫•y b·∫°n d√©p-·ªôp engineer."/>



<meta property="og:title" content="Rails for DevOps engineer" />
<meta property="og:description" content="M·ªôt s·ªë c√∫ ph√°p, best practice khi s·ª≠ d·ª•ng Active Record c∆° b·∫£n cho m·∫•y b·∫°n d√©p-·ªôp engineer." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xluffy.github.io/post/rails-for-devops-engineer/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2018-07-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-07-25T00:00:00+00:00" /><meta property="og:site_name" content="/dev/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/dev/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Rails for DevOps engineer</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2018-07-25
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://xluffy.github.io/tags/rails/">#rails</a>&nbsp;
        
          <a href="https://xluffy.github.io/tags/active-record/">#active-record</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>M·ªôt s·ªë c√∫ ph√°p, best practice khi s·ª≠ d·ª•ng Active Record c∆° b·∫£n cho m·∫•y b·∫°n d√©p-·ªôp engineer.</p>
<h2 id="1-basic-active-record">1. Basic Active Record</h2>
<h3 id="11-find">1.1 find</h3>
<p>Tham s·ªë truy·ªÅn v√†o c·ªßa <code>find</code> l√† primary-key, v√≠ d·ª• <code>User.find(1)</code> t∆∞∆°ng ƒë∆∞∆°ng v·ªõi <code>SELECT * FROM users WHERE id = 1 LIMIT 1</code></p>
<p>C≈©ng c√≥ th·ªÉ nh·∫≠n nhi·ªÅu gi√° tr·ªã ki·ªÉu <code>User.find(1, 10)</code> ho·∫∑c <code>User.find([1, 10])</code> s·∫Ω t∆∞∆°ng ƒë∆∞∆°ng v·ªõi <code>SELECT * FROM users WHERE id IN (1, 10)</code></p>
<h3 id="12-takefirstlast">1.2 take/first/last</h3>
<ul>
<li><code>take</code> tr·∫£ v·ªÅ m·ªôt ho·∫∑c nhi·ªÅu record t√πy v√†o gi√° tr·ªã truy·ªÅn v√†o nh∆∞ng KH√îNG S·∫ÆP X·∫æP</li>
<li><code>first</code> m·∫∑c ƒë·ªãnh tr·∫£ v·ªÅ m·ªôt record v√† S·∫ÆP X·∫æP GI·∫¢M D·∫¶N d·ª±a tr√™n primary key <code>ORDER BY id ASC</code>, c≈©ng c√≥ th·ªÉ tr·∫£ v·ªÅ nhi·ªÅu gi√° tr·ªã</li>
<li><code>last</code> gi·ªëng <code>first</code>, ch·ªâ kh√°c l√† s·∫Øp x·∫øp tƒÉng d·∫ßn.</li>
</ul>
<p>Theo th·ª© t·ª± active record v√† sql s·∫Ω nh∆∞ sau:</p>
<pre tabindex="0"><code>User.take
User.take(20)

SELECT * FROM users LIMIT 1;
SELECT * FROM users LIMIT 20;

User.first
User.first(2)

SELECT * FROM users ORDER BY id ASC LIMIT 1
SELECT * FROM users ORDER BY id ASC LIMIT 2

User.last

SELECT * FROM users ORDER BY id DESC LIMIT 1
</code></pre><h3 id="13-find_by-v√†-wheretake">1.3 <code>find_by</code> v√† <code>where().take</code></h3>
<ul>
<li><code>find_by</code> tr·∫£ v·ªÅ m·ªôt record match v·ªõi ƒëi·ªÅu ki·ªán.</li>
<li><code>where</code> tr·∫£ v·ªÅ record theo ƒëi·ªÅu ki·ªán.</li>
</ul>
<p>V√≠ d·ª• 2 query sau s·∫Ω nh∆∞ nhau:</p>
<pre tabindex="0"><code>User.find_by name: 'Quang'
User.where(name: 'Quang').take

SELECT * FROM users WHERE name = 'Quang' LIMIT 1;
</code></pre><h3 id="14-unscope-v√†-only">1.4 <code>unscope</code> v√† <code>only</code></h3>
<p><code>unscope</code> d√πng ƒë·ªÉ x√≥a m·ªôt s·ªë <strong>ƒëi·ªÅu ki·ªán</strong> c·ª• th·ªÉ n√†o ƒë√≥, <code>only</code> th√¨ ng∆∞·ª£c l·∫°i, ch·ªâ ƒë·ªãnh c√°c <strong>ƒëi·ªÅu ki·ªán</strong> s·∫Ω ƒë∆∞·ª£c gi·ªØ l·∫°i, v√≠ d·ª•:</p>
<pre tabindex="0"><code>User.where(&quot;email LIKE '%@gmail%'&quot;).order(:id)
SELECT  `users`.* FROM `users` WHERE (email LIKE '%@gmail%') ORDER BY `users`.`id` ASC;
</code></pre><p>Nh∆∞ng gi·ªù m√¨nh mu·ªën x√≥a ƒëi·ªÅu ki·ªán s·∫Øp x·∫øp theo <code>id</code> th√¨ d√πng method <code>unscope</code> nh∆∞ sau:</p>
<pre tabindex="0"><code>User.where(&quot;email LIKE '%@gmail%'&quot;).order(:id).unscope(:order)
SELECT  `users`.* FROM `users` WHERE (email LIKE '%@gmail%');
</code></pre><h2 id="2-some-active-record-tips">2. Some Active-Record tips</h2>
<h3 id="21-include-v√†-n--1-query">2.1. <code>include</code> v√† n + 1 query</h3>
<p>Gi·∫£ s·ª≠ ta c√≥ model User nh∆∞ sau:</p>
<pre tabindex="0"><code>class User
  has_many :posts
end
</code></pre><p>=&gt; m·ªôt user c√≥ th·ªÉ c√≥ nhi·ªÅu post</p>
<p>V·ªõi c√°ch query th√¥ng th∆∞·ªùng trong active-record</p>
<pre tabindex="0"><code>users = User.all

users.each do |user|
  user.posts
end
</code></pre><p>ƒêo·∫°n tr√™n s·∫Ω generate ra n + 1 query nh∆∞ sau:</p>
<pre tabindex="0"><code>SELECT users.* FROM users;

SELECT posts.* FROM posts WHERE posts.user_id = 1;
SELECT posts.* FROM posts WHERE posts.user_id = 2;
SELECT posts.* FROM posts WHERE posts.user_id = 3;
SELECT posts.* FROM posts WHERE posts.user_id = 4;
...
SELECT posts.* FROM posts WHERE posts.user_id = n;
</code></pre><p>=&gt; n·∫øu c√≥ bao nhi√™u user th√¨ generate ra b·∫±ng ƒë√≥ + 1 user n√™n g·ªçi l√† n + 1</p>
<p>N·∫øu ta d√πng <code>includes</code> th√¨ s·∫Ω ch·ªâ generate ra 2 query, 1 l√† load t·∫•t c·∫£ users v√† 1 l√† load t·∫•t c·∫£ c√°c posts li√™n quan ƒë·∫øn c√°c users ƒë√≥.</p>
<pre tabindex="0"><code>users = User.includes(:posts)

users.each do |user|
  user.posts
end
</code></pre><pre tabindex="0"><code>SELECT users.* FROM users;

SELECT posts.* FROM posts WHERE posts.user_id IN (1, 2, 3, 4 ... n);
</code></pre><p>Ngo√†i <code>include</code> c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng <code>preload</code> ho·∫∑c <code>eager_load</code> ƒë·ªÉ tr√°nh n + 1 query</p>
<h3 id="22-find_each-khi-load-m·ªôt-l∆∞·ª£ng-l·ªõn-record">2.2. <code>find_each</code> khi load m·ªôt l∆∞·ª£ng l·ªõn record</h3>
<p>T∆∞∆°ng t·ª± nh∆∞ vi·ªác d√πng <code>LIMIT</code> trong SQL</p>
<pre tabindex="0"><code>User.all.each do |user|
  puts users
end

# SQL generate

SELECT users.* FROM users;
</code></pre><p>Thay v√¨ load t·∫•t c·∫£ c√°c user th√¨ ta c√≥ th·ªÉ LIMIT l∆∞·ª£ng user hi·ªÉn th·ªã ra b·∫±ng c√°ch d√πng <code>find_each</code> nh∆∞ sau:</p>
<pre tabindex="0"><code>User.all.find_each(batch_size: 100) do |u|
  puts u
end

# SQL query

SELECT users.* FROM users ORDER BY users.id ASC LIMIT 100;
SELECT users.* FROM users WHERE users.id &gt; 100 ORDER BY users.id ASC LIMIT 100;
SELECT users.* FROM users WHERE users.id &gt; 200 ORDER BY users.id ASC LIMIT 100;
...
</code></pre><p>Ch√∫ √Ω l√† c√°c query sau s·∫Ω c√≥ th√™m ƒëi·ªÅu ki·ªán <code>users.id &gt; batch_size</code></p>
<h3 id="23-ch·ªâ-l·∫•y-field-c·∫ßn-v·ªõi-pluck-ho·∫∑c-select">2.3. Ch·ªâ l·∫•y field c·∫ßn v·ªõi <code>pluck</code> ho·∫∑c <code>select</code></h3>
<p>T∆∞∆°ng t·ª± trong SQL, kh√¥ng ph·∫£i l√∫c n√†o ta c≈©ng c·∫ßn t·∫•t c·∫£ thu·ªôc t√≠nh c·ªßa model, thay v√¨:</p>
<pre tabindex="0"><code>SELECT * FROM users;
</code></pre><p>Ta ch·ªâ l·∫•y c√°c thu·ªôc t√≠nh c·∫ßn thi·∫øt b·∫±ng c√¢u query:</p>
<pre tabindex="0"><code>SELECT email FROM users;
</code></pre><p>Trong active-record th√¨ thay v√¨ d√πng</p>
<pre tabindex="0"><code>user_emails = User.where(status: &quot;active&quot;).map(&amp;:email)
# SELECT * FROM users;
</code></pre><p>Ta s·∫Ω ch·ªâ l·∫•y thu·ªôc t√≠nh email c·ªßa user nh∆∞ sau:</p>
<pre tabindex="0"><code>user_emails = User.where(status: &quot;active&quot;).pluck(:email)
# SELECT users.email FROM users;
</code></pre><p>Ho·∫∑c x√†i <code>select</code></p>
<pre tabindex="0"><code>User.select(:name)
or
User.select(&quot;name&quot;)
</code></pre><h3 id="24-ki·ªÉm-tra-s·ª±-t·ªìn-t·∫°i-c·ªßa-d·ªØ-li·ªáu-v·ªõi-exist-thay-v√¨-present">2.4. Ki·ªÉm tra s·ª± t·ªìn t·∫°i c·ªßa d·ªØ li·ªáu v·ªõi <code>exist?</code> thay v√¨ <code>present?</code></h3>
<pre tabindex="0"><code>if User.where(email: &quot;a@bc.d&quot;).present?
  puts &quot;There is a user with email address a@bc.d&quot;
else
  puts &quot;There is no user with email address a@bc.d&quot;
end
</code></pre><p>C√¢u query SQL s·∫Ω generate th√†nh:</p>
<pre tabindex="0"><code>SELECT * FROM users WHERE email = 'a@bc.d';
</code></pre><p>C√¢u query tr√™n s·∫Ω l√£ng ph√≠ b·ªüi v√≠ ta kh√¥ng c·∫ßn load h·∫øt thu·ªôc t√≠nh c·ªßa user ƒë·ªÉ ki·ªÉm tra user v·ªõi email ƒë√≥ c√≥ t·ªìn t·∫°i hay kh√¥ng. Thay v√†o ƒë√≥ c√≥ th·ªÉ d√πng nh∆∞ sau:</p>
<pre tabindex="0"><code>if User.where(email: &quot;a@bc.d&quot;).exist?
  puts &quot;There is a user with email address a@bc.d&quot;
else
  puts &quot;There is no user with email address a@bc.d&quot;
end
</code></pre><p>Query SQL s·∫Ω th√†nh:</p>
<pre tabindex="0"><code>SELECT 1 FROM users WHERE email = 'a@bc.d' LIMIT 1;
</code></pre><p>K·∫øt qu·∫£ ch·ªâ tr·∫£ v·ªÅ 1 record v√† kh√¥ng bao g·ªìm b·∫•t k·ª≥ thu·ªôc t√≠nh n√†o.</p>
<h3 id="25-bulk">2.5 Bulk</h3>
<p>V√≠ d·ª• ta ph·∫£i INSERT/UPDATE/DELETE m·ªôt l∆∞·ª£ng l·ªõn d·ªØ li·ªáu, th√¨ bulk INSERT/UPDATE/DELETE s·∫Ω nhanh h∆°n l√† thao t√°c v·ªõi t·ª´ng record d·ªØ li·ªáu.</p>
<p>V√≠ d·ª• v·ªõi t·∫°o d·ªØ li·ªáu:</p>
<pre tabindex="0"><code>new_users = [
  {name: &quot;A&quot;, email: &quot;a@bc.d&quot;},
  {name: &quot;B&quot;, email: &quot;b@bc.d&quot;},
  {name: &quot;C&quot;, email: &quot;c@bc.d&quot; },
  ...
  {name: &quot;Z&quot;, email: &quot;z@bc.d&quot; },
]

new_users.each do |u|
  User.create(u)
end

-----------------------------------------
INSERT INTO users VALUES (&quot;A&quot;, &quot;a@bc.d&quot;);
INSERT INTO users VALUES (&quot;B&quot;, &quot;b@bc.d&quot;);
INSERT INTO users VALUES (&quot;C&quot;, &quot;c@bc.d&quot;);
...
INSERT INTO users VALUES (&quot;Z&quot;, &quot;z@bc.d&quot;);
</code></pre><p>Ta c√≥ th·ªÉ bulk INSERT b·∫±ng c√°ch:</p>
<pre tabindex="0"><code>User.create(new_users)

-------------------------------------------------------------------------------------------
INSERT INTO users VALUES (&quot;A&quot;, &quot;a@bc.d&quot;), (&quot;B&quot;, &quot;b@bc.d&quot;), (&quot;C&quot;, &quot;c@bc.d&quot;), (&quot;Z&quot;, &quot;z@bc.d&quot;);
</code></pre><p>V√≠ d·ª• v·ªõi c·∫≠p nh·∫≠t d·ªØ li·ªáu:</p>
<pre tabindex="0"><code>update_users = User.where(user_status: nil)

update_users.each do |u|
  u.updute(user_status: &quot;new_user&quot;)
end

</code></pre><p>Ta c√≥ th·ªÉ bulk UPDATE b·∫±ng c√°ch:</p>
<pre tabindex="0"><code>update_users = User.where(user_status: nil)
update_users.update_all(user_status: &quot;new_user&quot;)
</code></pre><p>V√≠ d·ª• v·ªõi x√≥a d·ªØ li·ªáu:</p>
<pre tabindex="0"><code>banned_users = User.where(user_status: &quot;banned&quot;)

banned_users.each do |u|
  u.destroy
end

-------------------------------------------------------
SELECT * FROM users WHERE users.user_status = &quot;banned&quot;;
DELETE FROM users WHERE id = 1;
DELETE FROM users WHERE id = 2;
DELETE FROM users WHERE id = 3;
DELETE FROM users WHERE id = 4;
</code></pre><p>=&gt; L·∫•y t·∫•t c·∫£ c√°c user c·∫ßn DELETE sau ƒë√≥ sinh ra n query DELETE t·ª´ng user d·ª±a tr√™n id c·ªßa user. Thay v√¨ v·∫≠y ta c√≥ th·ªÉ x√†i bulk DELETE nh∆∞ sau</p>
<pre tabindex="0"><code>banned_users = User.where(user_status: &quot;banned&quot;)
banned_users.delete_all

-----------------------------------------------------
DELETE FROM users WHERE users.user_status = &quot;banned&quot;;
</code></pre><h3 id="26-map-vs-select">2.6. Map vs Select</h3>
<p>K·∫øt qu·∫£ tr·∫£ v·ªÅ c·ªßa <code>map</code> s·∫Ω l√† m·ªôt m·∫£ng b·∫±ng m·∫£ng ƒë·∫ßu v√†o, k·∫øt qu·∫£ c·ªßa <code>map</code> l√† m·∫£ng ch·ª©a k·∫øt qu·∫£ c·ªßa t·ª´ng ph·∫ßn t·ª≠ ƒë·ªëi chi·∫øu v·ªõi ƒëi·ªÅu ki·ªán trong block.</p>
<p><code>select</code> ch·ªâ tr·∫£ v·ªÅ c√°c k·∫øt qu·∫£ th·ªèa m√£n v·ªõi ƒëi·ªÅu ki·ªán trong block, <code>select</code> c√≥ th·ªÉ xem nh∆∞ <code>map</code> + <code>compact</code></p>
<pre tabindex="0"><code>&gt; an_array = [0, 1, 2, 3, 4, 5]
&gt; m_array = an_array.map { |e| e if e.even? }
=&gt; [0, nil, 2, nil, 4, nil]
&gt; m_array.compact
=&gt; [0, 2, 4]

&gt; s_array = an_array.select { |e| e if e.even? }
=&gt; [0, 2, 4]
</code></pre><h2 id="3-other">3. Other</h2>
<h3 id="31-">3.1. <code>||=</code></h3>
<p>V√≠ d·ª• <code>x ||= y</code> c√≥ nghƒ©a l√† <code>x || x = y</code>. N·∫øu <code>x = nil</code> ho·∫∑c <code>x = false</code> g√°n <code>x = y</code></p>
<h2 id="4-ref">4. Ref</h2>
<ul>
<li><a href="https://medium.com/@User3141592/active-record-query-performance-tips-a3c3947b968">https://medium.com/@User3141592/active-record-query-performance-tips-a3c3947b968</a></li>
<li><a href="https://www.netguru.co/codestories/activerecord-tips-2">https://www.netguru.co/codestories/activerecord-tips-2</a></li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://xluffy.github.io/post/sidekiq-how-to-reliability/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Sidekiq, how to reliability?</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://xluffy.github.io/post/how-to-setup-our-networking/">
                  <span class="button__text">Setup h·ªá th·ªëng m·∫°ng cho cty v·ª´a v√† nh·ªè</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">h√†ng nh√† tr·ªìng üå¥ theo gi·∫•y ph√©p CC BY-NC 4.0</div>
      
  </div>
</footer>

<script src="https://xluffy.github.io/assets/main.js"></script>
<script src="https://xluffy.github.io/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
