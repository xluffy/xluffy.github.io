<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Chaos of configuration ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Má»™t trong cÃ¡c váº¥n Ä‘á» cÆ¡ báº£n khi deployment vÃ  Ä‘áº£m báº£o security cho á»©ng dá»¥ng Ä‘Ã³ lÃ  lÃ m sao Ä‘á»ƒ quáº£n lÃ½ config má»™t cÃ¡ch tiá»‡n lá»£i, an toÃ n, dá»… cáº­p nháº­t."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/chaos-of-configuration/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Chaos of configuration"/>
<meta name="twitter:description" content="Má»™t trong cÃ¡c váº¥n Ä‘á» cÆ¡ báº£n khi deployment vÃ  Ä‘áº£m báº£o security cho á»©ng dá»¥ng Ä‘Ã³ lÃ  lÃ m sao Ä‘á»ƒ quáº£n lÃ½ config má»™t cÃ¡ch tiá»‡n lá»£i, an toÃ n, dá»… cáº­p nháº­t."/>



<meta property="og:title" content="Chaos of configuration" />
<meta property="og:description" content="Má»™t trong cÃ¡c váº¥n Ä‘á» cÆ¡ báº£n khi deployment vÃ  Ä‘áº£m báº£o security cho á»©ng dá»¥ng Ä‘Ã³ lÃ  lÃ m sao Ä‘á»ƒ quáº£n lÃ½ config má»™t cÃ¡ch tiá»‡n lá»£i, an toÃ n, dá»… cáº­p nháº­t." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/chaos-of-configuration/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-06T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Chaos of configuration</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-01-06
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/rails/">#rails</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/configuration/">#configuration</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/deployment/">#deployment</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Má»™t trong cÃ¡c váº¥n Ä‘á» cÆ¡ báº£n khi deployment vÃ  Ä‘áº£m báº£o security cho á»©ng dá»¥ng Ä‘Ã³ lÃ  lÃ m sao Ä‘á»ƒ quáº£n lÃ½ config má»™t cÃ¡ch tiá»‡n lá»£i, an toÃ n, dá»… cáº­p nháº­t.</p>
<p>TuÃ¢n theo má»™t method lÃ  <a href="https://12factor.net/config">12factor</a> ta coi nhÆ° viá»‡c dÃ¹ng <strong>biáº¿n mÃ´i trÆ°á»ng</strong> Ä‘á»ƒ lÆ°u config lÃ  <strong>chuyá»‡n hiá»ƒn nhiÃªn</strong> khÃ´ng cáº§n pháº£i giáº£i thÃ­ch.</p>
<h3 id="1-what-the-fuck-are-u-doing-now">1. What the fuck are u doing now?</h3>
<p>Láº¥y vÃ­ dá»¥ lÃ  á»©ng dá»¥ng Rails, cÃ¡ch quáº£n lÃ½ config hiá»‡n táº¡i Ä‘Æ°á»£c mÃ´ táº£ nhÆ° sau:</p>
<p>Sá»­ dá»¥ng gem <a href="https://github.com/laserlemon/figaro">Figaro</a> Ä‘á»ƒ quáº£n lÃ½ config: VÃ­ dá»¥ khi sá»­ dá»¥ng Pusher (má»™t 3rd service Ä‘á»ƒ push notification in-app vá» cho mobile) nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># config/application.yml</span>
<span style="color:#f92672">defaults</span>: <span style="color:#75715e">&amp;defaults</span>
  <span style="color:#f92672">PUSHER_APP_ID</span>: <span style="color:#e6db74">&#34;2954&#34;</span>
  <span style="color:#f92672">PUSHER_KEY</span>: <span style="color:#e6db74">&#34;7381a978f7dd7f9a1117&#34;</span>
  <span style="color:#f92672">PUSHER_SECRET</span>: <span style="color:#e6db74">&#34;abdc3b896a0ffb85d373&#34;</span>
  <span style="color:#f92672">PUSHER_CLUSTER</span>: <span style="color:#e6db74">&#34;mt1&#34;</span>

<span style="color:#f92672">development</span>:
  <span style="color:#f92672">&lt;</span>: <span style="color:#75715e">*defaults</span>

<span style="color:#f92672">production</span>:
  <span style="color:#f92672">&lt;</span>: <span style="color:#75715e">*defaults</span>
  <span style="color:#f92672">PUSHER_APP_ID</span>: <span style="color:#e6db74">&#34;1234&#34;</span>
  <span style="color:#f92672">PUSHER_KEY</span>: <span style="color:#e6db74">&#34;7381a978f7dd7f9a1117&#34;</span>
  <span style="color:#f92672">PUSHER_SECRET</span>: <span style="color:#e6db74">&#34;abdc3b896a0ffb85d373&#34;</span>
  <span style="color:#f92672">PUSHER_CLUSTER</span>: <span style="color:#e6db74">&#34;mt1&#34;</span>
</code></pre></div><p>Config pusher trong initializer nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rubY" data-lang="rubY"><span style="color:#75715e"># initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>app_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_APP_ID&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_KEY&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_SECRET&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>cluster <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_CLUSTER&#39;</span><span style="color:#f92672">]</span>
</code></pre></div><p>Ta sáº½ lÆ°u thÃ´ng tin cáº¥u hÃ¬nh lÃ  má»™t cáº·p key/value vÃ o má»™t táº­p tin <code>yaml</code> vÃ  load cáº¥u hÃ¬nh thÃ´ng qua initializers. Má»™t initializer Ä‘Æ¡n giáº£n lÃ  má»™t táº­p tin Ruby Ä‘Æ°á»£c Ä‘áº·t táº¡i <code>config/initializers</code>. Initializers thÆ°á»ng Ä‘Æ°á»£c dÃ¹ng Ä‘á»ƒ <strong>lÆ°u cáº¥u hÃ¬nh mÃ  muá»‘n load sau cÃ¹ng</strong>, khi framework vÃ  táº¥t cáº£ cÃ¡c gem (thÆ° viá»‡n trong ruby) Ä‘Æ°á»£c load.</p>
<p>Vá» cÆ¡ báº£n, váº­y lÃ  xong. Tuy nhiÃªn náº¿u ta muá»‘n rÃ ng buá»™c cháº·t cháº½ hÆ¡n, yÃªu cáº§u lÃ  cÃ¡c thÃ´ng tin cáº¥u hÃ¬nh báº¯t buá»™c pháº£i tá»“n táº¡i, náº¿u thiáº¿u sáº½ khÃ´ng cho khá»Ÿi táº¡o á»©ng dá»¥ng. Figaro há»— trá»£ 2 phÆ°Æ¡ng thá»©c lÃ  proactively vÃ  lazily.</p>
<p>Proactively nghÄ©a lÃ  á»©ng dá»¥ng sáº½ raise má»™t exception náº¿u cÃ³ báº¥t cá»© giÃ¡ trá»‹ config nÃ o rÃ ng buá»™c nhÆ°ng khÃ´ng Ä‘Æ°á»£c thiáº¿t láº­p <strong>ngay khi á»©ng dá»¥ng khá»Ÿi táº¡o</strong> (initialization).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/initializers/figaro.rb</span>

<span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>require_keys(<span style="color:#e6db74">&#34;PUSHER_APP_ID&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_KEY&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_SECRET&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_CLUSTER&#34;</span>)
</code></pre></div><p>Trong khi lazily khÃ´ng raise exception khi khá»Ÿi táº¡o, nÃªn dáº«n tá»›i cÃ¡c lá»—i khÃ´ng mong Ä‘á»£i trong runtime (khi nÃ o cáº§n dÃ¹ng má»›i kiá»ƒm tra vÃ  náº¿u thiáº¿u sáº½ raise exception).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>app_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_APP_ID!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>key    <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_KEY!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_SECRET!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>cluster <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_CLUSTER!
</code></pre></div><p>NgoÃ i Figaro, cÃ³ má»™t sá»‘ gem khÃ¡c tÆ°Æ¡ng tá»±, vÃ­ dá»¥ <a href="https://github.com/bkeepers/dotenv">dotenv</a>. Vá» cÆ¡ báº£n, cÃ¡ch tiáº¿p cáº­n giá»¯a Figaro vÃ  <a href="https://github.com/bkeepers/dotenv">dotenv</a> lÃ  nhÆ° nhau, cÃ¹ng Ä‘Æ°á»£c phÃ¡t triá»ƒn táº¡i má»™t thá»i Ä‘iá»ƒm vÃ  giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» tÆ°Æ¡ng tá»± nhau:</p>
<p><strong>TÆ°Æ¡ng Ä‘á»“ng:</strong></p>
<ul>
<li>Há»— trá»£ tá»‘t cho cÃ¡c á»©ng dá»¥ng Ruby.</li>
<li>Phá»• biáº¿n vÃ  váº«n cÃ²n Ä‘Æ°á»£c báº£o trÃ¬ code tá»‘t.</li>
<li>Äá»u láº¥y cáº£m há»©ng tá»« concept Twelve-Factor App.</li>
<li>Äá»u lÆ°u giÃ¡ trá»‹ config trong biáº¿n mÃ´i trÆ°á»ng <code>ENV</code>.</li>
</ul>
<p><strong>KhÃ¡c biá»‡t:</strong></p>
<ul>
<li>Táº­p tin config:
<ul>
<li>Figaro lÆ°u táº¥t cáº£ cÃ¡c biáº¿n config cá»§a cÃ¡c mÃ´i trÆ°á»ng trong cÃ¹ng má»™t táº­p tin.</li>
<li>Dotenv há»— trá»£ tÃ¡ch biáº¿n config cá»§a cÃ¡c mÃ´i trÆ°á»ng ra cÃ¡c táº­p tin riÃªng biá»‡t (<code>.env.local</code>, <code>.env.development</code>, <code>.env</code>).</li>
</ul>
</li>
<li>Äá»‹nh dáº¡ng táº­p tin cáº¥u hÃ¬nh
<ul>
<li>Figaro sá»­ dá»¥ng <code>yaml</code> vá»›i má»™t cáº·p key/value.</li>
<li>Dotenv lÃ  má»™t táº­p há»£p cÃ¡c giÃ¡ trá»‹ <code>KEY=VALUE</code>.</li>
</ul>
</li>
<li>Security vs. Convenience
<ul>
<li>Figaro quy Æ°á»›c lÃ  khÃ´ng bao giá» commit táº­p tin cáº¥u hÃ¬nh.</li>
<li>Dotenv khuyáº¿n khÃ­ch commit cáº¥u hÃ¬nh cá»§a mÃ´i trÆ°á»ng development.</li>
</ul>
</li>
<li>Framework Focus
<ul>
<li>Figaro táº­p trung vÃ o á»©ng dá»¥ng Rails.</li>
<li>Dotenv cÃ³ thá»ƒ sá»­ dá»¥ng cho cÃ¡c á»©ng dá»¥ng Ruby.</li>
</ul>
</li>
</ul>
<p>Viáº¿t dÃ i dÃ i cho vui chá»© thá»±c ra khÃ´ng cÃ³ nhiá»u sá»± khÃ¡c biá»‡t láº¯m giá»¯a hai thÆ° viá»‡n nÃ y, <strong>dÃ¹ng cÃ¡i nÃ o cÅ©ng Ä‘Æ°á»£c.</strong></p>
<p>LÆ°u vÃ  táº£i config khi á»©ng dá»¥ng khá»Ÿi táº¡o thÃ¬ nhÆ° váº­y, nhÆ°ng quáº£n lÃ½ cáº¥u hÃ¬nh vÃ  deployment thÃ¬ cáº§n thÃªm <strong>cÃ¡c yÃªu cáº§u</strong> nhÆ° sau:</p>
<ul>
<li>GiÃ¡ trá»‹ cáº¥u hÃ¬nh trÃªn mÃ´i trÆ°á»ng <code>production</code> <strong>KHÃ”NG</strong> chia sáº» cho developer.</li>
<li>GiÃ¡ trá»‹ cáº¥u hÃ¬nh pháº£i khÃ¡c biá»‡t giá»¯a cÃ¡c mÃ´i trÆ°á»ng, vÃ­ dá»¥ <code>PUSHER_SECRET_KEY</code> pháº£i khÃ¡c biá»‡t giá»¯a development vÃ  production. Báº£o vá»‡ key cá»§a mÃ´i trÆ°á»ng production an toÃ n nháº¥t cÃ³ thá»ƒ. Cho phÃ©p apply cÃ¡c rule khÃ¡c nhau lÃªn tá»«ng cáº¥u hÃ¬nh (vÃ­ dá»¥ key cá»§a development chá»‰ dÃ¹ng Ä‘á»ƒ test nÃªn limit notification &hellip;).</li>
<li>Cáº§n cÃ³ má»™t cÃ¡ch tiá»‡n lá»£i Ä‘á»ƒ chia sáº» táº­p tin cáº¥u hÃ¬nh á»Ÿ development khi cÃ³ má»™t ngÆ°á»i má»›i join team nhÆ°ng khÃ´ng Ä‘Æ°á»£c commit vÃ o git.</li>
<li>Cáº§n cÃ³ má»™t cÃ¡ch Ä‘á»ƒ quáº£n lÃ½ version cá»§a cáº¥u hÃ¬nh trÃªn production. Dá»… dÃ ng thÃªm má»›i, delivery lÃªn production.</li>
</ul>
<p><strong>NguyÃªn táº¯c sá»‘ 1:</strong>  Quáº£n lÃ½ táº¥t cáº£ cáº¥u hÃ¬nh qua biáº¿n mÃ´i trÆ°á»ng (<code>ENV</code>), thÃ´ng qua thÆ° viá»‡n, khÃ´ng <strong>hard-code</strong> báº¥t cá»© chá»— nÃ o trong á»©ng dá»¥ng. NghÄ©a lÃ  khÃ´ng chÆ¡i nhÆ° váº§y:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bX5kuRUuVJlP1AD&#34;</span>
</code></pre></div><p><strong>NguyÃªn táº¯c sá»‘ 2:</strong> KhÃ´ng commit báº¥t ká»³ táº­p tin cáº¥u hÃ¬nh nÃ o vÃ o git, khÃ´ng lÆ°u trá»¯ cÃ¡c credentials info vÃ o git. NghÄ©a lÃ  khÃ´ng Ä‘Æ°á»£c tá»“n táº¡i cÃ¡c táº­p tin nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree config/
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ application.yml
â”‚Â Â  â”œâ”€â”€ database.yml
â”‚Â Â  â”œâ”€â”€ mongoid.yml
â”‚Â Â  â”œâ”€â”€ newrelic.yml
â”‚Â Â  â”œâ”€â”€ redis.yml
â”‚Â Â  â”œâ”€â”€ secrets.yml
â”‚Â Â  â””â”€â”€ sidekiq.yml
</code></pre></div><p><strong>NguyÃªn táº¯c sá»‘ 3:</strong>  Äá»ƒ Ä‘áº£m báº£o consistensy cá»§a giÃ¡ trá»‹ cáº¥u hÃ¬nh giá»¯a cÃ¡c mÃ´i trÆ°á»ng (cÃ³ á»Ÿ production mÃ  thiáº¿u á»Ÿ development) vÃ  Ä‘á»ƒ dá»… dÃ ng cho developer má»›i khi tham gia dá»± Ã¡n, commit vÃ o git má»™t táº­p tin example cá»§a tá»«ng táº­p tin cáº¥u hÃ¬nh. VÃ­ dá»¥:</p>
<pre tabindex="0"><code>&gt; tree config/
â”œâ”€â”€ config
â”‚Â Â  â”œâ”€â”€ application.example.yml
â”‚Â Â  â”œâ”€â”€ database.example.yml
â”‚Â Â  â”œâ”€â”€ mongoid.example.yml
â”‚Â Â  â”œâ”€â”€ newrelic.example.yml
â”‚Â Â  â”œâ”€â”€ redis.example.yml
â”‚Â Â  â”œâ”€â”€ secrets.example.yml
â”‚Â Â  â””â”€â”€ sidekiq.example.yml
</code></pre><p>LÆ°u Ã½:</p>
<ul>
<li>Giá»¯ nguyÃªn extention lÃ  <code>yaml</code> Ä‘á»ƒ sá»­ dá»¥ng highlight syntax cá»§a editor (khÃ´ng nÃªn dÃ¹ng <code>application.yml.example</code>).</li>
<li>Khi cáº§n sá»­ dá»¥ng thÃªm má»™t biáº¿n mÃ´i trÆ°á»ng má»›i NÃŠN thÃªm vÃ o file example vÃ  commit lÃªn git, trÃªn production cÅ©ng tra cá»©u ngÆ°á»£c vÃ o táº­p tin example Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng thiáº¿u/dÆ° thá»«a báº¥t ká»³ giÃ¡ trá»‹ nÃ o.</li>
</ul>
<p>=&gt; Tuy nhiÃªn táº­p tin example chá»‰ giáº£i quyáº¿t Ä‘Æ°á»£c cÃ¡c credentials info mÃ  developer cÃ³ thá»ƒ tá»± táº¡o (nhÆ° database, redis &hellip;) chá»© credentials info tá»« 3rd service thÃ¬ váº«n cáº§n pháº£i chia sáº» thá»§ cÃ´ng (ngÆ°á»i cÅ© gá»­i cho ngÆ°á»i má»›i).</p>
<p><strong>NguyÃªn táº¯c sá»‘ 4:</strong> Quáº£n lÃ½ credentials Ä‘á»™c láº­p cho tá»«ng mÃ´i trÆ°á»ng &lt;=&gt; pick cÃ¡c service cho phÃ©p generate, phÃ¢n quyá»n vÃ  giá»›i háº¡n Ä‘á»™c láº­p trÃªn tá»«ng credential. VÃ­ dá»¥:</p>
<ul>
<li>Táº¡o thÃ´ng tin pusher cho cÃ¹ng má»™t á»©ng dá»¥ng nhÆ°ng 2 mÃ´i trÆ°á»ng development (coding + debug) vÃ  production.</li>
<li>Giá»›i háº¡n sá»‘ push notification cho mÃ´i trÆ°á»ng development (vÃ¬ debug khÃ´ng cáº§n nhiá»u, trÃ¡nh bug/lá»™ secret_key dáº«n tá»›i tá»‘n chi phÃ­).</li>
<li>Cho phÃ©p truy cáº­p web admin cá»§a development key, há»— trá»£ debugging.</li>
</ul>
<p>TÃ¡ch Ä‘á»™c láº­p cho tá»«ng mÃ´i trÆ°á»ng, tá»«ng á»©ng dá»¥ng giÃºp dá»… dÃ ng revoker khi thÃ´ng tin bá»‹ lá»™ ra ngoÃ i, hoáº·c náº¿u lá»™, giáº£m thiá»ƒu áº£nh hÆ°á»Ÿng chung Ä‘áº¿n toÃ n bá»™ á»©ng dá»¥ng.</p>
<p>CÅ©ng cáº§n lÆ°u Ã½ lÃ  má»™t sá»‘ dá»‹ch vá»¥ nhÆ° IAM AWS, secret_key chá»‰ hiá»‡n thá»‹ Ä‘Ãºng má»™t láº§n lÃºc táº¡o, sau nÃ y sáº½ khÃ´ng thá»ƒ xem láº¡i Ä‘Æ°á»£c ná»¯a, nÃªn náº¿u quÃªn secret_key thÃ¬ chá»‰ cÃ³ cÃ¡ch táº¡o secret_key khÃ¡c.</p>
<p><strong>Váº¥n Ä‘á» lÃ  lÆ°u thÃ´ng tin cáº¥u hÃ¬nh trÃªn production á»Ÿ Ä‘Ã¢u Ä‘á»ƒ:</strong></p>
<ul>
<li>Lá»¡ tay xoÃ¡ máº¥t hoáº·c server cÃ³ sá»± cá»‘ máº¥t thÃ´ng tin cáº¥u hÃ¬nh.</li>
<li>Dá»… dÃ ng sync khi deployment.</li>
<li>CÃ³ mÃ£ hoÃ¡ nhÆ°ng pháº£i quáº£n lÃ½ Ä‘Æ°á»£c version tÆ°Æ¡ng tá»± nhÆ° quáº£n lÃ½ code vá»›i git.</li>
</ul>
<p>VÃ­ dá»¥ vá» má»™t <strong>quy trÃ¬nh deployment</strong> thá»§ cÃ´ng nhÆ° sau:</p>
<ul>
<li>
<p>Cáº¥u trÃºc thÆ° má»¥c cá»§a node deployment nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree /fk
/fk
â””â”€â”€ predeploy
    â””â”€â”€ fk-service-hs
        â”œâ”€â”€ current -&gt; releases/20200104193548
        â”œâ”€â”€ fk-service-hs_master <span style="color:#75715e"># git-repo_branch</span>
        â”œâ”€â”€ override-latest/config
        â””â”€â”€ releases/20200104193548
</code></pre></div></li>
<li>
<p>Vá»›i predeploy lÃ  nÆ¡i code sáº½ Ä‘Æ°á»£c chuáº©n bá»‹ Ä‘á»ƒ deployment.</p>
</li>
<li>
<p><code>override-latest/config</code> lÃ  thÃ´ng tin cáº¥u hÃ¬nh cá»§a production, lÆ°u trá»¯ cÃ¡c táº­p tin cáº§n <em>chÃ©p Ä‘Ã¨</em> sá»­ dá»¥ng cho production.</p>
</li>
<li>
<p><code>fk-service-hs_master</code> thÆ° má»¥c chá»©a source code láº¥y tá»« github vá».</p>
</li>
<li>
<p><code>current</code> lÃ  symbol link tá»›i <code>releases/20200104193548</code> Ä‘Ã¢y cÅ©ng chÃ­nh lÃ  code cháº¡y production. <code>current = fk-service-hs_master + override-latest/* </code>.</p>
</li>
<li>
<p>VÃ­ dá»¥ ta cáº§n dÃ¹ng má»™t táº­p thÃ´ng tin khÃ¡c cho Pusher trÃªn production, ta sáº½ override láº¡i toÃ n bá»™ táº­p tin <code>application.yml</code>, tÆ°Æ¡ng tá»± vá»›i cÃ¡c táº­p tin <code>yaml</code> khÃ¡c.</p>
</li>
<li>
<p>Cuá»‘i cÃ¹ng chá»‰ cáº§n sync <code>current</code>, <code>releases/20200104193548</code> tá»›i cÃ¡c node production lÃ  xong.</p>
</li>
<li>
<p>Ã tÆ°á»Ÿng lÃ  cá»§a <a href="https://github.com/capistrano/capistrano">capistrano</a>.</p>
</li>
</ul>
<p>NhÆ° ta tháº¥y, thÃ´ng tin cáº¥u hÃ¬nh trÃªn production cÃ³ thá»ƒ lÆ°u trá»¯ á»Ÿ 3 nÆ¡i:</p>
<ul>
<li>TrÃªn node deployment, lÆ°u á»Ÿ <code>override-latest/config</code>. Má»—i láº§n cáº§n update gÃ¬ thÃ¬ ssh vÃ o node nÃ y cáº­p nháº­t.</li>
<li>HÆ¡i máº¥t cÃ´ng khi cáº§n update Ä‘á»u cáº§n ssh vÃ o server.</li>
<li>Chá»‰ lÆ°u trÃªn server production, nÃªn ai vÃ o production má»›i xem Ä‘Æ°á»£c nÃªn khÃ´ng nháº¥t thiáº¿t pháº£i mÃ£ hoÃ¡.</li>
<li>KhÃ´ng quáº£n lÃ½ Ä‘Æ°á»£c version, nhÆ°ng khÃ´ng cáº§n backup vÃ¬ lÆ°u trÃªn nhiá»u node.</li>
<li>LÆ°u á»Ÿ má»™t bÃªn thá»© 3 nhÆ° S3 bucket.
<ul>
<li>Khi deployment, náº¿u cáº§n cáº­p nháº­t thÃ´ng tin cáº¥u hÃ¬nh thÃ¬ cho phÃ©p tick Ä‘á»ƒ chá»n sync má»›i cáº¥u hÃ¬nh tá»« tá»« S3 bucket -&gt; <code>override-latest/config</code>. Node deployment pháº£i cÃ³ quyá»n access vÃ o S3 bucket.</li>
<li>Multi-version (tÃ­nh nÄƒng cá»§a S3) nhÆ°ng khÃ´ng cÃ³ commit log.</li>
<li>CÃ³ sáºµn mÃ£ hoÃ¡ tá»« KMS (tÃ­nh nÄƒng cá»§a S3).</li>
<li>CÃ³ thá»ƒ lÆ°u local + git sau Ä‘Ã³ sync qua <code>aws s3 sync</code> nhÆ°ng hÆ¡i máº¥t cÃ´ng vÃ¬ vá»«a pháº£i commit vá»«a sync. (<code>git add . &amp;&amp; git ci -m'Update pusher infos' &amp;&amp; aws s3 sync . s3://fk-service-hs/ --profile lazy-ops</code>).</li>
</ul>
</li>
<li>Cuá»‘i cÃ¹ng lÃ  lÆ°u tháº³ng vÃ o github, Ä‘Ã¢y lÃ  cÃ¡ch khoáº» nháº¥t.
<ul>
<li>Quáº£n lÃ½ Ä‘Æ°á»£c version, commit log, dá»… dÃ ng update tÆ°Æ¡ng tá»± code (commit, push, PR, review).</li>
<li>Native vá»›i deployment vÃ¬ chá»‰ cáº§n cáº¥p thÃªm quyá»n vÃ o má»™t repo khÃ¡c, dá»… dÃ ng sync má»›i vá» node deployment.</li>
<li>KhÃ´ng mÃ£ hoÃ¡ ğŸ¤¨ğŸ¤¨ğŸ¤¨. (má»i thá»© Ä‘á»u á»•n cho tá»›i chá»— nÃ y).</li>
</ul>
</li>
</ul>
<p>Vá»›i cÃ¡ch cuá»‘i, cÃ³ thá»ƒ dÃ¹ng má»™t secret_key (mÃ£ hoÃ¡ báº¥t Ä‘á»‘i xá»©ng) Ä‘á»ƒ mÃ£ hoÃ¡ vÃ  validate trÆ°á»›c khi push lÃªn github nhÆ°ng láº¡i máº¥t Ä‘i tÃ­nh nÄƒng quáº£n lÃ½ version (vim vÃ  git diff) nÃªn cÆ¡ báº£n cÅ©ng khÃ´ng xÃ i Ä‘Æ°á»£c.</p>
<p>Äáº¡i khÃ¡i báº¡n sáº½ muá»‘n quáº£n lÃ½ version cá»§a config nhÆ° váº§y:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- PUSHER_KEY: &#34;7381a978f7dd7f9a1117&#34;
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+ PUSHER_KEY: &#34;7381a9sjd7dd7f9a1117&#34;
</span><span style="color:#a6e22e"></span>  PUSHER_SECRET: &#34;abdc3b896a0ffb85d373&#34;
</code></pre></div><h3 id="2-what-next">2. What next?</h3>
<p>CÃ³ báº¡n sáº½ há»i sao khÃ´ng xÃ i <a href="https://www.vaultproject.io">Vault</a>? Vá» cÆ¡ báº£n cÅ©ng gáº·p cÃ¡c váº¥n Ä‘á» trÃªn, chá»‰ khÃ¡c lÃ  lÆ°u vÃ o file thÃ¬ giá» thÃªm con server ná»¯a, lÆ°u trá»¯ biáº¿n mÃ´i trÆ°á»ng dÃ¹ng cho cáº¥u hÃ¬nh trÃªn con server Vault. NhÃ  thÃ¬ bao viá»‡c, thÃªm con server ná»¯a, láº¡i pháº£i HA con server nÃ y, gáº¯n monitoring cÃ¡c kiá»ƒu, nghÄ© thÃ´i cÅ©ng Ä‘Ã£ háº¿t ngÃ y.</p>
<blockquote>
<p>TuÃ¢n theo má»™t method lÃ  <a href="https://12factor.net/config">12factor</a> ta coi nhÆ° viá»‡c dÃ¹ng <del><strong>biáº¿n mÃ´i trÆ°á»ng</strong></del> Ä‘á»ƒ lÆ°u config lÃ  <del><strong>chuyá»‡n hiá»ƒn nhiÃªn</strong> khÃ´ng cáº§n pháº£i giáº£i thÃ­ch</del>.</p>
</blockquote>
<p>CÃ³ ráº¥t <a href="https://github.com/thekompanee/chamber/wiki/Problems-with-Environment-Variables">nhiá»u váº¥n Ä‘á»</a> náº¿u sá»­ dá»¥ng <strong>biáº¿n mÃ´i trÆ°á»ng</strong> Ä‘á»ƒ quáº£n lÃ½ config vÃ  Ä‘áº·c biá»‡t náº¿u sá»­ dá»¥ng <code>dotenv</code>, lÆ°u trá»¯ trong má»™t táº­p tin plain text. VÃ­ dá»¥:</p>
<ul>
<li>
<p>Chá»‰ há»— trá»£ <code>string</code>, kiá»ƒu dá»¯ liá»‡u quÃ¡ Ä‘Æ¡n giáº£n cho cÃ¡c nhu cáº§u phá»©c táº¡p (cáº£ figaro vÃ  dotenv Ä‘á»u gáº·p váº¥n Ä‘á»).</p>
</li>
<li>
<p>Tá»• chá»©c config, chia sáº» config giá»¯a cÃ¡c namespace (<code>yaml</code> há»— trá»£ nÃªn figaro cÃ³ thá»ƒ tá»• chá»©c ra nhiá»u file, nhiá»u namespace, share giá»¯a cÃ¡c namespace, dotenv khÃ´ng há»— trá»£).</p>
</li>
<li>
<p>&hellip;</p>
</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/null-in-sql/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Null in SQL</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://taoquangne.com/post/change-schema-of-huge-table-in-mysql/">
                  <span class="button__text">Change schema of huge table in MySQL</span>
                  <span class="button__icon">â†’</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
