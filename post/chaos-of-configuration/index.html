<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Chaos of configuration ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="M·ªôt trong c√°c v·∫•n ƒë·ªÅ c∆° b·∫£n khi deployment v√† ƒë·∫£m b·∫£o security cho ·ª©ng d·ª•ng ƒë√≥ l√† l√†m sao ƒë·ªÉ qu·∫£n l√Ω config m·ªôt c√°ch ti·ªán l·ª£i, an to√†n, d·ªÖ c·∫≠p nh·∫≠t."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/chaos-of-configuration/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Chaos of configuration"/>
<meta name="twitter:description" content="M·ªôt trong c√°c v·∫•n ƒë·ªÅ c∆° b·∫£n khi deployment v√† ƒë·∫£m b·∫£o security cho ·ª©ng d·ª•ng ƒë√≥ l√† l√†m sao ƒë·ªÉ qu·∫£n l√Ω config m·ªôt c√°ch ti·ªán l·ª£i, an to√†n, d·ªÖ c·∫≠p nh·∫≠t."/>



<meta property="og:title" content="Chaos of configuration" />
<meta property="og:description" content="M·ªôt trong c√°c v·∫•n ƒë·ªÅ c∆° b·∫£n khi deployment v√† ƒë·∫£m b·∫£o security cho ·ª©ng d·ª•ng ƒë√≥ l√† l√†m sao ƒë·ªÉ qu·∫£n l√Ω config m·ªôt c√°ch ti·ªán l·ª£i, an to√†n, d·ªÖ c·∫≠p nh·∫≠t." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/chaos-of-configuration/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-01-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-06T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Chaos of configuration</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-01-06
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/rails/">#rails</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/configuration/">#configuration</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/deployment/">#deployment</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>M·ªôt trong c√°c v·∫•n ƒë·ªÅ c∆° b·∫£n khi deployment v√† ƒë·∫£m b·∫£o security cho ·ª©ng d·ª•ng ƒë√≥ l√† l√†m sao ƒë·ªÉ qu·∫£n l√Ω config m·ªôt c√°ch ti·ªán l·ª£i, an to√†n, d·ªÖ c·∫≠p nh·∫≠t.</p>
<p>Tu√¢n theo m·ªôt method l√† <a href="https://12factor.net/config">12factor</a> ta coi nh∆∞ vi·ªác d√πng <strong>bi·∫øn m√¥i tr∆∞·ªùng</strong> ƒë·ªÉ l∆∞u config l√† <strong>chuy·ªán hi·ªÉn nhi√™n</strong> kh√¥ng c·∫ßn ph·∫£i gi·∫£i th√≠ch.</p>
<h3 id="1-what-the-fuck-are-u-doing-now">1. What the fuck are u doing now?</h3>
<p>L·∫•y v√≠ d·ª• l√† ·ª©ng d·ª•ng Rails, c√°ch qu·∫£n l√Ω config hi·ªán t·∫°i ƒë∆∞·ª£c m√¥ t·∫£ nh∆∞ sau:</p>
<p>S·ª≠ d·ª•ng gem <a href="https://github.com/laserlemon/figaro">Figaro</a> ƒë·ªÉ qu·∫£n l√Ω config: V√≠ d·ª• khi s·ª≠ d·ª•ng Pusher (m·ªôt 3rd service ƒë·ªÉ push notification in-app v·ªÅ cho mobile) nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># config/application.yml</span>
<span style="color:#f92672">defaults</span>: <span style="color:#75715e">&amp;defaults</span>
  <span style="color:#f92672">PUSHER_APP_ID</span>: <span style="color:#e6db74">&#34;2954&#34;</span>
  <span style="color:#f92672">PUSHER_KEY</span>: <span style="color:#e6db74">&#34;7381a978f7dd7f9a1117&#34;</span>
  <span style="color:#f92672">PUSHER_SECRET</span>: <span style="color:#e6db74">&#34;abdc3b896a0ffb85d373&#34;</span>
  <span style="color:#f92672">PUSHER_CLUSTER</span>: <span style="color:#e6db74">&#34;mt1&#34;</span>

<span style="color:#f92672">development</span>:
  <span style="color:#f92672">&lt;</span>: <span style="color:#75715e">*defaults</span>

<span style="color:#f92672">production</span>:
  <span style="color:#f92672">&lt;</span>: <span style="color:#75715e">*defaults</span>
  <span style="color:#f92672">PUSHER_APP_ID</span>: <span style="color:#e6db74">&#34;1234&#34;</span>
  <span style="color:#f92672">PUSHER_KEY</span>: <span style="color:#e6db74">&#34;7381a978f7dd7f9a1117&#34;</span>
  <span style="color:#f92672">PUSHER_SECRET</span>: <span style="color:#e6db74">&#34;abdc3b896a0ffb85d373&#34;</span>
  <span style="color:#f92672">PUSHER_CLUSTER</span>: <span style="color:#e6db74">&#34;mt1&#34;</span>
</code></pre></div><p>Config pusher trong initializer nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rubY" data-lang="rubY"><span style="color:#75715e"># initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>app_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_APP_ID&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>key <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_KEY&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_SECRET&#39;</span><span style="color:#f92672">]</span>
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>cluster <span style="color:#f92672">=</span> <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#39;PUSHER_CLUSTER&#39;</span><span style="color:#f92672">]</span>
</code></pre></div><p>Ta s·∫Ω l∆∞u th√¥ng tin c·∫•u h√¨nh l√† m·ªôt c·∫∑p key/value v√†o m·ªôt t·∫≠p tin <code>yaml</code> v√† load c·∫•u h√¨nh th√¥ng qua initializers. M·ªôt initializer ƒë∆°n gi·∫£n l√† m·ªôt t·∫≠p tin Ruby ƒë∆∞·ª£c ƒë·∫∑t t·∫°i <code>config/initializers</code>. Initializers th∆∞·ªùng ƒë∆∞·ª£c d√πng ƒë·ªÉ <strong>l∆∞u c·∫•u h√¨nh m√† mu·ªën load sau c√πng</strong>, khi framework v√† t·∫•t c·∫£ c√°c gem (th∆∞ vi·ªán trong ruby) ƒë∆∞·ª£c load.</p>
<p>V·ªÅ c∆° b·∫£n, v·∫≠y l√† xong. Tuy nhi√™n n·∫øu ta mu·ªën r√†ng bu·ªôc ch·∫∑t ch·∫Ω h∆°n, y√™u c·∫ßu l√† c√°c th√¥ng tin c·∫•u h√¨nh b·∫Øt bu·ªôc ph·∫£i t·ªìn t·∫°i, n·∫øu thi·∫øu s·∫Ω kh√¥ng cho kh·ªüi t·∫°o ·ª©ng d·ª•ng. Figaro h·ªó tr·ª£ 2 ph∆∞∆°ng th·ª©c l√† proactively v√† lazily.</p>
<p>Proactively nghƒ©a l√† ·ª©ng d·ª•ng s·∫Ω raise m·ªôt exception n·∫øu c√≥ b·∫•t c·ª© gi√° tr·ªã config n√†o r√†ng bu·ªôc nh∆∞ng kh√¥ng ƒë∆∞·ª£c thi·∫øt l·∫≠p <strong>ngay khi ·ª©ng d·ª•ng kh·ªüi t·∫°o</strong> (initialization).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/initializers/figaro.rb</span>

<span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>require_keys(<span style="color:#e6db74">&#34;PUSHER_APP_ID&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_KEY&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_SECRET&#34;</span>, <span style="color:#e6db74">&#34;PUSHER_CLUSTER&#34;</span>)
</code></pre></div><p>Trong khi lazily kh√¥ng raise exception khi kh·ªüi t·∫°o, n√™n d·∫´n t·ªõi c√°c l·ªói kh√¥ng mong ƒë·ª£i trong runtime (khi n√†o c·∫ßn d√πng m·ªõi ki·ªÉm tra v√† n·∫øu thi·∫øu s·∫Ω raise exception).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># config/initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>app_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_APP_ID!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>key    <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_KEY!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_SECRET!
<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>cluster <span style="color:#f92672">=</span> <span style="color:#66d9ef">Figaro</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>PUSHER_CLUSTER!
</code></pre></div><p>Ngo√†i Figaro, c√≥ m·ªôt s·ªë gem kh√°c t∆∞∆°ng t·ª±, v√≠ d·ª• <a href="https://github.com/bkeepers/dotenv">dotenv</a>. V·ªÅ c∆° b·∫£n, c√°ch ti·∫øp c·∫≠n gi·ªØa Figaro v√† <a href="https://github.com/bkeepers/dotenv">dotenv</a> l√† nh∆∞ nhau, c√πng ƒë∆∞·ª£c ph√°t tri·ªÉn t·∫°i m·ªôt th·ªùi ƒëi·ªÉm v√† gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ t∆∞∆°ng t·ª± nhau:</p>
<p><strong>T∆∞∆°ng ƒë·ªìng:</strong></p>
<ul>
<li>H·ªó tr·ª£ t·ªët cho c√°c ·ª©ng d·ª•ng Ruby.</li>
<li>Ph·ªï bi·∫øn v√† v·∫´n c√≤n ƒë∆∞·ª£c b·∫£o tr√¨ code t·ªët.</li>
<li>ƒê·ªÅu l·∫•y c·∫£m h·ª©ng t·ª´ concept Twelve-Factor App.</li>
<li>ƒê·ªÅu l∆∞u gi√° tr·ªã config trong bi·∫øn m√¥i tr∆∞·ªùng <code>ENV</code>.</li>
</ul>
<p><strong>Kh√°c bi·ªát:</strong></p>
<ul>
<li>T·∫≠p tin config:
<ul>
<li>Figaro l∆∞u t·∫•t c·∫£ c√°c bi·∫øn config c·ªßa c√°c m√¥i tr∆∞·ªùng trong c√πng m·ªôt t·∫≠p tin.</li>
<li>Dotenv h·ªó tr·ª£ t√°ch bi·∫øn config c·ªßa c√°c m√¥i tr∆∞·ªùng ra c√°c t·∫≠p tin ri√™ng bi·ªát (<code>.env.local</code>, <code>.env.development</code>, <code>.env</code>).</li>
</ul>
</li>
<li>ƒê·ªãnh d·∫°ng t·∫≠p tin c·∫•u h√¨nh
<ul>
<li>Figaro s·ª≠ d·ª•ng <code>yaml</code> v·ªõi m·ªôt c·∫∑p key/value.</li>
<li>Dotenv l√† m·ªôt t·∫≠p h·ª£p c√°c gi√° tr·ªã <code>KEY=VALUE</code>.</li>
</ul>
</li>
<li>Security vs. Convenience
<ul>
<li>Figaro quy ∆∞·ªõc l√† kh√¥ng bao gi·ªù commit t·∫≠p tin c·∫•u h√¨nh.</li>
<li>Dotenv khuy·∫øn kh√≠ch commit c·∫•u h√¨nh c·ªßa m√¥i tr∆∞·ªùng development.</li>
</ul>
</li>
<li>Framework Focus
<ul>
<li>Figaro t·∫≠p trung v√†o ·ª©ng d·ª•ng Rails.</li>
<li>Dotenv c√≥ th·ªÉ s·ª≠ d·ª•ng cho c√°c ·ª©ng d·ª•ng Ruby.</li>
</ul>
</li>
</ul>
<p>Vi·∫øt d√†i d√†i cho vui ch·ª© th·ª±c ra kh√¥ng c√≥ nhi·ªÅu s·ª± kh√°c bi·ªát l·∫Øm gi·ªØa hai th∆∞ vi·ªán n√†y, <strong>d√πng c√°i n√†o c≈©ng ƒë∆∞·ª£c.</strong></p>
<p>L∆∞u v√† t·∫£i config khi ·ª©ng d·ª•ng kh·ªüi t·∫°o th√¨ nh∆∞ v·∫≠y, nh∆∞ng qu·∫£n l√Ω c·∫•u h√¨nh v√† deployment th√¨ c·∫ßn th√™m <strong>c√°c y√™u c·∫ßu</strong> nh∆∞ sau:</p>
<ul>
<li>Gi√° tr·ªã c·∫•u h√¨nh tr√™n m√¥i tr∆∞·ªùng <code>production</code> <strong>KH√îNG</strong> chia s·∫ª cho developer.</li>
<li>Gi√° tr·ªã c·∫•u h√¨nh ph·∫£i kh√°c bi·ªát gi·ªØa c√°c m√¥i tr∆∞·ªùng, v√≠ d·ª• <code>PUSHER_SECRET_KEY</code> ph·∫£i kh√°c bi·ªát gi·ªØa development v√† production. B·∫£o v·ªá key c·ªßa m√¥i tr∆∞·ªùng production an to√†n nh·∫•t c√≥ th·ªÉ. Cho ph√©p apply c√°c rule kh√°c nhau l√™n t·ª´ng c·∫•u h√¨nh (v√≠ d·ª• key c·ªßa development ch·ªâ d√πng ƒë·ªÉ test n√™n limit notification &hellip;).</li>
<li>C·∫ßn c√≥ m·ªôt c√°ch ti·ªán l·ª£i ƒë·ªÉ chia s·∫ª t·∫≠p tin c·∫•u h√¨nh ·ªü development khi c√≥ m·ªôt ng∆∞·ªùi m·ªõi join team nh∆∞ng kh√¥ng ƒë∆∞·ª£c commit v√†o git.</li>
<li>C·∫ßn c√≥ m·ªôt c√°ch ƒë·ªÉ qu·∫£n l√Ω version c·ªßa c·∫•u h√¨nh tr√™n production. D·ªÖ d√†ng th√™m m·ªõi, delivery l√™n production.</li>
</ul>
<p><strong>Nguy√™n t·∫Øc s·ªë 1:</strong>  Qu·∫£n l√Ω t·∫•t c·∫£ c·∫•u h√¨nh qua bi·∫øn m√¥i tr∆∞·ªùng (<code>ENV</code>), th√¥ng qua th∆∞ vi·ªán, kh√¥ng <strong>hard-code</strong> b·∫•t c·ª© ch·ªó n√†o trong ·ª©ng d·ª•ng. Nghƒ©a l√† kh√¥ng ch∆°i nh∆∞ v·∫ßy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># initializers/pusher.rb</span>

<span style="color:#66d9ef">Pusher</span><span style="color:#f92672">.</span>secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bX5kuRUuVJlP1AD&#34;</span>
</code></pre></div><p><strong>Nguy√™n t·∫Øc s·ªë 2:</strong> Kh√¥ng commit b·∫•t k·ª≥ t·∫≠p tin c·∫•u h√¨nh n√†o v√†o git, kh√¥ng l∆∞u tr·ªØ c√°c credentials info v√†o git. Nghƒ©a l√† kh√¥ng ƒë∆∞·ª£c t·ªìn t·∫°i c√°c t·∫≠p tin nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree config/
‚îú‚îÄ‚îÄ config
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ application.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ database.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ mongoid.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ newrelic.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ redis.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ secrets.yml
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sidekiq.yml
</code></pre></div><p><strong>Nguy√™n t·∫Øc s·ªë 3:</strong>  ƒê·ªÉ ƒë·∫£m b·∫£o consistensy c·ªßa gi√° tr·ªã c·∫•u h√¨nh gi·ªØa c√°c m√¥i tr∆∞·ªùng (c√≥ ·ªü production m√† thi·∫øu ·ªü development) v√† ƒë·ªÉ d·ªÖ d√†ng cho developer m·ªõi khi tham gia d·ª± √°n, commit v√†o git m·ªôt t·∫≠p tin example c·ªßa t·ª´ng t·∫≠p tin c·∫•u h√¨nh. V√≠ d·ª•:</p>
<pre tabindex="0"><code>&gt; tree config/
‚îú‚îÄ‚îÄ config
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ application.example.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ database.example.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ mongoid.example.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ newrelic.example.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ redis.example.yml
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ secrets.example.yml
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sidekiq.example.yml
</code></pre><p>L∆∞u √Ω:</p>
<ul>
<li>Gi·ªØ nguy√™n extention l√† <code>yaml</code> ƒë·ªÉ s·ª≠ d·ª•ng highlight syntax c·ªßa editor (kh√¥ng n√™n d√πng <code>application.yml.example</code>).</li>
<li>Khi c·∫ßn s·ª≠ d·ª•ng th√™m m·ªôt bi·∫øn m√¥i tr∆∞·ªùng m·ªõi N√äN th√™m v√†o file example v√† commit l√™n git, tr√™n production c≈©ng tra c·ª©u ng∆∞·ª£c v√†o t·∫≠p tin example ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng thi·∫øu/d∆∞ th·ª´a b·∫•t k·ª≥ gi√° tr·ªã n√†o.</li>
</ul>
<p>=&gt; Tuy nhi√™n t·∫≠p tin example ch·ªâ gi·∫£i quy·∫øt ƒë∆∞·ª£c c√°c credentials info m√† developer c√≥ th·ªÉ t·ª± t·∫°o (nh∆∞ database, redis &hellip;) ch·ª© credentials info t·ª´ 3rd service th√¨ v·∫´n c·∫ßn ph·∫£i chia s·∫ª th·ªß c√¥ng (ng∆∞·ªùi c≈© g·ª≠i cho ng∆∞·ªùi m·ªõi).</p>
<p><strong>Nguy√™n t·∫Øc s·ªë 4:</strong> Qu·∫£n l√Ω credentials ƒë·ªôc l·∫≠p cho t·ª´ng m√¥i tr∆∞·ªùng &lt;=&gt; pick c√°c service cho ph√©p generate, ph√¢n quy·ªÅn v√† gi·ªõi h·∫°n ƒë·ªôc l·∫≠p tr√™n t·ª´ng credential. V√≠ d·ª•:</p>
<ul>
<li>T·∫°o th√¥ng tin pusher cho c√πng m·ªôt ·ª©ng d·ª•ng nh∆∞ng 2 m√¥i tr∆∞·ªùng development (coding + debug) v√† production.</li>
<li>Gi·ªõi h·∫°n s·ªë push notification cho m√¥i tr∆∞·ªùng development (v√¨ debug kh√¥ng c·∫ßn nhi·ªÅu, tr√°nh bug/l·ªô secret_key d·∫´n t·ªõi t·ªën chi ph√≠).</li>
<li>Cho ph√©p truy c·∫≠p web admin c·ªßa development key, h·ªó tr·ª£ debugging.</li>
</ul>
<p>T√°ch ƒë·ªôc l·∫≠p cho t·ª´ng m√¥i tr∆∞·ªùng, t·ª´ng ·ª©ng d·ª•ng gi√∫p d·ªÖ d√†ng revoker khi th√¥ng tin b·ªã l·ªô ra ngo√†i, ho·∫∑c n·∫øu l·ªô, gi·∫£m thi·ªÉu ·∫£nh h∆∞·ªüng chung ƒë·∫øn to√†n b·ªô ·ª©ng d·ª•ng.</p>
<p>C≈©ng c·∫ßn l∆∞u √Ω l√† m·ªôt s·ªë d·ªãch v·ª• nh∆∞ IAM AWS, secret_key ch·ªâ hi·ªán th·ªã ƒë√∫ng m·ªôt l·∫ßn l√∫c t·∫°o, sau n√†y s·∫Ω kh√¥ng th·ªÉ xem l·∫°i ƒë∆∞·ª£c n·ªØa, n√™n n·∫øu qu√™n secret_key th√¨ ch·ªâ c√≥ c√°ch t·∫°o secret_key kh√°c.</p>
<p><strong>V·∫•n ƒë·ªÅ l√† l∆∞u th√¥ng tin c·∫•u h√¨nh tr√™n production ·ªü ƒë√¢u ƒë·ªÉ:</strong></p>
<ul>
<li>L·ª° tay xo√° m·∫•t ho·∫∑c server c√≥ s·ª± c·ªë m·∫•t th√¥ng tin c·∫•u h√¨nh.</li>
<li>D·ªÖ d√†ng sync khi deployment.</li>
<li>C√≥ m√£ ho√° nh∆∞ng ph·∫£i qu·∫£n l√Ω ƒë∆∞·ª£c version t∆∞∆°ng t·ª± nh∆∞ qu·∫£n l√Ω code v·ªõi git.</li>
</ul>
<p>V√≠ d·ª• v·ªÅ m·ªôt <strong>quy tr√¨nh deployment</strong> th·ªß c√¥ng nh∆∞ sau:</p>
<ul>
<li>
<p>C·∫•u tr√∫c th∆∞ m·ª•c c·ªßa node deployment nh∆∞ sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree /fk
/fk
‚îî‚îÄ‚îÄ predeploy
    ‚îî‚îÄ‚îÄ fk-service-hs
        ‚îú‚îÄ‚îÄ current -&gt; releases/20200104193548
        ‚îú‚îÄ‚îÄ fk-service-hs_master <span style="color:#75715e"># git-repo_branch</span>
        ‚îú‚îÄ‚îÄ override-latest/config
        ‚îî‚îÄ‚îÄ releases/20200104193548
</code></pre></div></li>
<li>
<p>V·ªõi predeploy l√† n∆°i code s·∫Ω ƒë∆∞·ª£c chu·∫©n b·ªã ƒë·ªÉ deployment.</p>
</li>
<li>
<p><code>override-latest/config</code> l√† th√¥ng tin c·∫•u h√¨nh c·ªßa production, l∆∞u tr·ªØ c√°c t·∫≠p tin c·∫ßn <em>ch√©p ƒë√®</em> s·ª≠ d·ª•ng cho production.</p>
</li>
<li>
<p><code>fk-service-hs_master</code> th∆∞ m·ª•c ch·ª©a source code l·∫•y t·ª´ github v·ªÅ.</p>
</li>
<li>
<p><code>current</code> l√† symbol link t·ªõi <code>releases/20200104193548</code> ƒë√¢y c≈©ng ch√≠nh l√† code ch·∫°y production. <code>current = fk-service-hs_master + override-latest/* </code>.</p>
</li>
<li>
<p>V√≠ d·ª• ta c·∫ßn d√πng m·ªôt t·∫≠p th√¥ng tin kh√°c cho Pusher tr√™n production, ta s·∫Ω override l·∫°i to√†n b·ªô t·∫≠p tin <code>application.yml</code>, t∆∞∆°ng t·ª± v·ªõi c√°c t·∫≠p tin <code>yaml</code> kh√°c.</p>
</li>
<li>
<p>Cu·ªëi c√πng ch·ªâ c·∫ßn sync <code>current</code>, <code>releases/20200104193548</code> t·ªõi c√°c node production l√† xong.</p>
</li>
<li>
<p>√ù t∆∞·ªüng l√† c·ªßa <a href="https://github.com/capistrano/capistrano">capistrano</a>.</p>
</li>
</ul>
<p>Nh∆∞ ta th·∫•y, th√¥ng tin c·∫•u h√¨nh tr√™n production c√≥ th·ªÉ l∆∞u tr·ªØ ·ªü 3 n∆°i:</p>
<ul>
<li>Tr√™n node deployment, l∆∞u ·ªü <code>override-latest/config</code>. M·ªói l·∫ßn c·∫ßn update g√¨ th√¨ ssh v√†o node n√†y c·∫≠p nh·∫≠t.</li>
<li>H∆°i m·∫•t c√¥ng khi c·∫ßn update ƒë·ªÅu c·∫ßn ssh v√†o server.</li>
<li>Ch·ªâ l∆∞u tr√™n server production, n√™n ai v√†o production m·ªõi xem ƒë∆∞·ª£c n√™n kh√¥ng nh·∫•t thi·∫øt ph·∫£i m√£ ho√°.</li>
<li>Kh√¥ng qu·∫£n l√Ω ƒë∆∞·ª£c version, nh∆∞ng kh√¥ng c·∫ßn backup v√¨ l∆∞u tr√™n nhi·ªÅu node.</li>
<li>L∆∞u ·ªü m·ªôt b√™n th·ª© 3 nh∆∞ S3 bucket.
<ul>
<li>Khi deployment, n·∫øu c·∫ßn c·∫≠p nh·∫≠t th√¥ng tin c·∫•u h√¨nh th√¨ cho ph√©p tick ƒë·ªÉ ch·ªçn sync m·ªõi c·∫•u h√¨nh t·ª´ t·ª´ S3 bucket -&gt; <code>override-latest/config</code>. Node deployment ph·∫£i c√≥ quy·ªÅn access v√†o S3 bucket.</li>
<li>Multi-version (t√≠nh nƒÉng c·ªßa S3) nh∆∞ng kh√¥ng c√≥ commit log.</li>
<li>C√≥ s·∫µn m√£ ho√° t·ª´ KMS (t√≠nh nƒÉng c·ªßa S3).</li>
<li>C√≥ th·ªÉ l∆∞u local + git sau ƒë√≥ sync qua <code>aws s3 sync</code> nh∆∞ng h∆°i m·∫•t c√¥ng v√¨ v·ª´a ph·∫£i commit v·ª´a sync. (<code>git add . &amp;&amp; git ci -m'Update pusher infos' &amp;&amp; aws s3 sync . s3://fk-service-hs/ --profile lazy-ops</code>).</li>
</ul>
</li>
<li>Cu·ªëi c√πng l√† l∆∞u th·∫≥ng v√†o github, ƒë√¢y l√† c√°ch kho·∫ª nh·∫•t.
<ul>
<li>Qu·∫£n l√Ω ƒë∆∞·ª£c version, commit log, d·ªÖ d√†ng update t∆∞∆°ng t·ª± code (commit, push, PR, review).</li>
<li>Native v·ªõi deployment v√¨ ch·ªâ c·∫ßn c·∫•p th√™m quy·ªÅn v√†o m·ªôt repo kh√°c, d·ªÖ d√†ng sync m·ªõi v·ªÅ node deployment.</li>
<li>Kh√¥ng m√£ ho√° ü§®ü§®ü§®. (m·ªçi th·ª© ƒë·ªÅu ·ªïn cho t·ªõi ch·ªó n√†y).</li>
</ul>
</li>
</ul>
<p>V·ªõi c√°ch cu·ªëi, c√≥ th·ªÉ d√πng m·ªôt secret_key (m√£ ho√° b·∫•t ƒë·ªëi x·ª©ng) ƒë·ªÉ m√£ ho√° v√† validate tr∆∞·ªõc khi push l√™n github nh∆∞ng l·∫°i m·∫•t ƒëi t√≠nh nƒÉng qu·∫£n l√Ω version (vim v√† git diff) n√™n c∆° b·∫£n c≈©ng kh√¥ng x√†i ƒë∆∞·ª£c.</p>
<p>ƒê·∫°i kh√°i b·∫°n s·∫Ω mu·ªën qu·∫£n l√Ω version c·ªßa config nh∆∞ v·∫ßy:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-diff" data-lang="diff"><span style="color:#f92672">- PUSHER_KEY: &#34;7381a978f7dd7f9a1117&#34;
</span><span style="color:#f92672"></span><span style="color:#a6e22e">+ PUSHER_KEY: &#34;7381a9sjd7dd7f9a1117&#34;
</span><span style="color:#a6e22e"></span>  PUSHER_SECRET: &#34;abdc3b896a0ffb85d373&#34;
</code></pre></div><h3 id="2-what-next">2. What next?</h3>
<p>C√≥ b·∫°n s·∫Ω h·ªèi sao kh√¥ng x√†i <a href="https://www.vaultproject.io">Vault</a>? V·ªÅ c∆° b·∫£n c≈©ng g·∫∑p c√°c v·∫•n ƒë·ªÅ tr√™n, ch·ªâ kh√°c l√† l∆∞u v√†o file th√¨ gi·ªù th√™m con server n·ªØa, l∆∞u tr·ªØ bi·∫øn m√¥i tr∆∞·ªùng d√πng cho c·∫•u h√¨nh tr√™n con server Vault. Nh√† th√¨ bao vi·ªác, th√™m con server n·ªØa, l·∫°i ph·∫£i HA con server n√†y, g·∫Øn monitoring c√°c ki·ªÉu, nghƒ© th√¥i c≈©ng ƒë√£ h·∫øt ng√†y.</p>
<blockquote>
<p>Tu√¢n theo m·ªôt method l√† <a href="https://12factor.net/config">12factor</a> ta coi nh∆∞ vi·ªác d√πng <del><strong>bi·∫øn m√¥i tr∆∞·ªùng</strong></del> ƒë·ªÉ l∆∞u config l√† <del><strong>chuy·ªán hi·ªÉn nhi√™n</strong> kh√¥ng c·∫ßn ph·∫£i gi·∫£i th√≠ch</del>.</p>
</blockquote>
<p>C√≥ r·∫•t <a href="https://github.com/thekompanee/chamber/wiki/Problems-with-Environment-Variables">nhi·ªÅu v·∫•n ƒë·ªÅ</a> n·∫øu s·ª≠ d·ª•ng <strong>bi·∫øn m√¥i tr∆∞·ªùng</strong> ƒë·ªÉ qu·∫£n l√Ω config v√† ƒë·∫∑c bi·ªát n·∫øu s·ª≠ d·ª•ng <code>dotenv</code>, l∆∞u tr·ªØ trong m·ªôt t·∫≠p tin plain text. V√≠ d·ª•:</p>
<ul>
<li>
<p>Ch·ªâ h·ªó tr·ª£ <code>string</code>, ki·ªÉu d·ªØ li·ªáu qu√° ƒë∆°n gi·∫£n cho c√°c nhu c·∫ßu ph·ª©c t·∫°p (c·∫£ figaro v√† dotenv ƒë·ªÅu g·∫∑p v·∫•n ƒë·ªÅ).</p>
</li>
<li>
<p>T·ªï ch·ª©c config, chia s·∫ª config gi·ªØa c√°c namespace (<code>yaml</code> h·ªó tr·ª£ n√™n figaro c√≥ th·ªÉ t·ªï ch·ª©c ra nhi·ªÅu file, nhi·ªÅu namespace, share gi·ªØa c√°c namespace, dotenv kh√¥ng h·ªó tr·ª£).</p>
</li>
<li>
<p>&hellip;</p>
</li>
</ul>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/null-in-sql/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Null in SQL</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://taoquangne.com/post/change-schema-of-huge-table-in-mysql/">
                  <span class="button__text">Change schema of huge table in MySQL</span>
                  <span class="button__icon">‚Üí</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> h√†ng nh√† tr·ªìng üå¥ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">gi·∫•y ph√©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
