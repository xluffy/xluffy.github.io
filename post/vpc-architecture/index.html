<!doctype html><html lang=en><head><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-K62WF7M4")</script><title>VPC architecture ::
/home/xluffy
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://taoquangne.com/post/vpc-architecture/><link rel=stylesheet href=https://taoquangne.com/assets/style.css><link rel=stylesheet href=https://taoquangne.com/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://taoquangne.com/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://taoquangne.com/img/favicon.png><link href=https://taoquangne.com/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="VPC architecture"><meta property="og:url" content="https://taoquangne.com/post/vpc-architecture/"><meta property="og:site_name" content="/home/xluffy"><meta property="og:title" content="VPC architecture"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2019-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2019-03-11T00:00:00+00:00"><meta property="article:tag" content="Aws"><meta property="article:tag" content="Vpc"><meta property="article:tag" content="Network"><meta property="article:tag" content="Architecture"></head><body class=dark-theme><div class=container><header class=header><span class=header__inner><a href=/ class=logo style=text-decoration:none><span class=logo__mark><svg class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span><span class=logo__text>/home/xluffy ft ğŸ„</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>about</a></li><li><a href=/tags>tags</a></li><li><a href=https://github.com/xluffy/til/issues>til</a></li><li><a href=/weekly-summary>weekly-summary</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>VPC architecture</h1><div class=post-meta><span class=post-date>2019-03-11</span></div><span class=post-tags><a href=https://taoquangne.com/tags/aws/>#aws</a>&nbsp;
<a href=https://taoquangne.com/tags/vpc/>#vpc</a>&nbsp;
<a href=https://taoquangne.com/tags/network/>#network</a>&nbsp;
<a href=https://taoquangne.com/tags/architecture/>#architecture</a>&nbsp;</span><div class=post-content><p>Thiáº¿t káº¿ nÃ y Ä‘áº·t toÃ n bá»™ há»‡ thá»‘ng trong má»™t region vÃ  khÃ´ng cÃ³ má»™t káº¿t ná»‘i cross-region nÃ o. Sáº½ cÃ³ 2 VPC Ä‘Ã³ lÃ :</p><ul><li>Production VPC</li><li>Management VPC</li></ul><p><img src=https://raw.githubusercontent.com/xluffy/assets/master/VPC_architecture.jpg alt=VPC_architecture></p><p>ChÃºng Ä‘Æ°á»£c káº¿t ná»‘i vá»›i nhau thÃ´ng qua VPC Peering. VÃ  lá»›p máº¡ng Ä‘Æ°á»£c chá»n lá»±a Ä‘á»ƒ trÃ¡nh Ä‘á»¥ng Ä‘á»™ vá»›i cÃ¡c lá»›p máº¡ng á»Ÿ VPC khÃ¡c (khi cÃ³ nhu cáº§u peering giá»¯a cÃ¡c region, AWS Ä‘Ã£ há»— trá»£ peering giá»¯a cÃ¡c region, trÆ°á»›c Ä‘Ã¢y pháº£i táº¡o káº¿t ná»‘i VPN, tham kháº£o thÃªm vá» <a href=https://www.cloudping.co>AWS Inter-Region Latency</a>) hoáº·c Ä‘á»¥ng Ä‘á»™ vá»›i cÃ¡c lá»›p máº¡ng ná»™i bá»™ á»Ÿ cty.</p><p>Vá»›i region us-east-1 cÃ³ tá»•ng cá»™ng 6 availability zone lÃ  <code>us-east-1a</code> ,<code>us-east-1b</code>, <code>us-east-1c</code>, <code>us-east-1d</code>, <code>us-east-1e</code>, <code>us-east-1f</code>. Ta cÃ³ thá»ƒ sá»­ dá»¥ng cáº£ 6 zone hoáº·c sá»­ dá»¥ng 3 zone Ä‘á»ƒ Ä‘áº£m báº£o váº¥n Ä‘á» rá»§i ro khi háº¡ táº§ng táº¡i má»™t DC bá»‹ hÆ° há»ng (má»—i availability zone cÃ³ Ä‘á»‹a chá»‰ váº­t lÃ½ khÃ¡c nhau nhÆ°ng cÃ³ thá»ƒ chung má»™t bang, tá»‰nh, thÃ nh phá»‘).</p><p>VÃ­ dá»¥ á»Ÿ Ä‘Ã¢y ta chá»n lá»›p máº¡ng 10.20.0.0/16 cho VPC production, chia lÃ m tá»•ng cá»™ng 9 subnet (má»—i 3 subnet sáº½ náº±m á»Ÿ má»™t availability zone), vá»›i:</p><ul><li>3 subnet public, vá»›i outboud traffic sáº½ Ä‘Æ°á»£c route thÃ´ng qua Intenet Gateway (IG). Táº¥t cáº£ cÃ¡c dá»‹ch vá»¥ trong lá»›p máº¡ng nÃ y Ä‘á»u lÃ  ELB hoáº·c EC2 cÃ³ Elastic IP hoáº·c má»™t NAT gateway.</li><li>6 subnet cÃ²n láº¡i lÃ  private subnet, muá»‘n Ä‘i ra internet buá»™c pháº£i <strong>Ä‘i thÃ´ng qua</strong> NAT gateway Ä‘Æ°á»£c Ä‘áº·t á»Ÿ public subnet vÃ  <strong>khÃ´ng cÃ³ káº¿t ná»‘i inbound trá»±c tiáº¿p</strong> vÃ o báº¥t kÃ¬ server, dá»‹ch vá»¥ nÃ o trong cÃ¡c subnet nÃ y.<ul><li>3 subnet Ä‘áº§u lÃ  private subnet dÃ nh cho cÃ¡c dá»‹ch vá»¥ táº§ng web (HTTP protocol, Websocket) vÃ­ dá»¥ nhÆ° web, api, worker, report â€¦ CÃ¡c dá»‹ch vá»¥ á»Ÿ táº§ng nÃ y váº«n cÃ³ nhu cáº§u káº¿t ná»‘i ra bÃªn ngoÃ i khi thanh toÃ¡n, chá»©ng thá»±c qua bÃªn thá»© 3 (facebook, google â€¦) hoáº·c gá»­i email.</li><li>3 subnet cÃ²n láº¡i lÃ  private subnet dÃ nh cho persistence store nhÆ°: database (RDBMS, NoSQL), cache cluster, queue cluster, search cluster, mail replay &mldr;</li></ul></li></ul><p>Vá» NAT gateway, ta cÃ³ thá»ƒ thiáº¿t káº¿ theo 2 trÆ°á»ng phÃ¡i:</p><ul><li>Chá»‰ sá»­ dá»¥ng má»™t NAT gateway cho táº¥t cáº£ cÃ¡c private subnet (báº£n thÃ¢n NAT gateway Ä‘Ã£ cÃ³ sáºµn tÃ­nh failover tÆ°Æ¡ng tá»± nhÆ° ELB).</li><li>Má»—i cáº·p subnet á»Ÿ má»—i AZ sáº½ cÃ³ má»™t NAT gateway riÃªng, ta cÃ³ 3 AZs thÃ¬ sáº½ cÃ³ 3 NAT gateway tÆ°Æ¡ng á»©ng.</li></ul><p>Æ¯u nhÆ°á»£c Ä‘iá»ƒm cá»§a 2 trÆ°á»ng phÃ¡i nÃ y dá»±a vÃ o cÃ¡ch tÃ­nh chi phÃ­ cá»§a AWS vá»›i NAT gateway:</p><ul><li>Chi phÃ­ dá»±a trÃªn giá» sá»­ dá»¥ng.</li><li>Chi phÃ­ dá»±a trÃªn data processing mÃ  NAT gateway xá»­ lÃ½.</li><li>Má»™t trÆ°á»ng há»£p Ä‘áº·c biá»‡t ná»¯a lÃ  náº¿u EC2 route ra internet mÃ  qua má»™t NAT gateway khÃ¡c AZ sáº½ bá»‹ tÃ­nh phÃ­.</li></ul><p>NÃªn náº¿u cÃ³ nhu cáº§u gá»­i traffic ra internet nhiá»u tá»« EC2 náº±m trong private subnet (via NAT gateway) thÃ¬ nÃªn sá»­ dá»¥ng nhiá»u NAT gateway tÆ°Æ¡ng á»©ng vá»›i tá»«ng AZ, cÃ²n náº¿u gá»­i Ã­t thÃ¬ cÃ³ nhiá»u NAT gateway quÃ¡ sáº½ tá»‘n kÃ©m cho chi phÃ­ giá» sá»­ dá»¥ng <a href=https://github.com/xluffy/til/issues/132>[1]</a>.</p><p>NgoÃ i ra, náº¿u EC2 giao tiáº¿p vá»›i cÃ¡c dá»‹ch vá»¥ cá»§a AWS nhiá»u (vÃ­ dá»¥ cÃ¡c tÃ­nh nÄƒng upload/download dá»¯ liá»‡u trÃªn S3) thÃ¬ cÃ³ thá»ƒ cÃ¢n nháº¯c sá»­ dá»¥ng VPC Endpoint. Báº£n thÃ¢n EC2 khi káº¿t ná»‘i tá»›i S3 sáº½ lÃ  má»™t káº¿t ná»‘i internet nhÆ° cÃ¡ch káº¿t ná»‘i tá»›i cÃ¡c dá»‹ch vá»¥ khÃ¡c bÃªn ngoÃ i há»‡ thá»‘ng AWS. Chuyá»‡n nÃ y vá»«a tÄƒng latency + chi phÃ­ vá» data transfer. Khi sá»­ dá»¥ng VPC endpoint thÃ¬ tá»« EC2 -> S3 sáº½ lÃ  káº¿t ná»‘i thÃ´ng qua private address (Ä‘i ná»™i bá»™) giÃºp giáº£m chi phÃ­ vÃ  giáº£m latency káº¿t ná»‘i.</p><p>Vá»›i VPC dÃ nh cho management sáº½ Ä‘áº·t cÃ¡c dá»‹ch vá»¥ dÃ¹ng cho quáº£n trá»‹ há»‡ thá»‘ng nhÆ° cÃ¡c há»‡ thá»‘ng CI/CD, monitoring, logging, bastion, VPN â€¦ ThÃ´ng qua káº¿t ná»‘i VPC peering, ta cÃ³ thá»ƒ route request tá»« VPC nÃ y tá»›i Production VPC. Ta cÅ©ng cÃ³ thá»ƒ tá»• chá»©c VPC management tÆ°Æ¡ng tá»± vá»›i 3 layer nhÆ° Production VPC náº¿u muá»‘n. Vá»›i VPC nÃ y, ta cÃ³ thá»ƒ cho phÃ©p DevOps engineer cÃ³ thá»ƒ káº¿t ná»‘i thÃ´ng qua VPN hoáº·c whitelist lÃ  static IP cá»§a cÃ´ng ty (nhÆ° má»™t jump box).</p><p><del>Má»—i layer sáº½ cÃ³ má»™t security group hoáº¡t Ä‘á»™ng nhÆ° má»™t network firewall Ä‘á»ƒ cho phÃ©p/cháº·n cÃ¡c káº¿t ná»‘i khÃ´ng cáº§n thiáº¿t.</del></p><p>Theo tÃ i liá»‡u cá»§a <a href=https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Security.html>AWS vá» Security trong VPC</a> thÃ¬:</p><ul><li>Security Group: hoáº¡t Ä‘á»™ng nhÆ° má»™t host-firewall gáº¯n vá»›i má»™t EC instance Ä‘á»ƒ control traffic In/Out táº¡i instance level.</li><li>Network ACL: hoáº¡t Ä‘á»™ng nhÆ° má»™t network-firewall, gáº¯n vá»›i subnets, controll traffic In/Out táº¡i subnet level.</li></ul><p>CÃ¡c mÃ¡y chá»§ náº±m trong Prod VPC chá»‰ cÃ³ thá»ƒ truy cáº­p SSH Ä‘Æ°á»£c tá»« management VPC (má»Ÿ port 22 tá»« VPC nÃ y) vÃ  ngÆ°á»i quáº£n trá»‹ buá»™c pháº£i truy cáº­p vÃ o management VPC trÆ°á»›c khi muá»‘n truy cáº­p vÃ o há»‡ thá»‘ng production (ssh hoáº·c quay VPN).</p><p>Trong Prod VPC:</p><ul><li>Public subnet chá»‰ má»Ÿ 80/443.</li><li>Private subnet dÃ nh cho web app, chá»‰ má»Ÿ port 80.</li><li>Private subnet persistence store chá»‰ má»Ÿ cÃ¡c port liÃªn quan vÃ­ dá»¥ MySQL - 3306/3307, ES - 9200/9300, Redis - 6371/6372, memcached - 11211/11212, MongoDB - 27017/30000, Postgres - 5432, Kafka/Zookeeper - 9092/2181.</li></ul><p>CÃ³ thá»ƒ thiáº¿t káº¿ cÃ¡c security group nhÆ° sau:</p><ul><li><code>sg_prod_&lt;project>_mgnt</code>: Gáº¯n vÃ o táº¥t cáº£ cÃ¡c EC2 instance bÃªn prod VPC, má»Ÿ port 22 tá»« mgnt VPC.</li><li><code>sg_prod_&lt;project>_lb</code>: Gáº¯n vÃ o cÃ¡c EC2 instance náº±m á»Ÿ táº§ng public, má»Ÿ port 80/443.</li><li><code>sg_prod_&lt;project>_app</code>: Gáº¯n vÃ o EC2 instance náº±m á»Ÿ táº§ng á»©ng dá»¥ng, subnet private, má»Ÿ port 80.</li><li><code>sg_prod_&lt;project>_data</code>: Gáº¯n vÃ o cÃ¡c EC2 instance náº±m á»Ÿ táº§ng data, persistence store subnet, má»Ÿ cÃ¡c port theo dá»‹ch vá»¥ nhÆ° á»Ÿ trÃªn.</li></ul><p>Vá»›i Network ACL sáº½ thiáº¿t káº¿ nhÆ° sau:</p><ul><li><code>nacl_prod_&lt;project>_public</code>: Cho phÃ©p nháº­n inbound traffic tá»« báº¥t ká»³ Ä‘Ã¢u.</li><li><code>nacl_prod_&lt;project>_app</code>: Chá»‰ nháº­n traffic inbound tá»« duy nháº¥t public subnet</li><li><code>nacl_prod_&lt;project>_data</code>: Chá»‰ nháº­n traffic inboud tá»« duy nháº¥t app subnet (khÃ´ng nháº­n traffic tá»« public subnet)</li></ul><p><strong>BONUS 1</strong>: Viá»‡c thiáº¿t káº¿ há»‡ thá»‘ng â€¦ thá»±c ra phá»¥ thuá»™c vÃ o á»©ng dá»¥ng Ä‘ang phÃ¡t triá»ƒn, yÃªu cáº§u vá» security, tá»‘c Ä‘á»™ phÃ¡t triá»ƒn â€¦ CÃ³ má»™t phiÃªn báº£n Ä‘Æ¡n giáº£n hÆ¡n cá»§a architecture trÃªn Ä‘Ã³ lÃ  bá» Ä‘i Management VPC vÃ  káº¿t ná»‘i Peering. Thay vÃ o Ä‘Ã³ ta sáº½ Ä‘áº·t ssh-bastion, vpn service á»Ÿ public layer, cÃ¡c dá»‹ch vá»¥ devops khÃ¡c cÃ³ thá»ƒ Ä‘áº·t trong cÃ¡c subnet tÆ°Æ¡ng á»©ng nhÆ° cÃ¡c dá»‹ch vá»¥ phá»¥c vá»¥ cho user. CÃ³ nhá»¯ng cÃ´ng ty lÃ m vá» cá»•ng thanh toÃ¡n, vÃ­ Ä‘iá»‡n tá»­, cÃ¡c cty cÃ³ Ä‘á»™i ngÅ© security riÃªng (ISO team) thÃ¬ yÃªu cáº§u vá» security cÃ³ thá»ƒ cao hÆ¡n, há» kiá»ƒm soÃ¡t cáº£ cÃ¡c káº¿t ná»‘i outbound (ra Ä‘Ã¢u, ra tá»« port nÃ o, network interface nÃ o, Ä‘á»‹a chá»‰ nguá»“n/Ä‘Ã­ch ra sao), Ä‘iá»u Ä‘Ã³ lÃ  dá»… hiá»ƒu nhÆ°ng Ä‘á»“ng thá»i sáº½ cÃ³ nhiá»u issue liÃªn quan tá»›i viá»‡c má»Ÿ thiáº¿u cá»•ng, debug khÃ³ hÆ¡n, thá»i gian deploy lÃ¢u hÆ¡n &mldr;</p><p><strong>BONUS 2</strong>: Thiáº¿t káº¿ há»‡ thá»‘ng máº¡ng nhÆ° váº§y thá»±c ra khÃ´ng há» má»›i (náº¿u báº¡n Ä‘Ã£ há»c qua CCNA/CCNP), tá»« khi báº¡n xÃ¢y dá»±ng cÃ¡c há»‡ thá»‘ng physical thÃ¬ cÃ¡c lÃ½ thuyáº¿t nÃ y cÅ©ng Ä‘Ã£ tá»“n táº¡i rá»“i (khÃ´ng tin há»i thá»­ máº¥y báº¡n lÃ m network engineer xem). Äiá»ƒm khÃ¡c biá»‡t lÃ  vá»›i má»™t há»‡ thá»‘ng physical ta sáº½ cáº§n má»™t sá»‘ thiáº¿t bá»‹ máº¡ng nhÆ° sau:</p><ul><li>Switch layer 3 hoáº¡t Ä‘á»™ng vá»›i 2 chá»©c nÄƒng chÃ­nh nhÆ° router vÃ  chuyá»ƒn máº¡ch (switching) giá»¯a cÃ¡c VLAN (VLAN lÃ  lá»›p máº¡ng áº£o, tÆ°Æ¡ng tá»± nhÆ° Zone á»Ÿ trÃªn).</li><li>Switch layer 2 Ä‘á»ƒ chia máº¡ng thÃ nh nhiá»u VLAN nhá», nhÆ°ng do hoáº¡t Ä‘á»™ng á»Ÿ layer 2 lÃªn cÃ¡c mÃ¡y chá»§ trong má»™t VLAN sáº½ khÃ´ng thá»ƒ giao tiáº¿p Ä‘Æ°á»£c vá»›i nhau, nÃªn nhÆ° á»Ÿ trÃªn ta cÃ³ switch layer 3.</li><li>Hardware Firewall hoáº¡t Ä‘á»™ng nhÆ° má»™t network firewall, kiá»ƒm soÃ¡t truy cáº­p giá»¯a cÃ¡c VLAN, subnet.</li><li>Má»™t thiáº¿t bá»‹ VPN chuyÃªn dá»¥ng hoáº·c sá»­ dá»¥ng hardware fw á»Ÿ trÃªn náº¿u cÃ³ há»— trá»£.</li><li>&mldr;</li></ul><p>BÃ i viáº¿t tham kháº£o mÃ´ hÃ¬nh dÃ¹ng Mgnt VPC vÃ  káº¿t ná»‘i VPC peering á»Ÿ bÃ i viáº¿t <a href=https://www.whaletech.co/2014/10/02/reference-vpc-architecture.html>A Reference VPC Architecture</a> cá»§a tÃ¡c giáº£ <strong>Ben Whaley</strong> tá»« <a href=https://gruntwork.io/devops-checklist>DevOps checklist Gruntwork</a>.</p><p>Má»™t phiÃªn báº£n khÃ¡c tÆ°Æ¡ng tá»± tá»« <a href=https://www.boltops.com>https://www.boltops.com</a> nhÆ° sau:</p><p><img src=https://raw.githubusercontent.com/xluffy/assets/master/boltops-example-architecture-0a6fec7422d2caa0029c7fdfe3f8a62b3518591bf1a94e7b38849d46cd720daa.png alt=boltops-example-architecture></p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://taoquangne.com/post/cloudflare-101/><span class=button__icon>â†</span>
<span class=button__text>Cloudflare 101</span>
</a></span><span class="button next"><a href=https://taoquangne.com/post/who-owns-my-encrypt-keys-on-cloud/><span class=button__text>Who owns my encrypt keys on cloud?</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href=https://creativecommons.org/licenses/by-nc/4.0>giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://taoquangne.com/assets/main.js></script><script src=https://taoquangne.com/assets/prism.js></script></div><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K62WF7M4" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript></body></html>