<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Intro MySQL replication ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="1. Giá»›i thiá»‡u Right tool for right job."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/intro-mysql-replication/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Intro MySQL replication"/>
<meta name="twitter:description" content="1. Giá»›i thiá»‡u Right tool for right job."/>



<meta property="og:title" content="Intro MySQL replication" />
<meta property="og:description" content="1. Giá»›i thiá»‡u Right tool for right job." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/intro-mysql-replication/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-09-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-09-01T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Intro MySQL replication</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2015-09-01
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/mysql/">#mysql</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/replication/">#replication</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h1 id="1-giá»›i-thiá»‡u">1. Giá»›i thiá»‡u</h1>
<p>Right tool for right job. TrÆ°á»›c tiÃªn pháº£i hiá»ƒu lÃ  MySQL Replication khÃ´ng pháº£i lÃ  giáº£i phÃ¡p giáº£i quyáº¿t má»i bÃ i toÃ¡n vá» quÃ¡ táº£i há»‡ thá»‘ng cÆ¡ sá»Ÿ dá»¯ liá»‡u. Äá»ƒ má»Ÿ rá»™ng má»™t há»‡ thá»‘ng ta cÃ³ hai phÆ°Æ¡ng phÃ¡p má»Ÿ rá»™ng lÃ  scale up vÃ  scale out. Báº¯t Ä‘áº§u vá»›i 1 mÃ¡y chá»§ thÃ¬ hai phÆ°Æ¡ng phÃ¡p trÃªn Ä‘Æ°á»£c diá»…n giáº£i nhÆ° sau:</p>
<p>Scale up cÃ³ nghÄ©a lÃ  vá»›i má»™t mÃ¡y chá»§ ta lÃ m cÃ¡ch nÃ o Ä‘Ã³ Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ phá»¥c vá»¥ nhiá»u hÆ¡n sá»‘ lÆ°á»£ng káº¿t ná»‘i, truy váº¥n. NghÄ©a lÃ  giÃ¡ trá»‹ 1/(sá»‘ káº¿t ná»‘i phá»¥c vá»¥) cÃ ng nhá» thÃ¬ cÃ ng tá»‘t. Äá»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»¥c Ä‘Ã­ch nÃ y thÃ¬ cÃ³ 2 phÆ°Æ¡ng phÃ¡p:</p>
<ul>
<li>TÄƒng pháº§n cá»©ng lÃªn cho mÃ¡y chá»§. NghÄ©a lÃ  vá»›i CPU lÃ  4 core, RAM lÃ  8 GB phá»¥c vá»¥ Ä‘Æ°á»£c 500 truy váº¥n thÃ¬ giá» ta tÄƒng CPU lÃªn 24 core, RAM tÄƒng lÃªn 32GB -&gt; mÃ¡y chá»§ cÃ³ thá»ƒ phá»¥c vá»¥ Ä‘Æ°á»£c sá»‘ lÆ°á»£ng káº¿t ná»‘i truy váº¥n nhiá»u hÆ¡n.</li>
<li>Optimize á»©ng dá»¥ng, cÃ¢u truy váº¥n. VÃ­ dá»¥ vá»›i cÃ¢u truy váº¥n láº¥y dá»¯ liá»‡u tá»‘n 5s Ä‘á»ƒ láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u, sau Ä‘Ã³ má»›i tráº£ láº¡i tÃ i nguyÃªn cho há»‡ thá»‘ng phá»¥c vá»¥ cÃ¡c truy váº¥n khÃ¡c. MÃ¡y chá»§ cÃ³ thá»ƒ Ä‘á»“ng thá»i phá»¥c vá»¥ 500 truy váº¥n dáº¡ng nhÆ° váº­y thÃ¬ náº¿u ta tá»‘i Æ°u Ä‘á»ƒ truy váº¥n láº¥y dá»¯ liá»‡u chá»‰ tá»‘n 1s =&gt; MÃ¡y chá»§ cÃ³ thá»ƒ phá»¥c vá»¥ Ä‘á»“ng thá»i nhiá»u truy váº¥n hÆ¡n</li>
</ul>
<p>Scale out lÃ  giáº£i phÃ¡p tÄƒng sá»‘ lÆ°á»£ng server vÃ  dÃ¹ng cÃ¡c giáº£i phÃ¡p load-balacer Ä‘á»ƒ phÃ¢n phá»‘i truy váº¥n ra nhiá»u server. VÃ­ dá»¥ báº¡n cÃ³ 1 server cÃ³ kháº£ nÄƒng phá»¥c vá»¥ 500 truy váº¥n. Náº¿u ta dá»±ng thÃªm 5 server ná»¯a cÃ³ cáº¥u hÃ¬nh tÆ°Æ¡ng tá»±, Ä‘áº·t thÃªm má»™t LB phÃ­a trÆ°á»›c Ä‘á»ƒ phÃ¢n phá»‘i thÃ¬ cÃ³ kháº£ nÄƒng há»‡ thá»‘ng cÃ³ thá»ƒ phá»¥c vá»¥ Ä‘c 5x500 truy váº¥n Ä‘á»“ng thá»i.</p>
<p>MySQL Replication lÃ  má»™t giáº£i phÃ¡p scale out (tÄƒng sá»‘ lÆ°á»£ng instance MySQL) nhÆ°ng khÃ´ng pháº£i bÃ i toÃ¡n nÃ o cÅ©ng dÃ¹ng Ä‘Æ°á»£c. CÃ¡c bÃ i toÃ¡n mÃ  MySQL Replication sáº½ giáº£i quyáº¿t tá»‘t:</p>
<ul>
<li>Scale Read</li>
<li>Data Report</li>
<li>Real time backup</li>
</ul>
<h2 id="11-scale-read">1.1 Scale Read</h2>
<p>Scale Read thÆ°á»ng gáº·p á»Ÿ cÃ¡c á»©ng dá»¥ng mÃ  sá»‘ truy váº¥n Ä‘á»c dá»¯ liá»‡u nhiá»u hÆ¡n ghi, tá»‰ lá»‡ read/write cÃ³ thá»ƒ 80/20 hoáº·c hÆ¡n. CÃ¡c á»©ng dá»¥ng thÆ°á»ng gáº·p lÃ  bÃ¡o, trang tin tá»©c.</p>
<p>Vá»›i scale read ta sáº½ chá»‰ cÃ³ má»™t Master instance phá»¥c vá»¥ cho viá»‡c Ä‘á»c/ghi dá»¯ liá»‡u. CÃ³ thá»ƒ cÃ³ má»™t hoáº·c nhiá»u Slave instance chá»‰ phá»¥c vá»¥ cho viá»‡c Ä‘á»c dá»¯ liá»‡u</p>
<p>Má»™t sá»‘ á»©ng dá»¥ng write nhiá»u (thÆ°Æ¡ng máº¡i Ä‘iá»‡n tá»­) cÅ©ng cÃ³ sá»­ dá»¥ng MySQL Replication Ä‘á»ƒ scale out há»‡ thá»‘ng</p>
<h2 id="12-data-report">1.2 Data Report</h2>
<p>Má»™t sá»‘ há»‡ thá»‘ng cho phÃ©p má»™t sá»‘ ngÆ°á»i (leader, manager, ngÆ°á»i lÃ m report, thá»‘ng kÃª, data) truy cáº­p vÃ o dá»¯ liá»‡u trÃªn production phá»¥c vá»¥ cho cÃ´ng viá»‡c cá»§a há». Viá»‡c chá»c tháº³ng vÃ o data production sáº½ ráº¥t nguy hiá»ƒm vÃ¬:</p>
<ul>
<li>VÃ´ tÃ¬nh chá»‰nh sá»­a lÃ m sai lá»‡nh dá»¯ liá»‡u (náº¿u cÃ³ quyá»n insert, update)</li>
<li>VÃ´ tÃ¬nh thá»±c thi cÃ¡c cÃ¢u truy váº¥n tá»‘n nhiá»u tÃ i nguyÃªn, thá»i gian truy váº¥n dÃ i lÃ m treo há»‡ thá»‘ng</li>
</ul>
<p>Viá»‡c setup má»™t mÃ¡y chá»§ lÃ m data report (application cÅ©ng sáº½ khÃ´ng káº¿t ná»‘i tá»›i server nÃ y) lÃ m giáº£m thiá»ƒu 2 rá»§i ro trÃªn</p>
<h2 id="13-real-time-backup">1.3 Real time backup</h2>
<p>Vá»›i cÆ¡ sá»Ÿ dá»¯ liá»‡u lá»›n viá»‡c backup khÃ´ng thá»ƒ thá»±c hiá»‡n thÆ°á»ng xuyÃªn Ä‘Æ°á»£c (hÃ ng giá», hÃ ng phÃºt). Vá»›i cÃ¡c á»©ng dá»¥ng giao dá»‹ch tÃ i chÃ­nh, thanh toÃ¡n, TMDT náº¿u bá»‹ máº¥t dá»¯ liá»‡u 1 giá», 1 ngÃ y thÃ¬ thiá»‡t háº¡i sáº½ ráº¥t lá»›n (mÃ¡y chá»§ chÃ­nh tÆ° dÆ°ng bá»‹ há»ng). Real time backup lÃ  má»™t giáº£i phÃ¡p bá»• sung cho offline backup, cháº¡y Ä‘á»“ng thá»i cáº£ 2 phÆ°Æ¡ng phÃ¡p nÃ y Ä‘á»ƒ báº£o Ä‘áº£m sá»± an toÃ n cho dá»¯ liá»‡u.</p>
<p>Tuy nhiÃªn, viá»‡c dÃ¹ng replicate Ä‘á»ƒ backup dá»¯ liá»‡u chá»‰ Ä‘áº£m báº£o náº¿u Ä‘Ä©a cá»©ng cá»§a master bá»‹ há»ng, trong trÆ°á»ng há»£p human error khi xÃ³a nháº§m dá»¯ liá»‡u, hÃ nh Ä‘á»™ng xÃ³a sáº½ Ä‘Æ°á»£c replicate sang slave luÃ´n =&gt; váº«n bá»‹ máº¥t dá»¯ liá»‡u.</p>
<p>Äá»ƒ trÃ¡nh xáº£y ra trÆ°á»ng há»£p trÃªn vÃ  giáº£m thiá»ƒu rá»§i ro máº¥t dá»¯ liá»‡u, mÃ¬nh cÃ³ giá»›i thiá»‡u má»™t bÃ i khÃ¡c <a href="https://xluffy.github.io/post/delayed-replication-in-mysql/">delay-replication</a>.</p>
<h1 id="2-hoáº¡t-Ä‘á»™ng-nhÆ°-tháº¿-nÃ o">2. Hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?</h1>
<h2 id="21-má»™t-sá»‘-mÃ´-hÃ¬nh">2.1 Má»™t sá»‘ mÃ´ hÃ¬nh</h2>
<p align="center"><img src="https://i.imgur.com/mevNr10.png" alt="mysql-replication" width="65%"/></p>
<p>Vá»›i cáº£ hai mÃ´ hÃ¬nh ta luÃ´n chá»‰ cÃ³ 1 Master database phá»¥c vá»¥ cho Write dá»¯ liá»‡u, cÃ³ thá»ƒ cÃ³ má»™t hoáº·c nhiá»u Slave database. TÃ¹y tá»«ng mÃ´ hÃ¬nh ta cÃ³ thá»ƒ cáº¥u hÃ¬nh má»—i web node connect vÃ o má»™t Slave DB tÆ°Æ¡ng á»©ng hoáº·c cÃ³ thá»ƒ dÃ¹ng má»™t LB Ä‘áº·t trÆ°á»›c cá»¥m Slave Ä‘á»ƒ LB tá»± Ä‘á»™ng phÃ¢n phá»‘i connection vÃ o tá»«ng Slave DB theo thuáº­t toÃ¡n cá»§a LB.</p>
<p align="center"><img src="https://i.imgur.com/etkJXxd.png" alt="mysql-replication-lb" width="65%"/></p>
<h2 id="22-cÃ¡ch-hoáº¡t-Ä‘á»™ng">2.2 CÃ¡ch hoáº¡t Ä‘á»™ng</h2>
<p>TrÃªn Master:</p>
<ul>
<li>CÃ¡c káº¿t ná»‘i tá»« web app tá»›i Master DB sáº½ má»Ÿ má»™t <code>Session_Thread</code> khi cÃ³ nhu cáº§u ghi dá»¯ liá»‡u. <code>Session_Thread</code> sáº½ ghi cÃ¡c statement SQL vÃ o má»™t file binlog (vÃ­ dá»¥ vá»›i format cá»§a binlog lÃ  statement-based hoáº·c mix). Binlog Ä‘Æ°á»£c lÆ°u trá»¯ trong <code>data_dir</code> (cáº¥u hÃ¬nh my.cnf) vÃ  cÃ³ thá»ƒ Ä‘Æ°á»£c cáº¥u hÃ¬nh cÃ¡c thÃ´ng sá»‘ nhÆ° kÃ­ch thÆ°á»›c tá»‘i Ä‘a bao nhiÃªu, lÆ°u láº¡i trÃªn server bao nhiÃªu ngÃ y.</li>
<li>Master DB sáº½ má»Ÿ má»™t <code>Dump_Thread</code> vÃ  gá»­i binlog tá»›i cho <code>I/O_Thread</code> má»—i khi <code>I/O_Thread</code> tá»« Slave DB yÃªu cáº§u dá»¯ liá»‡u</li>
</ul>
<p>TrÃªn Slave:</p>
<ul>
<li>TrÃªn má»—i Slave DB sáº½ má»Ÿ má»™t <code>I/O_Thread</code> káº¿t ná»‘i tá»›i Master DB thÃ´ng qua network, giao thá»©c TCP (vá»›i MySQL 5.5 replication chá»‰ há»— trá»£ <code>Single_Thread</code> nÃªn má»—i Slave DB sáº½ chá»‰ má»Ÿ duy nháº¥t má»™t káº¿t ná»‘i tá»›i Master DB, cÃ¡c phiÃªn báº£n sau 5.6, 5.7 há»— trá»£ má»Ÿ Ä‘á»“ng thá»i nhiá»u káº¿t ná»‘i hÆ¡n) Ä‘á»ƒ yÃªu cáº§u binlog.</li>
<li>Sau khi <code>Dump_Thread</code> gá»­i binlog tá»›i <code>I/O_Thead</code>, <code>I/O_Thread</code> sáº½ cÃ³ nhiá»‡m vá»¥ Ä‘á»c binlog nÃ y vÃ  ghi vÃ o relaylog.</li>
<li>Äá»“ng thá»i trÃªn Slave sáº½ má»Ÿ má»™t <code>SQL_Thread</code>, <code>SQL_Thread</code> cÃ³ nhiá»‡m vá»¥ Ä‘á»c cÃ¡c event tá»« relaylog vÃ  apply cÃ¡c event Ä‘Ã³ vÃ o Slave =&gt; quÃ¡ trÃ¬nh replication hoÃ n thÃ nh.</li>
</ul>
<p align="center"><img src="https://i.imgur.com/RLAnddr.jpg" alt="mysql-replication-arch" width="85%"/></p>
<p>Vá» logic má»—i Slave DB sáº½ chá»‰ nháº­n dá»¯ liá»‡u tá»« Master DB, má»i hÃ nh Ä‘á»™ng cáº­p nháº­t dá»¯ liá»‡u <strong>Báº®T BUá»˜C</strong> pháº£i Ä‘Æ°á»£c thá»±c hiá»‡n trÃªn Master. Vá» nguyÃªn táº¯c náº¿u ghi dá»¯ liá»‡u trá»±c tiáº¿p lÃªn Slave DB =&gt; há»ng replication. NhÆ°ng thá»±c cháº¥t ta hoÃ n toÃ n cÃ³ thá»ƒ ghi dá»¯ liá»‡u trÃªn Slave miá»…n sao khi Slave Ä‘á»c binlog vÃ  apply khÃ´ng Ä‘á»¥ng gÃ¬ tá»›i nhá»¯ng trÆ°á»ng dá»¯ liá»‡u mÃ  ta má»›i ghi vÃ o thÃ¬ sáº½ khÃ´ng bá»‹ lá»—i (má»¥c nÃ y sáº½ nÃ³i thÃªm á»Ÿ cÃ¡c pháº§n sau)</p>
<p>Vá»›i MySQL 5.5 thÃ¬ má»—i slave sáº½ chá»‰ cÃ³ má»™t <code>slave_thread</code> connect tá»›i Master, tuy nhiÃªn tá»« phiÃªn báº£n 5.6 chÃºng ta cÃ³ thá»ƒ cáº¥u hÃ¬nh nhiá»u <code>slave_thread</code> Ä‘á»ƒ viá»‡c apply bin log tá»›i cÃ¡c slave nhanh hÆ¡n.</p>
<h1 id="3-hÆ°á»›ng-dáº«n-cÃ i-Ä‘áº·t-vÃ -cáº¥u-hÃ¬nh">3. HÆ°á»›ng dáº«n cÃ i Ä‘áº·t vÃ  cáº¥u hÃ¬nh</h1>
<h3 id="mÃ´-hÃ¬nh">MÃ´ hÃ¬nh:</h3>
<ul>
<li>Master DB: 172.17.0.1</li>
<li>Slave DB: 172.17.0.2</li>
</ul>
<h3 id="trÃªn-master-db">TrÃªn Master DB</h3>
<p>Cáº¥u hÃ¬nh my.cnf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">event-scheduler <span style="color:#f92672">=</span> on
bind-address <span style="color:#f92672">=</span> 172.17.0.1
server-id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

log-bin
binlog-format<span style="color:#f92672">=</span>row
binlog-do-db<span style="color:#f92672">=</span>dwh_prod
binlog-ignore-db<span style="color:#f92672">=</span>mysql
binlog-ignore-db<span style="color:#f92672">=</span>test

sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><p>Táº¡o user replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;slave_user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;172.16.0.2&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;p@ssword&#39;</span>;
FLUSH <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><p>Táº¡o schema, dá»¯ liá»‡u Ä‘á»ƒ test</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">SCHEMA</span> dwh_prod CHARACTER <span style="color:#66d9ef">SET</span> utf8 <span style="color:#66d9ef">COLLATE</span> utf8_general_ci;

<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb1 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;
 
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb2 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

<span style="color:#66d9ef">SHOW</span> TABLES;
</code></pre></div><h3 id="trÃªn-slave-db">TrÃªn Slave DB</h3>
<p>Cáº¥u hÃ¬nh my.cnf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">event_scheduler<span style="color:#f92672">=</span>off
bind-address <span style="color:#f92672">=</span> 172.17.0.2
server-id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>

log-bin
binlog-format<span style="color:#f92672">=</span>row
binlog-do-db<span style="color:#f92672">=</span>dwh_prod
binlog-ignore-db<span style="color:#f92672">=</span>mysql
binlog-ignore-db<span style="color:#f92672">=</span>test

transaction-isolation<span style="color:#f92672">=</span>read-committed
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><h3 id="táº¡o-replication-vÃ -kiá»ƒm-tra">Táº¡o replication vÃ  kiá»ƒm tra</h3>
<p>NguyÃªn táº¯c khi táº¡o replication lÃ  pháº£i LOCK táº¥t cáº£ cÃ¡c table trÃªn Master DB, Ä‘á»ƒ dá»¯ liá»‡u khÃ´ng thay Ä‘á»•i, sau Ä‘Ã³ xÃ¡c Ä‘á»‹nh binlog vÃ  position, 2 thÃ´ng sá»‘ dÃ¹ng Ä‘á»ƒ cáº¥u hÃ¬nh trÃªn Slave xÃ¡c Ä‘á»‹nh Ä‘oáº¡n dá»¯ liá»‡u báº¯t Ä‘áº§u Ä‘á»“ng bá»™</p>
<p>TrÃªn Master DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">FLUSH TABLES <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">LOCK</span>;
<span style="color:#66d9ef">SHOW</span> MASTER STATUS;

<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> File           <span style="color:#f92672">|</span> <span style="color:#66d9ef">Position</span> <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">827</span> <span style="color:#f92672">|</span> dwh_prod     <span style="color:#f92672">|</span> mysql,test       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span></code></pre></div><p>GiÃ¡ trá»‹ cáº§n quan tÃ¢m lÃ </p>
<ul>
<li>m01-bin.000001</li>
<li>827</li>
</ul>
<p>Sau Ä‘Ã³ ta sáº½ dump dá»¯ liá»‡u tá»« Master DB vÃ  Ä‘áº©y qua Slave DB (sau khi dump xong cÃ³ thá»ƒ <code>UNLOCK TABLES;</code> Ä‘á»ƒ Master DB cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng láº¡i).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysqldump -uroot -p dwh_prod &gt; dwh_prod_03072015.sql
rsync -avz -P -e<span style="color:#e6db74">&#39;ssh&#39;</span> dwh_prod_03072015.sql root@172.17.0.2:/root/
</code></pre></div><p>TrÃªn Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>uroot <span style="color:#f92672">-</span>p dwh_prod <span style="color:#f92672">&lt;</span> <span style="color:#f92672">/</span>root<span style="color:#f92672">/</span>dwh_prod_03072015.<span style="color:#66d9ef">sql</span>

<span style="color:#f92672">&gt;</span> CHANGE MASTER <span style="color:#66d9ef">TO</span> MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;172.17.0.1&#39;</span>,MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;slave_user&#39;</span>, MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p@ssword&#39;</span>, MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m01-bin.000001&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">827</span>;
<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">START</span> SLAVE
<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> SLAVE STATUS<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</code></pre></div><p>Má»™t sá»‘ thÃ´ng tin Ä‘Ã£ Ä‘Æ°á»£c lÆ°á»£c bá» cho dá»… nhÃ¬n</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
               Slave_IO_State: Waiting <span style="color:#66d9ef">for</span> master <span style="color:#66d9ef">to</span> send event
                  Master_Host: <span style="color:#ae81ff">172</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>
                  Master_User: slave_user
              Master_Log_File: m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span>
          Read_Master_Log_Pos: <span style="color:#ae81ff">827</span>
               Relay_Log_File: m02<span style="color:#f92672">-</span>relay<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000002</span>
                Relay_Log_Pos: <span style="color:#ae81ff">251</span>
        Relay_Master_Log_File: m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span>
                   Last_Errno: <span style="color:#ae81ff">0</span>
                   Last_Error: 
                 Skip_Counter: <span style="color:#ae81ff">0</span>
          Exec_Master_Log_Pos: <span style="color:#ae81ff">827</span>
              Relay_Log_Space: <span style="color:#ae81ff">405</span>
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Errno: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span style="color:#ae81ff">0</span>
               Last_SQL_Error: 
             Master_Server_Id: <span style="color:#ae81ff">1</span>
</code></pre></div><p>CÃ¡c thÃ´ng sá»‘ cáº§n quan tÃ¢m lÃ </p>
<ul>
<li><code>Last_Error: 0</code></li>
<li><code>Last_SQL_Error</code></li>
<li><code>Seconds_Behind_Master: 0</code></li>
</ul>
<p>Hai thÃ´ng sá»‘ Ä‘áº§u tiÃªn lÃ  lá»—i khi Slave DB thá»±c thi cÃ¡c event Ä‘á»c tá»« relay log. ThÃ´ng sá»‘ <code>Seconds_Behind_Master</code> cho ta biáº¿t dá»¯ liá»‡u cá»§a Slave DB Ä‘ang bá»‹ <strong>trá»…</strong> (delay, lag) bao nhiÃªu giÃ¢y so vá»›i Master DB. CÃ¡c pháº§n sau ta sáº½ nÃ³i ká»¹ hÆ¡n vá» replication lag nÃ y.</p>
<h1 id="4-váº­n-hÃ nh-há»‡-thá»‘ng-mysql-replicatione">4. Váº­n hÃ nh há»‡ thá»‘ng MySQL Replicatione</h1>
<h2 id="41-test-logic-replication">4.1 Test logic replication</h2>
<p>á» tráº¡ng thÃ¡i bÃ¬nh thÆ°á»ng dá»¯ liá»‡u trÃªn Slave DB Ä‘Ã£ Ä‘á»“ng bá»™ vá»›i Master DB. Kiá»ƒm tra</p>
<p>TrÃªn Master</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> USE dwh_prod
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>TrÃªn Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> USE dwh_prod
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#f92672">-</span>p <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
                   Last_Error: 
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Error:
</code></pre></div><p>Má»i thá»© Ä‘á»u á»•n, khÃ´ng lá»—i vÃ  khÃ´ng cÃ³ Lag.</p>
<p>Giá» giáº£ sá»­ ta sáº½ táº¡o má»™t table vá»›i tÃªn lÃ  tb00 trÃªn Slave vÃ  kiá»ƒm tra xem cÃ³ Ä‘Ãºng lÃ  khi ghi dá»¯ liá»‡u lÃªn Slave DB thÃ¬ replication cÃ³ bá»‹ há»ng hay khÃ´ng.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb00 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb00               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Kiá»ƒm tra cÃ¡c table trÃªn Master DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>VÃ  kiá»ƒm tra láº¡i tráº¡ng thÃ¡i cá»§a replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>                                                                                                   
            Last_Error: 
      Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
            Last_IO_Error: 
            Last_SQL_Error:
</code></pre></div><p>=&gt; NhÆ° ta tháº¥y rÃµ rÃ ng lÃ  dá»¯ liá»‡u trÃªn Slave vÃ  Master Ä‘Ã£ khÃ¡c nhau (Slave cÃ³ tb00 nhÆ°ng Master thÃ¬ khÃ´ng) nhÆ°ng tráº¡ng thÃ¡i cá»§a replication váº«n hoÃ n toÃ n á»•n.</p>
<p>Giá» chÃºng ta sáº½ thá»­ thÃªm má»™t trÆ°á»ng há»£p ná»¯a lÃ  trÃªn Master ta sáº½ táº¡o má»™t table tÃªn lÃ  tb6 Ä‘á»ƒ kiá»ƒm tra xem chuyá»‡n gÃ¬ sáº½ xáº£y ra</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb6 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb6                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>Kiá»ƒm tra cÃ¡c table trÃªn Slave DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb00               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb6                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>=&gt; báº£ng tb6 Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»“ng bá»™ tá»« Master qua, kiá»ƒm tra tráº¡ng thÃ¡i replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
                   Last_Error: 
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Error:
</code></pre></div><p>=&gt; Má»i thá»© váº«n á»•n, nghÄ©a lÃ  dÃ¹ ta cÃ³ ghi dá»¯ liá»‡u vÃ o Slave, nhÆ°ng náº¿u Master thá»±c thi cÃ¡c cÃ¢u truy váº¥n khÃ´ng Ä‘á»¥ng gÃ¬ tá»›i dá»¯ liá»‡u Ä‘Æ°á»£c ghi má»›i á»Ÿ Slave thÃ¬ tráº¡ng thÃ¡i cá»§a replication váº«n á»•n.</p>
<p>Giá» ta sáº½ thá»±c hiá»‡n thÃªm má»™t thá»­ nghiá»‡m ná»¯a lÃ  trÃªn Master ta táº¡o má»™t table tÃªn lÃ  tb00, trÃ¹ng vá»›i table Ä‘Ã£ táº¡o lÃºc trÆ°á»›c á»Ÿ Slave phÃ­a trÃªn vÃ  kiá»ƒm tra láº¡i tráº¡ng thÃ¡i cá»§a replication</p>
<p>Kiá»ƒm tra tráº¡ng thÃ¡i replication trÃªn Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
              Last_Error: Error <span style="color:#e6db74">&#39;Table &#39;</span>tb00<span style="color:#e6db74">&#39; already exists&#39;</span> <span style="color:#66d9ef">on</span> query. <span style="color:#66d9ef">Default</span> <span style="color:#66d9ef">database</span>: <span style="color:#e6db74">&#39;dwh_prod&#39;</span>. Query: <span style="color:#e6db74">&#39;CREATE TABLE tb00 (
</span><span style="color:#e6db74">   Seconds_Behind_Master: NULL
</span><span style="color:#e6db74">           Last_IO_Error:
</span><span style="color:#e6db74">          Last_SQL_Error: Error &#39;</span><span style="color:#66d9ef">Table</span> <span style="color:#e6db74">&#39;tb00&#39;</span> already <span style="color:#66d9ef">exists</span><span style="color:#e6db74">&#39; on query. Default database: &#39;</span>dwh_prod<span style="color:#e6db74">&#39;. Query: &#39;</span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb00 (
</code></pre></div><p>=&gt; nhÆ° ta tháº¥y há»‡ thá»‘ng bÃ¡o lá»—i do trÃªn Slave khÃ´ng thá»ƒ thá»±c thi hÃ nh Ä‘á»™ng táº¡o table tb00 tá»« Master Ä‘áº©y xuá»‘ng (do table nÃ y Ä‘Ã£ tá»“n táº¡i trÆ°á»›c Ä‘Ã³)</p>
<p>Káº¿t Luáº­n: Viá»‡c ghi dá»¯ liá»‡u vÃ o Slave lÃ  cÃ³ thá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c, nhÆ°ng sáº½ gÃ¢y ra rá»§i ro há»ng replication á»Ÿ má»™t lÃºc nÃ o Ä‘Ã³. Nháº¥t lÃ  cÃ¡c cÃ¢u truy váº¥n dáº¡ng SELECT &hellip; UPDATE. Tá»‘t nháº¥t lÃ  nÃªn trÃ¡nh ghi dá»¯ liá»‡u vÃ o Slave</p>
<h2 id="42-replication-lag">4.2 Replication Lag</h2>
<p><code>Replication Lag</code> lÃ  Ä‘á»™ trá»… dá»¯ liá»‡u cá»§a Slave so vá»›i Master. Khi triá»ƒn khai má»™t há»‡ thá»‘ng MySQL Replication thÃ¬ Lag lÃ  váº¥n Ä‘á» cháº¯c cháº¯n gáº·p pháº£i. Ta chá»‰ cÃ³ thá»ƒ giáº£m thiá»ƒu Ä‘á»™ trá»… dá»¯ liá»‡u trong má»©c cháº¥p nháº­n Ä‘Æ°á»£c chá»© khÃ´ng thá»ƒ khÃ´ng cÃ³ lag. LÃ­ do lÃ  viá»‡c Ä‘á»“ng bá»™ dá»¯ liá»‡u lÃ  Asynchronous, nghÄ©a lÃ  cÃ¡c Slave server khÃ´ng cáº§n thÃ´ng bÃ¡o cho Master biáº¿t khi transaction thá»±c hiá»‡n trÃªn Slave thÃ nh cÃ´ng -&gt; Ä‘iá»u nÃ y giÃºp giá»¯ nguyÃªn hiá»‡u suáº¥t (khÃ¡c vá»›i cÆ¡ cháº¿ Ä‘á»“ng bá»™ synchronous, má»™t transaction Ä‘Æ°á»£c gá»i lÃ  thÃ nh cÃ´ng khi nÃ³ committed trÃªn master server vÃ  master server nháº­n Ä‘Æ°á»£c má»™t thÃ´ng bÃ¡o tá»« slave server lÃ  transaction nÃ y Ä‘Ã£ Ä‘Æ°á»£c write vÃ  committed. QuÃ¡ trÃ¬nh nÃ y Ä‘áº£m báº£o tÃ­nh thá»‘ng nháº¥t giá»¯a master vÃ  slave server nhÆ°ng Ä‘á»“ng thá»i nÃ³ lÃ m giáº£m hiá»‡u suáº¥t Ä‘i má»™t ná»¯a do cÃ¡c váº¥n Ä‘á» vá» network, bandwidth, location.)</p>
<p>Váº¥n Ä‘á» cá»§a <code>replication lag</code> áº£nh hÆ°á»Ÿng tá»›i cÃ¡c truy váº¥n vá»«a write dá»¯ liá»‡u xuá»‘ng lÃ  read dá»¯ liá»‡u lÃªn liá»n. VÃ­ dá»¥</p>
<p>Má»™t trang thÆ°Æ¡ng máº¡i Ä‘iá»‡n tá»­ cÃ³ tÃ­nh nÄƒng add vÃ o giá» hÃ ng má»™t sáº£n pháº©m. Sau khi sáº£n pháº©m Ä‘Æ°á»£c add vÃ o giá» hÃ ng sáº½ trá»« sá»‘ lÆ°á»£ng trong tá»“n kho. 2 user thá»±c hiá»‡n mua sáº£n pháº©m Ä‘Ã³ (sáº£n pháº©m Ä‘Ã³ cÃ³ sá»‘ lÆ°á»£ng tá»“n kho lÃ  1). Cáº£ 2 Ä‘á»u tháº¥y sáº£n pháº©m Ä‘Ã³ trÃªn website hiá»ƒn thá»‹ tráº¡ng thÃ¡i CÃ’N HÃ€NG. Khi má»™t user mua sáº£n pháº©m Ä‘Ã³ vÃ  thanh toÃ¡n thÃ nh cÃ´ng. Do Ä‘á»™ trá»… dá»¯ liá»‡u (vÃ­ dá»¥ 5s) nÃªn dá»¯ liá»‡u chÆ°a Ä‘c cáº­p nháº­t tá»“n kho xuá»‘ng Slave lÃ  sáº£n pháº©m Ä‘Ã£ háº¿t hÃ ng. Khi user Ä‘Ã³ add giá» hÃ ng vÃ  thanh toÃ¡n thÃ¬ lÃºc nÃ y dá»¯ liá»‡u má»›i cáº­p nháº­t vÃ  tráº£ vá» mÃ£ lá»—i lÃ  thanh toÃ¡n khÃ´ng thÃ nh cÃ´ng do sá»‘ lÆ°á»£ng tá»“n kho khÃ´ng Ä‘Ã¡p á»©ng =&gt; áº£nh hÆ°á»Ÿng tá»›i tráº£i nghiá»‡m cá»§a user trÃªn há»‡ thá»‘ng.</p>
<p>ThÆ°á»ng vá»›i nhá»¯ng trÆ°á»ng há»£p nÃ y (truy váº¥n write xong lÃ  read liá»n) thÃ¬ nÃªn sá»­ dá»¥ng cáº¥u hÃ¬nh truy váº¥n trÃªn Master (Ä‘Ã¢y lÃ  lÃ­ do Master cÃ³ thá»ƒ vá»«a write vá»«a read chá»© khÃ´ng nháº¥t thiáº¿t lÃ  chá»‰ cÃ³ write)</p>
<h2 id="43-lb-mysql-vÃ -healthchk">4.3 Lb mysql vÃ  healthchk</h2>
<p>NhÆ° 1 trong 2 mÃ´ hÃ¬nh phÃ­a trÃªn thÃ¬ vá»›i mÃ´ hÃ¬nh thá»© 2 ta cÃ³ thá»ƒ dÃ¹ng haproxy lÃ m lb cho cÃ¡c MySQL Instance.</p>
<p>Vá»›i mÃ´ hÃ¬nh 1 nhÆ°á»£c Ä‘iá»ƒm lÃ  náº¿u MySQL instance bá»‹ delay quÃ¡ lÃ¢u, server quÃ¡ táº£i hoáº·c rá»§i ro nháº¥t lÃ  instace Ä‘Ã³ bá»‹ down thÃ¬ ta khÃ´ng cÃ³ cÃ¡ch nÃ o check hoáº·c remove instance Ä‘Ã³ ra Ä‘Æ°á»£c.</p>
<p>Vá»›i mÃ´ hÃ¬nh 2 nhÆ°á»£c Ä‘iá»ƒm lÃ  ta máº¥t thÃªm 1 layer (haproxy) ná»¯a má»›i cÃ³ thá»ƒ káº¿t ná»‘i tá»›i MySQL (tá»‘n thá»i gian, xá»­ lÃ­ nhiá»u lá»›p) nhÆ°ng lá»£i Ä‘iá»ƒm lÃ  cÃ³ thá»ƒ cáº¥u hÃ¬nh healthchk, hoáº·c remove instance theo má»™t sá»‘ Ä‘iá»u kiá»‡n.</p>
<h1 id="5-má»™t-sá»‘-lÆ°u-Ã½">5. Má»™t sá»‘ lÆ°u Ã½</h1>
<h2 id="51-váº¥n-Ä‘á»-vá»-server-pháº§n-cá»©ng">5.1 Váº¥n Ä‘á» vá» server, pháº§n cá»©ng</h2>
<p>CÃ¡c váº¥n Ä‘á» vá» CPU, RAM, Ä‘Ä©a cá»©ng (kÃ­ch thÆ°á»›c, loáº¡i Ä‘Ä©a cá»©ng, SSD hay HDD, tá»‘c Ä‘á»™ Ä‘á»c ghi cá»§a Ä‘Ä©a cá»©ng)</p>
<p>Vá»›i má»™t há»‡ thá»‘ng DB cÃ¡c thÃ´ng sá»‘ pháº§n cá»©ng NÃŠN quan tÃ¢m lÃ </p>
<ul>
<li>CPU: CÃ ng nhiá»u core cÃ ng tá»‘t, tá»‘c Ä‘á»™ cÃ ng nhanh cÃ ng tá»‘t</li>
<li>RAM: RAM cÃ ng nhiá»u cÃ ng tá»‘t</li>
</ul>
<p>Vá»›i Ä‘Ä©a cá»©ng</p>
<ul>
<li>NÃªn sá»­ dá»¥ng RAID 5, 6, 10</li>
<li>NÃªn sá»­ dá»¥ng SSD (Enterprise thÃ¬ cÃ ng tá»‘t) IOPS cÃ ng cao cÃ ng tá»‘t</li>
<li>ÄÄ©a cá»©ng nÃªn cÃ³ dung lÆ°á»£ng Ã­t nháº¥t lÃ  x2 láº§n dung lÆ°á»£ng cá»§a CSDL (sáº½ cáº§n thiáº¿t trong trÆ°á»ng há»£p dump, backup dá»¯ liá»‡u Ä‘á»ƒ fix replication)</li>
</ul>
<p>KhÃ¡c vá»›i cÃ¡c á»©ng dá»¥ng khÃ¡c nhÆ° web, static (thÆ°á»ng CPU khÃ´ng cáº§n nhiá»u core, Ä‘Ä©a cá»©ng khÃ´ng cáº§n nhiá»u vÃ  nhanh), mÃ¡y chá»§ CSDL sáº½ cáº§n nhiá»u cÃ¡c thÃ´ng sá»‘ trÃªn</p>
<p>Vá»›i AWS khi chá»n Instance cÅ©ng nÃªn chÃº Ã½ cÃ¡c Ä‘iá»ƒm trÃªn</p>
<h2 id="52-cÃ¡c-váº¥n-Ä‘á»-vá»-kÃ­ch-thÆ°á»›c-dá»¯-liá»‡u">5.2 CÃ¡c váº¥n Ä‘á» vá» kÃ­ch thÆ°á»›c dá»¯ liá»‡u</h2>
<p>Váº¥n Ä‘á» kÃ­ch thÆ°á»›c dá»¯ liá»‡u áº£nh hÆ°á»Ÿng khÃ¡ nhiá»u Ä‘áº¿n váº­n hÃ nh má»™t há»‡ thá»‘ng MySQL Replication. Dá»¯ liá»‡u lá»›n thÃ¬ quÃ¡ trÃ¬nh replication Ä‘áº§u tiÃªn hoáº·c khi há»ng replication sáº½ ráº¥t lÃ¢u =&gt; Slave khÃ´ng thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c trong thá»i gian replication, Ä‘áº¿n khi <code>Second_Behind_Master</code> = 0 thÃ¬ má»›i cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘Æ°á»£c.</p>
<p>NgoÃ i ra cÃ¡c yáº¿u tá»‘ vá» á»• Ä‘Ä©a cá»©ng (SSD, tá»‘c Ä‘á»™ Ä‘á»c ghi) cÅ©ng áº£nh hÆ°á»Ÿng nhiá»u Ä‘áº¿n viá»‡c import hoáº·c apply cÃ¡c binlog tá»« Master</p>
<p>DÆ°á»›i Ä‘Ã¢y lÃ  má»™t mÃ´ táº£ thá»±c táº¿:</p>
<ul>
<li>Dá»¯ liá»‡u thÃ´ /var/lib/mysql cÃ³ kÃ­ch thÆ°á»›c 80-100GB</li>
<li>Dá»¯ liá»‡u dump ra chÆ°a nÃ©n 18-30GB</li>
<li>Dá»¯ liá»‡u nÃ©n báº±ng chuáº©n tgz ~ 2-3GB</li>
<li>MÃ¡y chá»§ 24 core, 32GB RAM, SSD Plextor M6 PRO (4x256, RAID 10)</li>
<li>Thá»i gian dump dá»¯ liá»‡u lÃ  1h-1h30</li>
<li>Thá»i gian sync báº£n dump qua cÃ¡c server (local, port 1Gb) ~ 1h</li>
<li>Thá»i gian import dá»¯ liá»‡u ~1.5h</li>
<li>Thá»i gian <code>Second_Behind_Master</code> sau khi import xong ~ 3600s</li>
</ul>
<h2 id="6-failover">6. Failover</h2>
<p>Má»™t váº¥n Ä‘á» khÃ¡c ngoÃ i chuyá»‡n scale Ä‘Ã³ lÃ  <strong>náº¿u master db cháº¿t thÃ¬ chuyá»‡n gÃ¬ xáº£y ra?</strong>. CÃ³ má»™t sá»‘ mindset mÃ  báº¡n báº¯t buá»™c pháº£i hiá»ƒu khi chá»n giáº£i phÃ¡p replication master-slave Ä‘Ã³ lÃ :</p>
<ul>
<li>QuÃ¡ trÃ¬nh promote 1 Slave thay tháº¿ Master lÃ  thá»§ cÃ´ng, khÃ´ng thá»ƒ tá»± Ä‘á»™ng switch sang slave mÃ  há»‡ thá»‘ng khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬.</li>
<li>Váº«n sáº½ cÃ³ downtime náº¿u master db cháº¿t, tuy nhiÃªn viá»‡c dÃ¹ng slave Ä‘áº£m báº£o thá»i gian downtime tá»‘i thiá»ƒu nháº¥t cÃ³ thá»ƒ.</li>
</ul>
<p>Quay trá»Ÿ láº¡i mÃ´ hÃ¬nh 1 master vÃ  2 slave (gá»i láº§n lÆ°á»£t lÃ  S1 vÃ  S2), ta cáº§n tráº£ lá»i lÃ  náº¿u master cháº¿t thÃ¬ chuyá»‡n gÃ¬ xáº£y ra vá»›i há»‡ thá»‘ng vÃ  cÃ¡ch promote má»™t slave lÃªn thay tháº¿ master lÃ  gÃ¬?</p>
<p>Máº·c Ä‘á»‹nh, Slave váº«n sáº½ cÃ³ binlog, vÃ  binlog nÃ y lÃ  cá»§a riÃªng slave chá»© khÃ´ng giá»‘ng vá»›i binlog cá»§a master (binlog cá»§a master khi Ä‘áº©y qua slave sáº½ thÃ nh relay-log), cÃ³ nghÄ©a lÃ  náº¿u S1 Ä‘áº©y lÃªn lÃ m master thÃ¬ S2 sáº½ khÃ´ng cÃ²n Ä‘á»“ng bá»™ vá»›i S1 ná»¯a vÃ  ta sáº½ cáº§n build láº¡i S2.</p>
<p>Äá»ƒ giáº£i quyáº¿t váº¥n Ä‘á» nÃ y, mysql khuyáº¿n cÃ¡o chÃºng ta báº­t <code>--skip-log-slave-updates</code> trÃªn Slave, chuyá»‡n nÃ y Ä‘áº£m báº£o:</p>
<ul>
<li>Slave váº«n sáº½ cÃ³ binlog nhÆ°ng vá»›i cÃ¡c hÃ nh vi apply relay-log (update dá»¯ liá»‡u nhÆ° master) thÃ¬ slave sáº½ khÃ´ng ghi ra binlog.</li>
<li>Khi master cháº¿t, ta cÃ³ nhu cáº§u promote S1 lÃªn lÃ m master, ta sáº½ cáº§n reset master cá»§a S2 trá» vá» S1, tuy nhiÃªn nhÆ° á»Ÿ trÃªn ta sáº½ cáº§n chá»‰ Ä‘á»‹nh file binlog vÃ  position cá»§a file log, vÃ  do S1 sau khi Ä‘c Ä‘á»•i thÃ nh master thÃ¬ má»›i báº¯t Ä‘áº§u sinh ra binlog, nÃªn trÃªn S2 ta chá»‰ cáº§n trá» vá» file binlog vÃ  position Ä‘áº§u tiÃªn cá»§a S2 lÃ  Ä‘á»§. =&gt; chuyá»‡n nÃ y Ä‘áº£m báº£o ráº±ng S2 sáº½ Ä‘á»“ng bá»™ dá»¯ liá»‡u vá»›i S1.</li>
</ul>
<p>Sau khi viá»‡c promote hoÃ n thÃ nh, ta cÃ³ thá»ƒ cáº­p nháº­t láº¡i á»Ÿ phÃ­a client Ä‘á»‹a chá»‰ cá»§ a S1 vÃ  hoÃ n thÃ nh viá»‡c báº£o trÃ¬ há»‡ thá»‘ng. Tuy nhiÃªn Ä‘á»ƒ Ã½ lÃ  quÃ¡ trÃ¬nh trÃªn lÃ  thá»§ cÃ´ng vÃ  ta váº«n cÃ³ downtime trong quÃ¡ trÃ¬nh promote.</p>
<p>Tuy nhiÃªn, Ä‘iá»u trÃªn chá»‰ Ä‘Ãºng chá»‰ Ä‘Ãºng khi slave sync vá»›i master trÆ°á»›c khi master cháº¿t vá»›i <code>second_behind_master = 0</code>.</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-solutions-switch.html">https://dev.mysql.com/doc/refman/8.0/en/replication-solutions-switch.html</a></p>
<h2 id="7-semi-synchronous">7. Semi-synchronous</h2>
<p>CÃ³ má»™t váº¥n Ä‘á» vá»›i asynchronous Ä‘Ã³ lÃ  náº¿u báº¡n cÃ³ nhu cáº§u Ä‘á»c ngay dá»¯ liá»‡u vá»«a ghi xuá»‘ng thÃ¬ cÃ³ thá»ƒ dá»¯ liá»‡u sáº½ sai, do slave chÆ°a ká»‹p apply dá»¯ liá»‡u tá»« master (lag dá»¯ liá»‡u), cÃ³ 2 cÃ¡ch giáº£i quyáº¿t táº¡m:</p>
<ul>
<li>Vá»›i trÆ°á»ng há»£p vá»«a ghi vÃ  Ä‘á»c liá»n dá»¯ liá»‡u, ta nÃªn dÃ¹ng á»Ÿ master.</li>
<li>DÃ¹ng cÆ¡ cháº¿ semi-synchronous Ä‘á»ƒ giáº£m lag dá»¯ liá»‡u.</li>
</ul>
<p>Semi-synchronous lÃ  má»™t kiá»ƒu lai giá»¯a asynchronous vÃ  synchronous. BÃ¬nh thÆ°á»ng náº¿u xÃ i synchronous thÃ¬ cÃ ng nhiá»u slave thÃ¬ cÃ ng giáº£m tá»‘c Ä‘á»™ ghi dá»¯ liá»‡u, do slave pháº£i committed vÃ  tráº£ lá»i ngÆ°á»£c vá» master. Vá»›i semi-synchronous thÃ¬ master coi nhÆ° ghi thÃ nh cÃ´ng lÃ  khi cÃ³ tá»‘i thiá»ƒu má»™t slave <strong>Ä‘Ã£ nháº­n</strong> vÃ  <strong>ghi ra relay log</strong> event mÃ  master gá»­i qua. Äiá»ƒm khÃ¡c biá»‡t lÃ  khÃ´ng cáº§n táº¥t cáº£ cÃ¡c slave gá»­i tÃ­n hiá»‡u ngÆ°á»£c láº¡i master, vÃ  event cÅ©ng khÃ´ng báº¯t buá»™c pháº£i Ä‘Æ°á»£c execute vÃ  commited trÃªn slave, chá»‰ cáº§n Ä‘áº£m báº£o lÃ  Ä‘Ã£ nháº­n vÃ  ghi ra relay log lÃ  Ä‘á»§.</p>
<p>NhÆ° mÃ´ táº£ á»Ÿ trÃªn thÃ¬ slave váº«n cÃ³ thá»ƒ khÃ´ng cÃ³ dá»¯ liá»‡u náº¿u relay log bá»‹ tÃ¡c Ä‘á»™ng vá»›i con ngÆ°á»i, hoáº·c server bá»‹ há»ng ngay khi chÆ°a ká»‹p apply relay log, tuy nhiÃªn nhá» viá»‡c Ä‘áº£m báº£o binlog event Ä‘Ã£ Ä‘c nháº­n vá»›i slave vÃ  ghi xuá»‘ng Ä‘Ä©a Ä‘Ã£ lÃ m giáº£m thá»i gian delay vÃ  váº¥n Ä‘á» vá» data race condition cÃ³ thá»ƒ Ä‘Æ°á»£c háº¡n cháº¿ pháº§n nÃ o.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/docker-eco-system/">
                  <span class="button__icon">â†</span>
                  <span class="button__text">Docker Ecosystem</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
