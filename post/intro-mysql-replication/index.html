<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        Intro MySQL replication ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="1. Gi·ªõi thi·ªáu Right tool for right job."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/post/intro-mysql-replication/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Intro MySQL replication"/>
<meta name="twitter:description" content="1. Gi·ªõi thi·ªáu Right tool for right job."/>



<meta property="og:title" content="Intro MySQL replication" />
<meta property="og:description" content="1. Gi·ªõi thi·ªáu Right tool for right job." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/post/intro-mysql-replication/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-09-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2015-09-01T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft üçÑ</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">Intro MySQL replication</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2015-09-01
        </span>

        
          
        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/mysql/">#mysql</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/replication/">#replication</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h1 id="1-gi·ªõi-thi·ªáu">1. Gi·ªõi thi·ªáu</h1>
<p>Right tool for right job. Tr∆∞·ªõc ti√™n ph·∫£i hi·ªÉu l√† MySQL Replication kh√¥ng ph·∫£i l√† gi·∫£i ph√°p gi·∫£i quy·∫øt m·ªçi b√†i to√°n v·ªÅ qu√° t·∫£i h·ªá th·ªëng c∆° s·ªü d·ªØ li·ªáu. ƒê·ªÉ m·ªü r·ªông m·ªôt h·ªá th·ªëng ta c√≥ hai ph∆∞∆°ng ph√°p m·ªü r·ªông l√† scale up v√† scale out. B·∫Øt ƒë·∫ßu v·ªõi 1 m√°y ch·ªß th√¨ hai ph∆∞∆°ng ph√°p tr√™n ƒë∆∞·ª£c di·ªÖn gi·∫£i nh∆∞ sau:</p>
<p>Scale up c√≥ nghƒ©a l√† v·ªõi m·ªôt m√°y ch·ªß ta l√†m c√°ch n√†o ƒë√≥ ƒë·ªÉ n√≥ c√≥ th·ªÉ ph·ª•c v·ª• nhi·ªÅu h∆°n s·ªë l∆∞·ª£ng k·∫øt n·ªëi, truy v·∫•n. Nghƒ©a l√† gi√° tr·ªã 1/(s·ªë k·∫øt n·ªëi ph·ª•c v·ª•) c√†ng nh·ªè th√¨ c√†ng t·ªët. ƒê·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ƒë√≠ch n√†y th√¨ c√≥ 2 ph∆∞∆°ng ph√°p:</p>
<ul>
<li>TƒÉng ph·∫ßn c·ª©ng l√™n cho m√°y ch·ªß. Nghƒ©a l√† v·ªõi CPU l√† 4 core, RAM l√† 8 GB ph·ª•c v·ª• ƒë∆∞·ª£c 500 truy v·∫•n th√¨ gi·ªù ta tƒÉng CPU l√™n 24 core, RAM tƒÉng l√™n 32GB -&gt; m√°y ch·ªß c√≥ th·ªÉ ph·ª•c v·ª• ƒë∆∞·ª£c s·ªë l∆∞·ª£ng k·∫øt n·ªëi truy v·∫•n nhi·ªÅu h∆°n.</li>
<li>Optimize ·ª©ng d·ª•ng, c√¢u truy v·∫•n. V√≠ d·ª• v·ªõi c√¢u truy v·∫•n l·∫•y d·ªØ li·ªáu t·ªën 5s ƒë·ªÉ l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu, sau ƒë√≥ m·ªõi tr·∫£ l·∫°i t√†i nguy√™n cho h·ªá th·ªëng ph·ª•c v·ª• c√°c truy v·∫•n kh√°c. M√°y ch·ªß c√≥ th·ªÉ ƒë·ªìng th·ªùi ph·ª•c v·ª• 500 truy v·∫•n d·∫°ng nh∆∞ v·∫≠y th√¨ n·∫øu ta t·ªëi ∆∞u ƒë·ªÉ truy v·∫•n l·∫•y d·ªØ li·ªáu ch·ªâ t·ªën 1s =&gt; M√°y ch·ªß c√≥ th·ªÉ ph·ª•c v·ª• ƒë·ªìng th·ªùi nhi·ªÅu truy v·∫•n h∆°n</li>
</ul>
<p>Scale out l√† gi·∫£i ph√°p tƒÉng s·ªë l∆∞·ª£ng server v√† d√πng c√°c gi·∫£i ph√°p load-balacer ƒë·ªÉ ph√¢n ph·ªëi truy v·∫•n ra nhi·ªÅu server. V√≠ d·ª• b·∫°n c√≥ 1 server c√≥ kh·∫£ nƒÉng ph·ª•c v·ª• 500 truy v·∫•n. N·∫øu ta d·ª±ng th√™m 5 server n·ªØa c√≥ c·∫•u h√¨nh t∆∞∆°ng t·ª±, ƒë·∫∑t th√™m m·ªôt LB ph√≠a tr∆∞·ªõc ƒë·ªÉ ph√¢n ph·ªëi th√¨ c√≥ kh·∫£ nƒÉng h·ªá th·ªëng c√≥ th·ªÉ ph·ª•c v·ª• ƒëc 5x500 truy v·∫•n ƒë·ªìng th·ªùi.</p>
<p>MySQL Replication l√† m·ªôt gi·∫£i ph√°p scale out (tƒÉng s·ªë l∆∞·ª£ng instance MySQL) nh∆∞ng kh√¥ng ph·∫£i b√†i to√°n n√†o c≈©ng d√πng ƒë∆∞·ª£c. C√°c b√†i to√°n m√† MySQL Replication s·∫Ω gi·∫£i quy·∫øt t·ªët:</p>
<ul>
<li>Scale Read</li>
<li>Data Report</li>
<li>Real time backup</li>
</ul>
<h2 id="11-scale-read">1.1 Scale Read</h2>
<p>Scale Read th∆∞·ªùng g·∫∑p ·ªü c√°c ·ª©ng d·ª•ng m√† s·ªë truy v·∫•n ƒë·ªçc d·ªØ li·ªáu nhi·ªÅu h∆°n ghi, t·ªâ l·ªá read/write c√≥ th·ªÉ 80/20 ho·∫∑c h∆°n. C√°c ·ª©ng d·ª•ng th∆∞·ªùng g·∫∑p l√† b√°o, trang tin t·ª©c.</p>
<p>V·ªõi scale read ta s·∫Ω ch·ªâ c√≥ m·ªôt Master instance ph·ª•c v·ª• cho vi·ªác ƒë·ªçc/ghi d·ªØ li·ªáu. C√≥ th·ªÉ c√≥ m·ªôt ho·∫∑c nhi·ªÅu Slave instance ch·ªâ ph·ª•c v·ª• cho vi·ªác ƒë·ªçc d·ªØ li·ªáu</p>
<p>M·ªôt s·ªë ·ª©ng d·ª•ng write nhi·ªÅu (th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠) c≈©ng c√≥ s·ª≠ d·ª•ng MySQL Replication ƒë·ªÉ scale out h·ªá th·ªëng</p>
<h2 id="12-data-report">1.2 Data Report</h2>
<p>M·ªôt s·ªë h·ªá th·ªëng cho ph√©p m·ªôt s·ªë ng∆∞·ªùi (leader, manager, ng∆∞·ªùi l√†m report, th·ªëng k√™, data) truy c·∫≠p v√†o d·ªØ li·ªáu tr√™n production ph·ª•c v·ª• cho c√¥ng vi·ªác c·ªßa h·ªç. Vi·ªác ch·ªçc th·∫≥ng v√†o data production s·∫Ω r·∫•t nguy hi·ªÉm v√¨:</p>
<ul>
<li>V√¥ t√¨nh ch·ªânh s·ª≠a l√†m sai l·ªánh d·ªØ li·ªáu (n·∫øu c√≥ quy·ªÅn insert, update)</li>
<li>V√¥ t√¨nh th·ª±c thi c√°c c√¢u truy v·∫•n t·ªën nhi·ªÅu t√†i nguy√™n, th·ªùi gian truy v·∫•n d√†i l√†m treo h·ªá th·ªëng</li>
</ul>
<p>Vi·ªác setup m·ªôt m√°y ch·ªß l√†m data report (application c≈©ng s·∫Ω kh√¥ng k·∫øt n·ªëi t·ªõi server n√†y) l√†m gi·∫£m thi·ªÉu 2 r·ªßi ro tr√™n</p>
<h2 id="13-real-time-backup">1.3 Real time backup</h2>
<p>V·ªõi c∆° s·ªü d·ªØ li·ªáu l·ªõn vi·ªác backup kh√¥ng th·ªÉ th·ª±c hi·ªán th∆∞·ªùng xuy√™n ƒë∆∞·ª£c (h√†ng gi·ªù, h√†ng ph√∫t). V·ªõi c√°c ·ª©ng d·ª•ng giao d·ªãch t√†i ch√≠nh, thanh to√°n, TMDT n·∫øu b·ªã m·∫•t d·ªØ li·ªáu 1 gi·ªù, 1 ng√†y th√¨ thi·ªát h·∫°i s·∫Ω r·∫•t l·ªõn (m√°y ch·ªß ch√≠nh t∆∞ d∆∞ng b·ªã h·ªèng). Real time backup l√† m·ªôt gi·∫£i ph√°p b·ªï sung cho offline backup, ch·∫°y ƒë·ªìng th·ªùi c·∫£ 2 ph∆∞∆°ng ph√°p n√†y ƒë·ªÉ b·∫£o ƒë·∫£m s·ª± an to√†n cho d·ªØ li·ªáu.</p>
<p>Tuy nhi√™n, vi·ªác d√πng replicate ƒë·ªÉ backup d·ªØ li·ªáu ch·ªâ ƒë·∫£m b·∫£o n·∫øu ƒëƒ©a c·ª©ng c·ªßa master b·ªã h·ªèng, trong tr∆∞·ªùng h·ª£p human error khi x√≥a nh·∫ßm d·ªØ li·ªáu, h√†nh ƒë·ªông x√≥a s·∫Ω ƒë∆∞·ª£c replicate sang slave lu√¥n =&gt; v·∫´n b·ªã m·∫•t d·ªØ li·ªáu.</p>
<p>ƒê·ªÉ tr√°nh x·∫£y ra tr∆∞·ªùng h·ª£p tr√™n v√† gi·∫£m thi·ªÉu r·ªßi ro m·∫•t d·ªØ li·ªáu, m√¨nh c√≥ gi·ªõi thi·ªáu m·ªôt b√†i kh√°c <a href="https://xluffy.github.io/post/delayed-replication-in-mysql/">delay-replication</a>.</p>
<h1 id="2-ho·∫°t-ƒë·ªông-nh∆∞-th·∫ø-n√†o">2. Ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?</h1>
<h2 id="21-m·ªôt-s·ªë-m√¥-h√¨nh">2.1 M·ªôt s·ªë m√¥ h√¨nh</h2>
<p align="center"><img src="https://i.imgur.com/mevNr10.png" alt="mysql-replication" width="65%"/></p>
<p>V·ªõi c·∫£ hai m√¥ h√¨nh ta lu√¥n ch·ªâ c√≥ 1 Master database ph·ª•c v·ª• cho Write d·ªØ li·ªáu, c√≥ th·ªÉ c√≥ m·ªôt ho·∫∑c nhi·ªÅu Slave database. T√πy t·ª´ng m√¥ h√¨nh ta c√≥ th·ªÉ c·∫•u h√¨nh m·ªói web node connect v√†o m·ªôt Slave DB t∆∞∆°ng ·ª©ng ho·∫∑c c√≥ th·ªÉ d√πng m·ªôt LB ƒë·∫∑t tr∆∞·ªõc c·ª•m Slave ƒë·ªÉ LB t·ª± ƒë·ªông ph√¢n ph·ªëi connection v√†o t·ª´ng Slave DB theo thu·∫≠t to√°n c·ªßa LB.</p>
<p align="center"><img src="https://i.imgur.com/etkJXxd.png" alt="mysql-replication-lb" width="65%"/></p>
<h2 id="22-c√°ch-ho·∫°t-ƒë·ªông">2.2 C√°ch ho·∫°t ƒë·ªông</h2>
<p>Tr√™n Master:</p>
<ul>
<li>C√°c k·∫øt n·ªëi t·ª´ web app t·ªõi Master DB s·∫Ω m·ªü m·ªôt <code>Session_Thread</code> khi c√≥ nhu c·∫ßu ghi d·ªØ li·ªáu. <code>Session_Thread</code> s·∫Ω ghi c√°c statement SQL v√†o m·ªôt file binlog (v√≠ d·ª• v·ªõi format c·ªßa binlog l√† statement-based ho·∫∑c mix). Binlog ƒë∆∞·ª£c l∆∞u tr·ªØ trong <code>data_dir</code> (c·∫•u h√¨nh my.cnf) v√† c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•u h√¨nh c√°c th√¥ng s·ªë nh∆∞ k√≠ch th∆∞·ªõc t·ªëi ƒëa bao nhi√™u, l∆∞u l·∫°i tr√™n server bao nhi√™u ng√†y.</li>
<li>Master DB s·∫Ω m·ªü m·ªôt <code>Dump_Thread</code> v√† g·ª≠i binlog t·ªõi cho <code>I/O_Thread</code> m·ªói khi <code>I/O_Thread</code> t·ª´ Slave DB y√™u c·∫ßu d·ªØ li·ªáu</li>
</ul>
<p>Tr√™n Slave:</p>
<ul>
<li>Tr√™n m·ªói Slave DB s·∫Ω m·ªü m·ªôt <code>I/O_Thread</code> k·∫øt n·ªëi t·ªõi Master DB th√¥ng qua network, giao th·ª©c TCP (v·ªõi MySQL 5.5 replication ch·ªâ h·ªó tr·ª£ <code>Single_Thread</code> n√™n m·ªói Slave DB s·∫Ω ch·ªâ m·ªü duy nh·∫•t m·ªôt k·∫øt n·ªëi t·ªõi Master DB, c√°c phi√™n b·∫£n sau 5.6, 5.7 h·ªó tr·ª£ m·ªü ƒë·ªìng th·ªùi nhi·ªÅu k·∫øt n·ªëi h∆°n) ƒë·ªÉ y√™u c·∫ßu binlog.</li>
<li>Sau khi <code>Dump_Thread</code> g·ª≠i binlog t·ªõi <code>I/O_Thead</code>, <code>I/O_Thread</code> s·∫Ω c√≥ nhi·ªám v·ª• ƒë·ªçc binlog n√†y v√† ghi v√†o relaylog.</li>
<li>ƒê·ªìng th·ªùi tr√™n Slave s·∫Ω m·ªü m·ªôt <code>SQL_Thread</code>, <code>SQL_Thread</code> c√≥ nhi·ªám v·ª• ƒë·ªçc c√°c event t·ª´ relaylog v√† apply c√°c event ƒë√≥ v√†o Slave =&gt; qu√° tr√¨nh replication ho√†n th√†nh.</li>
</ul>
<p align="center"><img src="https://i.imgur.com/RLAnddr.jpg" alt="mysql-replication-arch" width="85%"/></p>
<p>V·ªÅ logic m·ªói Slave DB s·∫Ω ch·ªâ nh·∫≠n d·ªØ li·ªáu t·ª´ Master DB, m·ªçi h√†nh ƒë·ªông c·∫≠p nh·∫≠t d·ªØ li·ªáu <strong>B·∫ÆT BU·ªòC</strong> ph·∫£i ƒë∆∞·ª£c th·ª±c hi·ªán tr√™n Master. V·ªÅ nguy√™n t·∫Øc n·∫øu ghi d·ªØ li·ªáu tr·ª±c ti·∫øp l√™n Slave DB =&gt; h·ªèng replication. Nh∆∞ng th·ª±c ch·∫•t ta ho√†n to√†n c√≥ th·ªÉ ghi d·ªØ li·ªáu tr√™n Slave mi·ªÖn sao khi Slave ƒë·ªçc binlog v√† apply kh√¥ng ƒë·ª•ng g√¨ t·ªõi nh·ªØng tr∆∞·ªùng d·ªØ li·ªáu m√† ta m·ªõi ghi v√†o th√¨ s·∫Ω kh√¥ng b·ªã l·ªói (m·ª•c n√†y s·∫Ω n√≥i th√™m ·ªü c√°c ph·∫ßn sau)</p>
<p>V·ªõi MySQL 5.5 th√¨ m·ªói slave s·∫Ω ch·ªâ c√≥ m·ªôt <code>slave_thread</code> connect t·ªõi Master, tuy nhi√™n t·ª´ phi√™n b·∫£n 5.6 ch√∫ng ta c√≥ th·ªÉ c·∫•u h√¨nh nhi·ªÅu <code>slave_thread</code> ƒë·ªÉ vi·ªác apply bin log t·ªõi c√°c slave nhanh h∆°n.</p>
<h1 id="3-h∆∞·ªõng-d·∫´n-c√†i-ƒë·∫∑t-v√†-c·∫•u-h√¨nh">3. H∆∞·ªõng d·∫´n c√†i ƒë·∫∑t v√† c·∫•u h√¨nh</h1>
<h3 id="m√¥-h√¨nh">M√¥ h√¨nh:</h3>
<ul>
<li>Master DB: 172.17.0.1</li>
<li>Slave DB: 172.17.0.2</li>
</ul>
<h3 id="tr√™n-master-db">Tr√™n Master DB</h3>
<p>C·∫•u h√¨nh my.cnf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">event-scheduler <span style="color:#f92672">=</span> on
bind-address <span style="color:#f92672">=</span> 172.17.0.1
server-id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>

log-bin
binlog-format<span style="color:#f92672">=</span>row
binlog-do-db<span style="color:#f92672">=</span>dwh_prod
binlog-ignore-db<span style="color:#f92672">=</span>mysql
binlog-ignore-db<span style="color:#f92672">=</span>test

sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><p>T·∫°o user replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">GRANT</span> REPLICATION SLAVE <span style="color:#66d9ef">ON</span> <span style="color:#f92672">*</span>.<span style="color:#f92672">*</span> <span style="color:#66d9ef">TO</span> <span style="color:#e6db74">&#39;slave_user&#39;</span><span style="color:#f92672">@</span><span style="color:#e6db74">&#39;172.16.0.2&#39;</span> IDENTIFIED <span style="color:#66d9ef">BY</span> <span style="color:#e6db74">&#39;p@ssword&#39;</span>;
FLUSH <span style="color:#66d9ef">PRIVILEGES</span>;
</code></pre></div><p>T·∫°o schema, d·ªØ li·ªáu ƒë·ªÉ test</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">SCHEMA</span> dwh_prod CHARACTER <span style="color:#66d9ef">SET</span> utf8 <span style="color:#66d9ef">COLLATE</span> utf8_general_ci;

<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb1 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;
 
<span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb2 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

<span style="color:#66d9ef">SHOW</span> TABLES;
</code></pre></div><h3 id="tr√™n-slave-db">Tr√™n Slave DB</h3>
<p>C·∫•u h√¨nh my.cnf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">event_scheduler<span style="color:#f92672">=</span>off
bind-address <span style="color:#f92672">=</span> 172.17.0.2
server-id<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>

log-bin
binlog-format<span style="color:#f92672">=</span>row
binlog-do-db<span style="color:#f92672">=</span>dwh_prod
binlog-ignore-db<span style="color:#f92672">=</span>mysql
binlog-ignore-db<span style="color:#f92672">=</span>test

transaction-isolation<span style="color:#f92672">=</span>read-committed
sync_binlog<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
expire_logs_days<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><h3 id="t·∫°o-replication-v√†-ki·ªÉm-tra">T·∫°o replication v√† ki·ªÉm tra</h3>
<p>Nguy√™n t·∫Øc khi t·∫°o replication l√† ph·∫£i LOCK t·∫•t c·∫£ c√°c table tr√™n Master DB, ƒë·ªÉ d·ªØ li·ªáu kh√¥ng thay ƒë·ªïi, sau ƒë√≥ x√°c ƒë·ªãnh binlog v√† position, 2 th√¥ng s·ªë d√πng ƒë·ªÉ c·∫•u h√¨nh tr√™n Slave x√°c ƒë·ªãnh ƒëo·∫°n d·ªØ li·ªáu b·∫Øt ƒë·∫ßu ƒë·ªìng b·ªô</p>
<p>Tr√™n Master DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">FLUSH TABLES <span style="color:#66d9ef">WITH</span> <span style="color:#66d9ef">READ</span> <span style="color:#66d9ef">LOCK</span>;
<span style="color:#66d9ef">SHOW</span> MASTER STATUS;

<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> File           <span style="color:#f92672">|</span> <span style="color:#66d9ef">Position</span> <span style="color:#f92672">|</span> Binlog_Do_DB <span style="color:#f92672">|</span> Binlog_Ignore_DB <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span> <span style="color:#f92672">|</span>      <span style="color:#ae81ff">827</span> <span style="color:#f92672">|</span> dwh_prod     <span style="color:#f92672">|</span> mysql,test       <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">----------------+----------+--------------+------------------+
</span></code></pre></div><p>Gi√° tr·ªã c·∫ßn quan t√¢m l√†</p>
<ul>
<li>m01-bin.000001</li>
<li>827</li>
</ul>
<p>Sau ƒë√≥ ta s·∫Ω dump d·ªØ li·ªáu t·ª´ Master DB v√† ƒë·∫©y qua Slave DB (sau khi dump xong c√≥ th·ªÉ <code>UNLOCK TABLES;</code> ƒë·ªÉ Master DB c√≥ th·ªÉ ho·∫°t ƒë·ªông l·∫°i).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysqldump -uroot -p dwh_prod &gt; dwh_prod_03072015.sql
rsync -avz -P -e<span style="color:#e6db74">&#39;ssh&#39;</span> dwh_prod_03072015.sql root@172.17.0.2:/root/
</code></pre></div><p>Tr√™n Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>uroot <span style="color:#f92672">-</span>p dwh_prod <span style="color:#f92672">&lt;</span> <span style="color:#f92672">/</span>root<span style="color:#f92672">/</span>dwh_prod_03072015.<span style="color:#66d9ef">sql</span>

<span style="color:#f92672">&gt;</span> CHANGE MASTER <span style="color:#66d9ef">TO</span> MASTER_HOST<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;172.17.0.1&#39;</span>,MASTER_USER<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;slave_user&#39;</span>, MASTER_PASSWORD<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;p@ssword&#39;</span>, MASTER_LOG_FILE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;m01-bin.000001&#39;</span>, MASTER_LOG_POS<span style="color:#f92672">=</span><span style="color:#ae81ff">827</span>;
<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">START</span> SLAVE
<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> SLAVE STATUS<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">G</span>
</code></pre></div><p>M·ªôt s·ªë th√¥ng tin ƒë√£ ƒë∆∞·ª£c l∆∞·ª£c b·ªè cho d·ªÖ nh√¨n</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#f92672">***************************</span> <span style="color:#ae81ff">1</span>. <span style="color:#66d9ef">row</span> <span style="color:#f92672">***************************</span>
               Slave_IO_State: Waiting <span style="color:#66d9ef">for</span> master <span style="color:#66d9ef">to</span> send event
                  Master_Host: <span style="color:#ae81ff">172</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">1</span>
                  Master_User: slave_user
              Master_Log_File: m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span>
          Read_Master_Log_Pos: <span style="color:#ae81ff">827</span>
               Relay_Log_File: m02<span style="color:#f92672">-</span>relay<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000002</span>
                Relay_Log_Pos: <span style="color:#ae81ff">251</span>
        Relay_Master_Log_File: m01<span style="color:#f92672">-</span>bin.<span style="color:#ae81ff">000001</span>
                   Last_Errno: <span style="color:#ae81ff">0</span>
                   Last_Error: 
                 Skip_Counter: <span style="color:#ae81ff">0</span>
          Exec_Master_Log_Pos: <span style="color:#ae81ff">827</span>
              Relay_Log_Space: <span style="color:#ae81ff">405</span>
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Errno: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Errno: <span style="color:#ae81ff">0</span>
               Last_SQL_Error: 
             Master_Server_Id: <span style="color:#ae81ff">1</span>
</code></pre></div><p>C√°c th√¥ng s·ªë c·∫ßn quan t√¢m l√†</p>
<ul>
<li><code>Last_Error: 0</code></li>
<li><code>Last_SQL_Error</code></li>
<li><code>Seconds_Behind_Master: 0</code></li>
</ul>
<p>Hai th√¥ng s·ªë ƒë·∫ßu ti√™n l√† l·ªói khi Slave DB th·ª±c thi c√°c event ƒë·ªçc t·ª´ relay log. Th√¥ng s·ªë <code>Seconds_Behind_Master</code> cho ta bi·∫øt d·ªØ li·ªáu c·ªßa Slave DB ƒëang b·ªã <strong>tr·ªÖ</strong> (delay, lag) bao nhi√™u gi√¢y so v·ªõi Master DB. C√°c ph·∫ßn sau ta s·∫Ω n√≥i k·ªπ h∆°n v·ªÅ replication lag n√†y.</p>
<h1 id="4-v·∫≠n-h√†nh-h·ªá-th·ªëng-mysql-replicatione">4. V·∫≠n h√†nh h·ªá th·ªëng MySQL Replicatione</h1>
<h2 id="41-test-logic-replication">4.1 Test logic replication</h2>
<p>·ªû tr·∫°ng th√°i b√¨nh th∆∞·ªùng d·ªØ li·ªáu tr√™n Slave DB ƒë√£ ƒë·ªìng b·ªô v·ªõi Master DB. Ki·ªÉm tra</p>
<p>Tr√™n Master</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> USE dwh_prod
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>Tr√™n Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> USE dwh_prod
mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#f92672">-</span>p <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
                   Last_Error: 
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Error:
</code></pre></div><p>M·ªçi th·ª© ƒë·ªÅu ·ªïn, kh√¥ng l·ªói v√† kh√¥ng c√≥ Lag.</p>
<p>Gi·ªù gi·∫£ s·ª≠ ta s·∫Ω t·∫°o m·ªôt table v·ªõi t√™n l√† tb00 tr√™n Slave v√† ki·ªÉm tra xem c√≥ ƒë√∫ng l√† khi ghi d·ªØ li·ªáu l√™n Slave DB th√¨ replication c√≥ b·ªã h·ªèng hay kh√¥ng.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb00 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb00               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#ae81ff">5</span> <span style="color:#66d9ef">rows</span> <span style="color:#66d9ef">in</span> <span style="color:#66d9ef">set</span> (<span style="color:#ae81ff">0</span>.<span style="color:#ae81ff">00</span> sec)
</code></pre></div><p>Ki·ªÉm tra c√°c table tr√™n Master DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>V√† ki·ªÉm tra l·∫°i tr·∫°ng th√°i c·ªßa replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>                                                                                                   
            Last_Error: 
      Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
            Last_IO_Error: 
            Last_SQL_Error:
</code></pre></div><p>=&gt; Nh∆∞ ta th·∫•y r√µ r√†ng l√† d·ªØ li·ªáu tr√™n Slave v√† Master ƒë√£ kh√°c nhau (Slave c√≥ tb00 nh∆∞ng Master th√¨ kh√¥ng) nh∆∞ng tr·∫°ng th√°i c·ªßa replication v·∫´n ho√†n to√†n ·ªïn.</p>
<p>Gi·ªù ch√∫ng ta s·∫Ω th·ª≠ th√™m m·ªôt tr∆∞·ªùng h·ª£p n·ªØa l√† tr√™n Master ta s·∫Ω t·∫°o m·ªôt table t√™n l√† tb6 ƒë·ªÉ ki·ªÉm tra xem chuy·ªán g√¨ s·∫Ω x·∫£y ra</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb6 (
 id INT,
 <span style="color:#66d9ef">data</span> VARCHAR(<span style="color:#ae81ff">100</span>)
) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8;

mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb6                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>Ki·ªÉm tra c√°c table tr√™n Slave DB</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">SHOW</span> TABLES;
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> Tables_in_dwh_prod <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span><span style="color:#75715e"></span><span style="color:#f92672">|</span> tb00               <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb1                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb2                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb3                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb4                <span style="color:#f92672">|</span>
<span style="color:#f92672">|</span> tb6                <span style="color:#f92672">|</span>
<span style="color:#f92672">+</span><span style="color:#75715e">--------------------+
</span></code></pre></div><p>=&gt; b·∫£ng tb6 ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô t·ª´ Master qua, ki·ªÉm tra tr·∫°ng th√°i replication</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
                   Last_Error: 
        Seconds_Behind_Master: <span style="color:#ae81ff">0</span>
                Last_IO_Error: 
               Last_SQL_Error:
</code></pre></div><p>=&gt; M·ªçi th·ª© v·∫´n ·ªïn, nghƒ©a l√† d√π ta c√≥ ghi d·ªØ li·ªáu v√†o Slave, nh∆∞ng n·∫øu Master th·ª±c thi c√°c c√¢u truy v·∫•n kh√¥ng ƒë·ª•ng g√¨ t·ªõi d·ªØ li·ªáu ƒë∆∞·ª£c ghi m·ªõi ·ªü Slave th√¨ tr·∫°ng th√°i c·ªßa replication v·∫´n ·ªïn.</p>
<p>Gi·ªù ta s·∫Ω th·ª±c hi·ªán th√™m m·ªôt th·ª≠ nghi·ªám n·ªØa l√† tr√™n Master ta t·∫°o m·ªôt table t√™n l√† tb00, tr√πng v·ªõi table ƒë√£ t·∫°o l√∫c tr∆∞·ªõc ·ªü Slave ph√≠a tr√™n v√† ki·ªÉm tra l·∫°i tr·∫°ng th√°i c·ªßa replication</p>
<p>Ki·ªÉm tra tr·∫°ng th√°i replication tr√™n Slave</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">mysql <span style="color:#f92672">-</span>e <span style="color:#e6db74">&#39;SHOW SLAVE STATUS\G&#39;</span> <span style="color:#f92672">|</span> grep <span style="color:#f92672">-</span>i <span style="color:#e6db74">&#39;error\|seconds&#39;</span>
              Last_Error: Error <span style="color:#e6db74">&#39;Table &#39;</span>tb00<span style="color:#e6db74">&#39; already exists&#39;</span> <span style="color:#66d9ef">on</span> query. <span style="color:#66d9ef">Default</span> <span style="color:#66d9ef">database</span>: <span style="color:#e6db74">&#39;dwh_prod&#39;</span>. Query: <span style="color:#e6db74">&#39;CREATE TABLE tb00 (
</span><span style="color:#e6db74">   Seconds_Behind_Master: NULL
</span><span style="color:#e6db74">           Last_IO_Error:
</span><span style="color:#e6db74">          Last_SQL_Error: Error &#39;</span><span style="color:#66d9ef">Table</span> <span style="color:#e6db74">&#39;tb00&#39;</span> already <span style="color:#66d9ef">exists</span><span style="color:#e6db74">&#39; on query. Default database: &#39;</span>dwh_prod<span style="color:#e6db74">&#39;. Query: &#39;</span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> tb00 (
</code></pre></div><p>=&gt; nh∆∞ ta th·∫•y h·ªá th·ªëng b√°o l·ªói do tr√™n Slave kh√¥ng th·ªÉ th·ª±c thi h√†nh ƒë·ªông t·∫°o table tb00 t·ª´ Master ƒë·∫©y xu·ªëng (do table n√†y ƒë√£ t·ªìn t·∫°i tr∆∞·ªõc ƒë√≥)</p>
<p>K·∫øt Lu·∫≠n: Vi·ªác ghi d·ªØ li·ªáu v√†o Slave l√† c√≥ th·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c, nh∆∞ng s·∫Ω g√¢y ra r·ªßi ro h·ªèng replication ·ªü m·ªôt l√∫c n√†o ƒë√≥. Nh·∫•t l√† c√°c c√¢u truy v·∫•n d·∫°ng SELECT &hellip; UPDATE. T·ªët nh·∫•t l√† n√™n tr√°nh ghi d·ªØ li·ªáu v√†o Slave</p>
<h2 id="42-replication-lag">4.2 Replication Lag</h2>
<p><code>Replication Lag</code> l√† ƒë·ªô tr·ªÖ d·ªØ li·ªáu c·ªßa Slave so v·ªõi Master. Khi tri·ªÉn khai m·ªôt h·ªá th·ªëng MySQL Replication th√¨ Lag l√† v·∫•n ƒë·ªÅ ch·∫Øc ch·∫Øn g·∫∑p ph·∫£i. Ta ch·ªâ c√≥ th·ªÉ gi·∫£m thi·ªÉu ƒë·ªô tr·ªÖ d·ªØ li·ªáu trong m·ª©c ch·∫•p nh·∫≠n ƒë∆∞·ª£c ch·ª© kh√¥ng th·ªÉ kh√¥ng c√≥ lag. L√≠ do l√† vi·ªác ƒë·ªìng b·ªô d·ªØ li·ªáu l√† Asynchronous, nghƒ©a l√† c√°c Slave server kh√¥ng c·∫ßn th√¥ng b√°o cho Master bi·∫øt khi transaction th·ª±c hi·ªán tr√™n Slave th√†nh c√¥ng -&gt; ƒëi·ªÅu n√†y gi√∫p gi·ªØ nguy√™n hi·ªáu su·∫•t (kh√°c v·ªõi c∆° ch·∫ø ƒë·ªìng b·ªô synchronous, m·ªôt transaction ƒë∆∞·ª£c g·ªçi l√† th√†nh c√¥ng khi n√≥ committed tr√™n master server v√† master server nh·∫≠n ƒë∆∞·ª£c m·ªôt th√¥ng b√°o t·ª´ slave server l√† transaction n√†y ƒë√£ ƒë∆∞·ª£c write v√† committed. Qu√° tr√¨nh n√†y ƒë·∫£m b·∫£o t√≠nh th·ªëng nh·∫•t gi·ªØa master v√† slave server nh∆∞ng ƒë·ªìng th·ªùi n√≥ l√†m gi·∫£m hi·ªáu su·∫•t ƒëi m·ªôt n·ªØa do c√°c v·∫•n ƒë·ªÅ v·ªÅ network, bandwidth, location.)</p>
<p>V·∫•n ƒë·ªÅ c·ªßa <code>replication lag</code> ·∫£nh h∆∞·ªüng t·ªõi c√°c truy v·∫•n v·ª´a write d·ªØ li·ªáu xu·ªëng l√† read d·ªØ li·ªáu l√™n li·ªÅn. V√≠ d·ª•</p>
<p>M·ªôt trang th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠ c√≥ t√≠nh nƒÉng add v√†o gi·ªè h√†ng m·ªôt s·∫£n ph·∫©m. Sau khi s·∫£n ph·∫©m ƒë∆∞·ª£c add v√†o gi·ªè h√†ng s·∫Ω tr·ª´ s·ªë l∆∞·ª£ng trong t·ªìn kho. 2 user th·ª±c hi·ªán mua s·∫£n ph·∫©m ƒë√≥ (s·∫£n ph·∫©m ƒë√≥ c√≥ s·ªë l∆∞·ª£ng t·ªìn kho l√† 1). C·∫£ 2 ƒë·ªÅu th·∫•y s·∫£n ph·∫©m ƒë√≥ tr√™n website hi·ªÉn th·ªã tr·∫°ng th√°i C√íN H√ÄNG. Khi m·ªôt user mua s·∫£n ph·∫©m ƒë√≥ v√† thanh to√°n th√†nh c√¥ng. Do ƒë·ªô tr·ªÖ d·ªØ li·ªáu (v√≠ d·ª• 5s) n√™n d·ªØ li·ªáu ch∆∞a ƒëc c·∫≠p nh·∫≠t t·ªìn kho xu·ªëng Slave l√† s·∫£n ph·∫©m ƒë√£ h·∫øt h√†ng. Khi user ƒë√≥ add gi·ªè h√†ng v√† thanh to√°n th√¨ l√∫c n√†y d·ªØ li·ªáu m·ªõi c·∫≠p nh·∫≠t v√† tr·∫£ v·ªÅ m√£ l·ªói l√† thanh to√°n kh√¥ng th√†nh c√¥ng do s·ªë l∆∞·ª£ng t·ªìn kho kh√¥ng ƒë√°p ·ª©ng =&gt; ·∫£nh h∆∞·ªüng t·ªõi tr·∫£i nghi·ªám c·ªßa user tr√™n h·ªá th·ªëng.</p>
<p>Th∆∞·ªùng v·ªõi nh·ªØng tr∆∞·ªùng h·ª£p n√†y (truy v·∫•n write xong l√† read li·ªÅn) th√¨ n√™n s·ª≠ d·ª•ng c·∫•u h√¨nh truy v·∫•n tr√™n Master (ƒë√¢y l√† l√≠ do Master c√≥ th·ªÉ v·ª´a write v·ª´a read ch·ª© kh√¥ng nh·∫•t thi·∫øt l√† ch·ªâ c√≥ write)</p>
<h2 id="43-lb-mysql-v√†-healthchk">4.3 Lb mysql v√† healthchk</h2>
<p>Nh∆∞ 1 trong 2 m√¥ h√¨nh ph√≠a tr√™n th√¨ v·ªõi m√¥ h√¨nh th·ª© 2 ta c√≥ th·ªÉ d√πng haproxy l√†m lb cho c√°c MySQL Instance.</p>
<p>V·ªõi m√¥ h√¨nh 1 nh∆∞·ª£c ƒëi·ªÉm l√† n·∫øu MySQL instance b·ªã delay qu√° l√¢u, server qu√° t·∫£i ho·∫∑c r·ªßi ro nh·∫•t l√† instace ƒë√≥ b·ªã down th√¨ ta kh√¥ng c√≥ c√°ch n√†o check ho·∫∑c remove instance ƒë√≥ ra ƒë∆∞·ª£c.</p>
<p>V·ªõi m√¥ h√¨nh 2 nh∆∞·ª£c ƒëi·ªÉm l√† ta m·∫•t th√™m 1 layer (haproxy) n·ªØa m·ªõi c√≥ th·ªÉ k·∫øt n·ªëi t·ªõi MySQL (t·ªën th·ªùi gian, x·ª≠ l√≠ nhi·ªÅu l·ªõp) nh∆∞ng l·ª£i ƒëi·ªÉm l√† c√≥ th·ªÉ c·∫•u h√¨nh healthchk, ho·∫∑c remove instance theo m·ªôt s·ªë ƒëi·ªÅu ki·ªán.</p>
<h1 id="5-m·ªôt-s·ªë-l∆∞u-√Ω">5. M·ªôt s·ªë l∆∞u √Ω</h1>
<h2 id="51-v·∫•n-ƒë·ªÅ-v·ªÅ-server-ph·∫ßn-c·ª©ng">5.1 V·∫•n ƒë·ªÅ v·ªÅ server, ph·∫ßn c·ª©ng</h2>
<p>C√°c v·∫•n ƒë·ªÅ v·ªÅ CPU, RAM, ƒëƒ©a c·ª©ng (k√≠ch th∆∞·ªõc, lo·∫°i ƒëƒ©a c·ª©ng, SSD hay HDD, t·ªëc ƒë·ªô ƒë·ªçc ghi c·ªßa ƒëƒ©a c·ª©ng)</p>
<p>V·ªõi m·ªôt h·ªá th·ªëng DB c√°c th√¥ng s·ªë ph·∫ßn c·ª©ng N√äN quan t√¢m l√†</p>
<ul>
<li>CPU: C√†ng nhi·ªÅu core c√†ng t·ªët, t·ªëc ƒë·ªô c√†ng nhanh c√†ng t·ªët</li>
<li>RAM: RAM c√†ng nhi·ªÅu c√†ng t·ªët</li>
</ul>
<p>V·ªõi ƒëƒ©a c·ª©ng</p>
<ul>
<li>N√™n s·ª≠ d·ª•ng RAID 5, 6, 10</li>
<li>N√™n s·ª≠ d·ª•ng SSD (Enterprise th√¨ c√†ng t·ªët) IOPS c√†ng cao c√†ng t·ªët</li>
<li>ƒêƒ©a c·ª©ng n√™n c√≥ dung l∆∞·ª£ng √≠t nh·∫•t l√† x2 l·∫ßn dung l∆∞·ª£ng c·ªßa CSDL (s·∫Ω c·∫ßn thi·∫øt trong tr∆∞·ªùng h·ª£p dump, backup d·ªØ li·ªáu ƒë·ªÉ fix replication)</li>
</ul>
<p>Kh√°c v·ªõi c√°c ·ª©ng d·ª•ng kh√°c nh∆∞ web, static (th∆∞·ªùng CPU kh√¥ng c·∫ßn nhi·ªÅu core, ƒëƒ©a c·ª©ng kh√¥ng c·∫ßn nhi·ªÅu v√† nhanh), m√°y ch·ªß CSDL s·∫Ω c·∫ßn nhi·ªÅu c√°c th√¥ng s·ªë tr√™n</p>
<p>V·ªõi AWS khi ch·ªçn Instance c≈©ng n√™n ch√∫ √Ω c√°c ƒëi·ªÉm tr√™n</p>
<h2 id="52-c√°c-v·∫•n-ƒë·ªÅ-v·ªÅ-k√≠ch-th∆∞·ªõc-d·ªØ-li·ªáu">5.2 C√°c v·∫•n ƒë·ªÅ v·ªÅ k√≠ch th∆∞·ªõc d·ªØ li·ªáu</h2>
<p>V·∫•n ƒë·ªÅ k√≠ch th∆∞·ªõc d·ªØ li·ªáu ·∫£nh h∆∞·ªüng kh√° nhi·ªÅu ƒë·∫øn v·∫≠n h√†nh m·ªôt h·ªá th·ªëng MySQL Replication. D·ªØ li·ªáu l·ªõn th√¨ qu√° tr√¨nh replication ƒë·∫ßu ti√™n ho·∫∑c khi h·ªèng replication s·∫Ω r·∫•t l√¢u =&gt; Slave kh√¥ng th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c trong th·ªùi gian replication, ƒë·∫øn khi <code>Second_Behind_Master</code> = 0 th√¨ m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c.</p>
<p>Ngo√†i ra c√°c y·∫øu t·ªë v·ªÅ ·ªï ƒëƒ©a c·ª©ng (SSD, t·ªëc ƒë·ªô ƒë·ªçc ghi) c≈©ng ·∫£nh h∆∞·ªüng nhi·ªÅu ƒë·∫øn vi·ªác import ho·∫∑c apply c√°c binlog t·ª´ Master</p>
<p>D∆∞·ªõi ƒë√¢y l√† m·ªôt m√¥ t·∫£ th·ª±c t·∫ø:</p>
<ul>
<li>D·ªØ li·ªáu th√¥ /var/lib/mysql c√≥ k√≠ch th∆∞·ªõc 80-100GB</li>
<li>D·ªØ li·ªáu dump ra ch∆∞a n√©n 18-30GB</li>
<li>D·ªØ li·ªáu n√©n b·∫±ng chu·∫©n tgz ~ 2-3GB</li>
<li>M√°y ch·ªß 24 core, 32GB RAM, SSD Plextor M6 PRO (4x256, RAID 10)</li>
<li>Th·ªùi gian dump d·ªØ li·ªáu l√† 1h-1h30</li>
<li>Th·ªùi gian sync b·∫£n dump qua c√°c server (local, port 1Gb) ~ 1h</li>
<li>Th·ªùi gian import d·ªØ li·ªáu ~1.5h</li>
<li>Th·ªùi gian <code>Second_Behind_Master</code> sau khi import xong ~ 3600s</li>
</ul>
<h2 id="6-failover">6. Failover</h2>
<p>M·ªôt v·∫•n ƒë·ªÅ kh√°c ngo√†i chuy·ªán scale ƒë√≥ l√† <strong>n·∫øu master db ch·∫øt th√¨ chuy·ªán g√¨ x·∫£y ra?</strong>. C√≥ m·ªôt s·ªë mindset m√† b·∫°n b·∫Øt bu·ªôc ph·∫£i hi·ªÉu khi ch·ªçn gi·∫£i ph√°p replication master-slave ƒë√≥ l√†:</p>
<ul>
<li>Qu√° tr√¨nh promote 1 Slave thay th·∫ø Master l√† th·ªß c√¥ng, kh√¥ng th·ªÉ t·ª± ƒë·ªông switch sang slave m√† h·ªá th·ªëng kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨.</li>
<li>V·∫´n s·∫Ω c√≥ downtime n·∫øu master db ch·∫øt, tuy nhi√™n vi·ªác d√πng slave ƒë·∫£m b·∫£o th·ªùi gian downtime t·ªëi thi·ªÉu nh·∫•t c√≥ th·ªÉ.</li>
</ul>
<p>Quay tr·ªü l·∫°i m√¥ h√¨nh 1 master v√† 2 slave (g·ªçi l·∫ßn l∆∞·ª£t l√† S1 v√† S2), ta c·∫ßn tr·∫£ l·ªùi l√† n·∫øu master ch·∫øt th√¨ chuy·ªán g√¨ x·∫£y ra v·ªõi h·ªá th·ªëng v√† c√°ch promote m·ªôt slave l√™n thay th·∫ø master l√† g√¨?</p>
<p>M·∫∑c ƒë·ªãnh, Slave v·∫´n s·∫Ω c√≥ binlog, v√† binlog n√†y l√† c·ªßa ri√™ng slave ch·ª© kh√¥ng gi·ªëng v·ªõi binlog c·ªßa master (binlog c·ªßa master khi ƒë·∫©y qua slave s·∫Ω th√†nh relay-log), c√≥ nghƒ©a l√† n·∫øu S1 ƒë·∫©y l√™n l√†m master th√¨ S2 s·∫Ω kh√¥ng c√≤n ƒë·ªìng b·ªô v·ªõi S1 n·ªØa v√† ta s·∫Ω c·∫ßn build l·∫°i S2.</p>
<p>ƒê·ªÉ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, mysql khuy·∫øn c√°o ch√∫ng ta b·∫≠t <code>--skip-log-slave-updates</code> tr√™n Slave, chuy·ªán n√†y ƒë·∫£m b·∫£o:</p>
<ul>
<li>Slave v·∫´n s·∫Ω c√≥ binlog nh∆∞ng v·ªõi c√°c h√†nh vi apply relay-log (update d·ªØ li·ªáu nh∆∞ master) th√¨ slave s·∫Ω kh√¥ng ghi ra binlog.</li>
<li>Khi master ch·∫øt, ta c√≥ nhu c·∫ßu promote S1 l√™n l√†m master, ta s·∫Ω c·∫ßn reset master c·ªßa S2 tr·ªè v·ªÅ S1, tuy nhi√™n nh∆∞ ·ªü tr√™n ta s·∫Ω c·∫ßn ch·ªâ ƒë·ªãnh file binlog v√† position c·ªßa file log, v√† do S1 sau khi ƒëc ƒë·ªïi th√†nh master th√¨ m·ªõi b·∫Øt ƒë·∫ßu sinh ra binlog, n√™n tr√™n S2 ta ch·ªâ c·∫ßn tr·ªè v·ªÅ file binlog v√† position ƒë·∫ßu ti√™n c·ªßa S2 l√† ƒë·ªß. =&gt; chuy·ªán n√†y ƒë·∫£m b·∫£o r·∫±ng S2 s·∫Ω ƒë·ªìng b·ªô d·ªØ li·ªáu v·ªõi S1.</li>
</ul>
<p>Sau khi vi·ªác promote ho√†n th√†nh, ta c√≥ th·ªÉ c·∫≠p nh·∫≠t l·∫°i ·ªü ph√≠a client ƒë·ªãa ch·ªâ c·ªß a S1 v√† ho√†n th√†nh vi·ªác b·∫£o tr√¨ h·ªá th·ªëng. Tuy nhi√™n ƒë·ªÉ √Ω l√† qu√° tr√¨nh tr√™n l√† th·ªß c√¥ng v√† ta v·∫´n c√≥ downtime trong qu√° tr√¨nh promote.</p>
<p>Tuy nhi√™n, ƒëi·ªÅu tr√™n ch·ªâ ƒë√∫ng ch·ªâ ƒë√∫ng khi slave sync v·ªõi master tr∆∞·ªõc khi master ch·∫øt v·ªõi <code>second_behind_master = 0</code>.</p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/replication-solutions-switch.html">https://dev.mysql.com/doc/refman/8.0/en/replication-solutions-switch.html</a></p>
<h2 id="7-semi-synchronous">7. Semi-synchronous</h2>
<p>C√≥ m·ªôt v·∫•n ƒë·ªÅ v·ªõi asynchronous ƒë√≥ l√† n·∫øu b·∫°n c√≥ nhu c·∫ßu ƒë·ªçc ngay d·ªØ li·ªáu v·ª´a ghi xu·ªëng th√¨ c√≥ th·ªÉ d·ªØ li·ªáu s·∫Ω sai, do slave ch∆∞a k·ªãp apply d·ªØ li·ªáu t·ª´ master (lag d·ªØ li·ªáu), c√≥ 2 c√°ch gi·∫£i quy·∫øt t·∫°m:</p>
<ul>
<li>V·ªõi tr∆∞·ªùng h·ª£p v·ª´a ghi v√† ƒë·ªçc li·ªÅn d·ªØ li·ªáu, ta n√™n d√πng ·ªü master.</li>
<li>D√πng c∆° ch·∫ø semi-synchronous ƒë·ªÉ gi·∫£m lag d·ªØ li·ªáu.</li>
</ul>
<p>Semi-synchronous l√† m·ªôt ki·ªÉu lai gi·ªØa asynchronous v√† synchronous. B√¨nh th∆∞·ªùng n·∫øu x√†i synchronous th√¨ c√†ng nhi·ªÅu slave th√¨ c√†ng gi·∫£m t·ªëc ƒë·ªô ghi d·ªØ li·ªáu, do slave ph·∫£i committed v√† tr·∫£ l·ªùi ng∆∞·ª£c v·ªÅ master. V·ªõi semi-synchronous th√¨ master coi nh∆∞ ghi th√†nh c√¥ng l√† khi c√≥ t·ªëi thi·ªÉu m·ªôt slave <strong>ƒë√£ nh·∫≠n</strong> v√† <strong>ghi ra relay log</strong> event m√† master g·ª≠i qua. ƒêi·ªÉm kh√°c bi·ªát l√† kh√¥ng c·∫ßn t·∫•t c·∫£ c√°c slave g·ª≠i t√≠n hi·ªáu ng∆∞·ª£c l·∫°i master, v√† event c≈©ng kh√¥ng b·∫Øt bu·ªôc ph·∫£i ƒë∆∞·ª£c execute v√† commited tr√™n slave, ch·ªâ c·∫ßn ƒë·∫£m b·∫£o l√† ƒë√£ nh·∫≠n v√† ghi ra relay log l√† ƒë·ªß.</p>
<p>Nh∆∞ m√¥ t·∫£ ·ªü tr√™n th√¨ slave v·∫´n c√≥ th·ªÉ kh√¥ng c√≥ d·ªØ li·ªáu n·∫øu relay log b·ªã t√°c ƒë·ªông v·ªõi con ng∆∞·ªùi, ho·∫∑c server b·ªã h·ªèng ngay khi ch∆∞a k·ªãp apply relay log, tuy nhi√™n nh·ªù vi·ªác ƒë·∫£m b·∫£o binlog event ƒë√£ ƒëc nh·∫≠n v·ªõi slave v√† ghi xu·ªëng ƒëƒ©a ƒë√£ l√†m gi·∫£m th·ªùi gian delay v√† v·∫•n ƒë·ªÅ v·ªÅ data race condition c√≥ th·ªÉ ƒë∆∞·ª£c h·∫°n ch·∫ø ph·∫ßn n√†o.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://taoquangne.com/post/docker-eco-system/">
                  <span class="button__icon">‚Üê</span>
                  <span class="button__text">Docker Ecosystem</span>
                </a>
              </span>
            
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> h√†ng nh√† tr·ªìng üå¥ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">gi·∫•y ph√©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
