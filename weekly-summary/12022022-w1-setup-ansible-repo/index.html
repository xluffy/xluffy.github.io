<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        12/02/2022 - Week 1 - Setup Ansible repo ::
        /home/xluffy
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Trong khi tháº¿ giá»›i Ä‘Ã£ thay Ä‘á»•i ráº¥t nhiá»u, cÃ¡ch váº­n hÃ nh há»‡ thá»‘ng cÅ©ng Ä‘Ã£ thay Ä‘á»•i so vá»›i 10 nÄƒm vá» trÆ°á»›c, thÃ¬ tui váº«n xÃ i nhá»¯ng thá»© gá»i lÃ  boring-tech vÃ  xÃ i ráº¥t nhiá»u trong nhiá»u dá»± Ã¡n ká»ƒ cáº£ cÃ¡ nhÃ¢n láº«n cÃ´ng viá»‡c vÃ  má»™t trong sá»‘ Ä‘Ã³ lÃ  Ansible Ä‘á»ƒ quáº£n trá»‹ há»‡ thá»‘ng."
/>
<meta
  name="keywords"
  content=""
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://taoquangne.com/weekly-summary/12022022-w1-setup-ansible-repo/" />





<link rel="stylesheet" href="https://taoquangne.com/assets/style.css" />

<link rel="stylesheet" href="https://taoquangne.com/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="https://taoquangne.com/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="https://taoquangne.com/img/favicon.png" />


<link href="https://taoquangne.com/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="https://taoquangne.com/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="12/02/2022 - Week 1 - Setup Ansible repo"/>
<meta name="twitter:description" content="Trong khi tháº¿ giá»›i Ä‘Ã£ thay Ä‘á»•i ráº¥t nhiá»u, cÃ¡ch váº­n hÃ nh há»‡ thá»‘ng cÅ©ng Ä‘Ã£ thay Ä‘á»•i so vá»›i 10 nÄƒm vá» trÆ°á»›c, thÃ¬ tui váº«n xÃ i nhá»¯ng thá»© gá»i lÃ  boring-tech vÃ  xÃ i ráº¥t nhiá»u trong nhiá»u dá»± Ã¡n ká»ƒ cáº£ cÃ¡ nhÃ¢n láº«n cÃ´ng viá»‡c vÃ  má»™t trong sá»‘ Ä‘Ã³ lÃ  Ansible Ä‘á»ƒ quáº£n trá»‹ há»‡ thá»‘ng."/>



<meta property="og:title" content="12/02/2022 - Week 1 - Setup Ansible repo" />
<meta property="og:description" content="Trong khi tháº¿ giá»›i Ä‘Ã£ thay Ä‘á»•i ráº¥t nhiá»u, cÃ¡ch váº­n hÃ nh há»‡ thá»‘ng cÅ©ng Ä‘Ã£ thay Ä‘á»•i so vá»›i 10 nÄƒm vá» trÆ°á»›c, thÃ¬ tui váº«n xÃ i nhá»¯ng thá»© gá»i lÃ  boring-tech vÃ  xÃ i ráº¥t nhiá»u trong nhiá»u dá»± Ã¡n ká»ƒ cáº£ cÃ¡ nhÃ¢n láº«n cÃ´ng viá»‡c vÃ  má»™t trong sá»‘ Ä‘Ã³ lÃ  Ansible Ä‘á»ƒ quáº£n trá»‹ há»‡ thá»‘ng." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://taoquangne.com/weekly-summary/12022022-w1-setup-ansible-repo/" /><meta property="article:section" content="weekly-summary" />
<meta property="article:published_time" content="2022-02-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-12T00:00:00+00:00" /><meta property="og:site_name" content="/home/xluffy" />







  </head>
  <body class="">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >/home/xluffy ft ğŸ„</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">about</a></li>
        
      
        
          <li><a href="/tags">tags</a></li>
        
      
        
          <li><a href="https://github.com/xluffy/til/issues">til</a></li>
        
      
        
          <li><a href="/weekly-summary">weekly-summary</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">about</a></li>
      
    
      
        <li><a href="/tags">tags</a></li>
      
    
      
        <li><a href="https://github.com/xluffy/til/issues">til</a></li>
      
    
      
        <li><a href="/weekly-summary">weekly-summary</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">12/02/2022 - Week 1 - Setup Ansible repo</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-02-12
        </span>

        
      

      


      
    </div>

    
      <span class="post-tags">
        
          <a href="https://taoquangne.com/tags/ansible/">#ansible</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/molecule/">#molecule</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/testing/">#testing</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/python/">#python</a>&nbsp;
        
          <a href="https://taoquangne.com/tags/poetry/">#poetry</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Trong khi tháº¿ giá»›i Ä‘Ã£ thay Ä‘á»•i ráº¥t nhiá»u, cÃ¡ch váº­n hÃ nh há»‡ thá»‘ng cÅ©ng Ä‘Ã£ thay Ä‘á»•i so vá»›i 10 nÄƒm vá» trÆ°á»›c, thÃ¬ tui váº«n xÃ i nhá»¯ng thá»© gá»i lÃ  boring-tech vÃ  xÃ i ráº¥t nhiá»u trong nhiá»u dá»± Ã¡n ká»ƒ cáº£ cÃ¡ nhÃ¢n láº«n cÃ´ng viá»‡c vÃ  má»™t trong sá»‘ Ä‘Ã³ lÃ  Ansible Ä‘á»ƒ quáº£n trá»‹ há»‡ thá»‘ng. Tuáº§n nÃ y, sáº½ nÃ³i vá» cÃ¡ch tui setup má»™t Ansible repo mÃ  tui Ä‘ang xÃ i Ä‘á»ƒ quáº£n lÃ½, cÃ i Ä‘áº·t, cáº¥u hÃ¬nh cÃ¡c dá»‹ch vá»¥ trÃªn cÃ¡c VM.</p>
<blockquote>
<p>Nháº¯c láº¡i má»™t chÃºt vá» nguyÃªn táº¯c khi viáº¿t weekly-summary Ä‘Ã³ lÃ  KHÃ”NG NÃ“I Xáº O, cÃ³ sao nÃ³i váº­y, Ä‘ang lÃ m gÃ¬ thÃ¬ nÃ³i váº­y, khÃ´ng lÃ m thÃ¬ nÃ³i khÃ´ng lÃ m, lÃ m dá»Ÿ thÃ¬ nÃ³i lÃ m dá»Ÿ, má»™t sá»‘ chá»— náº¿u dÃ­nh NDA khÃ´ng thá»ƒ nÃ³i cÅ©ng sáº½ ghi cá»¥ thá»ƒ.</p>
</blockquote>
<p>Tui hay chia háº¡ táº§ng nÃ³i chung thÃ nh 2 pháº§n nhÆ° kiá»ƒu cá»§a <a href="https://blog.gruntwork.io/why-we-use-terraform-and-not-chef-puppet-ansible-saltstack-or-cloudformation-7989dad2865c#.63ls7fpkq">Gruntwork</a>, vá»›i má»™t pháº§n sáº½ cÃ³ cÃ¡ch tiáº¿p cáº­n riÃªng:</p>
<ul>
<li>Pháº§n Infra phÃ­a dÆ°á»›i, bao gá»“m nhá»¯ng thá»© tui tá»± Ä‘á»‹nh nghÄ©a lÃ  tá»« OS trá»Ÿ xuá»‘ng dÆ°á»›i nhÆ° Network, subnet, routing, VM &hellip; á» thá»i Ä‘iá»ƒm hiá»‡n táº¡i, váº«n xÃ i Terraform quáº£n trá»‹ miá»…n lÃ  provider Ä‘Ã³ cÃ³ há»— trá»£, vÃ­ dá»¥ xÆ°a thÃ¬ AWS, giá» thÃ¬ Linode.</li>
<li>Pháº§n System phÃ­a trÃªn, tá»« OS trá»Ÿ lÃªn trÃªn nhÆ° package, services, config &hellip; Pháº§n nÃ y lÃ  Ansible cÃ¡i mÃ  sáº½ nÃ³i trong tuáº§n nÃ y.</li>
</ul>
<p>Tui cÃ²n nhá»› láº§n Ä‘áº§u tiÃªn tui viáº¿t Ansible lÃ  vÃ o nÄƒm 2016 thÃ¬ pháº£i, trÆ°á»›c Ä‘Ã³ thÃ¬ Ä‘á»ƒ setup má»™t VM tui váº«n manual hoáº·c bash-script lÃºc Ä‘Ã³ bash-script cÃ³ má»™t vÃ i cÃ¡i ráº¥t khÃ³ chá»‹u:</p>
<ul>
<li>KhÃ´ng scale Ä‘Æ°á»£c, kiá»ƒu cháº¡y parallel trÃªn multi-VM khÃ´ng Ä‘Æ°á»£c</li>
<li>Viáº¿t logic ráº¥t khÃ³, cÃ ng phá»©c táº¡p cÃ ng khÃ³ hoáº·c viáº¿t Ä‘Æ°á»£c nhÆ°ng code Ä‘á»c thÃ¬ khÃ´ng hiá»ƒu gÃ¬ cáº£. (vÃ¬ bash há»— trá»£ kiá»ƒu dá»¯ liá»‡u Ä‘Æ¡n giáº£n, cÃ¡c kiá»ƒu phá»©c táº¡p nhÆ° array, hash, map khÃ´ng cÃ³ hoáº·c máº¥y cÃ¡i grep/awk/sed quÃ¡ nhiá»u logic sáº½ khÃ³ hiá»ƒu)</li>
<li>KhÃ³ test, cÃ³ cÃ¡i <a href="https://github.com/bats-core/bats-core">bats-core</a> nhÆ°ng thÃº tháº­t lÃ  khÃ´ng muá»‘n dÃ¹ng tÃ­ nÃ o</li>
<li>&lt;CÃ²n nhiá»u&gt;, nhÆ°ng lÃ¢u lÃ¢u váº«n xÃ i vÃ¬ nÃ³ nhanh, tiá»‡n náº¿u logic Ä‘Æ¡n giáº£n</li>
</ul>
<p>Sau Ä‘Ã³ chuyá»ƒn sang Ansible vÃ¬ nghe má»™t ngÆ°á»i báº¡n, cáº£m giÃ¡c láº§n Ä‘áº§u lÃ  khÃ´ng khoÃ¡i láº¯m, vÃ¬ sao tháº¥y nÃ³ phá»©c táº¡p quÃ¡. VÃ  ráº¥t khÃ³ chá»‹u á»Ÿ chá»— lÃ  lÃ¢u lÃ¢u cháº¡y láº¡i playbook thÃ¬ lÃºc nÃ o cÅ©ng lá»—i, lá»—i láº¡i pháº£i sá»­a tay nÃªn ráº¥t bá»±c bá»™i, lÃºc Ä‘Ã³ cáº£m tháº¥y ráº¥t khÃ³ test nÃªn cuá»‘i cÃ¹ng cÅ©ng khÃ´ng dÃ¹ng nhiá»u.</p>
<p>Má»™t sá»‘ lá»—i ráº¥t thÆ°á»ng gáº·p táº¡i thá»i Ä‘iá»ƒm Ä‘Ã³ mÃ  tui hay bá»‹:</p>
<ul>
<li>Mistake vá» package name, config option hoáº·c path -&gt; do khÃ´ng cÃ³ testing, nÃªn cá»© khi nÃ o update code, cháº¡y trÃªn production lÃ  ráº¥t dá»… dÃ­nh lá»—i (vÃ­ dá»¥ thay vÃ¬ package name lÃ  cá»§a dá»‹ch vá»¥ SSH client lÃ  <code>openssh-client</code> trÃªn Ubuntu, nhÆ°ng láº¡i lÃ  <code>openssh-clients</code> trÃªn CentOS, náº¿u sai tÃªn package thÃ¬ sáº½ <code>not found</code>, hoáº·c nhÆ° path default config cá»§a nginx thay vÃ¬ <code>/etc/nginx</code> láº¡i gÃµ nháº§m thÃ nh <code>/etc/ngnx</code> -&gt; khi render config thÃ¬ sáº½ <code>path not found</code> hoáº·c nhÆ° Redis version 6 há» Ä‘Ã£ bá» tá»« khÃ³a <code>slave</code> vÃ  thay báº±ng <code>replica</code>, náº¿u upgrade version Redis mÃ  khÃ´ng test thÃ¬ sáº½ khÃ´ng start Ä‘Æ°á»£c dá»‹ch vá»¥.</li>
<li>Setup mÃ´i trÆ°á»ng test Ä‘á»“ng nháº¥t vÃ  tá»± Ä‘á»™ng khÃ³, mong Ä‘á»£i lÃ  cÃ¡i VM test nÃ³ pháº£i giá»‘ng cÃ¡i VM Ä‘Æ°á»£c táº¡o bá»Ÿi cloud provider, tháº¿ thÃ¬ má»›i khÃ´ng cÃ³ bug Ä‘Æ°á»£c. Há»“i Ä‘Ã³ suy nghÄ© tá»›i viá»‡c cÃ i 1 cÃ¡i mÃ¡y áº£o VirtualBox Ubuntu, xong snapshot láº¡i má»—i láº§n test thÃ¬ reset láº¡i snapshot hoáº·c xÃ i Vagrant Ä‘á»ƒ boot má»™t cÃ¡i VM vÃ  run playbook vÃ o Ä‘Ã³. NhÆ°ng nÃ³i chung nÃ³ váº«n ko tá»± Ä‘á»™ng láº¯m.</li>
<li>Test báº±ng cÆ¡m, tá»©c lÃ  cÃ³ mÃ´i trÆ°á»ng, cháº¡y playbook vÃ  nhÃ¬n output.</li>
</ul>
<h2 id="1-setup-mÃ´i-trÆ°á»ng-python">1. Setup mÃ´i trÆ°á»ng Python</h2>
<p>Ansible vÃ  nhiá»u thÆ° viá»‡n liÃªn quan viáº¿t báº±ng Python, nÃªn nÃ³ cÅ©ng tÆ°Æ¡ng tá»± cÃ¡c mÃ£ nguá»“n Python khÃ¡c, nÃªn cáº§n cÃ³ mÃ´i trÆ°á»ng Ä‘á»ƒ development, test, á»Ÿ Ä‘Ã¢y dÃ¹ng cÃ¡c thá»© nhÆ° sau:</p>
<ul>
<li><code>pyenv</code> Ä‘á»ƒ quáº£n lÃ½ multi-version Python (ko dÃ¹ng Python cá»§a system, cÅ©ng ko tá»± build)</li>
<li><code>poetry</code> Ä‘á»ƒ quáº£n lÃ½ thÆ° viá»‡n Python, xÆ°a xÃ i cÃ¡i <code>requirement.txt</code> thÃ´ng qua <code>pip3</code> nhÆ°ng nÃ³ thá»§ cÃ´ng quÃ¡, má»™t pháº§n muá»‘n cÃ³ cÃ¡i kiá»ƒu <code>.lock</code> Ä‘á»ƒ lock version. XÃ i <code>poetry</code> nhiá»u lÃºc cÅ©ng bá»±c mÃ¬nh, vÃ¬ lá»—i lÃºc nÃ o cÅ©ng giá»‘ng nhau, lá»¡ cÃ³ bug gÃ¬ cÃ¡i lÃ  ráº¥t khÃ³ Ä‘á»ƒ tÃ¬m giáº£i phÃ¡p, nÃ³i chung xÃ i táº¡m Ä‘Æ°á»£c chá»© cÅ©ng ko Æ°a láº¯m =)) ai thÃ­ch cÃ³ thá»ƒ thá»­ cÃ¡i khÃ¡c</li>
<li><code>direnv</code> Ä‘á»ƒ tá»± Ä‘á»™ng load má»™t sá»‘ ENV variable khi <code>cd</code> vÃ o source code -&gt; cÃ¡i nÃ y tháº¥y ráº¥t ngon</li>
</ul>
<p>Cá»¥ thá»ƒ nhÆ° sau</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; brew install pyenv
<span style="color:#75715e"># NhÃ©t Ä‘á»§ 4 cÃ¡i vÃ o bash_profile, bashrc gÃ¬ Ä‘Ã³, lÃªn docs xem nhÃ©</span>

export PYENV_ROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$HOME<span style="color:#e6db74">/.pyenv
</span><span style="color:#e6db74">export PATH=&#34;</span>$PYENV_ROOT/bin:$PATH<span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">eval &#34;</span><span style="color:#66d9ef">$(</span>pyenv init --path<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">eval &#34;</span><span style="color:#66d9ef">$(</span>pyenv init -<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;
</span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Äang xÃ i Python 3.8.12</span>

&gt; pyenv install 3.8.12
&gt; pyenv global 3.8.12
&gt; python3 --version
Python 3.8.12

<span style="color:#75715e"># Upgrade pip vÃ  cÃ i poetry trÆ°á»›c nhÃ©</span>
&gt; pip install --upgrade pip
&gt; pip install poetry
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; brew install direnv
<span style="color:#75715e"># config direnv</span>
echo <span style="color:#e6db74">&#39;eval &#34;$(direnv hook bash)&#34;&#39;</span> &gt;&gt; ~/.bashrc

<span style="color:#75715e"># CÃ i layout poetry cho direnv</span>
&gt; add to ~/.direnvrc
layout_poetry<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> ! -f pyproject.toml <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    log_error <span style="color:#e6db74">&#39;No pyproject.toml found. Use `poetry new` or `poetry init` to create one first.&#39;</span>
    exit <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">fi</span>

  <span style="color:#75715e"># create venv if it doesn&#39;t exist</span>
  poetry run true

  export VIRTUAL_ENV<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>poetry env info --path<span style="color:#66d9ef">)</span>
  export POETRY_ACTIVE<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
  PATH_add <span style="color:#e6db74">&#34;</span>$VIRTUAL_ENV<span style="color:#e6db74">/bin&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ThÃªm má»™t tÃ­ lÃ  Ä‘á»ƒ <code>direnv</code> sáº½ tá»± update <code>PS1</code> khi <code>cd</code> vÃ  source code, thÃ¬ thÃªm cÃ¡i nÃ y trong <code>.bashrc</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">show_virtual_env<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n <span style="color:#e6db74">&#34;</span>$VIRTUAL_ENV<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">&amp;&amp;</span> -n <span style="color:#e6db74">&#34;</span>$DIRENV_DIR<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;(</span><span style="color:#66d9ef">$(</span>basename $VIRTUAL_ENV<span style="color:#66d9ef">)</span><span style="color:#e6db74">)&#34;</span>
  <span style="color:#66d9ef">fi</span>
<span style="color:#f92672">}</span>
export -f show_virtual_env
PS1<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;$(show_virtual_env)&#39;</span>$PS1
</code></pre></div><p>=&gt; DÃ¹ng Ä‘Æ°á»£c cho táº¥t cáº£ cÃ¡c dá»± Ã¡n Python khÃ¡c nhÃ©, khÃ´ng pháº£i má»—i Ansible</p>
<h2 id="2-init-ansible-repo">2. Init Ansible repo</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; cd ~/code/me
&gt; mkdir -pv gh-infra
&gt; pyenv local 3.8.12
&gt; cat .python-version
3.8.12
</code></pre></div><p>Sau máº¥y bÆ°á»›c trÃªn, trong thÆ° má»¥c code sinh ra file <code>.python-version</code> chá»‰ version Python cá»§a mÃ£ nguá»“n</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; poetry init

This command will guide you through creating your pyproject.toml config.

Package name <span style="color:#f92672">[</span>gh-infra<span style="color:#f92672">]</span>:
Version <span style="color:#f92672">[</span>0.1.0<span style="color:#f92672">]</span>:
Description <span style="color:#f92672">[]</span>:  Ansible demo
Author <span style="color:#f92672">[</span>xluffy &lt;hi.quang.gg@gmail.com&gt;, n to skip<span style="color:#f92672">]</span>:
License <span style="color:#f92672">[]</span>:
Compatible Python versions <span style="color:#f92672">[</span>^3.8<span style="color:#f92672">]</span>:

Would you like to define your main dependencies interactively? <span style="color:#f92672">(</span>yes/no<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>yes<span style="color:#f92672">]</span> yes
You can specify a package in the following forms:
  - A single name <span style="color:#f92672">(</span>requests<span style="color:#f92672">)</span>
  - A name and a constraint <span style="color:#f92672">(</span>requests@^2.23.0<span style="color:#f92672">)</span>
  - A git url <span style="color:#f92672">(</span>git+https://github.com/python-poetry/poetry.git<span style="color:#f92672">)</span>
  - A git url with a revision <span style="color:#f92672">(</span>git+https://github.com/python-poetry/poetry.git#develop<span style="color:#f92672">)</span>
  - A file path <span style="color:#f92672">(</span>../my-package/my-package.whl<span style="color:#f92672">)</span>
  - A directory <span style="color:#f92672">(</span>../my-package/<span style="color:#f92672">)</span>
  - A url <span style="color:#f92672">(</span>https://example.com/packages/my-package-0.1.0.tar.gz<span style="color:#f92672">)</span>

Search <span style="color:#66d9ef">for</span> package to add <span style="color:#f92672">(</span>or leave blank to <span style="color:#66d9ef">continue</span><span style="color:#f92672">)</span>: ansible<span style="color:#f92672">=</span>2.9.27
Adding ansible<span style="color:#f92672">=</span>2.9.27

Add a package: ansible-lint<span style="color:#f92672">=</span>^5.3.2
Adding ansible-lint<span style="color:#f92672">=</span>^5.3.2

Add a package: flake8<span style="color:#f92672">=</span>^4.0.1
Adding flake8<span style="color:#f92672">=</span>^4.0.1

Add a package: yamllint<span style="color:#f92672">=</span>^1.26.3
Adding yamllint<span style="color:#f92672">=</span>^1.26.3

Add a package: prettytable<span style="color:#f92672">=</span>^3.0.0
Adding prettytable<span style="color:#f92672">=</span>^3.0.0

Add a package: cryptography<span style="color:#f92672">=</span>^36.0.1
Adding cryptography<span style="color:#f92672">=</span>^36.0.1

Add a package: pytest<span style="color:#f92672">=</span>^6.2.5
Adding pytest<span style="color:#f92672">=</span>^6.2.5

Add a package: black<span style="color:#f92672">=</span>^21.12b0
Adding black<span style="color:#f92672">=</span>^21.12b0

Add a package: molecule<span style="color:#f92672">=</span>3.5.2
Adding molecule<span style="color:#f92672">=</span>3.5.2

Add a package: mitogen<span style="color:#f92672">=</span>0.2.9
Adding mitogen<span style="color:#f92672">=</span>0.2.9

Add a package: yamlfix<span style="color:#f92672">=</span>^0.8.0
Adding yamlfix<span style="color:#f92672">=</span>^0.8.0

Add a package: molecule-vagrant<span style="color:#f92672">=</span>^1.0.0
Adding molecule-vagrant<span style="color:#f92672">=</span>^1.0.0

Add a package: autopep8<span style="color:#f92672">=</span>^1.6.0
Adding autopep8<span style="color:#f92672">=</span>^1.6.0

Add a package: pytest-testinfra<span style="color:#f92672">=</span>^6.5.0
Adding pytest-testinfra<span style="color:#f92672">=</span>^6.5.0
</code></pre></div><p>Khá»Ÿi táº¡o vÃ  add cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t, sáº½ ra má»™t file <code>pyproject.toml</code></p>
<p>Táº¡o <code>.envrc</code>, file cáº¥u hÃ¬nh trong repo cá»§a <code>direnv</code> vÃ  allow content</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; cat .envrc
layout_poetry
export FORCE_COLOR<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
export PY_COLORS<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

direnv: error /Users/quanggg/code/me/gh-infra/.envrc is blocked. Run <span style="color:#e6db74">`</span>direnv allow<span style="color:#e6db74">`</span> to approve its content

&gt; direnv allow
</code></pre></div><p>Sau khi cháº¡y lá»‡nh trÃªn sáº½ tháº¥y Ä‘iá»u kÃ¬ diá»‡u cá»§a <code>direnv</code>, nÃ³ Ä‘Ã£ táº¡o cho chÃºng ta má»™t <code>VIRTUAL_ENV</code> vÃ  edit dÃ¹m <code>PS1</code>, sau Ä‘Ã³ chá»‰ viá»‡c xÃ i <code>poetry</code> Ä‘á»ƒ cÃ i thÆ° viá»‡n Ä‘Ã£ khai bÃ¡o á»Ÿ trÃªn.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; direnv allow
direnv: loading ~/code/me/gh-infra/.envrc
Creating virtualenv gh-infra-ckHUeV7x-py3.8 in /Users/quanggg/Library/Caches/pypoetry/virtualenvs
direnv: export +FORCE_COLOR +POETRY_ACTIVE +PY_COLORS +VIRTUAL_ENV ~PATH
<span style="color:#f92672">(</span>gh-infra-ckHUeV7x-py3.8<span style="color:#f92672">)</span>:: You are quanggg -at- xluffys-MacBook-Air <span style="color:#f92672">[</span>~/code/me/gh-infra<span style="color:#f92672">]</span>

&gt;  poetry install
Updating dependencies
Resolving dependencies... <span style="color:#f92672">(</span>21.0s<span style="color:#f92672">)</span>

Writing lock file

Package operations: <span style="color:#ae81ff">72</span> installs, <span style="color:#ae81ff">0</span> updates, <span style="color:#ae81ff">0</span> removals

  â€¢ Installing six <span style="color:#f92672">(</span>1.16.0<span style="color:#f92672">)</span>
  â€¢ Installing markupsafe <span style="color:#f92672">(</span>2.0.1<span style="color:#f92672">)</span>
  â€¢ Installing pycparser <span style="color:#f92672">(</span>2.21<span style="color:#f92672">)</span>
  â€¢ Installing python-dateutil <span style="color:#f92672">(</span>2.8.2<span style="color:#f92672">)</span>
  â€¢ ...
  
<span style="color:#75715e"># Sau bÆ°á»›c nÃ y ra cÃ¡i file `poetry.lock` lock version</span>
</code></pre></div><p>BÃ¢y giá» má»—i láº§n <code>cd</code> ra ngoÃ i source code vÃ  <code>cd</code> vÃ o source code, <code>direnv</code> sáº½ há»— trá»£ load/unload ENV variable vÃ  mÃ´i trÆ°á»ng áº£o Python giÃºp, khÃ´ng pháº£i lÃ m thÃªm gÃ¬ cáº£. Cáº§n thÃªm thÆ° viá»‡n gÃ¬ thÃ¬ cá»© <code>poetry add</code>, ai clone source vá» thÃ¬ sau má»¥c #1 phÃ­a trÃªn chá»‰ cáº§n <code>poetry install</code> lÃ  xong, Ä‘á»§ Ä‘á»“ chÆ¡i.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; cd ~
direnv: unloading

&gt; cd -
/Users/quanggg/code/me/gh-infra
direnv: loading ~/code/me/gh-infra/.envrc
direnv: export +FORCE_COLOR +POETRY_ACTIVE +PY_COLORS +VIRTUAL_ENV ~PATH

<span style="color:#f92672">(</span>gh-infra-ckHUeV7x-py3.8<span style="color:#f92672">)</span>:: You are quanggg -at- xluffys-MacBook-Air <span style="color:#f92672">[</span>~/code/me/gh-infra<span style="color:#f92672">]</span>
</code></pre></div><h2 id="3-ansible-orgs-and-tooling">3. Ansible orgs and tooling</h2>
<ul>
<li><a href="https://github.com/crate-ci/typos">typos</a> Ä‘á»ƒ ource code spell checker, tá»‡p <code>_typos.toml</code></li>
<li>Molecule vÃ  molecule-vagrant Ä‘á»ƒ táº¡o mÃ¡y áº£o test vÃ  viáº¿t code test, Ä‘i kÃ¨m lÃ  VirtualBox</li>
<li>Makefile Ä‘á»ƒ generate má»™t vÃ i info nhÆ° inventory</li>
<li><a href="https://mitogen.networkgenomics.com/ansible_detailed.html"><code>mitogen</code></a> Ä‘á»ƒ cháº¡y Ansible láº¹ hÆ¡n, nhÆ°ng chÆ°a há»— trá»£ Ansible lá»›n hÆ¡n 0.2.9 nÃªn váº«n xÃ i Ansible 0.2.9 nhÃ©</li>
<li><code>ansible-vault</code> Ä‘á»ƒ support symmetric encryption thÃ´ng qua <code>.vault_pass</code></li>
<li><code>yamllint</code> vÃ  <code>ansible-lint</code> Ä‘á»ƒ lint <code>yaml</code> file vÃ  ansible module cÃ³ theo rule khÃ´ng, há»— trá»£ develop thá»‘ng nháº¥t, chuáº©n.</li>
<li><code>flake8</code>, <code>black</code>, <code>autopep8</code> há»— trá»£ develop python theo coding style, auto fix &hellip;.</li>
<li><code>pytest</code>, <code>pytest-testinfra</code> Ä‘á»ƒ há»— trá»£ viáº¿t code test infra vÃ  Ansible role</li>
<li><code>docs</code> Ä‘á»ƒ chá»©a hÆ°á»›ng dáº«n vá» cÃ¡ch xÃ i, cÃ¡ch development, ad-hoc task cháº¡y sao, migration thÃ¬ nhÆ° tháº¿ nÃ o</li>
<li><code>secrets</code> chá»©a cÃ¡i gÃ¬ cáº§n giá»¯ bÃ­ máº­t, Ä‘á»«ng commit lÃªn nhÃ©, náº¿u khÃ´ng mang tÃ­nh bÃ­ máº­t thuá»™c vá» má»™t cÃ¡ nhÃ¢n nÃ o Ä‘Ã³ thÃ¬ cÃ³ thá»ƒ dÃ¹ng <code>ansible-vault</code> Ä‘á»ƒ encrypt giá»‘ng <code>id_ed25519.vault</code> cÅ©ng Ä‘Æ°á»£c</li>
</ul>
<p>Cáº¥u trÃºc mÃ£ nguá»“n nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ _typos.toml
â”œâ”€â”€ ansible.cfg
â”œâ”€â”€ ansible_cache
â”œâ”€â”€ docs
â”‚Â Â  â”œâ”€â”€ migrations
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ 001-migrate-abc-srv.md
â”‚Â Â  â”‚Â Â  â””â”€â”€ 001-migrate-redis-srv.md
â”‚Â Â  â”œâ”€â”€ runbooks
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ansible-run-specify-tasks.md
â”‚Â Â  â”‚Â Â  â””â”€â”€ debug-jinja2-render.md
â”‚Â Â  â”œâ”€â”€ setup.md
â”‚Â Â  â””â”€â”€ testing.md
â”œâ”€â”€ hosts.txt
â”œâ”€â”€ inventories
â”‚Â Â  â”œâ”€â”€ 000_cross_env_vars.yml
â”‚Â Â  â””â”€â”€ prod
â”‚Â Â      â”œâ”€â”€ group_vars
â”‚Â Â      â”‚Â Â  â””â”€â”€ all
â”‚Â Â      â”‚Â Â      â”œâ”€â”€ 000_cross_env_vars.yml -&gt; ../../../000_cross_env_vars.yml
â”‚Â Â      â”‚Â Â      â””â”€â”€ 001_remote_env_vars.yml
â”‚Â Â      â”œâ”€â”€ host_vars
â”‚Â Â      â””â”€â”€ hosts
â”œâ”€â”€ poetry.lock
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ roles
â”œâ”€â”€ run_molecule.py
â””â”€â”€ secrets
  â”œâ”€â”€ id_ed25519
  â””â”€â”€ id_ed25519.pub
  â””â”€â”€ id_ed25519.vault
</code></pre></div><p>CÃ i VirtualBox vÃ  vagrant há»— trá»£ táº¡o mÃ¡y áº£o testing, test <code>x86_64</code> vÃ  Ubuntu thÃ´i nhÃ©, tui ko cÃ²n Æ°a CentOS ná»¯a.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; VirtualBox lÃªn trang chá»§ táº£i
&gt; brew install vagrant
<span style="color:#75715e"># XÃ i chÃ­nh Ubuntu 20.04 lÃªn test trÃªn Ä‘Ã¢y, box nÃ y y chang VM AWS hoáº·c cÃ¡c cloud provider khá»Ÿi táº¡o nhÃ©</span>
&gt; vagrant box add ubuntu/focal64
&gt; vagrant box list
ubuntu/focal64 <span style="color:#f92672">(</span>virtualbox, 20220208.0.0<span style="color:#f92672">)</span>
</code></pre></div><h3 id="31-role-common">3.1 Role common</h3>
<ul>
<li>ÄÆ°á»£c include bá»Ÿi táº¥t cáº£ cÃ¡c playbook, lÃªn táº¥t cáº£ cÃ¡c server Ä‘á»u sáº½ cÃ³ thuá»™c tÃ­nh giá»‘ng nhau nhá» role nÃ y (tunning, hardening, security, audit, monitoring &hellip;)</li>
<li>Há»— trá»£ testing vá»›i <code>molecule</code></li>
</ul>
<p>Cáº¥u trÃºc lÆ°á»£c bá»›t nhÆ° sau, cá»¥ thá»ƒ tÃ­ xem source trong repo nhÃ©:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; tree
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ defaults
â”‚Â Â  â””â”€â”€ main
â”‚Â Â      â”œâ”€â”€ main.yml
â”‚Â Â      â”œâ”€â”€ node_exporter.yml
â”‚Â Â      â””â”€â”€ vault.yml
â”œâ”€â”€ files
â”‚Â Â  â””â”€â”€ bench-local-dns
â”œâ”€â”€ handlers
â”‚Â Â  â””â”€â”€ main.yml
â”œâ”€â”€ molecule
â”‚Â Â  â””â”€â”€ default
â”‚Â Â      â”œâ”€â”€ converge.yml
â”‚Â Â      â”œâ”€â”€ molecule.yml
â”‚Â Â      â”œâ”€â”€ prepare.yml
â”‚Â Â      â””â”€â”€ tests
â”‚Â Â          â”œâ”€â”€ __pycache__
â”‚Â Â          â”‚Â Â  â””â”€â”€ test_default.cpython-38-pytest-6.2.5.pyc
â”‚Â Â          â””â”€â”€ test_default.py
â”œâ”€â”€ tasks
â”‚Â Â  â”œâ”€â”€ apt.yml
â”‚Â Â  â”œâ”€â”€ build.yml
â”‚Â Â  â”œâ”€â”€ ps_mem.yml
â”‚Â Â  â”œâ”€â”€ resolved.yml
â”‚Â Â  â”œâ”€â”€ root.yml
â”‚Â Â  â”œâ”€â”€ sshd.yml
â”‚Â Â  â””â”€â”€ utils.yml
â””â”€â”€ templates
    â”œâ”€â”€ 00-header.sh.j2
    â”œâ”€â”€ 10-network-perf.conf.j2
    â”œâ”€â”€ 10-network-security.conf.j2
    â”œâ”€â”€ 10-system-memory.conf.j2
    â”œâ”€â”€ 10-system-security.conf.j2
    â”œâ”€â”€ 20auto-upgrades.j2
    â”œâ”€â”€ sshd_config.j2
    â”œâ”€â”€ system.conf.j2
    â”œâ”€â”€ uptimed.conf.j2
    â”œâ”€â”€ user.conf.j2
    â””â”€â”€ vimrc.j2
</code></pre></div><p>CÃ¡ch Ä‘á»ƒ khá»Ÿi táº¡o vÃ  cÃ¡c command cá»§a <code>molecule</code> thÃ¬ lÃªn docs coi nhÃ©, khÃ´ng thÃ¬ copy tÆ°Æ¡ng tá»± cÅ©ng cháº¡y Ä‘Æ°á»£c, nÃ³i nhanh thÃ¬ cÃ³ nhá»¯ng thá»© sau:</p>
<ul>
<li><code>molecule/default</code> gá»i lÃ  ká»‹ch báº£n (scenario)</li>
<li><code>molecule.yml</code> mÃ´ táº£ vá» mÃ´i trÆ°á»ng, cÃ¡ch test
<ul>
<li><code>platform</code> lÃ  vagrant, mÃ¡y áº£o virtualbox phÃ­a trÃªn, Ubuntu 20.04 <code>ubuntu/focal64</code>, memory mÃ¡y áº£o lÃ  1280MB, thuá»™c group <code>common</code></li>
<li><code>lint</code> thÃ¬ xÃ i <code>yamllint</code>, <code>ansible-lint</code> test <code>yml</code> file (tasks, handler, variables, templates)</li>
<li><code>provisioner</code> lÃ  ansible, chÃ­nh lÃ  cÃ¡i <code>converge.yml</code></li>
<li><code>verifier</code> lÃ  <code>./tests/test_default.py</code></li>
</ul>
</li>
<li><code>converge.yml</code> tÆ°Æ¡ng tá»± playbook</li>
<li><code>prepare.yml</code> lÃ m má»™t sá»‘ thá»© trÆ°á»›c khi cháº¡y playbook</li>
<li><code>molecule/default/tests/test_default.py</code> -&gt; code verify</li>
</ul>
<p><strong>VÃ­ dá»¥:</strong></p>
<p>CÃ³ má»™t task táº¡o user <code>deploy</code> khi server thuá»™c group <code>web/app/api</code> nhÆ° sau</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml">- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">common | create deployment group</span>
  <span style="color:#f92672">group</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deploy</span>
    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
  <span style="color:#f92672">when</span>: &gt;<span style="color:#e6db74">
</span><span style="color:#e6db74">    inventory_hostname in groups.app | default([])
</span><span style="color:#e6db74">    or
</span><span style="color:#e6db74">    inventory_hostname in groups.api | default([])
</span><span style="color:#e6db74">    or
</span><span style="color:#e6db74">    inventory_hostname in groups.web | default([])</span>    
  <span style="color:#f92672">tags</span>:
    - <span style="color:#ae81ff">r_common_based</span>
    - <span style="color:#ae81ff">r_common_users</span>

- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">common | create deployment user</span>
  <span style="color:#f92672">user</span>:
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">deploy</span>
    <span style="color:#f92672">create_home</span>: <span style="color:#66d9ef">yes</span>
    <span style="color:#f92672">state</span>: <span style="color:#ae81ff">present</span>
    <span style="color:#f92672">group</span>: <span style="color:#ae81ff">deploy</span>
    <span style="color:#f92672">comment</span>: <span style="color:#e6db74">&#34;Deployer user&#34;</span>
    <span style="color:#f92672">shell</span>: <span style="color:#e6db74">&#34;/bin/bash&#34;</span>
  <span style="color:#f92672">when</span>: &gt;<span style="color:#e6db74">
</span><span style="color:#e6db74">    inventory_hostname in groups.app | default([])
</span><span style="color:#e6db74">    or
</span><span style="color:#e6db74">    inventory_hostname in groups.api | default([])
</span><span style="color:#e6db74">    or
</span><span style="color:#e6db74">    inventory_hostname in groups.web | default([])</span>    
  <span style="color:#f92672">tags</span>:
    - <span style="color:#ae81ff">r_common_based</span>
    - <span style="color:#ae81ff">r_common_users</span>
</code></pre></div><p>Viáº¿t code test báº±ng <code>testinfra</code> Ä‘á»ƒ kiá»ƒm tra user Ä‘Ã³ cÃ³ tháº­t sá»± tá»“n táº¡i sau khi cháº¡y playbook khÃ´ng nhÆ° sau, cÃ¡ch nÃ y hÆ¡i phÃ¨n vÃ¬ check group dá»±a trÃªn hostname, nhÆ°ng nÃ³ cháº¡y, vÃ¬ rules tá»± Ä‘áº·t lÃ  trong hostname cÃ³ services:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_users</span>(host):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Test create user/group
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
    _hostname <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>uname()[<span style="color:#ae81ff">1</span>]

    <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#34;app&#34;</span> <span style="color:#f92672">in</span> _hostname <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;api&#34;</span> <span style="color:#f92672">in</span> _hostname <span style="color:#f92672">or</span> <span style="color:#e6db74">&#34;web&#34;</span> <span style="color:#f92672">in</span> _hostname:
        _g_deploy <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>group(<span style="color:#e6db74">&#34;deploy&#34;</span>)
        _u_deploy <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>user(<span style="color:#e6db74">&#34;deploy&#34;</span>)

        <span style="color:#66d9ef">assert</span> _g_deploy<span style="color:#f92672">.</span>exists
        <span style="color:#66d9ef">assert</span> _u_deploy<span style="color:#f92672">.</span>exists
        <span style="color:#66d9ef">assert</span> _u_deploy<span style="color:#f92672">.</span>shell <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;/bin/bash&#34;</span>
</code></pre></div><p>Hoáº·c muá»‘n test cÃ¡c service sau khi cháº¡y playbook xong sáº½ Ä‘Æ°á»£c start vÃ  cho phÃ©p khá»Ÿi Ä‘á»™ng khi boot OS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a6e22e">@pytest</span><span style="color:#f92672">.</span>mark<span style="color:#f92672">.</span>parametrize(<span style="color:#e6db74">&#34;services&#34;</span>, [<span style="color:#e6db74">&#34;sshd&#34;</span>, <span style="color:#e6db74">&#34;rsyslog&#34;</span>, <span style="color:#e6db74">&#34;chrony&#34;</span>, <span style="color:#e6db74">&#34;node_exporter&#34;</span>])
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_services_running</span>(host, services):
    <span style="color:#e6db74">&#34;&#34;&#34;
</span><span style="color:#e6db74">    Test services are running + enabled
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    _s_services <span style="color:#f92672">=</span> host<span style="color:#f92672">.</span>service(services)
    <span style="color:#66d9ef">assert</span> _s_services<span style="color:#f92672">.</span>is_running
    <span style="color:#66d9ef">assert</span> _s_services<span style="color:#f92672">.</span>is_enabled
</code></pre></div><p>Xong xuÃ´i, bÃ¢y giá» cháº¡y test, ká»‹ch báº£n cháº¡y tuáº§n tá»± sáº½ nhÆ° sau:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; mol matrix test
INFO     Test matrix
---
default:
  - dependency
  - lint
  - cleanup
  - destroy
  - syntax
  - create
  - prepare
  - converge
  - idempotence
  - side_effect
  - verify
  - cleanup
  - destroy
</code></pre></div><ul>
<li>cháº¡y <code>lint</code>, xem code cÃ³ Ä‘Ãºng chuáº©n chÆ°a, <code>yml</code> cÃ³ Ä‘Ãºng chuáº©n chÆ°a, viáº¿t task ansible cÃ³ theo best practice khÃ´ng (vÃ­ dá»¥ ko khuyáº¿n khÃ­ch xÃ i module <code>shell/command</code> nÃ¨ hoáº·c cÃ³ miss attribute gÃ¬ khÃ´ng, nhÆ° miss permission cá»§a thÆ° má»¥c khi táº¡o nÃ¨)</li>
<li><code>cleanup/destroy</code>, náº¿u Ä‘Ã£ cÃ³ má»™t VM trÆ°á»›c Ä‘Ã³, thÃ¬ xÃ³a Ä‘i, lÃ m láº¡i tá»« Ä‘áº§u, test cho chuáº©n (giá»‘ng xÃ³a cÃ¡i VM trÆ°á»›c Ä‘Ã³ Ä‘Ã£ test)</li>
<li><code>syntax</code> kiá»ƒm tra syntax</li>
<li><code>create</code> táº¡o VM thÃ´ng qua <code>vagrant</code> vÃ  VirtualBox, giá»‘ng <code>vagrant up</code> thÃ´i, xÃ i cÃ¡i <code>VBoxManage list runningvms</code> sáº½ tháº¥y VM Ä‘Æ°á»£c táº¡o ra hoáº·c má»Ÿ VirtualBox GUI sáº½ tháº¥y cÃ³ mÃ¡y áº£o má»›i</li>
<li><code>prepare</code>, cháº¡y cÃ¡i <code>prepare.yml</code> phÃ­a trÃªn</li>
<li><code>converge</code> cháº¡y playbook cá»§a role nÃ y</li>
<li><code>idempotence</code> má»™t Ä‘áº·c tÃ­nh quan trá»ng cá»§a Ansible, nÃ³ Ä‘áº£m báº£o ráº±ng playbook Ä‘Æ°á»£c cháº¡y Ä‘i cháº¡y láº¡i nhiá»u láº§n thÃ¬ váº«n Ä‘áº¡t tÃ­nh <code>idempotence</code>, vÃ­ dá»¥ máº¥y module <code>shell/command</code> khÃ´ng há»— trá»£ <code>idempotence</code> nÃªn thÆ°á»ng khÃ´ng khuyáº¿n khÃ­ch xÃ i, trá»« khi báº¯t buá»™c, lÃºc Ä‘Ã³ sáº½ cáº§n add tags <code>molecule-idempotence-notest</code> Ä‘á»ƒ skip test</li>
<li><code>verify</code> lÃ  cháº¡y nhá»¯ng thá»© kiá»ƒm tra xem role cÃ³ cháº¡y Ä‘Ãºng khÃ´ng, tá»‡p <code>molecule/default/tests/test_default.py</code></li>
<li>VÃ  xong xuÃ´i, cuá»‘i cÃ¹ng thÃ¬ <code>cleanup/destroy</code> -&gt; xÃ³a VM instance</li>
</ul>
<p>Cháº¡y thá»­ (xÃ³a bá»›t cho Ä‘á»¡ dÃ i dÃ²ng) (cá»© clone vá», setup Ä‘á»§ lÃ  cháº¡y Ä‘Æ°á»£c)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; cd roles/common
&gt; mol test

INFO     Running default &gt; lint
COMMAND: set -e
yamllint .
ansible-lint --exclude molecule
flake8

PLAY <span style="color:#f92672">[</span>Destroy<span style="color:#f92672">]</span> ******************************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Destroy molecule instance<span style="color:#f92672">(</span>s<span style="color:#f92672">)]</span> *********************************************************************************************************************************************************************************************************************
Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:18 +0700 <span style="color:#f92672">(</span>0:00:00.015<span style="color:#f92672">)</span>       0:00:00.015 *****
ok: <span style="color:#f92672">[</span>localhost<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>Populate instance config<span style="color:#f92672">]</span> *************************************************************************************************************************************************************************************************************************
Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:20 +0700 <span style="color:#f92672">(</span>0:00:02.370<span style="color:#f92672">)</span>       0:00:02.386 *****
ok: <span style="color:#f92672">[</span>localhost<span style="color:#f92672">]</span>

TASK <span style="color:#f92672">[</span>Dump instance config<span style="color:#f92672">]</span> *****************************************************************************************************************************************************************************************************************************
Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:20 +0700 <span style="color:#f92672">(</span>0:00:00.040<span style="color:#f92672">)</span>       0:00:02.426 *****
skipping: <span style="color:#f92672">[</span>localhost<span style="color:#f92672">]</span>

PLAY RECAP **********************************************************************************************************************************************************************************************************************************************
localhost                  : ok<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>    changed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    unreachable<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    failed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    skipped<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>    rescued<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>    ignored<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>

Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:20 +0700 <span style="color:#f92672">(</span>0:00:00.041<span style="color:#f92672">)</span>       0:00:02.467 *****
<span style="color:#f92672">===============================================================================</span>
Destroy molecule instance<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 2.37s
Dump instance config ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.04s
Populate instance config ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.04s
Playbook run took <span style="color:#ae81ff">0</span> days, <span style="color:#ae81ff">0</span> hours, <span style="color:#ae81ff">0</span> minutes, <span style="color:#ae81ff">2</span> seconds
INFO     Running default &gt; syntax

playbook: /Users/quanggg/code/me/gh-infra/roles/common/molecule/default/converge.yml
INFO     Running default &gt; create

PLAY <span style="color:#f92672">[</span>Create<span style="color:#f92672">]</span> *******************************************************************************************************************************************************************************************************************************************

TASK <span style="color:#f92672">[</span>Create molecule instance<span style="color:#f92672">(</span>s<span style="color:#f92672">)]</span> **********************************************************************************************************************************************************************************************************************
Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:21 +0700 <span style="color:#f92672">(</span>0:00:00.015<span style="color:#f92672">)</span>       0:00:00.015 *****

Saturday <span style="color:#ae81ff">12</span> February <span style="color:#ae81ff">2022</span>  16:58:57 +0700 <span style="color:#f92672">(</span>0:00:00.493<span style="color:#f92672">)</span>       0:00:36.103 *****
<span style="color:#f92672">===============================================================================</span>
Create molecule instance<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span> --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 35.47s
Dump instance config ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.49s
Populate instance config dict -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.06s
Convert instance config dict to a list ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 0.06s
Playbook run took <span style="color:#ae81ff">0</span> days, <span style="color:#ae81ff">0</span> hours, <span style="color:#ae81ff">0</span> minutes, <span style="color:#ae81ff">36</span> seconds
INFO     Running default &gt; prepare
</code></pre></div><p>Cuá»‘i cÃ¹ng Ä‘Æ°á»£c káº¿t quáº£ nhÆ° sau</p>
<p><img src="https://github.com/xluffy/assets/blob/master/gh-infra-molecule-test-verify.png?raw=true" alt="gh-infra-molecule-test-verify.png"></p>
<p>CÃ³ má»™t sá»‘ trick khÃ¡c hay xÃ i khi development vÃ  testing nhÆ° sau:</p>
<ul>
<li><code>mol test --destroy=never</code> sáº½ khÃ´ng destroy sau khi test cháº¡y xong (<code>mol</code> máº·c Ä‘á»‹nh sáº½ destroy ká»ƒ cáº£ khi cháº¡y test hoáº·c cháº¡y playbook fail), sáº½ tiá»‡n trong development vÃ¬ quÃ¡ tÃ¬nh <code>create</code> VM cÅ©ng máº¥t 1-2 phÃºt</li>
<li><code>mol login</code>, cÃ³ thá»ƒ login vÃ o VM tÆ°Æ¡ng tá»± nhÆ° <code>vagrant login</code>, há»— trá»£ debug trong instance</li>
<li><code>mol --debug test</code> sáº½ in ra nhiá»u thÃ´ng tin hÆ¡n khi cháº¡y <code>mol</code> dá»… debug hÆ¡n</li>
<li>2 biáº¿n mÃ´i trÆ°á»ng <code>FORCE_COLOR</code> vÃ  <code>PY_COLORS</code> á»Ÿ <code>direnv/.envrc</code> giÃºp show color khi cháº¡y test</li>
</ul>
<p>DÃ i váº­y, nhÆ°ng chÆ°a rÃµ thÃ¬ vÃ o mÃ£ nguá»“n xem thÃªm nhÃ© <a href="https://github.com/xluffy/gh-infra">https://github.com/xluffy/gh-infra</a></p>

    </div>
    

    
      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user"><span> hÃ ng nhÃ  trá»“ng ğŸŒ´ theo <a href="https://creativecommons.org/licenses/by-nc/4.0">giáº¥y phÃ©p CC BY-NC 4.0</a></span><span>Themes created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span></div>
      
  </div>
</footer>

<script src="https://taoquangne.com/assets/main.js"></script>
<script src="https://taoquangne.com/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
